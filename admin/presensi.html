<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Interaktif - Admin</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- 1. RESET & GLOBAL --- */
        :root { --primary: #003366; --accent: #11998e; --bg: #f4f7f6; --text: #333; --hadir: #28a745; --izin: #ffc107; --absen: #dc3545; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 50px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* --- 2. HEADER --- */
        .page-header { background: #fff; padding: 20px 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--accent); }
        .page-header h2 { margin: 0; color: var(--accent); font-size: 1.6rem; display: flex; align-items: center; gap: 10px;}

        /* --- 3. BOKS PENGATURAN (SETUP KELAS) --- */
        .setup-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #e0e0e0; }
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: 700; color: #475569; font-size: 0.9rem; }
        .form-control { padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        .form-control:focus { border-color: var(--primary); }
        
        .class-selection { display: flex; gap: 15px; justify-content: flex-end; align-items: flex-end; }

        /* --- 4. LIST SISWA (ABSENSI) --- */
        .attendance-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .section-title { margin-top: 0; color: var(--primary); font-size: 1.3rem; border-bottom: 2px dashed #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        .student-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 12px; transition: 0.2s; }
        .student-item:hover { background-color: #f8fafc; border-color: #cbd5e1; }
        .student-name { font-weight: 700; font-size: 1.1rem; color: #334155; }
        
        .attendance-buttons { display: flex; gap: 10px; }
        .status-btn { padding: 8px 20px; border-radius: 20px; font-weight: 700; border: 2px solid transparent; cursor: pointer; transition: 0.2s; background: white; font-size: 0.9rem; }
        
        .status-btn.btn-hadir { border-color: var(--hadir); color: var(--hadir); }
        .status-btn.btn-izin { border-color: var(--warning); color: #d97706; }
        .status-btn.btn-absen { border-color: var(--danger); color: var(--danger); }
        
        .status-btn.active.btn-hadir { background: var(--hadir); color: white; }
        .status-btn.active.btn-izin { background: var(--warning); color: white; }
        .status-btn.active.btn-absen { background: var(--danger); color: white; }

        /* --- 5. TOMBOL & LAIN-LAIN --- */
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;}
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: #002244; transform: translateY(-2px); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-success { background: var(--accent); width: 100%; font-size: 1.1rem; padding: 15px; }
        .btn-success:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        
        .hidden { display: none !important; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(2px); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        @media (max-width: 768px) {
            .setup-grid { grid-template-columns: 1fr; }
            .class-selection { flex-direction: column; align-items: stretch; }
            .student-item { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <h2><i class="fa-solid fa-clipboard-user"></i> Presensi Sesi Harian</h2>
            <a href="index.html" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
        </div>

        <div class="setup-box" id="step-1">
            <h3 class="section-title">1. Pengaturan Sesi Mengajar</h3>
            <div class="setup-grid">
                <div class="form-group">
                    <label>Nama Pengajar</label>
                    <input type="text" id="in-pengajar" class="form-control" readonly style="background:#f1f5f9;">
                </div>
                <div class="form-group">
                    <label>Materi / Topik Hari Ini</label>
                    <input type="text" id="in-materi" class="form-control" placeholder="Contoh: Teknik Menulis Puisi">
                </div>
            </div>
            <div class="class-selection">
                <button class="btn btn-primary" onclick="loadClass('Kelas A')"><i class="fa-solid fa-users"></i> Buka Kelas A</button>
                <button class="btn btn-primary" onclick="loadClass('Kelas B')"><i class="fa-solid fa-users"></i> Buka Kelas B</button>
            </div>
        </div>

        <div class="attendance-section hidden" id="step-2">
            <h3 class="section-title" id="attendance-title">2. Daftar Hadir - Kelas X</h3>
            <div id="student-list">
                </div>
            
            <div style="margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px;">
                <button class="btn btn-success" id="btn-submit" disabled onclick="submitPresensi()">
                    <i class="fa-solid fa-floppy-disk"></i> Simpan & Buat Laporan PDF
                </button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
        <p style="margin-top: 15px; font-weight: 700; color: #333;" id="loading-text">Memuat...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
            authDomain: "mading-cf676.firebaseapp.com", 
            projectId: "mading-cf676", 
            storageBucket: "mading-cf676.firebasestorage.app", 
            messagingSenderId: "72175203671", 
            appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentClass = "";
        let attendanceData = {}; 

        const showLoading = (msg) => { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').classList.remove('hidden'); };
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        // 1. INIT
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                await signInAnonymously(auth);
            } else {
                // Ambil data pengajar
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if(userDoc.exists()) {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                    document.getElementById('in-pengajar').value = currentUser.name || "Pengajar";
                }
            }
        });

        // 2. LOAD SISWA KELAS
        window.loadClass = async (kelasName) => {
            const materi = document.getElementById('in-materi').value.trim();
            if (!materi) return alert("Silakan isi Materi / Topik hari ini terlebih dahulu!");

            showLoading(`Memuat data ${kelasName}...`);
            currentClass = kelasName;
            attendanceData = {}; // Reset data absensi

            try {
                // Karena di admin/siswa.html datanya mengambil dari tabel 'users' dengan filter role='siswa',
                // kita bisa memodifikasinya dengan menambahkan filter tambahan jika nanti ada pembagian kelas di Biodata.
                // Untuk sementara, kita ambil semua siswa yang aktif.
                const q = query(collection(db, 'users'), where('role', '==', 'siswa'));
                const snap = await getDocs(q);

                const studentListDiv = document.getElementById('student-list');
                studentListDiv.innerHTML = '';
                let studentCount = 0;

                snap.forEach(d => {
                    const s = d.data();
                    if(s.status === 'suspended') return; // Jangan absen anak yang di-suspend

                    studentCount++;
                    attendanceData[d.id] = { name: s.name, status: null };

                    studentListDiv.innerHTML += `
                        <div class="student-item">
                            <span class="student-name">${studentCount}. ${s.name}</span>
                            <div class="attendance-buttons" data-id="${d.id}">
                                <button class="status-btn btn-hadir" onclick="setStatus('${d.id}', 'Hadir', this)">Hadir</button>
                                <button class="status-btn btn-izin" onclick="setStatus('${d.id}', 'Izin', this)">Izin</button>
                                <button class="status-btn btn-absen" onclick="setStatus('${d.id}', 'Absen', this)">Absen</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('attendance-title').innerText = `2. Daftar Hadir - ${kelasName} (${materi})`;
                document.getElementById('step-2').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("Gagal memuat daftar siswa.");
            } finally {
                hideLoading();
            }
        };

        // 3. SET STATUS HADIR
        window.setStatus = (id, status, btnElement) => {
            attendanceData[id].status = status;

            // Reset warna tombol lain di baris yang sama
            const parent = btnElement.parentElement;
            parent.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
            
            // Beri warna tombol yang diklik
            btnElement.classList.add('active');

            checkAllAttended();
        };

        function checkAllAttended() {
            const allChecked = Object.values(attendanceData).every(s => s.status !== null);
            document.getElementById('btn-submit').disabled = !allChecked;
        }

        // 4. SUBMIT PRESENSI & GENERATE PDF
        window.submitPresensi = async () => {
            showLoading("Menyimpan & Membuat Laporan PDF...");
            const materi = document.getElementById('in-materi').value;

            const payload = {
                pengajarUid: currentUser.uid,
                pengajar: currentUser.name,
                kelas: currentClass,
                materi: materi,
                presensi: attendanceData,
                tanggal: new Date().toLocaleDateString('id-ID', { dateStyle: 'full' }),
                createdAt: serverTimestamp()
            };

            try {
                // Simpan ke Firestore
                await addDoc(collection(db, "attendanceRecords"), payload);

                // Tambahkan poin ke Pengajar
                await updateDoc(doc(db, "users", currentUser.uid), {
                    points: increment(5000)
                });

                // Generate PDF Laporan
                generatePDF(payload);

            } catch (error) {
                console.error(error);
                alert("Gagal menyimpan presensi.");
                hideLoading();
            }
        };

        function generatePDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text(`LAPORAN PRESENSI`, 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Mata Pelajaran : Sastra & Penulisan Kreatif`, 15, 35);
            doc.text(`Materi Hari Ini : ${data.materi}`, 15, 42);
            doc.text(`Pengajar       : ${data.pengajar}`, 15, 49);
            doc.text(`Kelas / Tanggal: ${data.kelas} / ${data.tanggal}`, 15, 56);

            const tableColumn = ["No.", "Nama Lengkap Siswa", "Status Kehadiran"];
            const tableRows = [];

            let i = 1;
            Object.values(data.presensi).forEach(siswa => {
                tableRows.push([i++, siswa.name, siswa.status]);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 65,
                theme: 'grid',
                headStyles: { fillColor: [0, 51, 102] } 
            });

            doc.save(`Presensi_${data.kelas}_${new Date().getTime()}.pdf`);
            
            hideLoading();
            alert("Presensi berhasil disimpan dan PDF telah diunduh! Anda mendapatkan 5.000 Poin.");
            window.location.reload(); // Refresh setelah sukses
        }
    </script>
</body>
</html>
