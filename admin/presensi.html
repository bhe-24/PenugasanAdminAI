<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Presensi - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- GLOBAL --- */
        :root { --primary: #003366; --accent: #11998e; --bg: #f4f7f6; --text: #333; --hadir: #28a745; --izin: #ffc107; --absen: #dc3545; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 50px; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* --- HEADER & NAVBAR --- */
        .navbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; border-bottom: 3px solid var(--accent); }
        .navbar h2 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        .nav-links { display: flex; gap: 15px; }

        /* --- BOKS KONTEN --- */
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .card-title { margin-top: 0; color: var(--primary); border-bottom: 2px dashed #eee; padding-bottom: 15px; margin-bottom: 20px; }

        /* --- FORMULIR --- */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 700; margin-bottom: 8px; color: #475569; }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        .form-control:focus { border-color: var(--accent); }

        /* --- DAFTAR SISWA (PRESENSI) --- */
        .student-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 12px; transition: 0.2s; }
        .student-item:hover { background-color: #f8fafc; border-color: #cbd5e1; }
        .student-name { font-weight: 700; font-size: 1.1rem; color: #334155; }
        
        .attendance-buttons { display: flex; gap: 10px; }
        .status-btn { padding: 8px 20px; border-radius: 20px; font-weight: 700; border: 2px solid transparent; cursor: pointer; transition: 0.2s; background: white; font-size: 0.9rem; }
        .status-btn.btn-hadir { border-color: var(--hadir); color: var(--hadir); }
        .status-btn.btn-izin { border-color: var(--warning); color: #d97706; }
        .status-btn.btn-absen { border-color: var(--absen); color: var(--absen); }
        .status-btn.active.btn-hadir { background: var(--hadir); color: white; }
        .status-btn.active.btn-izin { background: var(--warning); color: white; }
        .status-btn.active.btn-absen { background: var(--absen); color: white; }

        /* --- TOMBOL --- */
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;}
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: #002244; transform: translateY(-2px); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-success { background: var(--accent); width: 100%; font-size: 1.1rem; padding: 15px; }
        .btn-success:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }

        /* --- PROFIL & WITHDRAWAL (Dari kode lamamu) --- */
        .profile-header { text-align: center; margin-bottom: 20px; }
        #profile-points { font-size: 3em; font-weight: 700; color: var(--primary); }
        #profile-salary-equivalent { font-size: 1.2em; color: #64748b; margin-top: -10px; margin-bottom: 20px;}
        .archive-item { padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; background: #fff; }
        .withdrawal-summary { background-color: #e0f2fe; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; }
        #form-to-capture { position: absolute; left: -9999px; width: 800px; padding: 40px; background: white; color: black; border: 2px solid black; }

        .hidden { display: none !important; }
        .view-section { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* TABLE PREVIEW */
        .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .preview-table th, .preview-table td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; }
        .preview-table th { background: var(--primary); color: white; }

        @media (max-width: 768px) {
            .student-item { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <h2><i class="fa-solid fa-clipboard-user"></i> Portal Presensi</h2>
        <div class="nav-links">
            <button class="btn btn-secondary" onclick="navigate('setup')"><i class="fa-solid fa-home"></i> Awal</button>
            <button class="btn btn-secondary" onclick="navigate('profil')"><i class="fa-solid fa-user-circle"></i> Profil</button>
        </div>
    </div>

    <div class="container">

        <div id="view-setup" class="view-section hidden">
            <div class="card">
                <h3 class="card-title">1. Persiapan Sesi Mengajar</h3>
                <div class="form-group">
                    <label>Mata Pelajaran</label>
                    <input type="text" id="setup-matkul" class="form-control" placeholder="Contoh: Menulis Cerpen">
                </div>
                <div class="form-group">
                    <label>Pilih Semester</label>
                    <select id="setup-semester" class="form-control">
                        <option value="">-- Pilih Semester Terlebih Dahulu --</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                        <option value="4">Semester 4</option>
                        <option value="5">Semester 5</option>
                        <option value="6">Semester 6</option>
                    </select>
                </div>
                <button id="btn-start-session" class="btn btn-success" disabled onclick="mulaiSesi()">
                    Pilih Semester Dulu
                </button>
            </div>
        </div>

        <div id="view-kelas" class="view-section hidden">
            <div class="card">
                <h3 class="card-title" id="title-kelas">2. Daftar Hadir</h3>
                <div id="student-list-container">
                    </div>
                <button id="btn-next-to-mapel" class="btn btn-success" style="margin-top: 20px;" disabled onclick="saveKelasAndNext()">
                    Lanjutkan ke Detail Materi <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div id="view-mapel" class="view-section hidden">
            <div class="card">
                <h3 class="card-title">3. Laporan Materi & Durasi</h3>
                <div class="form-group">
                    <label>Materi yang Disampaikan</label>
                    <textarea id="mapel-materi" class="form-control" rows="4" placeholder="Jelaskan secara singkat materi hari ini..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Jam Mulai</label>
                        <input type="time" id="mapel-start" class="form-control" onchange="calcDuration()">
                    </div>
                    <div class="form-group">
                        <label>Jam Selesai</label>
                        <input type="time" id="mapel-end" class="form-control" onchange="calcDuration()">
                    </div>
                </div>
                <div id="duration-display" style="background:#e0f2fe; padding:15px; border-radius:8px; font-weight:bold; color:#0369a1; text-align:center; margin-bottom: 20px;">
                    Durasi: Lengkapi jam mulai dan selesai.
                </div>
                <button class="btn btn-success" onclick="saveMapelAndNext()">
                    Lanjutkan ke Pratinjau <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div id="view-preview" class="view-section hidden">
            <div class="card">
                <h3 class="card-title">4. Pratinjau Laporan Presensi</h3>
                <div style="background:#f8fafc; padding:20px; border-radius:8px; margin-bottom:20px; border: 1px solid #e2e8f0;">
                    <p><strong>Mata Pelajaran:</strong> <span id="prev-matkul"></span></p>
                    <p><strong>Semester:</strong> <span id="prev-semester"></span></p>
                    <p><strong>Materi:</strong> <span id="prev-materi"></span></p>
                    <p><strong>Durasi:</strong> <span id="prev-durasi"></span> Menit</p>
                </div>
                
                <table class="preview-table">
                    <thead><tr><th>No.</th><th>Nama Siswa</th><th>Status</th></tr></thead>
                    <tbody id="prev-table-body"></tbody>
                </table>

                <button class="btn btn-success" onclick="submitFinal()">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Simpan Data & Unduh PDF
                </button>
            </div>
        </div>

        <div id="view-profil" class="view-section hidden">
            <div class="card">
                <div class="profile-header">
                    <i class="fas fa-user-circle" style="font-size: 5em; color: var(--primary);"></i>
                    <h2 id="profile-name" style="margin-bottom: 5px;">Memuat...</h2>
                    <p>Total Poin Anda</p>
                    <div id="profile-points">0</div>
                    <p id="profile-salary-equivalent">(Rp 0)</p>
                </div>
                <div id="withdrawal-container"></div>
                <h3 class="card-title" style="margin-top: 40px;"><i class="fas fa-archive"></i> Arsip Mengajar</h3>
                <div id="teacher-archive-list"></div>
            </div>
        </div>

    </div>

    <div id="loading-overlay" class="hidden">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 4rem; color: var(--primary);"></i>
        <h3 id="loading-text" style="color:var(--primary); margin-top:15px;">Memproses...</h3>
    </div>

    <div id="form-to-capture">
        <h2 style="text-align:center; font-size:24px; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;">FORMULIR PENARIKAN GAJI<br><span style="font-size: 16px; font-weight: normal;">Cendekia Aksara</span></h2>
        <p><strong>Tanggal Pengajuan:</strong> <span id="capture-date"></span></p>
        <p><strong>Nama Pengajar:</strong> <span id="capture-name"></span></p>
        <p><strong>Email:</strong> <span id="capture-email"></span></p>
        <div style="border-top: 1px solid #ccc; padding-top: 15px; margin-top: 15px;">
            <p><strong>Jumlah Penarikan (Poin):</strong> <span id="capture-points"></span></p>
            <p><strong>Jumlah Penarikan (Rupiah):</strong> <span id="capture-rupiah"></span></p>
        </div>
        <div style="border-top: 1px solid #ccc; padding-top: 15px; margin-top: 15px;">
            <p><strong>Nama Bank Tujuan:</strong> <span id="capture-bank"></span></p>
            <p><strong>Nomor Rekening:</strong> <span id="capture-account"></span></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
            authDomain: "mading-cf676.firebaseapp.com", 
            projectId: "mading-cf676", 
            storageBucket: "mading-cf676.firebasestorage.app", 
            messagingSenderId: "72175203671", 
            appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        const showLoading = (msg) => { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').classList.remove('hidden'); };
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        // ==========================================
        // SISTEM ROUTER MODERN (MULTI-PAGE DI 1 FILE)
        // ==========================================
        window.navigate = (page, id = null) => {
            let url = `?page=${page}`;
            if (id) url += `&id=${id}`;
            window.history.pushState({ page, id }, "", url);
            renderPage(page, id);
        };

        window.onpopstate = (e) => {
            if (e.state) renderPage(e.state.page, e.state.id);
            else renderPage('setup', null);
        };

        function renderPage(page, id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const viewEl = document.getElementById(`view-${page}`);
            if(viewEl) viewEl.classList.remove('hidden');

            if (page === 'kelas') loadKelasData(id);
            if (page === 'preview') loadPreviewData(id);
            if (page === 'profil') loadTeacherProfile();
        }

        // ==========================================
        // INIT & AUTH
        // ==========================================
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                await signInAnonymously(auth);
            } else {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if(userDoc.exists()) {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                    
                    // Cek URL saat pertama kali load
                    const urlParams = new URLSearchParams(window.location.search);
                    const initialPage = urlParams.get('page') || 'setup';
                    const initialId = urlParams.get('id');
                    renderPage(initialPage, initialId);
                }
            }
        });

        // ==========================================
        // VIEW 1: SETUP
        // ==========================================
        document.getElementById('setup-semester').addEventListener('change', (e) => {
            const val = e.target.value;
            const btn = document.getElementById('btn-start-session');
            if (val) {
                btn.innerHTML = `Mulai Presensi Semester ${val} <i class="fa-solid fa-arrow-right"></i>`;
                btn.disabled = false;
            } else {
                btn.innerHTML = `Pilih Semester Dulu`;
                btn.disabled = true;
            }
        });

        window.mulaiSesi = () => {
            const matkul = document.getElementById('setup-matkul').value;
            const semester = parseInt(document.getElementById('setup-semester').value);
            if(!matkul) return alert("Isi Mata Pelajaran!");

            const sessionId = "S-" + Date.now().toString(36).toUpperCase();
            const data = {
                id: sessionId, matkul, semester, pengajar: currentUser.name, pengajarUid: currentUser.uid,
                presensi: {}, materi: '', jamMulai: '', jamSelesai: '', durasi: 0
            };
            sessionStorage.setItem('presensi_' + sessionId, JSON.stringify(data));
            navigate('kelas', sessionId); // Pindah ke URL /presensi.html?page=kelas&id=S-XYZ
        };

        // ==========================================
        // VIEW 2: KELAS (ABSENSI)
        // ==========================================
        async function loadKelasData(sessionId) {
            const data = JSON.parse(sessionStorage.getItem('presensi_' + sessionId));
            if(!data) return navigate('setup');

            document.getElementById('title-kelas').innerText = `2. Daftar Hadir - Semester ${data.semester}`;
            const listDiv = document.getElementById('student-list-container');
            
            showLoading("Memuat data anak-anak...");
            try {
                const q = query(collection(db, 'users'), where('role', '==', 'siswa'));
                const snap = await getDocs(q);
                
                listDiv.innerHTML = '';
                let count = 0;

                snap.forEach(d => {
                    const s = d.data();
                    // Filter berdasarkan semester siswa
                    if(s.status !== 'suspended' && parseInt(s.semester || 1) === data.semester) {
                        count++;
                        if(!data.presensi[d.id]) data.presensi[d.id] = { name: s.name, status: null };

                        const status = data.presensi[d.id].status;
                        listDiv.innerHTML += `
                            <div class="student-item">
                                <span class="student-name">${count}. ${s.name}</span>
                                <div class="attendance-buttons" data-id="${d.id}">
                                    <button class="status-btn btn-hadir ${status==='Hadir'?'active':''}" onclick="setStatus('${sessionId}', '${d.id}', 'Hadir', this)">Hadir</button>
                                    <button class="status-btn btn-izin ${status==='Izin'?'active':''}" onclick="setStatus('${sessionId}', '${d.id}', 'Izin', this)">Izin</button>
                                    <button class="status-btn btn-absen ${status==='Absen'?'active':''}" onclick="setStatus('${sessionId}', '${d.id}', 'Absen', this)">Absen</button>
                                </div>
                            </div>
                        `;
                    }
                });

                if(count === 0) listDiv.innerHTML = "<p>Tidak ada siswa aktif di semester ini.</p>";
                
                sessionStorage.setItem('presensi_' + sessionId, JSON.stringify(data));
                checkAllAttended(sessionId);
            } catch(e) {
                console.error(e);
            } finally { hideLoading(); }
        }

        window.setStatus = (sessionId, studentId, status, btnEl) => {
            const data = JSON.parse(sessionStorage.getItem('presensi_' + sessionId));
            data.presensi[studentId].status = status;
            sessionStorage.setItem('presensi_' + sessionId, JSON.stringify(data));

            btnEl.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
            btnEl.classList.add('active');
            checkAllAttended(sessionId);
        };

        function checkAllAttended(sessionId) {
            const data = JSON.parse(sessionStorage.getItem('presensi_' + sessionId));
            const allChecked = Object.values(data.presensi).every(s => s.status !== null);
            document.getElementById('btn-next-to-mapel').disabled = !allChecked;
        }

        window.saveKelasAndNext = () => {
            const urlParams = new URLSearchParams(window.location.search);
            navigate('mapel', urlParams.get('id'));
        };

        // ==========================================
        // VIEW 3: MAPEL
        // ==========================================
        window.calcDuration = () => {
            const start = document.getElementById('mapel-start').value;
            const end = document.getElementById('mapel-end').value;
            const display = document.getElementById('duration-display');
            
            if (start && end) {
                const s = new Date(`1970-01-01T${start}`);
                const e = new Date(`1970-01-01T${end}`);
                if (e > s) {
                    const mins = Math.round((e - s) / 60000);
                    display.innerText = `Durasi kelas: ${mins} Menit`;
                    return mins;
                } else {
                    display.innerText = "Jam selesai salah!";
                    return null;
                }
            }
            return null;
        };

        window.saveMapelAndNext = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('id');
            const data = JSON.parse(sessionStorage.getItem('presensi_' + sessionId));
            
            data.materi = document.getElementById('mapel-materi').value;
            data.jamMulai = document.getElementById('mapel-start').value;
            data.jamSelesai = document.getElementById('mapel-end').value;
            data.durasi = calcDuration();

            if(!data.materi || !data.durasi) return alert("Lengkapi data materi dan jam mengajar!");

            sessionStorage.setItem('presensi_' + sessionId, JSON.stringify(data));
            navigate('preview', sessionId);
        };

        // ==========================================
        // VIEW 4: PREVIEW & SUBMIT
        // ==========================================
        function loadPreviewData(sessionId) {
            const data = JSON.parse(sessionStorage.getItem('presensi_' + sessionId));
            document.getElementById('prev-matkul').innerText = data.matkul;
            document.getElementById('prev-semester').innerText = data.semester;
            document.getElementById('prev-materi').innerText = data.materi;
            document.getElementById('prev-durasi').innerText = data.durasi;

            const tbody = document.getElementById('prev-table-body');
            tbody.innerHTML = '';
            let i = 1;
            Object.values(data.presensi).sort((a,b)=>a.name.localeCompare(b.name)).forEach(s => {
                tbody.innerHTML += `<tr><td>${i++}</td><td>${s.name}</td><td><strong>${s.status}</strong></td></tr>`;
            });
        }

        window.submitFinal = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('id');
            const payload = JSON.parse(sessionStorage.getItem('presensi_' + sessionId));
            
            showLoading("Menyimpan ke Database...");
            
            try {
                // 1. Simpan ke attendanceRecords (Untuk bisa dibaca di kontrol admin/arsip)
                payload.createdAt = serverTimestamp();
                payload.tanggal = new Date().toLocaleDateString('id-ID', { dateStyle: 'full' });
                await addDoc(collection(db, "attendanceRecords"), payload);

                // 2. Tambah 5000 poin ke Pengajar
                await updateDoc(doc(db, "users", currentUser.uid), {
                    points: increment(5000)
                });

                // 3. Download PDF
                generatePDF(payload);

                // 4. Selesai
                sessionStorage.removeItem('presensi_' + sessionId);
                hideLoading();
                alert("Hore! ðŸŽ‰ Anda mendapatkan 5.000 Poin!");
                navigate('profil'); // Pindah ke profil melihat gaji

            } catch(e) {
                console.error(e);
                alert("Gagal menyimpan data.");
                hideLoading();
            }
        };

        function generatePDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18); doc.text(`LAPORAN PRESENSI SMT ${data.semester}`, 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Mata Pelajaran : ${data.matkul}`, 15, 35);
            doc.text(`Materi         : ${data.materi}`, 15, 42);
            doc.text(`Pengajar       : ${data.pengajar}`, 15, 49);
            doc.text(`Tanggal / Durasi: ${data.tanggal} / ${data.durasi} Menit`, 15, 56);

            const tableRows = [];
            let i = 1;
            Object.values(data.presensi).sort((a,b)=>a.name.localeCompare(b.name)).forEach(s => {
                tableRows.push([i++, s.name, s.status]);
            });

            doc.autoTable({ head: [["No.", "Nama Siswa", "Status"]], body: tableRows, startY: 65, headStyles: { fillColor: [0, 51, 102] } });
            doc.save(`Presensi_Smt${data.semester}_${new Date().getTime()}.pdf`);
        }

        // ==========================================
        // VIEW 5: PROFIL & GAJI
        // ==========================================
        async function loadTeacherProfile() {
            showLoading("Memuat profil...");
            try {
                const userRef = doc(db, "users", currentUser.uid);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const userPoints = userData.points || 0;

                document.getElementById('profile-name').textContent = userData.name;
                document.getElementById('profile-points').textContent = userPoints.toLocaleString('id-ID');
                document.getElementById('profile-salary-equivalent').textContent = `(Rp ${userPoints.toLocaleString('id-ID')})`;

                const wdContainer = document.getElementById('withdrawal-container');
                if (userPoints >= 30000) {
                    wdContainer.innerHTML = `
                        <div class="withdrawal-summary">
                            <p>Saldo Mencukupi untuk Penarikan</p>
                            <button id="btn-wd" class="btn btn-success" style="margin-top:10px;"><i class="fas fa-wallet"></i> Tarik Gaji Sekarang</button>
                        </div>
                    `;
                    document.getElementById('btn-wd').onclick = () => showWithdrawal(userPoints);
                } else {
                    wdContainer.innerHTML = `<p style="text-align:center; color:#64748b;">Kumpulkan minimal 30.000 poin untuk dapat menarik gaji.</p>`;
                }

                // Arsip
                const recordsRef = collection(db, "attendanceRecords");
                const q = query(recordsRef, where("pengajarUid", "==", currentUser.uid));
                const snap = await getDocs(q);
                
                const list = document.getElementById('teacher-archive-list');
                list.innerHTML = '';
                if(snap.empty) list.innerHTML = "<p style='text-align:center'>Belum ada riwayat mengajar.</p>";
                
                snap.forEach(d => {
                    const r = d.data();
                    const date = r.createdAt ? r.createdAt.toDate().toLocaleDateString('id-ID') : r.tanggal;
                    list.innerHTML += `
                        <div class="archive-item">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${r.matkul} - Sem ${r.semester}</strong>
                                <span>${date}</span>
                            </div>
                            <p style="margin:5px 0 0 0; color:#666; font-size:0.9rem;">Materi: ${r.materi}</p>
                        </div>
                    `;
                });

            } catch (e) { console.error(e); } 
            finally { hideLoading(); }
        }

        // Fitur penarikan Gaji (Membangkitkan gambar)
        function showWithdrawal(points) {
            document.getElementById('capture-name').textContent = currentUser.name;
            document.getElementById('capture-email').textContent = currentUser.email;
            document.getElementById('capture-points').textContent = points.toLocaleString('id-ID');
            document.getElementById('capture-rupiah').textContent = `Rp ${points.toLocaleString('id-ID')}`;
            document.getElementById('capture-bank').textContent = prompt("Masukkan Nama Bank (BCA/BRI/dsb):", "BCA");
            document.getElementById('capture-account').textContent = prompt("Masukkan Nomor Rekening:", "");
            document.getElementById('capture-date').textContent = new Date().toLocaleDateString('id-ID', { dateStyle: 'full' });

            html2canvas(document.getElementById('form-to-capture'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.download = `Formulir_Gaji_${currentUser.name}.jpeg`;
                link.click();
                
                alert("Bukti formulir gaji telah diunduh. Silakan kirimkan ke Admin.");
                // Update ke 0 Poin
                updateDoc(doc(db, "users", currentUser.uid), { points: 0 }).then(() => loadTeacherProfile());
            });
        }
    </script>
</body>
</html>
