<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan Pusat - Admin</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --primary: #003366; --accent: #4361ee; --bg: #f4f7fe; }
        body { background-color: var(--bg); font-family: 'Outfit', sans-serif; color: #333; margin: 0; padding-bottom: 50px; }
        .container { max-width: 1400px; width: 95%; margin: 0 auto; padding: 25px; }

        /* HEADER */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 25px 35px; border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 30px;
        }
        .ph-left h2 { margin: 0; color: var(--primary); font-size: 1.6rem; }
        
        .btn { padding: 12px 20px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; transition: 0.2s; font-size: 0.9rem; }
        .btn-dash { background: #f1f5f9; color: #334155; }
        .btn-dash:hover { background: #e2e8f0; }

        /* SIKLUS PANEL */
        .cycle-panel {
            background: #fff; padding: 20px; border-radius: 16px; margin-bottom: 25px;
            border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .cycle-status { font-weight: bold; padding: 5px 12px; border-radius: 50px; font-size: 0.85rem; }
        .st-open { background: #dcfce7; color: #166534; }
        .st-closed { background: #fee2e2; color: #991b1b; }

        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* TABS */
        .tab-menu { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .tab-item { padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; color: #64748b; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .tab-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3); }
        .badge-count { background: #ef4444; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 20px; }

        .content-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); min-height: 400px; }
        .hidden { display: none !important; }

        /* CARD VERIFIKASI */
        .req-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
        .req-card { border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; background: #fff; transition: 0.2s; position: relative; overflow: hidden; }
        .req-card:hover { border-color: var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .req-card::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 5px; background: #f59e0b; }
        
        .req-amount { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .req-desc { font-size: 0.85rem; color: #64748b; margin-bottom: 15px; display: flex; align-items: center; gap: 5px; }

        /* BUTTONS VERIFIKASI */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-act { padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; font-size: 0.85rem; }
        
        .bg-green { background: #10b981; } /* Lunas */
        .bg-yellow { background: #f59e0b; color: white; } /* Cicil */
        .bg-red { background: #ef4444; } /* Tolak */
        .full-width { grid-column: 1 / -1; }

        /* TABLE */
        .archive-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .archive-table th { text-align: left; padding: 15px; background: #f8fafc; color: #475569; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        .archive-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: #334155; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-mod { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        .mod-yes { background: var(--primary); color: white; }
        .mod-no { background: #f1f5f9; color: #475569; }

        /* PDF */
        #pdf-template { display: none; padding: 40px; background: white; font-family: sans-serif; }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <div class="ph-left">
                <h2><i class="fa-solid fa-wallet"></i> Keuangan Pusat</h2>
                <p>Verifikasi pembayaran & laporan keuangan.</p>
            </div>
            <a href="../index.html" class="btn btn-dash"><i class="fa-solid fa-house"></i> Dashboard</a>
        </div>

        <div class="cycle-panel">
            <div>
                <h4><i class="fa-solid fa-rotate"></i> Siklus Pembayaran</h4>
                <div id="cycle-badge" class="cycle-status st-closed">Sistem Tertutup</div>
                <p style="font-size:0.85rem; color:#666; margin-top:5px;">Tutup untuk mereset tagihan semua siswa.</p>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="cycle-toggle" onchange="toggleCycle(this)">
                <span class="slider"></span>
            </label>
        </div>

        <div class="tab-menu">
            <div class="tab-item active" onclick="switchTab('verif')">
                <i class="fa-solid fa-hourglass-half"></i> Verifikasi Masuk
                <span id="badge-waiting" class="badge-count hidden">0</span>
            </div>
            <div class="tab-item" onclick="switchTab('arsip')">
                <i class="fa-solid fa-box-archive"></i> Arsip Pemasukan
            </div>
            <div class="tab-item" style="margin-left: auto;" onclick="loadRequests()">
                <i class="fa-solid fa-sync"></i> Refresh
            </div>
        </div>

        <div id="tab-verif" class="content-card">
            <div id="loading-verif" style="text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
            <div id="list-request" class="req-grid"></div>
            <div id="empty-verif" class="hidden" style="text-align:center; padding:50px; color:#94a3b8;">
                <i class="fa-solid fa-check-circle" style="font-size:4rem; opacity:0.3; margin-bottom:10px;"></i>
                <h3>Semua Bersih!</h3>
                <p>Tidak ada pembayaran yang menunggu konfirmasi.</p>
            </div>
        </div>

        <div id="tab-arsip" class="content-card hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">Riwayat Pemasukan</h3>
                <div style="display:flex; gap:10px;">
                    <button onclick="downloadReport('ujian')" class="btn" style="background:#e0f2fe; color:#0284c7;"><i class="fa-solid fa-file-pdf"></i> Laporan Ujian</button>
                    <button onclick="downloadReport('spp')" class="btn" style="background:#f3e8ff; color:#7c3aed;"><i class="fa-solid fa-file-pdf"></i> Laporan SPP</button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table class="archive-table">
                    <thead><tr><th>Tanggal</th><th>Nama Siswa</th><th>Jenis</th><th>Nominal</th><th>Admin</th></tr></thead>
                    <tbody id="archive-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-icon" class="modal-icon"></div>
            <h3 id="modal-title" class="modal-title"></h3>
            <p id="modal-msg" class="modal-msg"></p>
            <div id="modal-actions" class="modal-btns"></div>
        </div>
    </div>

    <div id="pdf-template">
        <h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">LAPORAN KEUANGAN</h2>
        <p>Dicetak: <span id="pdf-date"></span></p>
        <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse:collapse; margin-top:15px;">
            <thead style="background:#eee;"><tr><th>No</th><th>Tanggal</th><th>Nama</th><th>Ket</th><th>Nominal</th></tr></thead>
            <tbody id="pdf-body"></tbody>
            <tfoot><tr><td colspan="4" align="right"><strong>TOTAL</strong></td><td id="pdf-total"></td></tr></tfoot>
        </table>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { collection, query, where, getDocs, updateDoc, doc, addDoc, serverTimestamp, orderBy, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentAdmin = null;
        let activeExamsCount = 0;

        (async () => {
            currentAdmin = await checkAuth('pengajar');
            if(!currentAdmin) window.location.href = '../index.html';

            const examSnap = await getDocs(query(collection(db, 'exams'), where('status', '==', 'active')));
            activeExamsCount = examSnap.size;

            loadCycleStatus();
            loadRequests();
            loadArchive();
        })();

        // --- CORE: MODAL ---
        function showModal(type, title, msg, onYes, onNo) {
            const overlay = document.getElementById('custom-modal');
            const icon = document.getElementById('modal-icon');
            const actions = document.getElementById('modal-actions');
            
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            
            icon.innerHTML = type === 'success' ? 'ðŸŽ‰' : type === 'warning' ? 'âš ï¸' : type === 'loading' ? 'â³' : 'â“';
            actions.innerHTML = '';

            if (type === 'loading') {
                // No buttons
            } else if (onYes) {
                const btnYes = document.createElement('button');
                btnYes.className = 'btn-mod mod-yes'; btnYes.innerText = 'Ya';
                btnYes.onclick = () => { if(type !== 'loading') overlay.classList.remove('active'); onYes(); };
                
                const btnNo = document.createElement('button');
                btnNo.className = 'btn-mod mod-no'; btnNo.innerText = 'Batal';
                btnNo.onclick = () => { overlay.classList.remove('active'); if(onNo) onNo(); };
                
                actions.append(btnNo, btnYes);
            } else {
                const btnOk = document.createElement('button');
                btnOk.className = 'btn-mod mod-yes'; btnOk.innerText = 'Tutup';
                btnOk.onclick = () => overlay.classList.remove('active');
                actions.appendChild(btnOk);
            }
            overlay.classList.add('active');
        }

        // --- FITUR 1: VERIFIKASI (LOGIC FIX UNTUK CICILAN) ---
        window.loadRequests = async () => {
            const container = document.getElementById('list-request');
            const loading = document.getElementById('loading-verif');
            
            loading.classList.remove('hidden');
            container.innerHTML = ''; 

            try {
                const q = query(collection(db, 'users'), where('paymentStatus', '==', 'waiting'));
                const snap = await getDocs(q);

                loading.classList.add('hidden');
                document.getElementById('badge-waiting').innerText = snap.size;
                document.getElementById('badge-waiting').classList.toggle('hidden', snap.size === 0);

                if(snap.empty) {
                    document.getElementById('empty-verif').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-verif').classList.add('hidden');

                snap.forEach(d => {
                    try {
                        const u = d.data();
                        const safeName = u.name || "Tanpa Nama";
                        const shortUid = (u.uid || "ERR").substring(0,5);
                        const sem = parseInt(String(u.semester || "1").replace(/\D/g, '') || 1);
                        
                        // LOGIC TOMBOL DINAMIS
                        let buttonsHtml = '';
                        let amountDisplay = '';
                        let desc = '';

                        // Case 1: Semester 1 & 2 (Uang Ujian)
                        if (sem < 3) {
                            const nominal = (activeExamsCount || 0) * 1000;
                            amountDisplay = `Rp ${nominal.toLocaleString()}`;
                            desc = `Ujian (${activeExamsCount} Mapel)`;
                            buttonsHtml = `
                                <button onclick="actReject('${d.id}')" class="btn-act bg-red">Tolak</button>
                                <button onclick="actApprove('${d.id}', '${safeName}', ${nominal}, 'Ujian', ${sem}, 'Lunas')" class="btn-act bg-green">Terima Lunas</button>
                            `;
                        } 
                        // Case 2: Semester 3+ (SPP)
                        else {
                            if (u.statusPembayaran === 'Belum') {
                                // SPP Baru: Bisa Full atau Cicil
                                amountDisplay = "Opsi Pembayaran";
                                desc = "SPP / Administrasi";
                                buttonsHtml = `
                                    <button onclick="actApprove('${d.id}', '${safeName}', 37725, 'SPP', ${sem}, 'Cicilan')" class="btn-act bg-yellow">Verif Cicilan (37rb)</button>
                                    <button onclick="actApprove('${d.id}', '${safeName}', 75450, 'SPP', ${sem}, 'Lunas')" class="btn-act bg-green">Verif Lunas (75rb)</button>
                                    <button onclick="actReject('${d.id}')" class="btn-act bg-red full-width">Tolak Semua</button>
                                `;
                            } else if (u.statusPembayaran === 'Cicilan') {
                                // Pelunasan Sisa
                                const nominal = 37725;
                                amountDisplay = `Rp ${nominal.toLocaleString()}`;
                                desc = "Pelunasan Sisa Cicilan";
                                buttonsHtml = `
                                    <button onclick="actReject('${d.id}')" class="btn-act bg-red">Tolak</button>
                                    <button onclick="actApprove('${d.id}', '${safeName}', ${nominal}, 'SPP', ${sem}, 'Lunas')" class="btn-act bg-green">Terima Pelunasan</button>
                                `;
                            }
                        }

                        container.innerHTML += `
                            <div class="req-card">
                                <div class="req-head">
                                    <div><div class="req-name">${safeName}</div><div class="req-id">Sem ${sem} | ID: ${shortUid}</div></div>
                                    <div class="req-tag">Menunggu</div>
                                </div>
                                <div class="req-desc"><i class="fa-solid fa-receipt"></i> ${desc}</div>
                                <div class="req-amount">${amountDisplay}</div>
                                <div class="btn-group">
                                    ${buttonsHtml}
                                </div>
                            </div>
                        `;
                    } catch (err) { console.error("Skip user:", err); }
                });
            } catch(e) { console.error(e); }
        }

        // Action Approve (Updated with newStatus)
        window.actApprove = (uid, name, amount, type, sem, newStatus) => {
            const msg = newStatus === 'Cicilan' 
                ? `Konfirmasi pembayaran CICILAN Rp ${amount.toLocaleString()}?` 
                : `Konfirmasi pembayaran LUNAS Rp ${amount.toLocaleString()}?`;

            showModal('confirm', 'Konfirmasi Terima', msg, async () => {
                showModal('loading', 'Menyimpan', 'Sedang memproses...');
                try {
                    // 1. Update Status User (Sesuai tombol yg diklik admin)
                    await updateDoc(doc(db, 'users', uid), {
                        statusPembayaran: newStatus, // 'Cicilan' atau 'Lunas'
                        paymentStatus: 'verified'    // Clear waiting
                    });

                    // 2. Arsip
                    await addDoc(collection(db, 'finance_logs'), {
                        studentName: name, studentUid: uid, type: type, amount: amount, semester: sem,
                        status: newStatus, adminName: currentAdmin.name, timestamp: serverTimestamp()
                    });

                    document.getElementById('custom-modal').classList.remove('active');
                    loadRequests();
                    loadArchive();
                    
                } catch(e) { showModal('error', 'Gagal', e.message); }
            });
        }

        window.actReject = (uid) => {
            showModal('confirm', 'Tolak?', 'Status siswa akan kembali ke Belum Bayar.', async () => {
                await updateDoc(doc(db, 'users', uid), { paymentStatus: 'rejected' });
                document.getElementById('custom-modal').classList.remove('active');
                loadRequests();
            });
        }

        // --- FITUR 2: ARSIP ---
        async function loadArchive() {
            const tbody = document.getElementById('archive-body');
            const q = query(collection(db, 'finance_logs'), orderBy('timestamp', 'desc'));
            const snap = await getDocs(q);
            
            if(snap.empty) return tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Belum ada riwayat.</td></tr>';
            
            tbody.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                const date = data.timestamp ? new Date(data.timestamp.seconds*1000).toLocaleDateString('id-ID') : '-';
                tbody.innerHTML += `
                    <tr>
                        <td>${date}</td><td>${data.studentName}<br><small style="color:#999">${data.status || 'Lunas'}</small></td>
                        <td style="color:${data.type==='Ujian'?'#0284c7':'#7c3aed'}">${data.type}</td>
                        <td style="font-weight:bold;">Rp ${data.amount.toLocaleString('id-ID')}</td>
                        <td>${data.adminName}</td>
                    </tr>`;
            });
        }

        // --- FITUR 3: SIKLUS ---
        async function loadCycleStatus() {
            try {
                const snap = await getDoc(doc(db, 'settings', 'finance'));
                const isOpen = snap.exists() ? snap.data().isOpen : false;
                document.getElementById('cycle-toggle').checked = isOpen;
                updateCycleUI(isOpen);
            } catch(e) {}
        }

        window.toggleCycle = (el) => {
            if (!el.checked) {
                showModal('warning', 'Tutup & Reset?', 'SEMUA status siswa akan di-reset jadi BELUM BAYAR. Lanjutkan?', 
                    async () => {
                        showModal('loading', 'Resetting...', 'Mereset data...');
                        await setDoc(doc(db, 'settings', 'finance'), { isOpen: false }, { merge: true });
                        const q = query(collection(db, 'users'), where('role', '==', 'siswa'));
                        const snap = await getDocs(q);
                        const batch = writeBatch(db);
                        snap.forEach(d => batch.update(doc(db, 'users', d.id), { statusPembayaran: 'Belum', paymentStatus: null }));
                        await batch.commit();
                        document.getElementById('custom-modal').classList.remove('active');
                        updateCycleUI(false);
                        loadRequests();
                        showModal('success', 'Selesai', 'Siklus ditutup & data di-reset.');
                    },
                    () => { el.checked = true; }
                );
            } else {
                setDoc(doc(db, 'settings', 'finance'), { isOpen: true }, { merge: true });
                updateCycleUI(true);
            }
        }

        function updateCycleUI(isOpen) {
            const badge = document.getElementById('cycle-badge');
            if(isOpen) { badge.className = 'cycle-status st-open'; badge.innerText = "Pembayaran DIBUKA"; }
            else { badge.className = 'cycle-status st-closed'; badge.innerText = "Pembayaran DITUTUP"; }
        }

        // --- PDF ---
        window.downloadReport = async (filterType) => {
            const title = filterType === 'ujian' ? 'LAPORAN UJIAN' : 'LAPORAN SPP';
            const key = filterType === 'ujian' ? 'Ujian' : 'SPP';
            const q = query(collection(db, 'finance_logs'), where('type', '==', key));
            const snap = await getDocs(q);

            if(snap.empty) return showModal('warning', 'Kosong', 'Tidak ada data.');

            let html = ''; let total = 0; let no = 1;
            snap.forEach(d => {
                const x = d.data();
                const date = x.timestamp ? new Date(x.timestamp.seconds*1000).toLocaleDateString('id-ID') : '-';
                html += `<tr><td>${no++}</td><td>${date}</td><td>${x.studentName} (${x.status||'Lunas'})</td><td>${x.type}</td><td align="right">Rp ${x.amount.toLocaleString()}</td></tr>`;
                total += x.amount;
            });

            document.getElementById('pdf-date').innerText = new Date().toLocaleDateString('id-ID');
            document.getElementById('pdf-body').innerHTML = html;
            document.getElementById('pdf-total').innerText = "Rp " + total.toLocaleString('id-ID');

            const elem = document.getElementById('pdf-template');
            elem.style.display = 'block';
            html2pdf().from(elem).save(`${title}.pdf`).then(() => elem.style.display='none');
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content-card').forEach(el => el.classList.add('hidden'));
            if(tab === 'verif') { document.querySelector('.tab-item:nth-child(1)').classList.add('active'); document.getElementById('tab-verif').classList.remove('hidden'); }
            else { document.querySelector('.tab-item:nth-child(2)').classList.add('active'); document.getElementById('tab-arsip').classList.remove('hidden'); }
        }
        window.loadRequests = loadRequests;
    </script>
</body>
</html>
