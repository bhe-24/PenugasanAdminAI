<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Penilaian Tugas Otomatis</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* --- CSS RESET & GLOBAL --- */
        :root { --primary-color: #003366; --primary-light: #005a9c; --accent-color: #28a745; --bg-color: #f4f7f6; --text-color: #333; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; color: var(--text-color); padding-bottom: 50px; }
        
        /* DIPERLEBAR UNTUK LAPTOP */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* HEADER */
        .page-header { background: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-left: 6px solid var(--primary-color); }
        .page-header h2 { margin: 0; color: var(--primary-color); font-size: 1.6rem; display: flex; align-items: center; gap: 10px; }

        /* DROPDOWN */
        .select-container { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-control { width: 100%; max-width: 500px; padding: 12px 15px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; cursor: pointer; }
        .form-control:focus { border-color: var(--primary-light); }

        /* GRID LAYOUT UNTUK KARTU (SEJAJAR DI LAPTOP) */
        #list-jawaban {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(480px, 1fr));
            gap: 25px;
            align-items: start;
        }

        /* CARD */
        .grading-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .card-header { background: var(--primary-color); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { margin: 0; font-size: 1.15rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 25px; display: flex; flex-direction: column; flex: 1; }

        .tag { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: white; }
        .tag-green { background-color: var(--accent-color); }
        .tag-blue { background-color: var(--primary-light); border: 1px solid #bae6fd; }

        /* TEXT PREVIEW DENGAN TOGGLE */
        .text-wrapper { position: relative; margin-bottom: 20px; }
        .answer-box { 
            background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; 
            color: #334155; line-height: 1.6; white-space: pre-wrap; 
            max-height: 120px; overflow: hidden; position: relative; transition: max-height 0.3s ease;
        }
        .answer-box.expanded { max-height: 1000px; overflow-y: auto; }
        .answer-box::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 50px; background: linear-gradient(transparent, #f8fafc); pointer-events: none; transition: opacity 0.3s; }
        .answer-box.expanded::after { opacity: 0; }
        
        .toggle-btn { background: none; border: none; color: var(--primary-light); font-weight: 700; cursor: pointer; padding: 5px 0; font-size: 0.9rem; margin-top: 5px; display: inline-flex; align-items: center; gap: 5px; }
        .toggle-btn:hover { text-decoration: underline; }
        
        /* FORM PENILAIAN & AI TOOLS */
        .grading-form { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; gap: 20px; margin-top: auto; }
        
        .ai-tools { background: #e0f2fe; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .btn-ai { background: #0284c7; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .btn-ai:hover { background: #0369a1; }
        .btn-ai:disabled { background: #7dd3fc; cursor: not-allowed; }

        .form-row-score { display: flex; align-items: center; gap: 15px; }
        .score-input { width: 90px; text-align: center; font-size: 1.5rem; font-weight: bold; padding: 10px; border: 2px solid #ccc; border-radius: 8px; color: var(--primary-color); }
        .score-input:focus { border-color: var(--primary-light); }

        /* RICH FEEDBACK (CONTENTEDITABLE) */
        .rich-feedback { 
            width: 100%; min-height: 120px; padding: 15px; border: 2px solid #ccc; 
            border-radius: 8px; background: #fff; font-family: inherit; 
            line-height: 1.6; transition: 0.3s; overflow-y: auto; max-height: 300px;
        }
        .rich-feedback:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.1); }
        .rich-feedback[placeholder]:empty:before { content: attr(placeholder); color: #999; pointer-events: none; display: block; /* For Firefox */ }

        /* BUTTONS */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;}
        .btn-secondary { background: #f1f5f9; color: #334155; }
        .btn-secondary:hover { background: #e2e8f0; }
        
        .btn-save { background: var(--accent-color); width: 100%; padding: 15px; font-size: 1.05rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); }
        .btn-save:hover { background: #218838; transform: translateY(-2px); }
        .btn-save:disabled { background: #94d3a2; cursor: not-allowed; transform: none; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            #list-jawaban { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; text-align: center; }
            .ai-tools { flex-direction: column; text-align: center; }
            .btn-ai { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <h2><i class="fa-solid fa-marker"></i> Penilaian Tugas Otomatis</h2>
            <a href="index.html" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
        </div>

        <div class="select-container">
            <label style="font-weight: 700; display: block; margin-bottom: 12px; color: #334155; font-size: 1.1rem;">Pilih Tugas:</label>
            <select id="tugas-select" class="form-control">
                <option value="">-- Memuat Daftar Tugas... --</option>
            </select>
        </div>
        
        <div id="list-jawaban">
            <div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 80px 20px; background: white; border-radius: 16px; border: 2px dashed #cbd5e1;">
                <i class="fa-solid fa-clipboard-check" style="font-size: 4rem; margin-bottom: 20px; color: #e2e8f0;"></i>
                <h3 style="margin: 0; color: #64748b;">Belum ada tugas yang dipilih</h3>
                <p>Silakan pilih tugas pada menu dropdown di atas.</p>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; color: #003366;"></i>
        <p style="margin-top: 20px; font-weight: 600;" id="loading-text">Memproses...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, getDocs, getDoc, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
            authDomain: "mading-cf676.firebaseapp.com", 
            projectId: "mading-cf676", 
            storageBucket: "mading-cf676.firebasestorage.app", 
            messagingSenderId: "72175203671", 
            appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // PATH RELATIF KE VERCEL
        const VERCEL_API_URL = "/api/grade2"; 

        const showLoading = (msg) => { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').classList.remove('hidden'); };
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');
        
        let currentAssignmentData = null;

        // 1. INIT
        onAuthStateChanged(auth, async (user) => {
            if (!user) await signInAnonymously(auth);
            loadDropdown();
        });

        // 2. LOAD DROPDOWN TUGAS
        async function loadDropdown() {
            const sel = document.getElementById('tugas-select');
            try {
                const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                
                if (snap.empty) { sel.innerHTML = '<option value="">Kosong</option>'; return; }

                sel.innerHTML = '<option value="">-- Klik untuk Memilih Tugas --</option>';
                snap.forEach(d => {
                    const data = d.data();
                    const sm = data.semester ? ` (Sem ${data.semester})` : '';
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.text = `${data.judul}${sm}`;
                    opt.setAttribute('data-judul', data.judul); 
                    sel.appendChild(opt);
                });
            } catch(e) { sel.innerHTML = '<option>Error Memuat</option>'; }
        }

        // 3. LOAD JAWABAN SISWA
        document.getElementById('tugas-select').onchange = async (e) => {
            const tid = e.target.value;
            const listDiv = document.getElementById('list-jawaban');
            
            if(!tid) {
                listDiv.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 80px 20px; background: white; border-radius: 16px; border: 2px dashed #cbd5e1;"><i class="fa-solid fa-clipboard-check" style="font-size: 4rem; margin-bottom: 20px; color: #e2e8f0;"></i><p>Silakan pilih tugas.</p></div>';
                return;
            }

            showLoading('Mengambil data jawaban...');
            listDiv.innerHTML = '';

            try {
                const assignmentSnap = await getDoc(doc(db, 'assignments', tid));
                currentAssignmentData = assignmentSnap.data();

                const q = query(collection(db, 'submissions'), where('assignmentId', '==', tid));
                const snap = await getDocs(q);

                if(snap.empty) {
                    listDiv.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:50px; background:white; border-radius:12px; border:1px solid #eee;"><h3 style="color:#64748b;">Belum ada siswa yang mengumpulkan.</h3></div>';
                    hideLoading(); return;
                }

                snap.forEach(d => {
                    const sub = d.data();
                    const uid = d.id;
                    const isGraded = sub.nilai !== undefined && sub.nilai !== null && sub.nilai !== "";
                    
                    const card = document.createElement('div');
                    card.className = 'grading-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <h3><i class="fa-solid fa-user-graduate"></i> ${sub.studentName || 'Siswa'}</h3>
                            <span class="tag ${isGraded ? 'tag-blue' : 'tag-green'}">${isGraded ? 'SUDAH DINILAI' : 'BARU MASUK'}</span>
                        </div>
                        <div class="card-body">
                            ${sub.fileUrl ? 
                                `<div style="margin-bottom:20px; text-align:center;"><a href="${sub.fileUrl}" target="_blank" class="btn btn-secondary" style="width:100%;"><i class="fa-solid fa-file-pdf"></i> Lihat File Tugas Siswa</a></div>` : 
                                `
                                <div class="text-wrapper">
                                    <div class="answer-box" id="text-${uid}">${sub.jawabanTeks || 'Tidak ada teks jawaban.'}</div>
                                    <button type="button" class="toggle-btn" onclick="window.toggleText('${uid}')" id="toggle-${uid}">Baca Selengkapnya <i class="fa-solid fa-chevron-down"></i></button>
                                </div>
                                `
                            }

                            <form class="grading-form" data-id="${uid}" data-student-uid="${sub.studentUid}">
                                <div class="ai-tools">
                                    <div style="font-weight:600; color:#0369a1;"><i class="fa-solid fa-wand-magic-sparkles"></i> Asisten AI Cendekia</div>
                                    <button type="button" class="btn-ai" onclick="window.generateAI('${uid}', \`${sub.studentName || 'Siswa'}\`)" id="btn-ai-${uid}">
                                        Buat Penilaian
                                    </button>
                                </div>

                                <div class="form-row-score">
                                    <label><strong>Nilai:</strong></label>
                                    <input type="number" class="score-input" id="score-${uid}" value="${sub.nilai||''}" min="0" max="100">
                                </div>
                                <div>
                                    <label><strong>Catatan Guru / Ulasan AI:</strong></label>
                                    <div class="rich-feedback" id="feedback-${uid}" contenteditable="true" placeholder="Ketik catatan di sini...">${sub.feedback || ''}</div>
                                </div>
                                <div class="form-actions" style="margin-top:10px;">
                                    <button type="submit" class="btn btn-save"><i class="fa-solid fa-save"></i> Simpan & Sinkron IPS</button>
                                </div>
                            </form>
                        </div>
                    `;
                    listDiv.appendChild(card);
                });
            } catch(e) { console.error(e); } 
            finally { hideLoading(); }
        };

        window.toggleText = (docId) => {
            const textEl = document.getElementById(`text-${docId}`);
            const btnEl = document.getElementById(`toggle-${docId}`);
            textEl.classList.toggle('expanded');
            if (textEl.classList.contains('expanded')) {
                btnEl.innerHTML = `Sembunyikan <i class="fa-solid fa-chevron-up"></i>`;
            } else {
                btnEl.innerHTML = `Baca Selengkapnya <i class="fa-solid fa-chevron-down"></i>`;
            }
        };

        function formatFeedback(text) {
            if(!text) return "";
            return text
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') 
                .replace(/\*(.*?)\*/g, '<i>$1</i>')     
                .replace(/\n/g, '<br>');               
        }

        // --- FUNGSI MENGHUBUNGI API VERCEL (GRADE2) ---
        window.generateAI = async (docId, studentName) => {
            const btn = document.getElementById(`btn-ai-${docId}`);
            const scoreInput = document.getElementById(`score-${docId}`);
            const feedbackInput = document.getElementById(`feedback-${docId}`);
            
            const textElement = document.getElementById(`text-${docId}`);
            const studentText = textElement ? textElement.innerText : "Tugas berupa File (Tidak bisa dibaca AI). Berikan saya kalimat motivasi umum untuk siswa.";

            // MENGGUNAKAN currentAssignmentData.instruksi SESUAI DENGAN admin/tugas.html
            const instruksiTugas = currentAssignmentData && currentAssignmentData.instruksi ? currentAssignmentData.instruksi : 'Kerjakan tugas dengan baik.';

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Menganalisis...';

            try {
                // MENGIRIM PROMPT SESUAI PERMINTAAN TANPA ADA PERUBAHAN
                const promptRaw = `
Peran: Kamu adalah teman belajar yang pintar dan asik (bukan guru yang kaku).
Tugas: Nilai jawaban temanmu (siswa) berdasarkan instruksi penugasan.

Informasi Siswa:
Nama: "${studentName}"

Instruksi Penugasan:
"${instruksiTugas}"

Jawaban Siswa:
"${studentText}"

Tolong berikan output HANYA dalam format JSON valid berikut:
{
  "score": (angka bulat 0-100),
  "feedback": "(string HTML)"
}

Ketentuan Feedback (Wajib diikuti):
1. Sapaan & Nama: Mulailah dengan sapaan hangat "Halo, ${studentName}!" atau "Selamat Pagi/Siang/Sore, ${studentName}!".
2. Gaya Bahasa: Gunakan bahasa yang santai, akrab, dan memotivasi. Gunakan kata ganti "Aku" (sebagai penilai) dan "Kamu" (untuk siswa). Jangan gunakan "Anda" atau "Saya". Hindari bahasa birokratis atau terlalu formal.
3. Struktur Isi:
   - Analisis Kesalahan: Jelaskan bagian mana yang kurang tepat atau salah dari jawaban siswa.
   - Koreksi: Berikan contoh jawaban yang benar atau cara memperbaikinya.
   - Pujian: Tetap apresiasi usaha mereka.
4. Format HTML: Gunakan tag HTML <b> untuk menebalkan poin penting, <i> untuk istilah asing, dan <br> untuk baris baru. Jangan gunakan markdown (**bold**), harus HTML tag.
                `;

                const response = await fetch(VERCEL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instruction: promptRaw, 
                        rubric: "Gunakan ketentuan prompt di atas.",
                        answer: studentText,
                        studentName: studentName
                    })
                });
                
                if(!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || "Gagal terhubung ke Vercel.");
                }

                const result = await response.json();
                
                if (result.score !== undefined && result.feedback) {
                    scoreInput.value = result.score;
                    feedbackInput.innerHTML = formatFeedback(result.feedback); 
                    
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Selesai Dibuat';
                    btn.style.background = "#059669";
                    
                    setTimeout(() => {
                        btn.innerHTML = 'Buat Penilaian';
                        btn.style.background = "#0284c7";
                        btn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error("Respon AI tidak valid atau kosong.");
                }
            } catch (e) {
                console.error(e);
                alert("Gagal memanggil AI: " + e.message);
                btn.innerHTML = '<i class="fa-solid fa-rotate-right"></i> Coba Lagi';
                btn.disabled = false;
            }
        };

        // 4. DETEKSI KOLOM NILAI (LOGIC UTAMA)
        function detectColumn(judulTugas) {
            const lowerTitle = judulTugas.toLowerCase();
            if (lowerTitle.includes("tugas 1") || lowerTitle.includes("t1")) return "nilai_t1";
            if (lowerTitle.includes("tugas 2") || lowerTitle.includes("t2")) return "nilai_t2";
            if (lowerTitle.includes("tugas 3") || lowerTitle.includes("t3")) return "nilai_t3";
            if (lowerTitle.includes("tugas 4") || lowerTitle.includes("t4")) return "nilai_t4";
            if (lowerTitle.includes("tugas 5") || lowerTitle.includes("t5")) return "nilai_t5";
            if (lowerTitle.includes("tugas 6") || lowerTitle.includes("t6")) return "nilai_t6";
            if (lowerTitle.includes("tugas 7") || lowerTitle.includes("t7")) return "nilai_t7";
            if (lowerTitle.includes("tugas 8") || lowerTitle.includes("t8")) return "nilai_t8";
            if (lowerTitle.includes("uts")) return "nilai_uts";
            if (lowerTitle.includes("uas")) return "nilai_uas";
            return null; 
        }

        // 5. SIMPAN & HITUNG IPS OTOMATIS
        document.getElementById('list-jawaban').addEventListener('submit', async (e) => {
            if(e.target.classList.contains('grading-form')) {
                e.preventDefault();
                const form = e.target;
                const submissionId = form.dataset.id;
                const studentUid = form.dataset.studentUid; 
                
                const btn = form.querySelector('.btn-save');
                const nilaiVal = parseFloat(form.querySelector('.score-input').value) || 0;
                let feedbackVal = form.querySelector('.rich-feedback').innerHTML; 
                if (feedbackVal === '<br>' || feedbackVal === '<div><br></div>') feedbackVal = '';

                const selectBox = document.getElementById('tugas-select');
                const judulTugas = selectBox.options[selectBox.selectedIndex].getAttribute('data-judul');
                const targetField = detectColumn(judulTugas); 

                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';
                btn.disabled = true;

                try {
                    // A. Update Submission
                    await updateDoc(doc(db, 'submissions', submissionId), {
                        nilai: nilaiVal,
                        feedback: feedbackVal
                    });

                    // B. Update Data Siswa & IPS
                    if (targetField && studentUid) {
                        const userRef = doc(db, 'users', studentUid);
                        const userSnap = await getDoc(userRef);
                        
                        if (userSnap.exists()) {
                            let userData = userSnap.data();
                            userData[targetField] = nilaiVal;

                            let totalTugas = 0;
                            for(let i=1; i<=8; i++) {
                                let val = userData[`nilai_t${i}`] || 0; 
                                totalTugas += val * 0.05;
                            }
                            let scoreUts = (userData['nilai_uts'] || 0) * 0.30;
                            let scoreUas = (userData['nilai_uas'] || 0) * 0.30;
                            
                            const finalScore = totalTugas + scoreUts + scoreUas;
                            const ipsBaru = (finalScore / 100) * 4;

                            await updateDoc(userRef, {
                                [targetField]: nilaiVal, 
                                ips: ipsBaru            
                            });
                        }
                    }

                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Tersimpan & Sinkron!';
                    btn.style.backgroundColor = '#005a9c';
                    
                    const cardHeader = form.closest('.grading-card').querySelector('.card-header span.tag');
                    cardHeader.className = 'tag tag-blue';
                    cardHeader.innerText = 'SUDAH DINILAI';

                    setTimeout(() => { 
                        btn.innerHTML = originalText; 
                        btn.style.backgroundColor = ''; 
                        btn.disabled = false; 
                    }, 2000);

                } catch(err) {
                    console.error(err);
                    alert("Gagal menyimpan: " + err.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        });
    </script>
</body>
</html>
