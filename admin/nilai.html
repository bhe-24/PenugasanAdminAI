<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Penilaian Tugas Otomatis</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* --- CSS RESET & GLOBAL --- */
        :root { --primary-color: #003366; --primary-light: #005a9c; --accent-color: #28a745; --bg-color: #f4f7f6; --text-color: #333; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; color: var(--text-color); }
        .container { max-width: 900px; margin: 0 auto; padding: 20px 15px; }

        /* HEADER */
        .page-header { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .page-header h2 { margin: 0; color: var(--primary-color); font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }

        /* DROPDOWN */
        .select-container { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e0e0e0; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
        .form-control:focus { border-color: var(--primary-light); }

        /* CARD */
        .grading-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; overflow: hidden; border: 1px solid #e0e0e0; }
        .card-header { background: var(--primary-color); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { margin: 0; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 25px; }

        .tag { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: white; }
        .tag-green { background-color: var(--accent-color); }
        .tag-blue { background-color: var(--primary-light); }

        .answer-box { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto; margin-bottom: 25px; color: #333; }
        
        /* FORM PENILAIAN */
        .grading-form { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .form-row-score { display: flex; align-items: center; gap: 15px; }
        .score-input { width: 100px; text-align: center; font-size: 1.4rem; font-weight: bold; padding: 10px; border: 2px solid #ccc; border-radius: 8px; color: var(--primary-color); }
        .score-input:focus { border-color: var(--primary-light); }

        .rich-feedback { width: 100%; min-height: 60px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background: #fff; white-space: pre-wrap; transition: 0.3s; }
        .rich-feedback:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.1); }

        /* BUTTONS */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-secondary { background: #6c757d; font-size: 0.9rem; }
        .btn-save { background: var(--accent-color); width: auto; min-width: 180px; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); }
        .btn-save:hover { background: #218838; transform: translateY(-2px); }
        .btn-save:disabled { background: #94d3a2; cursor: not-allowed; }
        .form-actions { display: flex; justify-content: flex-end; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            .page-header { flex-direction: column; text-align: center; }
            .btn-save { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <h2><i class="fa-solid fa-marker"></i> Penilaian & Sinkronisasi</h2>
            <a href="index.html" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
        </div>

        <div class="select-container">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">Pilih Tugas:</label>
            <select id="tugas-select" class="form-control">
                <option value="">-- Memuat Daftar Tugas... --</option>
            </select>
        </div>
        
        <div id="list-jawaban">
            <div style="text-align: center; color: #888; padding: 60px;">
                <i class="fa-solid fa-clipboard-check" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                <p>Pilih tugas untuk mulai menilai.</p>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; color: #003366;"></i>
        <p style="margin-top: 20px; font-weight: 600;" id="loading-text">Memproses...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, getDocs, getDoc, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
            authDomain: "mading-cf676.firebaseapp.com", 
            projectId: "mading-cf676", 
            storageBucket: "mading-cf676.firebasestorage.app", 
            messagingSenderId: "72175203671", 
            appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- HELPER FUNCTIONS ---
        const showLoading = (msg) => { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').classList.remove('hidden'); };
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');
        
        // 1. INIT
        onAuthStateChanged(auth, async (user) => {
            if (!user) await signInAnonymously(auth);
            loadDropdown();
        });

        // 2. LOAD DROPDOWN TUGAS
        async function loadDropdown() {
            const sel = document.getElementById('tugas-select');
            try {
                const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                
                if (snap.empty) { sel.innerHTML = '<option value="">Kosong</option>'; return; }

                sel.innerHTML = '<option value="">-- Klik untuk Memilih --</option>';
                snap.forEach(d => {
                    const data = d.data();
                    const sm = data.semester ? ` (Sem ${data.semester})` : '';
                    // Simpan Judul di attribute untuk deteksi otomatis nanti
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.text = `${data.judul}${sm}`;
                    opt.setAttribute('data-judul', data.judul); // Penting buat deteksi T1/UTS
                    sel.appendChild(opt);
                });
            } catch(e) { sel.innerHTML = '<option>Error Memuat</option>'; }
        }

        // 3. LOAD JAWABAN SISWA
        document.getElementById('tugas-select').onchange = async (e) => {
            const tid = e.target.value;
            if(!tid) return;

            showLoading('Mengambil data...');
            const listDiv = document.getElementById('list-jawaban');
            listDiv.innerHTML = '';

            try {
                const q = query(collection(db, 'submissions'), where('assignmentId', '==', tid));
                const snap = await getDocs(q);

                if(snap.empty) {
                    listDiv.innerHTML = '<div style="text-align:center; padding:40px;">Belum ada yang mengumpulkan.</div>';
                    hideLoading(); return;
                }

                // Render Card
                snap.forEach(d => {
                    const sub = d.data();
                    const uid = d.id;
                    const isGraded = sub.nilai !== undefined && sub.nilai !== null && sub.nilai !== "";
                    
                    const card = document.createElement('div');
                    card.className = 'grading-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <h3><i class="fa-solid fa-user-graduate"></i> ${sub.studentName || 'Siswa'}</h3>
                            <span class="tag ${isGraded ? 'tag-blue' : 'tag-green'}">${isGraded ? 'DINILAI' : 'BARU'}</span>
                        </div>
                        <div class="card-body">
                            ${sub.fileUrl ? 
                                `<div style="margin-bottom:15px;"><a href="${sub.fileUrl}" target="_blank" class="btn btn-secondary"><i class="fa-solid fa-file"></i> Lihat File Siswa</a></div>` : 
                                `<div class="answer-box">${sub.jawabanTeks || '-'}</div>`
                            }

                            <form class="grading-form" data-id="${uid}" data-student-uid="${sub.studentUid}">
                                <div class="form-row-score">
                                    <label><strong>Nilai (0-100):</strong></label>
                                    <input type="number" class="score-input" value="${sub.nilai||''}" min="0" max="100">
                                </div>
                                <div>
                                    <label><strong>Feedback:</strong></label>
                                    <div class="rich-feedback" contenteditable="true">${sub.feedback || ''}</div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-save"><i class="fa-solid fa-save"></i> Simpan & Sinkron IPS</button>
                                </div>
                            </form>
                        </div>
                    `;
                    listDiv.appendChild(card);
                });
            } catch(e) { console.error(e); } 
            finally { hideLoading(); }
        };

        // 4. DETEKSI KOLOM NILAI (LOGIC UTAMA)
        function detectColumn(judulTugas) {
            const lowerTitle = judulTugas.toLowerCase();
            // Cek kata kunci di judul tugas
            if (lowerTitle.includes("tugas 1") || lowerTitle.includes("t1")) return "nilai_t1";
            if (lowerTitle.includes("tugas 2") || lowerTitle.includes("t2")) return "nilai_t2";
            if (lowerTitle.includes("tugas 3") || lowerTitle.includes("t3")) return "nilai_t3";
            if (lowerTitle.includes("tugas 4") || lowerTitle.includes("t4")) return "nilai_t4";
            if (lowerTitle.includes("tugas 5") || lowerTitle.includes("t5")) return "nilai_t5";
            if (lowerTitle.includes("tugas 6") || lowerTitle.includes("t6")) return "nilai_t6";
            if (lowerTitle.includes("tugas 7") || lowerTitle.includes("t7")) return "nilai_t7";
            if (lowerTitle.includes("tugas 8") || lowerTitle.includes("t8")) return "nilai_t8";
            if (lowerTitle.includes("uts")) return "nilai_uts";
            if (lowerTitle.includes("uas")) return "nilai_uas";
            return null; // Tidak ketemu kategori
        }

        // 5. SIMPAN & HITUNG IPS OTOMATIS
        document.getElementById('list-jawaban').addEventListener('submit', async (e) => {
            if(e.target.classList.contains('grading-form')) {
                e.preventDefault();
                const form = e.target;
                const submissionId = form.dataset.id;
                const studentUid = form.dataset.studentUid; // UID Siswa Penting!
                
                const btn = form.querySelector('.btn-save');
                const nilaiVal = parseFloat(form.querySelector('.score-input').value) || 0;
                const feedbackVal = form.querySelector('.rich-feedback').innerText;

                // Ambil Judul Tugas dari Dropdown
                const selectBox = document.getElementById('tugas-select');
                const judulTugas = selectBox.options[selectBox.selectedIndex].getAttribute('data-judul');
                const targetField = detectColumn(judulTugas); // Deteksi: nilai_t1, nilai_uts, dll

                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';
                btn.disabled = true;

                try {
                    // A. Update Submission (Data Tugas)
                    await updateDoc(doc(db, 'submissions', submissionId), {
                        nilai: nilaiVal,
                        feedback: feedbackVal
                    });

                    // B. Update Data Siswa (Data Pusat)
                    if (targetField && studentUid) {
                        const userRef = doc(db, 'users', studentUid);
                        const userSnap = await getDoc(userRef);
                        
                        if (userSnap.exists()) {
                            let userData = userSnap.data();
                            
                            // 1. Update nilai spesifik (misal: nilai_t1 = 90) di MEMORI dulu
                            userData[targetField] = nilaiVal;

                            // 2. Hitung Ulang IPS menggunakan rumus yang sama dengan siswa.html
                            let totalTugas = 0;
                            for(let i=1; i<=8; i++) {
                                let val = userData[`nilai_t${i}`] || 0; // Ambil nilai 0 jika belum ada
                                totalTugas += val * 0.05;
                            }
                            let scoreUts = (userData['nilai_uts'] || 0) * 0.30;
                            let scoreUas = (userData['nilai_uas'] || 0) * 0.30;
                            
                            const finalScore = totalTugas + scoreUts + scoreUas;
                            const ipsBaru = (finalScore / 100) * 4;

                            // 3. Simpan ke Database Users
                            await updateDoc(userRef, {
                                [targetField]: nilaiVal, // Simpan nilai tugas
                                ips: ipsBaru             // Simpan IPS baru
                            });
                            
                            console.log(`Auto-Sync Berhasil: ${targetField} updated, IPS jadi ${ipsBaru}`);
                        }
                    }

                    // UI Feedback
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Tersimpan & Sinkron!';
                    btn.style.backgroundColor = '#005a9c';
                    setTimeout(() => { 
                        btn.innerHTML = originalText; 
                        btn.style.backgroundColor = ''; 
                        btn.disabled = false; 
                    }, 2000);

                } catch(err) {
                    console.error(err);
                    alert("Gagal menyimpan: " + err.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        });
    </script>
</body>
</html>
