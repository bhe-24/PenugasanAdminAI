<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Penilaian Tugas</title>
    
    <!-- FontAwesome untuk ikon (menggunakan CDN yang stabil) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* --- 1. CSS RESET & GLOBAL VARIABLES --- */
        :root {
            --primary-color: #003366;
            --primary-light: #005a9c;
            --accent-color: #28a745;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* --- 2. LAYOUT CONTAINER --- */
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px 15px; 
        }
        
        /* --- 3. HEADER --- */
        .page-header { 
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .page-header h2 { 
            margin: 0; 
            color: var(--primary-color); 
            font-size: 1.5rem; 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- 4. DROPDOWN AREA --- */
        .select-container { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color); 
            margin-bottom: 30px; 
            box-shadow: var(--shadow-sm); 
        }
        
        .form-control { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1rem; 
            transition: border-color 0.3s;
            background-color: #fff;
        }
        
        .form-control:focus {
            border-color: var(--primary-light);
        }

        /* --- 5. CARD PENILAIAN (CARD UTAMA) --- */
        .grading-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: var(--shadow-md); 
            margin-bottom: 30px; 
            overflow: hidden; 
            border: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            transition: transform 0.2s;
        }
        
        .card-header { 
            background: var(--primary-color); 
            color: white; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .card-header h3 { 
            margin: 0; 
            font-size: 1.1rem; 
            font-weight: 600;
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .tag { 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white; 
        }
        .tag-green { background-color: var(--accent-color); }
        .tag-blue { background-color: var(--primary-light); }

        .card-body { padding: 25px; }

        /* INFO SISWA */
        .student-info-inline { 
            margin-bottom: 20px; 
            color: #555; 
            font-size: 0.95rem; 
            border-left: 4px solid var(--primary-light);
            background: #f0f4f8; 
            padding: 12px 15px; 
            border-radius: 0 6px 6px 0; 
        }

        /* TAMPILAN JAWABAN */
        .answer-box { 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 8px; 
            max-height: 400px; 
            overflow-y: auto; 
            margin-bottom: 25px; 
            color: #333;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);
        }

        /* --- 6. FORM PENILAIAN --- */
        .grading-form { 
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column; 
            gap: 20px;
        }

        .form-row-score {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .score-input { 
            width: 100px; 
            text-align: center; 
            font-size: 1.4rem; 
            font-weight: bold; 
            padding: 10px; 
            border: 2px solid #ccc; 
            border-radius: 8px; 
            color: var(--primary-color);
            transition: border-color 0.3s;
        }
        .score-input:focus { border-color: var(--primary-light); }

        /* --- 7. RICH TEXT EDITOR (EXPANDABLE) --- */
        .feedback-wrapper {
            position: relative;
            width: 100%;
        }

        .rich-feedback {
            width: 100%; 
            min-height: 60px; 
            height: 60px;     
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            background: #fff; 
            font-family: inherit; 
            line-height: 1.5;
            white-space: pre-wrap;
            overflow: hidden; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        /* Gradient mask saat collapsed agar terlihat ada teks lanjutannya */
        .rich-feedback:not(.expanded)::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 30px;
            background: linear-gradient(to bottom, transparent, #fff);
            pointer-events: none;
        }

        /* Kelas saat Expanded */
        .rich-feedback.expanded {
            height: auto;
            min-height: 180px;
            overflow-y: auto;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.1);
        }
        .rich-feedback.expanded::after { display: none; }

        .rich-feedback:empty::before { content: "Tulis feedback di sini..."; color: #999; }
        .rich-feedback b, .rich-feedback strong { font-weight: 700; color: #000; }
        .rich-feedback i, .rich-feedback em { font-style: italic; }

        /* Tombol Toggle */
        .toggle-feedback-btn {
            background: none;
            border: none;
            color: var(--primary-light);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 8px;
            font-weight: 600;
            padding: 5px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .toggle-feedback-btn:hover { color: var(--primary-color); text-decoration: underline; }

        /* --- 8. BUTTONS --- */
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            color: white; 
            font-weight: 600; 
            font-size: 1rem; 
            transition: all 0.2s ease; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-secondary { 
            background: #6c757d; 
            font-size: 0.9rem;
            padding: 10px 20px;
        }
        .btn-secondary:hover { background: #5a6268; }

        .btn-save { 
            background: var(--accent-color); 
            width: auto;
            min-width: 180px;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
        }
        .btn-save:hover { 
            background: #218838; 
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(40, 167, 69, 0.3);
        }
        .btn-save:active { transform: translateY(0); }
        .btn-save:disabled { background: #94d3a2; cursor: not-allowed; transform: none; }

        .form-actions {
            display: flex;
            justify-content: flex-end; /* Tombol dikanan */
            margin-top: 10px;
        }

        /* --- 9. LOADING & UTILS --- */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); z-index: 1000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .hidden { display: none !important; }

        /* --- 10. RESPONSIVE --- */
        @media (max-width: 600px) {
            .page-header { flex-direction: column; align-items: stretch; text-align: center; }
            .page-header h2 { justify-content: center; margin-bottom: 10px; }
            .btn-save { width: 100%; } 
            .form-row-score { flex-direction: column; align-items: flex-start; }
            .score-input { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- HEADER -->
        <div class="page-header">
            <h2><i class="fa-solid fa-marker"></i> Penilaian Tugas</h2>
            <a href="index.html" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i> Kembali ke Dashboard
            </a>
        </div>

        <!-- PILIH TUGAS -->
        <div class="select-container">
            <label style="font-weight: bold; display: block; margin-bottom: 10px; color: #555;">Pilih Tugas yang Ingin Dinilai:</label>
            <select id="tugas-select" class="form-control">
                <option value="">-- Sedang Memuat Daftar Tugas... --</option>
            </select>
        </div>
        
        <!-- DAFTAR JAWABAN -->
        <div id="list-jawaban">
            <div style="text-align: center; color: #888; padding: 60px 20px;">
                <i class="fa-solid fa-clipboard-list" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                <p style="font-size: 1.1rem;">Silakan pilih tugas pada menu di atas untuk menampilkan jawaban siswa.</p>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="hidden">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; color: #003366;"></i>
        <p style="margin-top: 20px; font-weight: 600; color: #555;" id="loading-text">Memproses Data...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, getDocs, getDoc, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = { 
            apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
            authDomain: "mading-cf676.firebaseapp.com", 
            projectId: "mading-cf676", 
            storageBucket: "mading-cf676.firebasestorage.app", 
            messagingSenderId: "72175203671", 
            appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const showLoading = (msg) => { 
            document.getElementById('loading-text').innerText = msg;
            document.getElementById('loading-overlay').classList.remove('hidden');
        };
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');
        
        const nl2br = (str) => {
            if (!str) return '<i style="color:#999">(Tidak ada jawaban teks)</i>';
            return str.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
        }

        // 1. Auth & Load
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadDropdown();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth Error:", error);
                    // Tetap coba load meski error auth, siapa tau public
                    loadDropdown();
                }
            }
        });

        // 2. Load Daftar Tugas (Dengan Info Semester)
        async function loadDropdown() {
            const sel = document.getElementById('tugas-select');
            try {
                const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    sel.innerHTML = '<option value="">-- Tidak ada tugas tersedia --</option>';
                    return;
                }

                sel.innerHTML = '<option value="">-- Klik untuk Memilih Tugas --</option>';
                snap.forEach(d => {
                    const data = d.data();
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    
                    // Format Label: JUDUL TUGAS (Semester X)
                    const semesterInfo = data.semester ? ` (Semester ${data.semester})` : '';
                    opt.text = `${data.judul}${semesterInfo}`;
                    
                    sel.appendChild(opt);
                });
            } catch(e) { 
                console.error(e); 
                sel.innerHTML = '<option value="">-- Gagal Memuat Data --</option>';
                alert("Gagal memuat daftar tugas. Periksa koneksi internet."); 
            }
        }

        // 3. Logic Utama: Tampilkan Data
        document.getElementById('tugas-select').onchange = async (e) => {
            const tid = e.target.value;
            const listDiv = document.getElementById('list-jawaban');
            
            if(!tid) { 
                listDiv.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 60px 20px;">
                        <i class="fa-solid fa-clipboard-list" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                        <p style="font-size: 1.1rem;">Silakan pilih tugas pada menu di atas.</p>
                    </div>`; 
                return; 
            }

            showLoading('Mengambil jawaban siswa...');
            
            try {
                const q = query(collection(db, 'submissions'), where('assignmentId', '==', tid));
                const snap = await getDocs(q);
                
                listDiv.innerHTML = '';
                if(snap.empty) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; border: 1px dashed #ccc;">
                            <i class="fa-solid fa-box-open" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p style="color: #666;">Belum ada siswa yang mengumpulkan tugas ini.</p>
                        </div>`;
                    hideLoading();
                    return;
                }

                const submissions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                for (const sub of submissions) {
                    
                    // --- NAMA SISWA ---
                    let displayName = sub.studentName || sub.nama || sub.name || "Nama Tidak Ditemukan";
                    const uidSiswa = sub.studentUid || sub.uid || sub.userId;
                    
                    if ((displayName === "Nama Tidak Ditemukan" || displayName === 'Unknown') && uidSiswa) {
                        try {
                            const uSnap = await getDoc(doc(db, 'users', uidSiswa));
                            if (uSnap.exists()) displayName = uSnap.data().name || "User Tanpa Nama";
                        } catch(err) {}
                    }

                    const isGraded = sub.nilai !== null && sub.nilai !== undefined && sub.nilai !== "";
                    
                    // --- KONTEN JAWABAN ---
                    let kontenJawaban = sub.fileUrl 
                        ? `<div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee; display:flex; align-items:center; gap:10px;">
                             <i class="fa-solid fa-file-pdf" style="color:#d32f2f; font-size:1.5rem;"></i>
                             <div style="flex:1;">
                                <strong>Lampiran File</strong><br>
                                <small style="color:#666;">Siswa melampirkan dokumen.</small>
                             </div>
                             <a href="${sub.fileUrl}" target="_blank" class="btn btn-secondary" style="padding:8px 15px;">
                                <i class="fa-solid fa-external-link-alt"></i> Buka File
                             </a>
                           </div>`
                        : `<div class="answer-box">${nl2br(sub.jawabanTeks)}</div>`;

                    // --- RENDER CARD ---
                    const card = document.createElement('div');
                    card.className = 'grading-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <h3><i class="fa-solid fa-user-graduate"></i> ${displayName}</h3>
                            <span class="tag ${isGraded ? 'tag-blue' : 'tag-green'}">${isGraded ? 'SUDAH DINILAI' : 'BELUM DINILAI'}</span>
                        </div>
                        <div class="card-body">
                            <div class="student-info-inline">
                                <i class="fa-regular fa-id-card"></i> <strong>Siswa:</strong> ${displayName}
                            </div>

                            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#444;">Jawaban Siswa:</label>
                            ${kontenJawaban}
                            
                            <form class="grading-form" data-id="${sub.id}">
                                
                                <div class="form-row-score">
                                    <label style="font-weight:bold; color:#333;">Nilai Akhir (0-100):</label>
                                    <input type="number" class="score-input" value="${sub.nilai||''}" placeholder="0" min="0" max="100">
                                </div>

                                <div class="feedback-wrapper">
                                    <label style="font-weight:bold; display:block; margin-bottom:8px; color:#333;">Catatan / Feedback untuk Siswa:</label>
                                    
                                    <!-- Area Feedback -->
                                    <div class="rich-feedback" contenteditable="true" id="fb-${sub.id}">${sub.feedback || ''}</div>
                                    
                                    <!-- Tombol Toggle -->
                                    <button type="button" class="toggle-feedback-btn" onclick="toggleFeedback('fb-${sub.id}', this)">
                                        <i class="fa-solid fa-pen-to-square"></i> Tulis / Lihat Selengkapnya
                                    </button>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-save">
                                        <i class="fa-solid fa-save"></i> Simpan Penilaian
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;
                    listDiv.appendChild(card);
                }
            } catch(e) { console.error(e); alert("Terjadi kesalahan saat mengambil data."); }
            finally { hideLoading(); }
        };

        // 4. Logic Toggle Feedback
        window.toggleFeedback = (elementId, btn) => {
            const el = document.getElementById(elementId);
            el.classList.toggle('expanded');
            
            if(el.classList.contains('expanded')) {
                btn.innerHTML = '<i class="fa-solid fa-compress"></i> Perkecil Tampilan';
                el.focus(); // Langsung fokus agar user bisa langsung ketik
            } else {
                btn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i> Tulis / Lihat Selengkapnya';
            }
        };

        // 5. Logic Simpan
        document.getElementById('list-jawaban').addEventListener('submit', async (e) => {
            if(e.target.classList.contains('grading-form')) {
                e.preventDefault();
                const form = e.target;
                const uid = form.dataset.id;
                const btn = form.querySelector('.btn-save');
                
                const feedbackHTML = form.querySelector('.rich-feedback').innerHTML;
                const nilaiVal = form.querySelector('.score-input').value;

                // Visual Loading State
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.style.width = btn.offsetWidth + 'px'; // Kunci lebar tombol biar gak goyang
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Menyimpan...';

                try {
                    await updateDoc(doc(db, 'submissions', uid), {
                        nilai: nilaiVal,
                        feedback: feedbackHTML
                    });
                    
                    // Sukses
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Tersimpan!';
                    btn.style.backgroundColor = '#005a9c'; 
                    
                    // Kembalikan tombol setelah 2 detik
                    setTimeout(() => { 
                        btn.innerHTML = originalText;
                        btn.style.backgroundColor = ''; // Reset ke warna CSS default
                        btn.style.width = 'auto';
                        btn.disabled = false; 
                    }, 2000);

                    // Update Badge Status di Header Card
                    const badge = form.closest('.grading-card').querySelector('.tag');
                    badge.className = 'tag tag-blue';
                    badge.innerText = 'SUDAH DINILAI';

                } catch(err) {
                    console.error(err);
                    alert("Gagal menyimpan nilai. Pastikan koneksi internet lancar.");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        });
    </script>
</body>
</html>
