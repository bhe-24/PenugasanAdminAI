<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Siswa - Admin</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* --- 1. RESET & GLOBAL --- */
        :root { --primary: #003366; --accent: #28a745; --bg: #f4f7f6; --text: #333; --danger: #dc3545; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 50px; }
        
        /* DIPERLEBAR AGAR LAPTOP FRIENDLY */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* --- 2. HEADER & SEARCH --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 3px solid var(--primary); padding-bottom: 15px; background: #fff; padding: 20px 30px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .page-header h2 { margin: 0; color: var(--primary); font-size: 1.6rem; display: flex; align-items: center; gap: 10px; }

        .search-box { display: flex; gap: 10px; margin-bottom: 25px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.03); max-width: 600px; }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        .form-control:focus { border-color: var(--primary); }

        /* MENGGUNAKAN GRID AGAR KARTU SEJAJAR DI LAYAR LEBAR */
        #list-siswa {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 25px;
            align-items: start;
        }

        /* --- 3. STUDENT CARD --- */
        .student-card { background: white; border: 1px solid #e0e0e0; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .student-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        
        /* CARD MERAH JIKA KURANG AKTIF */
        .student-card.inactive { border: 2px solid #fca5a5; background-color: #fef2f2; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #ccc; }
        .student-name { font-size: 1.25rem; color: var(--primary); margin: 0 0 5px 0; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .inactive-name { color: #991b1b; }
        
        .student-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        
        .ips-badge { background: var(--primary); color: white; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.3s; }
        .badge-danger { background: var(--danger); font-size: 0.75rem; padding: 4px 10px; }

        /* Grid Input Nilai */
        .nilai-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 25px; }
        .input-wrapper { display: flex; flex-direction: column; text-align: center; }
        .input-wrapper label { font-size: 0.75rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        
        .nilai-input { text-align: center; padding: 10px 5px; border: 2px solid #e0e0e0; border-radius: 8px; font-weight: bold; width: 100%; font-size: 1rem; color: #444; transition: all 0.2s; }
        .nilai-input:focus { border-color: var(--primary); color: var(--primary); background: #f0f8ff; }
        
        .ujian { background-color: #f3e5f5; border-color: #e1bee7; color: #4a148c; }
        .ujian:focus { border-color: #ab47bc; background: #fff; }

        /* Tombol */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-secondary { background: #f1f5f9; color: #334155; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-primary { background: var(--primary); }
        
        .card-actions { display: flex; gap: 10px; }
        .btn-save { flex: 1; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); transition: 0.2s; }
        .btn-save:hover { background: #218838; transform: translateY(-2px); }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-delete { padding: 12px 15px; background: white; color: var(--danger); border: 2px solid #fca5a5; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn-delete:hover { background: var(--danger); color: white; }

        /* --- 4. TOAST --- */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; padding: 15px 20px; background: #333; color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; opacity: 0; transform: translateY(20px); animation: slideIn 0.4s forwards; font-size: 0.95rem; }
        .toast.success { border-left: 5px solid #28a745; background: #fff; color: #333; }
        .toast.success i { color: #28a745; font-size: 1.2rem; }
        .toast.error { border-left: 5px solid #dc3545; background: #fff; color: #333; }
        .toast.error i { color: #dc3545; font-size: 1.2rem; }

        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(50px); } }

        @media (max-width: 768px) {
            #list-siswa { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; text-align: center; gap: 15px; }
            .search-box { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h2><i class="fa-solid fa-users-gear"></i> Data Siswa & Nilai</h2>
            <a href="index.html" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
        </div>
        
        <div class="search-box">
            <input type="text" id="search" class="form-control" oninput="window.searchSiswa()" placeholder="Cari nama atau email siswa..." autocomplete="off">
            <button onclick="window.searchSiswa()" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass"></i></button>
        </div>

        <div id="list-siswa">
            <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666; background: white; border-radius: 12px;">
                <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; color: #003366;"></i>
                <p style="margin-top: 15px; font-weight:bold;">Memuat data siswa...</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GANTI INI DENGAN CONFIG FIREBASE ANDA
        const firebaseConfig = { 
            apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
            authDomain: "mading-cf676.firebaseapp.com", 
            projectId: "mading-cf676", 
            storageBucket: "mading-cf676.firebasestorage.app", 
            messagingSenderId: "72175203671", 
            appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allStudents = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadData();
            } else {
                try { await signInAnonymously(auth); } 
                catch(e) { showToast("Gagal login: " + e.message, 'error'); }
            }
        });

        async function loadData() {
            try {
                const q = query(collection(db, 'users'), where('role', '==', 'siswa'));
                const snap = await getDocs(q);
                
                allStudents = [];
                snap.forEach(d => allStudents.push({id: d.id, ...d.data()}));
                
                // Urutkan A-Z
                allStudents.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
                
                render(allStudents);
            } catch(e) {
                console.error(e);
                document.getElementById('list-siswa').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:red;">Gagal memuat data.</div>';
            }
        }

        window.searchSiswa = () => {
            const key = document.getElementById('search').value.toLowerCase();
            if(!key) { render(allStudents); return; }
            const filtered = allStudents.filter(s => 
                (s.name && s.name.toLowerCase().includes(key)) || 
                (s.email && s.email.toLowerCase().includes(key))
            );
            render(filtered);
        };

        // --- BAGIAN RENDER ---
        function render(list) {
            const div = document.getElementById('list-siswa');
            
            if(list.length === 0) { 
                div.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #888; padding: 60px; background:white; border-radius:12px; border:2px dashed #ddd;">
                        <i class="fa-regular fa-folder-open" style="font-size: 4rem; margin-bottom: 15px; color:#cbd5e1;"></i>
                        <h3 style="margin:0; color:#64748b;">Tidak ada data</h3>
                        <p>Tidak ada data siswa ditemukan.</p>
                    </div>`; 
                return; 
            }

            let htmlBuffer = ''; 

            list.forEach(u => {
                const n = u; 
                const ips = parseFloat(u.ips||0).toFixed(2);

                // --- LOGIKA DETEKSI SISWA PASIF ---
                // Menghitung berapa banyak tugas (t1-t8, uts, uas) yang memiliki nilai
                let totalTugasTerisi = 0;
                for(let i=1; i<=8; i++) {
                    if (n[`nilai_t${i}`] !== undefined && n[`nilai_t${i}`] !== null && n[`nilai_t${i}`] !== "") totalTugasTerisi++;
                }
                if (n.nilai_uts !== undefined && n.nilai_uts !== null && n.nilai_uts !== "") totalTugasTerisi++;
                if (n.nilai_uas !== undefined && n.nilai_uas !== null && n.nilai_uas !== "") totalTugasTerisi++;

                const isInactive = totalTugasTerisi < 5;
                const cardClass = isInactive ? 'student-card inactive' : 'student-card';
                const nameClass = isInactive ? 'student-name inactive-name' : 'student-name';
                
                htmlBuffer += `
                    <div class="${cardClass}" id="card-${u.id}">
                        <div class="card-header">
                            <div>
                                <h3 class="${nameClass}"><i class="fa-solid fa-user-graduate"></i> ${u.name}</h3>
                                <small style="color:#64748b;">${u.email || 'Tanpa Email'}</small>
                                ${isInactive ? '<br><span class="ips-badge badge-danger" style="margin-top:8px; display:inline-block;"><i class="fa-solid fa-triangle-exclamation"></i> Kurang Aktif (Tugas < 5)</span>' : ''}
                            </div>
                            <div class="student-meta">
                                <span class="ips-badge" id="ips-display-${u.id}">IPS: ${ips}</span>
                                <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                                    <span style="font-size:0.85rem; font-weight:bold;">Sem:</span> 
                                    <input type="number" id="sem-${u.id}" value="${u.semester||1}" 
                                        style="width:50px; text-align:center; border:1px solid #ccc; border-radius:4px; padding:4px;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="nilai-grid">
                            ${renderInput(u.id, 't1', 'T1', n.nilai_t1)}
                            ${renderInput(u.id, 't2', 'T2', n.nilai_t2)}
                            ${renderInput(u.id, 't3', 'T3', n.nilai_t3)}
                            ${renderInput(u.id, 't4', 'T4', n.nilai_t4)}
                            ${renderInput(u.id, 't5', 'T5', n.nilai_t5)}
                            ${renderInput(u.id, 't6', 'T6', n.nilai_t6)}
                            ${renderInput(u.id, 't7', 'T7', n.nilai_t7)}
                            ${renderInput(u.id, 't8', 'T8', n.nilai_t8)}
                            ${renderInput(u.id, 'uts', 'UTS', n.nilai_uts, true)}
                            ${renderInput(u.id, 'uas', 'UAS', n.nilai_uas, true)}
                        </div>

                        <div class="card-actions">
                            <button class="btn-save" onclick="window.save('${u.id}')">
                                <i class="fa-solid fa-calculator"></i> Simpan & Hitung IPS
                            </button>
                            ${isInactive ? `
                            <button class="btn-delete" title="Hapus Siswa Pasif" onclick="window.deleteStudent('${u.id}', '${u.name}')">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>` : ''}
                        </div>
                    </div>
                `;
            });

            div.innerHTML = htmlBuffer;
        }

        function renderInput(uid, key, label, val, isExam=false) {
            const cls = isExam ? 'nilai-input ujian' : 'nilai-input';
            return `
                <div class="input-wrapper">
                    <label>${label}</label>
                    <input type="number" id="${key}-${uid}" value="${val!==undefined && val!==null ? val : ''}" 
                        class="${cls}" placeholder="0" min="0" max="100">
                </div>
            `;
        }

        window.save = async (uid) => {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menghitung...';
            btn.disabled = true;

            try {
                let totalTugas = 0;
                let dataToSave = {};

                // Ambil Tugas (40%)
                for(let i=1; i<=8; i++) {
                    const el = document.getElementById(`t${i}-${uid}`);
                    let val = el.value.trim();
                    let num = val === '' ? 0 : parseFloat(val);
                    dataToSave[`nilai_t${i}`] = val === '' ? null : num;
                    totalTugas += num * 0.05;
                }

                // Ambil UTS (30%)
                const elUts = document.getElementById(`uts-${uid}`);
                let valUts = elUts.value.trim();
                let numUts = valUts === '' ? 0 : parseFloat(valUts);
                dataToSave['nilai_uts'] = valUts === '' ? null : numUts;
                let scoreUts = numUts * 0.30;

                // Ambil UAS (30%)
                const elUas = document.getElementById(`uas-${uid}`);
                let valUas = elUas.value.trim();
                let numUas = valUas === '' ? 0 : parseFloat(valUas);
                dataToSave['nilai_uas'] = valUas === '' ? null : numUas;
                let scoreUas = numUas * 0.30;

                // Hitung
                const finalScore = totalTugas + scoreUts + scoreUas;
                const ips = (finalScore / 100) * 4;

                // Semester
                const sem = parseInt(document.getElementById(`sem-${uid}`).value) || 1;
                dataToSave['semester'] = sem;
                dataToSave['ips'] = ips;

                // Update Firestore
                await updateDoc(doc(db,'users',uid), dataToSave);

                // Update UI Cepat (Refresh kartu agar badge merah hilang jika tugas sudah >= 5)
                showToast(`Berhasil! IPS Siswa: ${ips.toFixed(2)}`, 'success');
                setTimeout(() => loadData(), 500); 

            } catch(e) {
                console.error(e);
                showToast("Gagal menyimpan: " + e.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // FUNGSI HAPUS SISWA PASIF
        window.deleteStudent = async (uid, name) => {
            const confirmDelete = confirm(`Apakah Anda yakin ingin MENGHAPUS akun siswa ${name} secara permanen dari sistem? \n\nAksi ini tidak dapat dibatalkan.`);
            
            if(confirmDelete) {
                try {
                    // Hanya menghapus dari koleksi 'users'
                    await deleteDoc(doc(db, 'users', uid));
                    showToast(`Siswa ${name} berhasil dihapus.`, 'success');
                    loadData(); // Reload UI
                } catch(e) {
                    console.error(e);
                    showToast("Gagal menghapus siswa: " + e.message, 'error');
                }
            }
        };

        function showToast(msg, type='success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
            toast.innerHTML = `<i class="fa-solid ${icon}"></i><span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
