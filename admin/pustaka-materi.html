<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Pustaka Materi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar untuk tabel */
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- NAVBAR -->
    <nav class="bg-gradient-to-r from-blue-900 to-gray-900 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <img src="https://imgur.com/5Srjyo4.png" alt="Logo" class="w-10 h-10 rounded-full border-2 border-yellow-400">
                    <span class="text-yellow-400 font-bold text-xl tracking-wide">ADMIN PANEL (FIREBASE)</span>
                </div>
                <div>
                    <a href="index.html" class="text-blue-200 hover:text-white text-sm font-semibold transition">
                        <i class="fas fa-external-link-alt mr-1"></i> Lihat Website
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT (GRID LAYOUT) -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- KOLOM KIRI: FORM INPUT -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md overflow-hidden sticky top-24">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-bold text-gray-800" id="formTitle">
                            <i class="fas fa-plus-circle text-blue-600 mr-2"></i>Tambah Materi Baru
                        </h2>
                    </div>
                    
                    <div class="p-6">
                        <form id="uploadForm" class="space-y-4">
                            <!-- Hidden Input untuk Mode Edit (Menyimpan ID Dokumen Firebase) -->
                            <input type="hidden" id="editId">
                            <input type="hidden" id="existingCoverUrl">

                            <!-- Judul -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Judul Buku/Materi</label>
                                <input type="text" id="judul" required 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                    placeholder="Contoh: Modul Fisika X">
                            </div>

                            <!-- Kategori -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Kategori</label>
                                <select id="kategori" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                                    <option value="karya">Karya (Novel/Cerpen)</option>
                                    <option value="materi">Materi Pelajaran</option>
                                </select>
                            </div>

                            <!-- Cover Image -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Cover Buku</label>
                                <input type="file" id="fileCover" accept="image/*" 
                                    class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <p class="text-xs text-gray-500 mt-1" id="coverHelp">*Upload baru untuk mengganti.</p>
                                <!-- Preview kecil saat edit -->
                                <div id="coverPreview" class="hidden mt-2">
                                    <img src="" class="h-16 w-auto rounded border border-gray-300">
                                </div>
                            </div>

                            <!-- Link Drive -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Link Google Drive</label>
                                <input type="text" id="linkDrive" required 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                    placeholder="Paste link 'Anyone with the link'...">
                            </div>

                            <!-- Action Buttons -->
                            <div class="pt-2 flex gap-2">
                                <button type="submit" id="btnSubmit" 
                                    class="flex-1 bg-blue-900 text-yellow-400 font-bold py-2.5 rounded-lg hover:bg-blue-800 transition shadow flex justify-center items-center gap-2">
                                    <span id="btnText">SIMPAN</span>
                                    <i id="loadingIcon" class="fas fa-spinner fa-spin hidden"></i>
                                </button>
                                
                                <button type="button" id="btnCancel" onclick="resetForm()" 
                                    class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">
                                    Batal
                                </button>
                            </div>
                        </form>
                        
                        <div id="statusMsg" class="mt-4 text-center text-sm font-semibold"></div>
                    </div>
                </div>
            </div>

            <!-- KOLOM KANAN: TABEL DATA -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-list-ul text-blue-600 mr-2"></i>Daftar Materi (Real-time)
                        </h2>
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full" id="totalCount">Loading...</span>
                    </div>

                    <!-- Error Container (Ditingkatkan) -->
                    <div id="error-container" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 p-4 m-4 rounded shadow-sm" role="alert">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <p class="font-bold text-lg">Akses Ditolak (Permission Error)</p>
                                <div id="error-message" class="text-sm mt-1 whitespace-pre-line">Something went wrong.</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 text-sm uppercase tracking-wider">
                                    <th class="p-4 border-b">Cover</th>
                                    <th class="p-4 border-b">Info Materi</th>
                                    <th class="p-4 border-b">Kategori</th>
                                    <th class="p-4 border-b text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-sm text-gray-700 divide-y divide-gray-100">
                                <!-- Data akan di-render di sini oleh Firebase -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pesan Kosong -->
                    <div id="emptyState" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-2 text-gray-300"></i>
                        <p>Belum ada data materi.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- LOGIKA UTAMA (MODULE) -->
    <script type="module">
        // Import Firebase & Auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // 1. KONFIGURASI FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDooErB7K4vFtmC6-PcI30v82Vh6b85fPI",
            authDomain: "berbasis-ai.firebaseapp.com",
            projectId: "berbasis-ai",
            storageBucket: "berbasis-ai.firebasestorage.app",
            messagingSenderId: "962437652324",
            appId: "1:962437652324:web:4426a5efcabf72caebe471"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = 'pustaka_materi';

        const API_KEY_IMGBB = '2f45fcafb6dfb2dbae295499022ce476'; 
        
        let materialsData = [];

        // ==========================================
        // 2. LOGIKA UTAMA (AUTH + DATABASE)
        // ==========================================

        async function initApp() {
            try {
                // Login Anonim sebelum akses database
                await signInAnonymously(auth);
                console.log("Berhasil login anonim");

                // Mulai Listener Database setelah login sukses
                startDatabaseListener();
            } catch (error) {
                console.error("Gagal login: ", error);
                
                // Cek jika error karena Anonymous Auth belum aktif
                if (error.code === 'auth/admin-restricted-operation' || error.message.includes('enable')) {
                    showError(`Login Anonim belum diaktifkan! 
                    
                    Solusi:
                    1. Buka Firebase Console > Build > Authentication.
                    2. Klik tab "Sign-in method".
                    3. Aktifkan "Anonymous" (Enable).`);
                } else {
                    showError("Gagal inisialisasi Login. Periksa koneksi internet Anda.");
                }
            }
        }

        function startDatabaseListener() {
            const q = query(collection(db, COLLECTION_NAME));
            
            onSnapshot(q, (snapshot) => {
                materialsData = []; // Reset data lokal
                const tbody = document.getElementById('tableBody');
                const emptyState = document.getElementById('emptyState');
                const errorContainer = document.getElementById('error-container');
                
                errorContainer.classList.add('hidden'); // Sembunyikan error jika berhasil
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    emptyState.classList.remove('hidden');
                    document.getElementById('totalCount').innerText = `0 Item`;
                    return;
                }

                emptyState.classList.add('hidden');
                document.getElementById('totalCount').innerText = `${snapshot.size} Item`;

                // Proses data snapshot
                snapshot.forEach((doc) => {
                    const item = doc.data();
                    item.id = doc.id;
                    materialsData.push(item);
                });

                // Sorting Client-side (Terbaru di atas)
                materialsData.sort((a, b) => new Date(b.tanggal || 0) - new Date(a.tanggal || 0));

                // Render Tabel
                materialsData.forEach((item) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition";
                    tr.innerHTML = `
                        <td class="p-4 align-middle w-20">
                            <img src="${item.cover}" alt="cover" class="w-12 h-16 object-cover rounded shadow-sm bg-gray-200" onerror="this.src='https://via.placeholder.com/50'">
                        </td>
                        <td class="p-4 align-middle">
                            <p class="font-bold text-gray-900 line-clamp-1">${item.judul}</p>
                            <a href="${item.link}" target="_blank" class="text-xs text-blue-500 hover:underline truncate block max-w-[200px]">
                                <i class="fas fa-link mr-1"></i>Link Download
                            </a>
                            <span class="text-[10px] text-gray-400">ID: ...${item.id.slice(-5)}</span>
                        </td>
                        <td class="p-4 align-middle">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${item.kategori === 'karya' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}">
                                ${(item.kategori || '-').toUpperCase()}
                            </span>
                        </td>
                        <td class="p-4 align-middle text-center w-32">
                            <div class="flex justify-center gap-2">
                                <button onclick="startEdit('${item.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteItem('${item.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Hapus">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }, (error) => {
                console.error("Error Database: ", error);
                let msg = error.message;

                // DETEKSI ERROR SPESIFIK UNTUK MEMBERIKAN SOLUSI
                if(msg.includes("Missing or insufficient permissions")) {
                    msg = `Firebase memblokir akses karena "Rules" masih terkunci.
                    
                    SOLUSI WAJIB (Di Firebase Console):
                    1. Buka Project ${firebaseConfig.projectId} > Build > Firestore Database.
                    2. Klik tab "Rules".
                    3. Ganti kodenya menjadi:
                       allow read, write: if true;
                    4. Klik "Publish".`;
                } 
                else if(msg.includes("Cloud Firestore API has not been used")) {
                    msg = "Database belum dibuat. Buka Firebase Console > Firestore Database > Klik 'Create Database' > Pilih Test Mode.";
                }
                
                showError(msg);
            });
        }

        function showError(msg) {
            const errorContainer = document.getElementById('error-container');
            const errorMsg = document.getElementById('error-message');
            errorContainer.classList.remove('hidden');
            errorMsg.innerText = msg;
        }


        // ==========================================
        // 3. FUNGSI GLOBAL & HELPER
        // ==========================================

        window.getDirectLink = (url) => {
            const regex = /\/d\/([a-zA-Z0-9_-]+)/;
            const match = url.match(regex);
            return (match && match[1]) ? `https://drive.google.com/uc?export=download&id=${match[1]}` : null;
        }

        window.deleteItem = async (id) => {
            if(confirm("Yakin ingin menghapus materi ini?")) {
                try {
                    await deleteDoc(doc(db, COLLECTION_NAME, id));
                    if(document.getElementById('editId').value == id) window.resetForm();
                } catch (e) {
                    // Cek error permission saat delete juga
                    if(e.message.includes("Missing or insufficient permissions")) {
                        alert("Gagal Hapus! Atur Firestore Rules menjadi 'true' dulu di Console.");
                    } else {
                        alert("Gagal menghapus: " + e.message);
                    }
                }
            }
        }

        window.startEdit = (id) => {
            const item = materialsData.find(x => x.id === id);
            if(!item) return;

            document.getElementById('editId').value = item.id;
            document.getElementById('existingCoverUrl').value = item.cover;
            document.getElementById('judul').value = item.judul;
            document.getElementById('kategori').value = item.kategori;
            document.getElementById('linkDrive').value = item.link; 

            document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit text-orange-500 mr-2"></i>Edit Materi';
            document.getElementById('btnText').innerText = "UPDATE DATA";
            document.getElementById('btnSubmit').classList.replace('bg-blue-900', 'bg-orange-600');
            document.getElementById('btnCancel').classList.remove('hidden');
            
            const preview = document.getElementById('coverPreview');
            preview.classList.remove('hidden');
            preview.querySelector('img').src = item.cover;
            
            document.querySelector('.lg:col-span-1').scrollIntoView({ behavior: 'smooth' });
        }

        window.resetForm = () => {
            document.getElementById('uploadForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('existingCoverUrl').value = "";
            
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus-circle text-blue-600 mr-2"></i>Tambah Materi Baru';
            document.getElementById('btnText').innerText = "SIMPAN";
            document.getElementById('btnSubmit').classList.replace('bg-orange-600', 'bg-blue-900');
            document.getElementById('btnCancel').classList.add('hidden');
            document.getElementById('coverPreview').classList.add('hidden');
            document.getElementById('statusMsg').innerHTML = '';
        }

        // ==========================================
        // 4. SUBMIT HANDLER
        // ==========================================

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btnSubmit = document.getElementById('btnSubmit');
            const btnText = document.getElementById('btnText');
            const loadingIcon = document.getElementById('loadingIcon');
            const msg = document.getElementById('statusMsg');
            const editId = document.getElementById('editId').value; 

            btnSubmit.disabled = true;
            btnSubmit.classList.add('opacity-75');
            btnText.innerText = editId ? "Mengupdate..." : "Mengupload...";
            loadingIcon.classList.remove('hidden');

            try {
                const judul = document.getElementById('judul').value;
                const kategori = document.getElementById('kategori').value;
                const rawLink = document.getElementById('linkDrive').value;
                
                let finalLink = rawLink;
                if(rawLink.includes('drive.google.com/file') || rawLink.includes('drive.google.com/open')) {
                    const dlLink = window.getDirectLink(rawLink);
                    if (!dlLink) throw new Error('Link Google Drive tidak valid!');
                    finalLink = dlLink;
                }

                let imageUrl = document.getElementById('existingCoverUrl').value;
                const fileInput = document.getElementById('fileCover');

                if (fileInput.files.length > 0) {
                     const formData = new FormData();
                    formData.append('image', fileInput.files[0]);

                    const imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY_IMGBB}`, {
                        method: 'POST',
                        body: formData
                    });
                    const imgData = await imgRes.json();
                    if (!imgData.success) throw new Error('Gagal upload gambar ke ImgBB');
                    imageUrl = imgData.data.url;
                } else if (!editId && !imageUrl) {
                    throw new Error('Wajib upload cover buku!');
                }

                const dataToSave = {
                    judul: judul,
                    kategori: kategori,
                    cover: imageUrl,
                    link: finalLink,
                    tanggal: new Date().toISOString()
                };

                if (editId) {
                    const docRef = doc(db, COLLECTION_NAME, editId);
                    await updateDoc(docRef, dataToSave);
                    msg.innerHTML = `<span class="text-green-600">Berhasil diupdate!</span>`;
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), dataToSave);
                    msg.innerHTML = `<span class="text-green-600">Berhasil disimpan!</span>`;
                }
                
                window.resetForm();

            } catch (err) {
                console.error(err);
                if(err.message.includes("Missing or insufficient permissions")) {
                    msg.innerHTML = `<span class="text-red-600 font-bold">GAGAL: Firestore Rules terkunci. Cek kotak error merah di kanan.</span>`;
                } else {
                    msg.innerHTML = `<span class="text-red-600">Error: ${err.message}</span>`;
                }
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.classList.remove('opacity-75');
                btnText.innerText = editId ? "UPDATE DATA" : "SIMPAN";
                loadingIcon.classList.add('hidden');
            }
        });

        // Jalankan Aplikasi
        initApp();

    </script>
</body>
</html>
