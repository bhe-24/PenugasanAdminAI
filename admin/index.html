<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* Style Tambahan Khusus Admin */
        .formatting-toolbar { display: flex; gap: 5px; margin-bottom: 5px; background: #f8f9fa; padding: 5px; border-radius: 6px; border: 1px solid #ddd; }
        .format-btn { background: white; border: 1px solid #ccc; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; color: #333; }
        .format-btn:hover { background: #e2e6ea; }
        
        .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-ai:hover { filter: brightness(1.1); }

        /* Style Card Siswa yang lebih padat */
        .student-card { background: white; border: 1px solid #ddd; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nilai-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px; margin-top: 10px; }
        .nilai-grid input { text-align: center; padding: 8px; font-size: 0.9em; }
        .nilai-grid input.ujian { background-color: #e3f2fd; border-color: #90caf9; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa-solid fa-user-shield"></i> Portal Pengajar</h1>
            <p id="admin-greeting">Memuat data...</p>
        </div>

        <div id="view-menu" class="view-section">
            <div class="dashboard-grid">
                <div class="dashboard-card tugas" onclick="navTo('view-tugas')"> <i class="fa-solid fa-cogs"></i> <h3>Kelola Tugas</h3> </div>
                <div class="dashboard-card review" onclick="navTo('view-penilaian')"> <i class="fa-solid fa-marker"></i> <h3>Beri Nilai</h3> </div>
                <div class="dashboard-card kelola-profil" onclick="navTo('view-siswa')"> <i class="fa-solid fa-users-cog"></i> <h3>Data & Nilai Siswa</h3> </div>
                <div class="dashboard-card arsip" onclick="navTo('view-arsip')"> <i class="fa-solid fa-file-invoice"></i> <h3>Log Aktivitas</h3> </div>
                <a href="https://bhe-24.github.io/PustakaMateri/" target="_blank" class="dashboard-card pustaka"> <i class="fa-solid fa-book-atlas"></i> <h3>Pustaka Materi</h3> </a>
                <a href="https://bhe-24.github.io/PortalKuis/" target="_blank" class="dashboard-card kuis"> <i class="fa-solid fa-list-check"></i> <h3>Kelola Kuis</h3> </a>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button id="logout-btn" class="btn btn-danger" style="width:auto;">Keluar (Logout)</button>
            </div>
        </div>

        <div id="view-tugas" class="view-section hidden">
            <button class="btn btn-secondary" onclick="navTo('view-menu')" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Kelola Tugas Harian</h2>
            <div id="list-tugas-admin"></div> 
            <hr style="margin: 30px 0;">
            <h3><i class="fa-solid fa-plus-circle"></i> Buat/Edit Tugas</h3>
            <form id="form-tugas">
                <input type="hidden" id="edit-task-id">
                <div class="form-group"><label>Judul Tugas</label><input type="text" id="judul-tugas" required></div>
                <div class="form-group"><label>Mata Pelajaran</label><input type="text" id="matkul-tugas" required></div>
                <div class="form-group"><label>Tipe Tugas</label><select id="tipe-tugas" class="form-control"><option value="Esai">Esai (Teks)</option><option value="Dokumen">Upload Dokumen</option></select></div>
                <div class="form-group">
                    <label>Instruksi</label>
                    <div class="formatting-toolbar">
                        <button type="button" class="format-btn" onclick="insertFormat('instruksi-tugas', '<b>', '</b>')">Bold</button>
                        <button type="button" class="format-btn" onclick="insertFormat('instruksi-tugas', '<i>', '</i>')">Italic</button>
                        <button type="button" class="format-btn" onclick="insertTable('instruksi-tugas')">Tabel</button>
                    </div>
                    <textarea id="instruksi-tugas" rows="4" required placeholder="Gunakan toolbar untuk format teks..."></textarea>
                </div>
                <div class="form-group"><label>Deadline</label><input type="datetime-local" id="deadline-tugas" class="form-control" required></div>
                <div class="form-group"><label>Semester</label><select id="semester-tugas" class="form-control" required><option value="1">Semester 1</option><option value="2">Semester 2</option><option value="3">Semester 3</option></select></div>
                <button type="submit" class="btn btn-success">Simpan Tugas</button>
                <button type="button" id="cancel-edit-btn" class="btn btn-secondary hidden" style="margin-top:10px;">Batal Edit</button>
            </form>
        </div>

        <div id="view-penilaian" class="view-section hidden">
            <button class="btn btn-secondary" onclick="navTo('view-menu')" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Beri Nilai Tugas</h2>
            <div class="form-group"><label>Pilih Tugas:</label><select id="selector-tugas-nilai" class="form-control"></select></div>
            <div id="list-jawaban-siswa"></div>
        </div>

        <div id="view-siswa" class="view-section hidden">
            <button class="btn btn-secondary" onclick="navTo('view-menu')" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Data & Nilai Siswa</h2>
            
            <form id="form-tambah-siswa" style="background: #f1f1f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label><strong>Tambah Siswa Baru (via Email)</strong></label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <input type="email" id="add-student-email" class="form-control" placeholder="Email siswa..." required style="margin-bottom: 0;">
                    <button type="submit" class="btn btn-success" style="width: auto;"><i class="fa-solid fa-plus"></i> Tambah</button>
                </div>
            </form>

            <input type="text" id="search-siswa" class="form-control" placeholder="Cari nama atau email siswa..." style="margin-bottom: 20px;">
            <div id="list-profil-siswa" style="max-height: 800px; overflow-y: auto;"></div>
        </div>

        <div id="view-arsip" class="view-section hidden">
            <button class="btn btn-secondary" onclick="navTo('view-menu')" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Log Aktivitas KHS</h2>
            <div style="overflow-x: auto;">
                <table class="log-table" style="width: 100%; border-collapse: collapse;">
                    <thead><tr style="background: #eee;"><th style="padding: 10px; border: 1px solid #ddd;">Waktu</th><th style="padding: 10px; border: 1px solid #ddd;">Nama</th><th style="padding: 10px; border: 1px solid #ddd;">Aksi</th></tr></thead>
                    <tbody id="tbody-arsip"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="width: 50px; height: 50px; border: 5px solid #ccc; border-top-color: #005a9c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p id="loading-text" style="margin-top:20px; font-weight:bold;">Memuat...</p>
    </div>
    <div id="custom-modal" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:8px; max-width:500px; width:90%;">
            <h3 id="modal-title">Judul</h3><div id="modal-body" style="margin: 15px 0;">Isi</div>
            <div style="text-align: right;"><button id="modal-cancel" class="btn btn-secondary" style="width:auto; display:none; margin-right:10px;">Batal</button><button id="modal-confirm" class="btn" style="width:auto;">OK</button></div>
        </div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <script type="module">
        import { db, auth, checkAuth } from "../js/firebase-config.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, query, orderBy, getDocs, where, addDoc, updateDoc, deleteDoc, doc, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentUser = null;
        let allStudentsCache = []; // Cache untuk pencarian cepat
        const apiKey = "AIzaSyCTwRap6VyKlN9bhj7hWuyAxsdPp6DFc_Y"; 
        const GEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- NAVIGATION & UTILS ---
        window.navTo = (viewId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            if(viewId === 'view-tugas') loadTugas();
            if(viewId === 'view-penilaian') loadSelectorTugas();
            if(viewId === 'view-siswa') loadSiswa();
            if(viewId === 'view-arsip') loadArsip();
        };

        const showLoading = (msg) => { document.getElementById('loading-text').textContent = msg; document.getElementById('loading-overlay').style.display = 'flex'; };
        const hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';
        
        const showModal = (title, content, isConfirm = false) => {
            return new Promise(resolve => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = content;
                const modal = document.getElementById('custom-modal');
                modal.style.display = 'flex';
                const btnOk = document.getElementById('modal-confirm');
                const btnCancel = document.getElementById('modal-cancel');
                btnCancel.style.display = isConfirm ? 'inline-block' : 'none';
                
                btnOk.onclick = () => { modal.style.display = 'none'; resolve(true); };
                btnCancel.onclick = () => { modal.style.display = 'none'; resolve(false); };
            });
        };

        const nl2br = (str) => str ? str.replace(/\n/g, '<br>') : '';
        window.insertFormat = (id, s, e) => { const el = document.getElementById(id); const start = el.selectionStart; el.value = el.value.substring(0, start) + s + el.value.substring(start, el.selectionEnd) + e + el.value.substring(el.selectionEnd); };
        window.insertTable = (id) => { document.getElementById(id).value += `\n<table border="1"><tr><th>H1</th><th>H2</th></tr><tr><td>D1</td><td>D2</td></tr></table>\n`; };

        // --- INIT ---
        (async () => {
            showLoading('Memuat Portal...');
            currentUser = await checkAuth('pengajar');
            if(currentUser) {
                document.getElementById('admin-greeting').innerText = `Selamat datang, ${currentUser.name}`;
                hideLoading();
            }
        })();
        document.getElementById('logout-btn').onclick = async () => { await signOut(auth); window.location.href = '/'; };

        // --- 1. KELOLA TUGAS ---
        async function loadTugas() {
            const div = document.getElementById('list-tugas-admin');
            div.innerHTML = '<p>Memuat...</p>';
            try {
                const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                div.innerHTML = '';
                if(snap.empty) div.innerHTML = '<p>Belum ada tugas.</p>';
                snap.forEach(doc => {
                    const t = doc.data();
                    div.innerHTML += `
                        <div class="item-card" style="border:1px solid #ddd; padding:15px; margin-bottom:10px; border-radius:8px;">
                            <div style="display:flex; justify-content:space-between;">
                                <h3>${t.judul} <span style="font-size:0.8em; background:#007bff; color:white; padding:2px 5px; border-radius:4px;">Sem ${t.semester||1}</span></h3>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="window.editTask('${doc.id}')"><i class="fa fa-edit"></i></button>
                                    <button class="btn btn-danger btn-sm" onclick="window.deleteTask('${doc.id}')"><i class="fa fa-trash"></i></button>
                                </div>
                            </div>
                            <p style="color:#666;">${t.mapel} | Deadline: ${new Date(t.deadline).toLocaleString()}</p>
                        </div>`;
                });
            } catch(e) { console.error(e); }
        }

        document.getElementById('form-tugas').onsubmit = async (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-task-id').value;
            const payload = {
                judul: document.getElementById('judul-tugas').value,
                mapel: document.getElementById('matkul-tugas').value,
                tipe: document.getElementById('tipe-tugas').value,
                instruksi: document.getElementById('instruksi-tugas').value,
                deadline: document.getElementById('deadline-tugas').value,
                semester: parseInt(document.getElementById('semester-tugas').value),
                namaPengajar: currentUser.name
            };
            showLoading('Menyimpan...');
            if(editId) await updateDoc(doc(db, 'assignments', editId), payload);
            else { payload.createdAt = serverTimestamp(); await addDoc(collection(db, 'assignments'), payload); }
            document.getElementById('form-tugas').reset(); document.getElementById('edit-task-id').value = ''; 
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            hideLoading(); loadTugas();
        };

        window.deleteTask = async (id) => { if(await showModal('Hapus?', 'Yakin hapus?', true)) { await deleteDoc(doc(db, 'assignments', id)); loadTugas(); }};
        window.editTask = async (id) => { 
            alert('Silakan edit di form bawah'); 
            document.getElementById('edit-task-id').value = id; 
            document.getElementById('cancel-edit-btn').classList.remove('hidden'); 
        };
        document.getElementById('cancel-edit-btn').onclick = () => { document.getElementById('form-tugas').reset(); document.getElementById('edit-task-id').value = ''; document.getElementById('cancel-edit-btn').classList.add('hidden'); };

        // --- 2. PENILAIAN ---
        async function loadSelectorTugas() {
            const sel = document.getElementById('selector-tugas-nilai');
            sel.innerHTML = '<option value="">-- Pilih Tugas --</option>';
            const snap = await getDocs(query(collection(db, 'assignments'), orderBy('createdAt', 'desc')));
            snap.forEach(doc => {
                const d = doc.data();
                const opt = document.createElement('option');
                opt.value = doc.id; opt.text = `${d.judul} (Sem ${d.semester||1})`;
                opt.dataset.instruksi = encodeURIComponent(d.instruksi);
                sel.appendChild(opt);
            });
        }

        document.getElementById('selector-tugas-nilai').onchange = async (e) => {
            const taskId = e.target.value;
            const listDiv = document.getElementById('list-jawaban-siswa');
            listDiv.innerHTML = 'Memuat jawaban...';
            if(!taskId) { listDiv.innerHTML = ''; return; }
            const instruksi = decodeURIComponent(e.target.options[e.target.selectedIndex].dataset.instruksi);

            const snap = await getDocs(query(collection(db, 'submissions'), where('assignmentId', '==', taskId)));
            listDiv.innerHTML = '';
            if(snap.empty) { listDiv.innerHTML = '<p>Belum ada pengumpulan.</p>'; return; }

            snap.forEach(docSnap => {
                const s = {id: docSnap.id, ...docSnap.data()};
                const isGraded = s.nilai !== null && s.nilai !== undefined && s.nilai !== '';
                let content = s.fileUrl ? `<a href="${s.fileUrl}" target="_blank" class="btn btn-secondary">Download File</a>` : `<div style="background:#f9f9f9; padding:10px; max-height:200px; overflow-y:auto;">${nl2br(s.jawabanTeks)}</div>`;
                let btnAI = s.jawabanTeks ? `<button class="btn-ai" onclick="window.runAI('${s.id}', '${encodeURIComponent(s.jawabanTeks)}', '${encodeURIComponent(instruksi)}')"><i class="fa-solid fa-magic"></i> Auto-Grade AI</button>` : '';

                listDiv.innerHTML += `
                    <div style="border:1px solid #ccc; padding:15px; margin-bottom:15px; border-radius:8px; background:white;">
                        <h3>${s.studentName} <span style="font-size:0.8em; background:${isGraded?'#007bff':'#28a745'}; color:white; padding:2px 5px; border-radius:4px;">${isGraded?'Dinilai':'Baru'}</span></h3>
                        ${content} ${btnAI}
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <label>Nilai:</label> <input type="number" id="nilai-${s.id}" value="${s.nilai||''}" style="width:60px; padding:5px;">
                            <br><label>Feedback:</label> <textarea id="feedback-${s.id}" style="width:100%;" rows="3">${s.feedback||''}</textarea>
                            <button class="btn btn-success" style="margin-top:5px;" onclick="window.saveGrade('${s.id}')">Simpan Nilai</button>
                        </div>
                    </div>`;
            });
        };

        window.saveGrade = async (subId) => {
            const val = document.getElementById(`nilai-${subId}`).value;
            const fb = document.getElementById(`feedback-${subId}`).value;
            await updateDoc(doc(db, 'submissions', subId), { nilai: val, feedback: fb });
            alert("Nilai tersimpan!");
        };

        window.runAI = async (subId, ans, inst) => {
            showLoading('AI Menganalisis...');
            try {
                const prompt = `Peran: Guru. Instruksi: "${decodeURIComponent(inst)}". Jawaban: "${decodeURIComponent(ans)}". Output JSON: { "score": 0-100, "feedback": "HTML string" }`;
                const res = await fetch(GEN_API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const d = await res.json();
                const json = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                document.getElementById(`nilai-${subId}`).value = json.score;
                document.getElementById(`feedback-${subId}`).value = json.feedback;
                alert("Selesai!");
            } catch(e) { alert("AI Error: " + e.message); } finally { hideLoading(); }
        };

        // --- 3. KELOLA SISWA (FULL RESTORED LOGIC) ---
        async function loadSiswa() {
            const div = document.getElementById('list-profil-siswa');
            div.innerHTML = 'Memuat data siswa...';
            try {
                // Ambil SEMUA users dengan role siswa agar bisa disearch/ditampilkan
                const q = query(collection(db, 'users'), where('role', '==', 'siswa'));
                const snap = await getDocs(q);
                allStudentsCache = [];
                snap.forEach(d => allStudentsCache.push({id: d.id, ...d.data()}));
                
                // Sort by name
                allStudentsCache.sort((a,b) => a.name.localeCompare(b.name));
                renderStudentList(allStudentsCache);
            } catch(e) { console.error(e); div.innerHTML = 'Gagal memuat siswa.'; }
        }

        function renderStudentList(students) {
            const div = document.getElementById('list-profil-siswa');
            div.innerHTML = '';
            if(students.length === 0) { div.innerHTML = '<p>Tidak ada data siswa.</p>'; return; }

            students.forEach(u => {
                // Logic IPS
                const nilai = { t1: u.nilai_t1||'', t2: u.nilai_t2||'', t3: u.nilai_t3||'', t4: u.nilai_t4||'', t5: u.nilai_t5||'', t6: u.nilai_t6||'', t7: u.nilai_t7||'', t8: u.nilai_t8||'', uts: u.nilai_uts||'', uas: u.nilai_uas||'' };
                const displayIPS = parseFloat(u.ips||0).toFixed(2);

                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3 style="margin:0;">${u.name}</h3>
                            <p style="margin:2px 0; color:#666; font-size:0.9em;">${u.email} | HP: ${u.noHp || '-'}</p>
                        </div>
                        <div style="text-align:right;">
                            <label>IPS: </label> <strong style="font-size:1.2em; color:#005a9c;">${displayIPS}</strong>
                            <br><label>Sem: </label> <input type="number" id="sem-${u.id}" value="${u.semester||1}" style="width:40px; text-align:center;">
                        </div>
                    </div>
                    <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                    <label style="font-size:0.8em; font-weight:bold; color:#555;">INPUT NILAI (Tugas 1-8, UTS, UAS)</label>
                    <div class="nilai-grid">
                        <input type="number" id="t1-${u.id}" placeholder="T1" value="${nilai.t1}" title="Tugas 1">
                        <input type="number" id="t2-${u.id}" placeholder="T2" value="${nilai.t2}" title="Tugas 2">
                        <input type="number" id="t3-${u.id}" placeholder="T3" value="${nilai.t3}" title="Tugas 3">
                        <input type="number" id="t4-${u.id}" placeholder="T4" value="${nilai.t4}" title="Tugas 4">
                        <input type="number" id="t5-${u.id}" placeholder="T5" value="${nilai.t5}" title="Tugas 5">
                        <input type="number" id="t6-${u.id}" placeholder="T6" value="${nilai.t6}" title="Tugas 6">
                        <input type="number" id="t7-${u.id}" placeholder="T7" value="${nilai.t7}" title="Tugas 7">
                        <input type="number" id="t8-${u.id}" placeholder="T8" value="${nilai.t8}" title="Tugas 8">
                        <input type="number" id="uts-${u.id}" placeholder="UTS" value="${nilai.uts}" title="UTS" class="ujian">
                        <input type="number" id="uas-${u.id}" placeholder="UAS" value="${nilai.uas}" title="UAS" class="ujian">
                    </div>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <button class="btn btn-secondary btn-sm" onclick="window.hitungIPS('${u.id}')">Hitung IPS Preview</button>
                        <button class="btn btn-success btn-sm" style="flex:1;" onclick="window.updateSiswa('${u.id}')">Simpan Data & Nilai</button>
                    </div>
                `;
                div.appendChild(card);
            });
        }

        // Pencarian Realtime
        document.getElementById('search-siswa').onkeyup = (e) => {
            const key = e.target.value.toLowerCase();
            const filtered = allStudentsCache.filter(u => u.name.toLowerCase().includes(key) || u.email.includes(key));
            renderStudentList(filtered);
        };

        // Fungsi Hitung & Update
        window.getNilaiFromInputs = (uid) => {
            const keys = ['t1','t2','t3','t4','t5','t6','t7','t8','uts','uas'];
            let total = 0, count = 0;
            const data = {};
            keys.forEach(k => {
                const val = document.getElementById(`${k}-${uid}`).value;
                if(val && val.trim() !== '') {
                    const num = parseFloat(val);
                    data[`nilai_${k}`] = num;
                    total += num; count++;
                } else {
                    data[`nilai_${k}`] = null;
                }
            });
            return { data, avg: count > 0 ? total/count : 0 };
        };

        window.hitungIPS = (uid) => {
            const { avg } = window.getNilaiFromInputs(uid);
            const ips = (avg / 100) * 4; // Skala 4
            alert(`Preview IPS untuk siswa ini: ${ips.toFixed(2)}`);
        };

        window.updateSiswa = async (uid) => {
            showLoading('Menyimpan Data Siswa...');
            try {
                const { data, avg } = window.getNilaiFromInputs(uid);
                const semester = parseInt(document.getElementById(`sem-${uid}`).value) || 1;
                const ips = (avg / 100) * 4;

                const payload = { ...data, semester, ips };
                await updateDoc(doc(db, 'users', uid), payload);
                
                // Update cache lokal biar gak perlu refresh
                const idx = allStudentsCache.findIndex(u => u.id === uid);
                if(idx !== -1) Object.assign(allStudentsCache[idx], payload);
                
                alert(`Data berhasil disimpan! IPS Baru: ${ips.toFixed(2)}`);
                renderStudentList(allStudentsCache); // Re-render untuk update tampilan IPS
            } catch(e) { alert("Gagal update: " + e.message); }
            finally { hideLoading(); }
        };

        // Tambah Siswa Baru
        document.getElementById('form-tambah-siswa').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('add-student-email').value.toLowerCase();
            showLoading('Mencari...');
            try {
                const q = query(collection(db, 'users'), where('email', '==', email));
                const snap = await getDocs(q);
                if(snap.empty) { alert("Email belum terdaftar di sistem (User belum Register)."); }
                else {
                    const u = snap.docs[0];
                    if(u.data().role !== 'siswa') {
                        await updateDoc(doc(db, 'users', u.id), { role: 'siswa', semester: 1, ips: 0 });
                        alert("Role user diubah menjadi Siswa.");
                    } else { alert("User sudah menjadi siswa."); }
                    loadSiswa(); // Refresh list
                    document.getElementById('add-student-email').value = '';
                }
            } catch(err) { alert(err.message); }
            finally { hideLoading(); }
        };

        // --- 4. ARSIP LOG ---
        async function loadArsip() {
            const tbody = document.getElementById('tbody-arsip');
            tbody.innerHTML = '<tr><td colspan="3">Memuat...</td></tr>';
            const snap = await getDocs(query(collection(db, 'khs_access_logs'), orderBy('timestamp', 'desc'), limit(20)));
            tbody.innerHTML = '';
            snap.forEach(d => {
                const l = d.data();
                tbody.innerHTML += `<tr><td style="padding:10px; border:1px solid #ddd;">${l.timestamp?.toDate().toLocaleString()}</td><td style="padding:10px; border:1px solid #ddd;">${l.studentName}</td><td style="padding:10px; border:1px solid #ddd;">${l.action}</td></tr>`;
            });
        }
    </script>
</body>
</html>
