<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Tugas - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* 1. CONTAINER LEBIH LUAS */
        .container { 
            max-width: 1000px; /* Diperlebar agar tabel muat */
            margin: 0 auto; 
            padding: 20px; 
        }
        
        /* Card Utama */
        .detail-card {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-top: 20px;
            animation: fadeIn 0.5s ease;
            border-top: 5px solid #003366; /* Aksen Navy */
        }

        /* Header Tugas */
        .task-title { font-size: 2rem; color: #003366; margin-bottom: 5px; font-weight: 700; line-height: 1.2; }
        .task-meta { color: #666; font-size: 1rem; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .badge-deadline { background: #fff0f6; color: #d63384; padding: 4px 10px; border-radius: 8px; font-weight: 600; font-size: 0.9em; }

        /* --- 2. PERBAIKAN FORMAT INSTRUKSI (RICH TEXT) --- */
        .instruction-box {
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid #e9ecef;
            margin: 25px 0;
        }

        /* Kelas ini menangani HTML dari Admin (Tabel, Bold, List) */
        .rich-content {
            line-height: 1.8; /* Jarak antar baris lebih lega */
            font-size: 1.05rem; /* Font sedikit diperbesar */
            color: #2d3436;
        }
        
        /* Handling Tabel agar Responsif */
        .rich-content table {
            width: 100%; border-collapse: collapse; margin: 15px 0; background: white;
        }
        .rich-content th, .rich-content td {
            border: 1px solid #dfe6e9; padding: 12px; text-align: left;
        }
        .rich-content th { background-color: #003366; color: white; }
        .rich-content tr:nth-child(even) { background-color: #f1f2f6; }
        
        /* Agar tabel tidak merusak layout di HP -> Scroll ke samping */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 15px; }

        /* Handling List & Paragraf */
        .rich-content ul, .rich-content ol { padding-left: 25px; margin-bottom: 15px; }
        .rich-content p { margin-bottom: 15px; }
        .rich-content blockquote { border-left: 4px solid #003366; padding-left: 15px; color: #555; font-style: italic; }

        /* --- 3. PERBAIKAN FORMAT CATATAN/FEEDBACK (SPASI/ENTER) --- */
        .feedback-content {
            white-space: pre-wrap; /* KUNCI: Menghormati Enter/Spasi dari Guru */
            font-family: 'Segoe UI', sans-serif;
            color: #444;
            line-height: 1.6;
        }

        /* Status Styles */
        .status-box { padding: 30px; text-align: center; border-radius: 12px; margin-top: 30px; }
        .status-success { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .status-late { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        
        /* Nilai Container */
        .grade-container {
            background: linear-gradient(to right, #f8f9fa, #ffffff);
            border: 2px solid #003366;
            padding: 30px; border-radius: 15px; 
            margin-top: 30px;
            display: flex; align-items: center; gap: 30px;
        }
        
        .grade-circle {
            width: 90px; height: 90px; background: #003366;
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center;
            font-size: 2.2rem; font-weight: 800; color: white;
            flex-shrink: 0; box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
        }

        /* Responsif untuk HP */
        @media (max-width: 600px) {
            .detail-card { padding: 20px; }
            .task-title { font-size: 1.5rem; }
            .grade-container { flex-direction: column; text-align: center; }
            .instruction-box { padding: 15px; }
        }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary" style="width: auto; border-radius: 50px; padding: 8px 20px; font-weight:600;">
            <i class="fa-solid fa-arrow-left"></i> Kembali ke Daftar
        </a>

        <div id="loading" style="text-align: center; margin-top: 80px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 3rem; color: #ccc;"></i>
            <p style="margin-top: 15px; color: #666;">Sedang membuka lembar tugas...</p>
        </div>

        <div id="content-area" class="detail-card hidden">
            
            <h1 id="t-judul" class="task-title">Judul Tugas</h1>
            <div class="task-meta">
                <span><i class="fa-solid fa-book"></i> <span id="t-mapel">-</span></span>
                <span class="badge-deadline"><i class="fa-solid fa-clock"></i> Deadline: <span id="t-deadline">-</span></span>
            </div>

            <hr style="margin: 0; border-top: 1px dashed #ddd;">

            <h3 style="margin-top: 25px; color: #333;">Instruksi Pengerjaan:</h3>
            <div class="instruction-box">
                <div id="t-instruksi" class="rich-content"></div>
            </div>

            <div id="submission-area">
                
                <div id="view-graded" class="hidden grade-container">
                    <div class="grade-circle" id="val-grade">0</div>
                    
                    <div style="flex-grow: 1;">
                        <h4 style="margin: 0 0 10px 0; color: #003366;"><i class="fa-solid fa-comment-dots"></i> Catatan / Feedback:</h4>
                        <div id="val-feedback" class="feedback-content">-</div>
                    </div>
                </div>

                <div id="view-submitted" class="status-box status-success hidden">
                    <i class="fa-solid fa-paper-plane" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3 style="margin: 0;">Tugas Berhasil Terkirim!</h3>
                    <p style="margin: 10px 0;">Jawaban Anda aman di sistem. Silakan tunggu penilaian dari pengajar.</p>
                    <div style="margin-top:15px; font-size:0.9em; background:rgba(255,255,255,0.5); display:inline-block; padding:5px 15px; border-radius:50px;">
                        <i class="fa-solid fa-history"></i> <span id="sub-date"></span>
                    </div>
                </div>

                <div id="view-late" class="status-box status-late hidden">
                    <i class="fa-solid fa-lock" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3 style="margin: 0;">Tugas Ditutup</h3>
                    <p>Waktu pengumpulan telah berakhir.</p>
                </div>

                <form id="form-submit" class="hidden" style="margin-top: 40px; background:#fbfbfb; padding:25px; border-radius:12px; border:1px solid #eee;">
                    <h3 style="margin-top:0; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; color:#333;">
                        <i class="fa-solid fa-pen-fancy"></i> Lembar Jawab
                    </h3>
                    
                    <div id="input-text" class="hidden">
                        <label style="font-weight: 600; display:block; margin-bottom:8px;">Jawaban Esai:</label>
                        <textarea id="ans-text" class="form-control" rows="12" style="font-size:1rem; line-height:1.6;" placeholder="Ketik jawaban Anda di sini dengan lengkap..."></textarea>
                    </div>

                    <div id="input-file" class="hidden">
                        <label style="font-weight: 600; display:block; margin-bottom:8px;">Upload Dokumen:</label>
                        <div style="background: white; padding: 30px; border: 2px dashed #003366; text-align: center; border-radius: 12px; cursor:pointer;" onclick="document.getElementById('ans-file').click()">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: #003366; margin-bottom:10px;"></i>
                            <p style="margin: 0; font-weight:600;">Klik untuk pilih file</p>
                            <p style="margin: 5px 0 0; font-size: 0.85em; color: #666;">PDF, Word, JPG (Maks 2MB)</p>
                            <input type="file" id="ans-file" class="form-control" style="display:none;">
                            <p id="file-name-display" style="margin-top:10px; color:#28a745; font-weight:bold;"></p>
                        </div>
                    </div>

                    <button type="submit" id="btn-kirim" class="btn btn-success" style="margin-top: 25px; width: 100%; padding: 15px; font-size: 1.1rem; border-radius:10px; font-weight:bold;">
                        <i class="fa-solid fa-paper-plane"></i> Kirim Jawaban
                    </button>
                </form>

            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth, storage, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let currentUser = null;
        
        // Ambil ID dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');

        (async () => {
            currentUser = await checkAuth('siswa');
            if (!taskId) {
                alert("ID Tugas tidak ditemukan!");
                window.location.href = 'index.html';
                return;
            }
            if (currentUser) loadDetail();
        })();

        async function loadDetail() {
            try {
                // 1. Ambil Data Tugas
                const taskSnap = await getDoc(doc(db, 'assignments', taskId));
                if (!taskSnap.exists()) {
                    alert("Tugas tidak ditemukan.");
                    window.location.href = 'index.html';
                    return;
                }

                const task = taskSnap.data();
                const deadline = new Date(task.deadline);
                const isLate = new Date() > deadline;

                // Render Info
                document.getElementById('t-judul').innerText = task.judul;
                document.getElementById('t-mapel').innerText = task.mapel;
                document.getElementById('t-deadline').innerText = deadline.toLocaleString('id-ID', {
                    weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit'
                });
                
                // Render Instruksi (HTML) + Bungkus Tabel
                const instruksiEl = document.getElementById('t-instruksi');
                instruksiEl.innerHTML = task.instruksi;
                
                // Otomatis bungkus tabel dengan wrapper agar bisa scroll
                const tables = instruksiEl.querySelectorAll('table');
                tables.forEach(tbl => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-wrapper';
                    tbl.parentNode.insertBefore(wrapper, tbl);
                    wrapper.appendChild(tbl);
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');

                // 2. Cek Submission
                const q = query(collection(db, 'submissions'), 
                    where('assignmentId', '==', taskId),
                    where('studentUid', '==', currentUser.uid)
                );
                const subSnap = await getDocs(q);

                if (!subSnap.empty) {
                    // SUDAH KUMPUL
                    const sub = subSnap.docs[0].data();
                    
                    if (sub.nilai !== null && sub.nilai !== undefined && sub.nilai !== "") {
                        // SUDAH DINILAI
                        document.getElementById('view-graded').classList.remove('hidden');
                        document.getElementById('val-grade').innerText = sub.nilai;
                        document.getElementById('val-feedback').innerText = sub.feedback || "Tidak ada catatan.";
                    } else {
                        // MENUNGGU
                        document.getElementById('view-submitted').classList.remove('hidden');
                        const tgl = sub.submittedAt ? new Date(sub.submittedAt.seconds * 1000).toLocaleString() : '-';
                        document.getElementById('sub-date').innerText = "Waktu: " + tgl;
                    }
                } else if (isLate) {
                    document.getElementById('view-late').classList.remove('hidden');
                } else {
                    // FORM AKTIF
                    const form = document.getElementById('form-submit');
                    form.classList.remove('hidden');

                    if (task.tipe === 'Dokumen') {
                        document.getElementById('input-file').classList.remove('hidden');
                        document.getElementById('ans-file').required = true;
                        
                        // Fitur Tampil Nama File
                        document.getElementById('ans-file').onchange = function() {
                            if(this.files[0]) document.getElementById('file-name-display').innerText = "Terpilih: " + this.files[0].name;
                        };
                    } else {
                        document.getElementById('input-text').classList.remove('hidden');
                        document.getElementById('ans-text').required = true;
                    }
                }

            } catch (e) {
                console.error(e);
                alert("Gagal memuat data.");
            }
        }

        // Logic Kirim (Sama seperti sebelumnya)
        document.getElementById('form-submit').onsubmit = async (e) => {
            e.preventDefault();
            if(!confirm("Kirim jawaban sekarang?")) return;

            const btn = document.getElementById('btn-kirim');
            btn.disabled = true; 
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengirim...';

            try {
                const payload = {
                    assignmentId: taskId, studentUid: currentUser.uid, studentName: currentUser.name,
                    submittedAt: serverTimestamp(), nilai: null, feedback: ''
                };

                const fileInput = document.getElementById('ans-file');
                if (!document.getElementById('input-file').classList.contains('hidden') && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    if (file.size > 2 * 1024 * 1024) throw new Error("File max 2MB");
                    const sRef = ref(storage, `submissions/${taskId}/${currentUser.uid}_${file.name}`);
                    await uploadBytes(sRef, file);
                    payload.fileUrl = await getDownloadURL(sRef);
                    payload.fileName = file.name;
                } else {
                    payload.jawabanTeks = document.getElementById('ans-text').value;
                }

                await addDoc(collection(db, 'submissions'), payload);
                alert("Tugas Terkirim!");
                location.reload();
            } catch (err) {
                alert("Gagal: " + err.message);
                btn.disabled = false; btn.innerText = "Kirim Jawaban";
            }
        };
    </script>
</body>
</html>
