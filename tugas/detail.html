<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Tugas - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        .detail-card {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 20px;
        }
        
        .instruction-box {
            background: #f8f9fa; border: 1px solid #e9ecef;
            padding: 20px; border-radius: 10px; margin: 20px 0;
            line-height: 1.6;
        }

        /* Status Styles */
        .status-box { padding: 20px; text-align: center; border-radius: 10px; margin-top: 20px; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-late { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .grade-display { font-size: 3rem; font-weight: bold; color: #005a9c; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary" style="width: auto; border-radius: 50px;">
            <i class="fa-solid fa-arrow-left"></i> Kembali ke Daftar
        </a>

        <div id="loading" style="text-align: center; margin-top: 50px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: #ccc;"></i>
            <p>Memuat detail tugas...</p>
        </div>

        <div id="content-area" class="detail-card hidden">
            <h1 id="t-judul" style="margin-bottom: 5px; font-size: 1.8rem;">Loading...</h1>
            <p style="color: #666; margin-top: 0;">
                <i class="fa-solid fa-book"></i> <span id="t-mapel">-</span> | 
                <i class="fa-solid fa-hourglass-half"></i> Deadline: <span id="t-deadline" style="font-weight: bold; color: #d63384;">-</span>
            </p>

            <hr>

            <h4>Instruksi Pengerjaan:</h4>
            <div id="t-instruksi" class="instruction-box"></div>

            <div id="submission-area">
                
                <div id="view-graded" class="hidden" style="text-align: center; background: #f0f4ff; padding: 20px; border-radius: 10px;">
                    <p style="margin:0; font-weight: bold; color: #666;">NILAI TUGAS</p>
                    <div id="val-grade" class="grade-display">0</div>
                    <div style="text-align: left; background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Catatan Guru:</strong><br>
                        <span id="val-feedback" style="font-style: italic;">-</span>
                    </div>
                </div>

                <div id="view-submitted" class="status-box status-success hidden">
                    <i class="fa-solid fa-circle-check" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <h3>Tugas Terkirim!</h3>
                    <p>Jawaban Anda sudah masuk dan menunggu penilaian.</p>
                    <small id="sub-date"></small>
                </div>

                <div id="view-late" class="status-box status-late hidden">
                    <i class="fa-solid fa-lock" style="font-size: 2rem;"></i>
                    <h3>Tugas Ditutup</h3>
                    <p>Anda melewati batas waktu pengumpulan.</p>
                </div>

                <form id="form-submit" class="hidden" style="margin-top: 30px;">
                    <h3 style="border-top: 2px dashed #ddd; padding-top: 20px;">Kumpulkan Jawaban</h3>
                    
                    <div id="input-text" class="hidden">
                        <label>Jawaban Esai:</label>
                        <textarea id="ans-text" class="form-control" rows="10" placeholder="Ketik jawaban di sini..."></textarea>
                    </div>

                    <div id="input-file" class="hidden">
                        <label>Upload File (PDF/Doc/Img - Maks 2MB):</label>
                        <input type="file" id="ans-file" class="form-control">
                    </div>

                    <button type="submit" id="btn-kirim" class="btn btn-success" style="margin-top: 15px;">
                        <i class="fa-solid fa-paper-plane"></i> Kirim Sekarang
                    </button>
                </form>

            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth, storage, checkAuth } from "/js/firebase-config.js";
        import { doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let currentUser = null;
        
        // 1. AMBIL ID DARI URL (Contoh: detail.html?id=123)
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');

        (async () => {
            currentUser = await checkAuth('siswa');
            if (currentUser && taskId) {
                loadDetail();
            } else {
                alert("Tugas tidak ditemukan!");
                window.location.href = 'index.html';
            }
        })();

        async function loadDetail() {
            try {
                // A. Ambil Data Tugas
                const taskSnap = await getDoc(doc(db, 'assignments', taskId));
                
                if (!taskSnap.exists()) {
                    alert("Tugas sudah dihapus oleh guru.");
                    window.location.href = 'index.html';
                    return;
                }

                const task = taskSnap.data();
                const deadline = new Date(task.deadline);
                const isLate = new Date() > deadline;

                // Render Info Tugas
                document.getElementById('t-judul').innerText = task.judul;
                document.getElementById('t-mapel').innerText = task.mapel;
                document.getElementById('t-deadline').innerText = deadline.toLocaleString('id-ID');
                document.getElementById('t-instruksi').innerHTML = task.instruksi;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');

                // B. Cek Apakah Siswa Sudah Mengumpulkan?
                const q = query(collection(db, 'submissions'), 
                    where('assignmentId', '==', taskId),
                    where('studentUid', '==', currentUser.uid)
                );
                const subSnap = await getDocs(q);

                // --- LOGIKA TAMPILAN ---
                if (!subSnap.empty) {
                    // SUDAH KUMPUL
                    const sub = subSnap.docs[0].data();
                    
                    if (sub.nilai !== null && sub.nilai !== undefined && sub.nilai !== "") {
                        // SUDAH DINILAI
                        document.getElementById('view-graded').classList.remove('hidden');
                        document.getElementById('val-grade').innerText = sub.nilai;
                        document.getElementById('val-feedback').innerText = sub.feedback || "-";
                    } else {
                        // MENUNGGU NILAI
                        document.getElementById('view-submitted').classList.remove('hidden');
                        document.getElementById('sub-date').innerText = "Dikirim: " + new Date(sub.submittedAt.seconds * 1000).toLocaleString();
                    }
                } else if (isLate) {
                    // TELAT & BELUM KUMPUL
                    document.getElementById('view-late').classList.remove('hidden');
                } else {
                    // BOLEH MENGERJAKAN
                    const form = document.getElementById('form-submit');
                    form.classList.remove('hidden');

                    if (task.tipe === 'Dokumen') {
                        document.getElementById('input-file').classList.remove('hidden');
                        document.getElementById('ans-file').required = true;
                    } else {
                        document.getElementById('input-text').classList.remove('hidden');
                        document.getElementById('ans-text').required = true;
                    }
                }

            } catch (e) {
                console.error(e);
                alert("Gagal memuat data.");
            }
        }

        // --- LOGIKA SUBMIT ---
        document.getElementById('form-submit').onsubmit = async (e) => {
            e.preventDefault();
            if(!confirm("Kirim tugas ini? Anda tidak bisa mengubahnya nanti.")) return;

            const btn = document.getElementById('btn-kirim');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengupload...';

            try {
                const payload = {
                    assignmentId: taskId,
                    studentUid: currentUser.uid,
                    studentName: currentUser.name,
                    submittedAt: serverTimestamp(),
                    nilai: null,
                    feedback: ''
                };

                // Cek ada file gak
                const fileInput = document.getElementById('ans-file');
                if (!document.getElementById('input-file').classList.contains('hidden') && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    if (file.size > 2 * 1024 * 1024) throw new Error("File terlalu besar (Max 2MB)");

                    const storageRef = ref(storage, `submissions/${taskId}/${currentUser.uid}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    payload.fileUrl = await getDownloadURL(storageRef);
                    payload.fileName = file.name;
                } else {
                    payload.jawabanTeks = document.getElementById('ans-text').value;
                }

                await addDoc(collection(db, 'submissions'), payload);
                
                alert("Berhasil dikirim!");
                location.reload(); // Reload halaman ini biar status berubah

            } catch (err) {
                alert("Error: " + err.message);
                btn.disabled = false;
                btn.innerText = "Kirim Sekarang";
            }
        };
    </script>
</body>
</html>
