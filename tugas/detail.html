<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Tugas - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Card Utama */
        .detail-card {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        /* Box Instruksi */
        .instruction-box {
            background: #f8f9fa; border-left: 4px solid #003366;
            padding: 20px; border-radius: 4px; margin: 20px 0;
            line-height: 1.6; color: #333;
        }

        /* Status Styles */
        .status-box { padding: 30px; text-align: center; border-radius: 12px; margin-top: 30px; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-late { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* Tampilan Nilai */
        .grade-container {
            background: linear-gradient(135deg, #f6f8fb 0%, #eef2f7 100%);
            border: 1px solid #dce4ec;
            padding: 30px; border-radius: 15px; text-align: center;
            margin-top: 30px;
        }
        .grade-circle {
            width: 100px; height: 100px; background: white;
            border-radius: 50%; border: 5px solid #003366;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; font-weight: 800; color: #003366;
            margin: 0 auto 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .feedback-box {
            background: white; padding: 15px; border-radius: 8px;
            text-align: left; margin-top: 15px; border: 1px dashed #bbb;
        }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary" style="width: auto; border-radius: 50px; padding: 8px 20px;">
            <i class="fa-solid fa-arrow-left"></i> Kembali ke Daftar
        </a>

        <div id="loading" style="text-align: center; margin-top: 50px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 3rem; color: #ccc;"></i>
            <p style="margin-top: 15px; color: #666;">Sedang mengambil detail tugas...</p>
        </div>

        <div id="content-area" class="detail-card hidden">
            
            <h1 id="t-judul" style="margin-bottom: 5px; font-size: 1.8rem; color: #003366;">Judul Tugas</h1>
            <div style="color: #666; font-size: 0.95rem;">
                <i class="fa-solid fa-book"></i> <span id="t-mapel">-</span> &nbsp;|&nbsp; 
                <i class="fa-solid fa-calendar-days"></i> Deadline: <span id="t-deadline" style="font-weight: bold; color: #dc3545;">-</span>
            </div>

            <hr style="margin: 20px 0; border-top: 1px solid #eee;">

            <h4 style="margin-bottom: 10px;">Instruksi Pengerjaan:</h4>
            <div id="t-instruksi" class="instruction-box"></div>

            <div id="submission-area">
                
                <div id="view-graded" class="hidden grade-container">
                    <p style="margin:0; font-weight: bold; color: #666; letter-spacing: 1px;">NILAI ANDA</p>
                    <div class="grade-circle" id="val-grade">0</div>
                    <div class="feedback-box">
                        <strong><i class="fa-solid fa-comment-dots"></i> Catatan Pengajar:</strong><br>
                        <span id="val-feedback" style="font-style: italic; color: #555;">-</span>
                    </div>
                </div>

                <div id="view-submitted" class="status-box status-success hidden">
                    <i class="fa-solid fa-circle-check" style="font-size: 4rem; margin-bottom: 15px;"></i>
                    <h3 style="margin: 0;">Tugas Berhasil Terkirim!</h3>
                    <p style="margin: 10px 0;">Jawaban Anda sudah masuk sistem dan sedang menunggu penilaian pengajar.</p>
                    <small id="sub-date" style="color: #155724; font-weight: bold;"></small>
                </div>

                <div id="view-late" class="status-box status-late hidden">
                    <i class="fa-solid fa-lock" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3 style="margin: 0;">Tugas Ditutup</h3>
                    <p>Mohon maaf, Anda telah melewati batas waktu pengumpulan.</p>
                </div>

                <form id="form-submit" class="hidden" style="margin-top: 40px;">
                    <h3 style="border-bottom: 2px dashed #ddd; padding-bottom: 10px; margin-bottom: 20px;">
                        <i class="fa-solid fa-pen-to-square"></i> Lembar Jawab
                    </h3>
                    
                    <div id="input-text" class="hidden">
                        <label style="font-weight: 600;">Jawaban Esai:</label>
                        <textarea id="ans-text" class="form-control" rows="10" placeholder="Ketik jawaban Anda di sini secara lengkap..."></textarea>
                    </div>

                    <div id="input-file" class="hidden">
                        <label style="font-weight: 600;">Upload Dokumen:</label>
                        <div style="background: #f8f9fa; padding: 20px; border: 2px dashed #ccc; text-align: center; border-radius: 8px;">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem; color: #999;"></i>
                            <p style="margin: 10px 0; font-size: 0.9em; color: #666;">Format: PDF, Word, atau Gambar (Maks 2MB)</p>
                            <input type="file" id="ans-file" class="form-control">
                        </div>
                    </div>

                    <button type="submit" id="btn-kirim" class="btn btn-success" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 1.1rem;">
                        <i class="fa-solid fa-paper-plane"></i> Kirim Tugas
                    </button>
                </form>

            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth, storage, checkAuth } from "/js/firebase-config.js";
        import { doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let currentUser = null;
        
        // 1. AMBIL ID TUGAS DARI URL (browser address bar)
        // Contoh: website.com/tugas/detail.html?id=ABC12345
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');

        (async () => {
            currentUser = await checkAuth('siswa');
            
            if (!taskId) {
                alert("ID Tugas tidak ditemukan!");
                window.location.href = 'index.html';
                return;
            }

            if (currentUser) {
                loadDetail();
            }
        })();

        async function loadDetail() {
            try {
                // A. Ambil Data Tugas dari Database
                const taskRef = doc(db, 'assignments', taskId);
                const taskSnap = await getDoc(taskRef);
                
                if (!taskSnap.exists()) {
                    alert("Tugas tidak ditemukan atau sudah dihapus.");
                    window.location.href = 'index.html';
                    return;
                }

                const task = taskSnap.data();
                const deadline = new Date(task.deadline);
                const isLate = new Date() > deadline;

                // Render Info Tugas ke HTML
                document.getElementById('t-judul').innerText = task.judul;
                document.getElementById('t-mapel').innerText = task.mapel;
                document.getElementById('t-deadline').innerText = deadline.toLocaleString('id-ID', {
                    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                document.getElementById('t-instruksi').innerHTML = task.instruksi; // Render HTML (bold/italic)

                // Hilangkan Loading, Munculkan Konten
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');

                // B. Cek Status Pengumpulan Siswa
                const q = query(collection(db, 'submissions'), 
                    where('assignmentId', '==', taskId),
                    where('studentUid', '==', currentUser.uid)
                );
                const subSnap = await getDocs(q);

                // --- LOGIKA PENENTUAN TAMPILAN ---
                if (!subSnap.empty) {
                    // KONDISI 1: SUDAH MENGUMPULKAN
                    const sub = subSnap.docs[0].data();
                    
                    if (sub.nilai !== null && sub.nilai !== undefined && sub.nilai !== "") {
                        // SUDAH DINILAI GURU
                        document.getElementById('view-graded').classList.remove('hidden');
                        document.getElementById('val-grade').innerText = sub.nilai;
                        document.getElementById('val-feedback').innerText = sub.feedback || "Tidak ada catatan tambahan.";
                    } else {
                        // MENUNGGU PENILAIAN
                        document.getElementById('view-submitted').classList.remove('hidden');
                        const tgl = sub.submittedAt ? new Date(sub.submittedAt.seconds * 1000).toLocaleString() : 'Baru saja';
                        document.getElementById('sub-date').innerText = "Waktu Pengiriman: " + tgl;
                    }
                } else if (isLate) {
                    // KONDISI 2: BELUM KUMPUL & SUDAH TELAT
                    document.getElementById('view-late').classList.remove('hidden');
                } else {
                    // KONDISI 3: BELUM KUMPUL & MASIH BISA (FORM AKTIF)
                    const form = document.getElementById('form-submit');
                    form.classList.remove('hidden');

                    // Tentukan input mana yang muncul (Text atau File)
                    if (task.tipe === 'Dokumen') {
                        document.getElementById('input-file').classList.remove('hidden');
                        document.getElementById('ans-file').required = true;
                    } else {
                        document.getElementById('input-text').classList.remove('hidden');
                        document.getElementById('ans-text').required = true;
                    }
                }

            } catch (e) {
                console.error(e);
                alert("Terjadi kesalahan saat memuat data.");
            }
        }

        // --- LOGIKA KIRIM TUGAS ---
        document.getElementById('form-submit').onsubmit = async (e) => {
            e.preventDefault();
            
            if(!confirm("Apakah Anda yakin ingin mengirim tugas ini? Jawaban tidak dapat diubah setelah dikirim.")) return;

            const btn = document.getElementById('btn-kirim');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sedang Mengirim...';

            try {
                const payload = {
                    assignmentId: taskId,
                    studentUid: currentUser.uid,
                    studentName: currentUser.name,
                    submittedAt: serverTimestamp(),
                    nilai: null, // Awalnya null
                    feedback: ''
                };

                // Cek Input File
                const fileInput = document.getElementById('ans-file');
                if (!document.getElementById('input-file').classList.contains('hidden') && fileInput.files[0]) {
                    // Proses Upload File
                    const file = fileInput.files[0];
                    if (file.size > 2 * 1024 * 1024) throw new Error("Ukuran file terlalu besar (Maksimal 2MB)");

                    // Simpan ke Firebase Storage
                    const storageRef = ref(storage, `submissions/${taskId}/${currentUser.uid}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    payload.fileUrl = await getDownloadURL(storageRef);
                    payload.fileName = file.name;
                } else {
                    // Proses Teks
                    payload.jawabanTeks = document.getElementById('ans-text').value;
                }

                // Simpan Data ke Firestore
                await addDoc(collection(db, 'submissions'), payload);
                
                alert("Tugas berhasil dikirim!");
                location.reload(); // Refresh halaman agar status berubah

            } catch (err) {
                alert("Gagal mengirim: " + err.message);
                btn.disabled = false;
                btn.innerText = "Kirim Tugas";
            }
        };
    </script>
</body>
</html>
