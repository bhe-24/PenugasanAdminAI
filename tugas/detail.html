<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Tugas - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; color: #333; }
        
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* HEADER BACK BUTTON */
        .header-nav { margin-bottom: 20px; }
        .btn-back {
            display: inline-flex; align-items: center; gap: 8px;
            background: white; color: #555; padding: 10px 20px;
            border-radius: 50px; text-decoration: none; font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-back:hover { background: #e9ecef; transform: translateX(-3px); }

        /* KARTU UTAMA */
        .detail-card {
            background: white; border-radius: 16px; padding: 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 30px;
            border-top: 6px solid #003366; /* Warna Identitas */
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER TUGAS */
        .task-header h1 { font-size: 1.8rem; color: #003366; margin: 0 0 10px 0; font-weight: 700; }
        .task-meta { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; color: #666; font-size: 0.9rem; }
        .meta-item { display: flex; align-items: center; gap: 6px; background: #f8f9fa; padding: 6px 12px; border-radius: 8px; }
        .meta-item i { color: #003366; }
        
        .badge-deadline { color: #d63384; background: #fff0f6; font-weight: 600; }

        /* --- RICH TEXT CONTENT (INSTRUKSI) --- */
        .instruction-area {
            margin: 25px 0; padding: 20px;
            background-color: #fafbfc; border-radius: 12px; border: 1px solid #eef2f5;
        }
        .label-section { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 10px; display: block; }

        /* CSS untuk merapikan hasil HTML dari Admin */
        .rich-content { line-height: 1.8; color: #2d3436; }
        .rich-content h1, .rich-content h2, .rich-content h3 { color: #003366; margin-top: 15px; }
        .rich-content ul, .rich-content ol { padding-left: 20px; margin-bottom: 15px; }
        .rich-content p { margin-bottom: 15px; }
        .rich-content b, .rich-content strong { font-weight: 700; color: #000; }
        .rich-content i, .rich-content em { font-style: italic; }
        
        /* Tabel Responsif */
        .rich-content table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.95rem; }
        .rich-content th { background: #003366; color: white; padding: 10px; text-align: left; }
        .rich-content td { border: 1px solid #ddd; padding: 10px; }
        .table-wrapper { overflow-x: auto; }

        /* AREA STATUS / FEEDBACK */
        .status-container { margin-top: 30px; text-align: center; }
        
        .status-card {
            padding: 30px; border-radius: 12px; border: 1px dashed;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .status-success { background: #f0fff4; border-color: #c6f6d5; color: #276749; }
        .status-late { background: #fff5f5; border-color: #fed7d7; color: #c53030; }
        
        /* NILAI & FEEDBACK GURU */
        .grade-box {
            background: #fff; border: 2px solid #003366; border-radius: 16px;
            padding: 25px; display: flex; align-items: flex-start; gap: 20px; text-align: left;
            margin-top: 20px; box-shadow: 0 5px 15px rgba(0,51,102,0.08);
        }
        .grade-circle {
            background: #003366; color: white; width: 70px; height: 70px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; font-weight: 700; flex-shrink: 0;
        }
        .feedback-text {
            font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: #444; white-space: pre-wrap;
        }
        .feedback-text b { font-weight: 700; color: #000; }

        /* FORM SUBMIT */
        .submit-section { 
            background: #fdfdfd; padding: 25px; border-radius: 12px; border: 1px solid #eee; margin-top: 30px;
        }
        .upload-area {
            border: 2px dashed #003366; background: white; padding: 40px; border-radius: 12px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .upload-area:hover { background: #f0f7ff; border-color: #0056b3; }
        
        .form-control { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        .form-control:focus { border-color: #003366; outline: none; }

        .btn-submit {
            background: #28a745; color: white; border: none; padding: 15px; width: 100%;
            border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 20px;
            display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.2s;
        }
        .btn-submit:hover { background: #218838; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        /* --- CUSTOM MODAL (PENGGANTI ALERT) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px;
            text-align: center; transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 10px; color: #333; }
        .modal-text { color: #666; margin-bottom: 25px; font-size: 0.95rem; }
        
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { padding: 10px 25px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; }
        .btn-modal-primary { background: #003366; color: white; }
        .btn-modal-secondary { background: #e9ecef; color: #333; }

        .hidden { display: none !important; }
        @media(max-width: 600px) {
            .detail-card { padding: 20px; }
            .grade-box { flex-direction: column; align-items: center; text-align: center; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-nav">
            <a href="index.html" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i> Kembali
            </a>
        </div>

        <div id="loading" style="text-align: center; margin-top: 100px;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; color: #ccc;"></i>
            <p style="margin-top: 15px; color: #888;">Menyiapkan lembar tugas...</p>
        </div>

        <div id="content-area" class="detail-card hidden">
            
            <div class="task-header">
                <h1 id="t-judul">Judul Tugas</h1>
                <div class="task-meta">
                    <div class="meta-item"><i class="fa-solid fa-book-open"></i> <span id="t-mapel">-</span></div>
                    <div class="meta-item badge-deadline"><i class="fa-regular fa-clock"></i> <span id="t-deadline">-</span></div>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px dashed #ddd;">

            <div class="instruction-area">
                <span class="label-section">Instruksi Pengerjaan:</span>
                <div id="t-instruksi" class="rich-content"></div>
            </div>

            <div id="submission-area">
                
                <div id="view-graded" class="hidden grade-box">
                    <div class="grade-circle" id="val-grade">0</div>
                    <div style="flex:1;">
                        <h4 style="margin: 0 0 10px 0; color: #003366;">Ulasan Pengajar:</h4>
                        <div id="val-feedback" class="feedback-text">-</div>
                    </div>
                </div>

                <div id="view-submitted" class="status-card status-success hidden">
                    <i class="fa-solid fa-circle-check" style="font-size: 3rem; margin-bottom: 15px; color: #276749;"></i>
                    <h3 style="margin: 0;">Tugas Berhasil Terkirim!</h3>
                    <p>Jawaban Anda sudah masuk sistem pada <b id="sub-date"></b>.</p>
                    <p style="font-size: 0.9em; opacity: 0.8;">Menunggu penilaian guru.</p>
                </div>

                <div id="view-late" class="status-card status-late hidden">
                    <i class="fa-solid fa-lock" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>Tugas Ditutup</h3>
                    <p>Waktu pengerjaan telah berakhir.</p>
                </div>

                <form id="form-submit" class="submit-section hidden">
                    <span class="label-section" style="color:#003366; margin-bottom: 15px; display:block;">
                        <i class="fa-solid fa-pen-nib"></i> Lembar Jawab Siswa
                    </span>

                    <div id="input-text" class="hidden">
                        <textarea id="ans-text" class="form-control" rows="10" placeholder="Tulis jawaban Anda di sini..."></textarea>
                    </div>

                    <div id="input-file" class="hidden">
                        <div class="upload-area" onclick="document.getElementById('ans-file').click()">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2.5rem; color: #003366; margin-bottom: 10px;"></i>
                            <h4 style="margin:0;">Pilih File Tugas</h4>
                            <p style="font-size: 0.9em; color: #666; margin-top:5px;">PDF, Word, atau Gambar (Max 5MB)</p>
                            <input type="file" id="ans-file" style="display: none;">
                            <p id="file-name-display" style="margin-top: 15px; font-weight: 600; color: #28a745;"></p>
                        </div>
                    </div>

                    <button type="submit" id="btn-kirim" class="btn-submit">
                        <i class="fa-solid fa-paper-plane"></i> Kirim Jawaban
                    </button>
                </form>

            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-icon" class="modal-icon"></div>
            <div id="modal-title" class="modal-title"></div>
            <div id="modal-text" class="modal-text"></div>
            <div id="modal-actions" class="modal-btns"></div>
        </div>
    </div>

    <script type="module">
        import { db, auth, storage, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let currentUser = null;
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');

        // --- FUNGSI MODAL MODERN ---
        function showModal(type, title, text, onConfirm = null) {
            const overlay = document.getElementById('custom-modal');
            const iconEl = document.getElementById('modal-icon');
            const actionsEl = document.getElementById('modal-actions');
            
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            
            // Icon Setup
            if(type === 'success') { iconEl.innerHTML = 'ðŸŽ‰'; }
            else if(type === 'error') { iconEl.innerHTML = 'âš ï¸'; }
            else { iconEl.innerHTML = 'ðŸ¤”'; } // Confirm

            // Buttons Setup
            actionsEl.innerHTML = '';
            if (onConfirm) {
                // Mode Confirm
                const btnCancel = document.createElement('button');
                btnCancel.className = 'btn-modal btn-modal-secondary';
                btnCancel.innerText = 'Batal';
                btnCancel.onclick = () => overlay.classList.remove('active');
                
                const btnOk = document.createElement('button');
                btnOk.className = 'btn-modal btn-modal-primary';
                btnOk.innerText = 'Ya, Kirim';
                btnOk.onclick = () => { overlay.classList.remove('active'); onConfirm(); };
                
                actionsEl.append(btnCancel, btnOk);
            } else {
                // Mode Alert Biasa
                const btnOk = document.createElement('button');
                btnOk.className = 'btn-modal btn-modal-primary';
                btnOk.innerText = 'Tutup';
                btnOk.onclick = () => overlay.classList.remove('active');
                actionsEl.appendChild(btnOk);
            }
            
            overlay.classList.add('active');
        }

        // --- MAIN LOGIC ---
        (async () => {
            currentUser = await checkAuth('siswa');
            if (!taskId) {
                showModal('error', 'Error', 'ID Tugas tidak ditemukan.');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }
            if (currentUser) loadDetail();
        })();

        async function loadDetail() {
            try {
                // 1. Ambil Tugas
                const taskSnap = await getDoc(doc(db, 'assignments', taskId));
                if (!taskSnap.exists()) {
                    showModal('error', '404', 'Tugas tidak ditemukan.');
                    return;
                }

                const task = taskSnap.data();
                const deadline = new Date(task.deadline);
                const isLate = new Date() > deadline;

                // Render Data Tugas
                document.getElementById('t-judul').innerText = task.judul;
                document.getElementById('t-mapel').innerText = task.mapel;
                document.getElementById('t-deadline').innerText = deadline.toLocaleString('id-ID', {
                    weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit'
                });

                // RENDER INSTRUKSI (HTML Enabled)
                // KUNCI: Pakai innerHTML agar format Bold/Italic/Table dari admin muncul
                const instruksiEl = document.getElementById('t-instruksi');
                instruksiEl.innerHTML = task.instruksi; 

                // Tweak Tabel (Bungkus agar bisa scroll di HP)
                instruksiEl.querySelectorAll('table').forEach(tbl => {
                    const wrap = document.createElement('div');
                    wrap.className = 'table-wrapper';
                    tbl.parentNode.insertBefore(wrap, tbl);
                    wrap.appendChild(tbl);
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');

                // 2. Cek Submission Siswa
                const q = query(collection(db, 'submissions'), 
                    where('assignmentId', '==', taskId),
                    where('studentUid', '==', currentUser.uid)
                );
                const subSnap = await getDocs(q);

                if (!subSnap.empty) {
                    // SUDAH KUMPUL
                    const sub = subSnap.docs[0].data();
                    
                    if (sub.nilai !== null && sub.nilai !== undefined && sub.nilai !== "") {
                        // SUDAH DINILAI
                        document.getElementById('view-graded').classList.remove('hidden');
                        document.getElementById('val-grade').innerText = sub.nilai;
                        // Feedback pakai innerHTML untuk support rich text dari guru (bold/italic)
                        document.getElementById('val-feedback').innerHTML = sub.feedback || "<i>Tidak ada catatan.</i>";
                    } else {
                        // MENUNGGU PENILAIAN
                        document.getElementById('view-submitted').classList.remove('hidden');
                        const tgl = sub.submittedAt ? new Date(sub.submittedAt.seconds * 1000).toLocaleString('id-ID') : '-';
                        document.getElementById('sub-date').innerText = tgl;
                    }
                } else if (isLate) {
                    // TERLAMBAT (Belum kumpul & waktu habis)
                    document.getElementById('view-late').classList.remove('hidden');
                } else {
                    // FORM PENGUMPULAN AKTIF
                    const form = document.getElementById('form-submit');
                    form.classList.remove('hidden');

                    if (task.tipe === 'Dokumen') {
                        document.getElementById('input-file').classList.remove('hidden');
                        document.getElementById('ans-file').onchange = function() {
                            if(this.files[0]) document.getElementById('file-name-display').innerText = "ðŸ“„ " + this.files[0].name;
                        };
                    } else {
                        document.getElementById('input-text').classList.remove('hidden');
                    }
                }

            } catch (e) {
                console.error(e);
                showModal('error', 'Gagal', 'Terjadi kesalahan memuat data.');
            }
        }

        // --- LOGIC KIRIM ---
        document.getElementById('form-submit').onsubmit = (e) => {
            e.preventDefault();
            
            // Validasi Sederhana
            const fileIn = document.getElementById('ans-file');
            const textIn = document.getElementById('ans-text');
            const isFile = !document.getElementById('input-file').classList.contains('hidden');

            if (isFile && !fileIn.files[0]) { showModal('error','','Pilih file dulu!'); return; }
            if (!isFile && !textIn.value.trim()) { showModal('error','','Jawaban tidak boleh kosong!'); return; }

            // Panggil Modal Konfirmasi
            showModal('confirm', 'Kirim Jawaban?', 'Pastikan jawaban sudah benar sebelum dikirim.', async () => {
                
                const btn = document.getElementById('btn-kirim');
                btn.disabled = true; 
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengirim...';

                try {
                    const payload = {
                        assignmentId: taskId, studentUid: currentUser.uid, studentName: currentUser.name,
                        submittedAt: serverTimestamp(), nilai: null, feedback: ''
                    };

                    if (isFile) {
                        const file = fileIn.files[0];
                        if (file.size > 5 * 1024 * 1024) throw new Error("Ukuran file maksimal 5MB");
                        
                        const sRef = ref(storage, `submissions/${taskId}/${currentUser.uid}_${file.name}`);
                        await uploadBytes(sRef, file);
                        payload.fileUrl = await getDownloadURL(sRef);
                        payload.fileName = file.name;
                    } else {
                        payload.jawabanTeks = textIn.value;
                    }

                    await addDoc(collection(db, 'submissions'), payload);
                    
                    showModal('success', 'Berhasil!', 'Tugas Anda telah terkirim.');
                    setTimeout(() => location.reload(), 1500);

                } catch (err) {
                    showModal('error', 'Gagal', err.message);
                    btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Kirim Jawaban';
                }
            });
        };
    </script>
</body>
</html>
