<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="google-site-verification" content="91izMJQVYKyBzhErFCy_uln92gdID9V-Ugv1hPUozgo" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Akademik - Cendekia Aksara (AI Integrated)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap'); /* Untuk Judul KHS */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css');

        :root {
            --primary-color: #005a9c; --secondary-color: #003366; --accent-color: #f7a04a;
            --success-color: #28a745; --danger-color: #dc3545; --light-bg: #f0f4f8;
            --white-color: #ffffff; --gray-color: #6c757d; --light-gray: #e9ecef;
            --dark-text: #343a40; --border-radius: 12px; --shadow: 0 8px 30px rgba(0, 40, 80, 0.1);
            --khs-border-color: #1a365d; /* Biru tua untuk border KHS */
        }

        body {
            font-family: 'Poppins', sans-serif; background-color: var(--light-bg); margin: 0;
            padding: 20px; color: var(--dark-text); line-height: 1.6;
        }

        .container {
            max-width: 800px; margin: auto; background: var(--white-color); padding: 30px;
            border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; position: relative;
        }

        .header {
            text-align: center; margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
        }
        .header h1 {
            color: var(--secondary-color); margin: 0; font-size: 2.2em; display: flex;
            align-items: center; justify-content: center; gap: 10px;
        }
        .header h1 i { color: var(--accent-color); }
        .header p { color: var(--gray-color); margin-top: 5px; }

        .hidden { display: none !important; }

        .btn {
            display: inline-block; width: 100%; padding: 12px 20px; border: none;
            border-radius: 8px; color: var(--white-color); background-color: var(--primary-color);
            font-weight: 600; cursor: pointer; text-align: center; transition: all 0.3s ease; box-sizing: border-box; text-decoration: none;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 90, 156, 0.3); }
        .btn:disabled { background-color: var(--gray-color); cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: var(--gray-color); }
        
        /* [BARU] Style Tombol AI */
        .btn-ai { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            display: flex; justify-content: center; align-items: center; gap: 8px;
            margin-bottom: 15px;
            width: 100%;
        }
        .btn-ai:hover { filter: brightness(1.1); }

        /* [BARU] Style Toolbar Format Teks */
        .formatting-toolbar {
            display: flex; gap: 5px; margin-bottom: 5px; background: #f8f9fa; padding: 5px; border-radius: 6px; border: 1px solid #ddd;
        }
        .format-btn {
            background: white; border: 1px solid #ccc; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; color: #333;
        }
        .format-btn:hover { background: #e2e6ea; }

        .btn-icon { width: auto; }
        .btn-sm { padding: 8px 12px; font-size: 0.9em; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea, .form-control {
            width: 100%; padding: 12px; border: 1px solid #ccc;
            border-radius: 8px; box-sizing: border-box; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus, .form-control:focus { outline: none; border-color: var(--primary-color); }
        .toggle-auth { text-align: center; margin-top: 15px; cursor: pointer; color: var(--primary-color); font-weight: 500; }

        h2, h3 { color: var(--secondary-color); text-align: center; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .dashboard-card {
            background-color: var(--secondary-color); color: var(--white-color);
            padding: 30px; border-radius: var(--border-radius); text-align: center;
            cursor: pointer; transition: all 0.3s ease; text-decoration: none;
        }
        .dashboard-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15); }
        .dashboard-card i { font-size: 3em; margin-bottom: 15px; }
        .dashboard-card h3 { color: var(--white-color); margin: 0; }
        .dashboard-card.tugas { background-image: linear-gradient(45deg, #005a9c, #007bff); }
        .dashboard-card.kuis { background-image: linear-gradient(45deg, #28a745, #20c997); }
        .dashboard-card.ujian { background-image: linear-gradient(45deg, #f7a04a, #ffc107); }
        .dashboard-card.review { background-image: linear-gradient(45deg, #6610f2, #6f42c1); }
        .dashboard-card.profil { background-image: linear-gradient(45deg, #17a2b8, #20c997); }
        .dashboard-card.kelola-profil { background-image: linear-gradient(45deg, #343a40, #6c757d); }
        .dashboard-card.kartu-studi { background-image: linear-gradient(45deg, #6f42c1, #e83e8c); }
        .dashboard-card.arsip { background-image: linear-gradient(45deg, #374151, #1f2937); }
        .dashboard-card.pustaka { background-image: linear-gradient(45deg, #fd7e14, #d63384); }

        .khs-wrapper { width: 100%; overflow-x: auto; padding: 10px 0; background-color: #f5f5f5; border-radius: 8px; display: flex; justify-content: center; }
        .khs-container { background: white; border: 5px solid var(--khs-border-color); padding: 40px 30px 20px 30px; font-family: 'Times New Roman', serif; color: black; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.1); width: 560px; min-width: 560px; min-height: 794px; box-sizing: border-box; margin: 0 auto; }
        .khs-header { text-align: center; margin-bottom: 30px; }
        .khs-header h2 { font-family: 'Merriweather', serif; font-size: 24pt; color: var(--khs-border-color); margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .khs-header p { font-family: 'Times New Roman', serif; font-size: 14pt; font-weight: bold; color: var(--khs-border-color); margin: 5px 0 0 0; }
        .khs-student-info { margin-bottom: 20px; font-size: 12pt; font-weight: bold; color: var(--khs-border-color); }
        .khs-student-info table { width: 100%; border: none; }
        .khs-student-info td { padding: 2px 0; vertical-align: top; }
        .khs-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 2px solid var(--khs-border-color); }
        .khs-table th, .khs-table td { border: 2px solid var(--khs-border-color); padding: 8px 5px; text-align: center; font-size: 11pt; }
        .khs-table th { background-color: var(--khs-border-color); color: white; font-weight: bold; text-transform: uppercase; }
        .khs-table td:nth-child(2) { text-align: center; }
        .khs-watermark { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); opacity: 0.08; z-index: 0; width: 250px; height: auto; pointer-events: none; }
        .khs-footer { margin-top: 20px; font-weight: bold; color: var(--khs-border-color); font-size: 12pt; }
        .khs-signature-section { display: flex; justify-content: flex-end; margin-top: 30px; margin-bottom: 30px; }
        .signature-box { text-align: center; width: 250px; color: var(--khs-border-color); position: relative; }
        .signature-stamp { position: absolute; top: 0px; left: 50%; transform: translateX(-50%) rotate(-5deg); width: 110px; height: auto; z-index: 1; }
        .khs-bottom-bar { background-color: var(--khs-border-color); color: white; padding: 10px 15px; font-size: 9pt; text-align: left; margin-top: 20px; margin-left: -30px; margin-right: -30px; margin-bottom: -20px; font-family: 'Poppins', sans-serif; }

        .item-card, .grading-card { border: 1px solid var(--light-gray); padding: 20px; border-radius: var(--border-radius); margin-bottom: 15px; background: #fdfdfd; transition: all 0.3s ease; animation: fadeIn 0.5s ease; position: relative; }
        .item-card.clickable { cursor: pointer; }
        .item-card.clickable:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); border-left: 5px solid var(--accent-color); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-header h3 { margin: 0 0 10px; text-align: left; color: var(--secondary-color); }
        .item-card p, .grading-card p { text-align: left; margin: 4px 0; font-size: 0.9em; color: var(--gray-color); }
        .card-actions { display: flex; gap: 10px; margin-top: 15px; }
        .tag { display: inline-block; padding: 4px 12px; border-radius: 50px; font-size: 0.8em; font-weight: 600; color: var(--white-color); }
        .tag-green { background-color: var(--success-color); }
        .tag-blue { background-color: var(--primary-color); }
        .tag-gray { background-color: var(--gray-color); }
        .tag-orange { background-color: var(--accent-color); }
        .tag-red { background-color: var(--danger-color); }
        .submitted-icon { position: absolute; top: 15px; right: 15px; font-size: 1.5em; color: var(--success-color); }
        .grading-card .form-group { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .grading-card .form-group input { width: 100px; }
        .grading-card .form-group textarea { flex: 1; min-width: 200px; }
        .grading-card-footer { text-align: right; }
        .download-link { padding: 5px 10px; font-size: 0.9em; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }

        .submission-success-view { text-align: center; padding: 40px 20px; border: 2px dashed var(--success-color); border-radius: var(--border-radius); background-color: #f8fdfd; }
        .submission-success-view i { font-size: 3em; color: var(--success-color); margin-bottom: 20px; }
        .submission-success-view h3 { color: var(--secondary-color); }
        .submission-success-view p { color: var(--dark-text); font-style: italic; }
        .submission-success-view button { margin-top: 20px; }

        .profile-info { text-align: center; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px auto; display: flex; justify-content: center; align-items: center; font-size: 2.5em; font-weight: bold; color: white; position: relative; transition: all 0.3s ease; }
        .profile-pic.good { background: linear-gradient(135deg, #28a745, #20c997); }
        .profile-pic.warning { background: linear-gradient(135deg, #f7a04a, #ffc107); animation: pulse 2s infinite; }
        .profile-pic.warning::after { content: '\f071'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; bottom: -10px; right: -5px; background: var(--danger-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .ips-warning { background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-top: 15px; color: #856404; font-size: 0.9em; display: flex; align-items: center; gap: 10px; }
        .ips-warning i { color: var(--accent-color); font-size: 1.2em; }
        
        .profile-info h3 { margin: 0; }
        .profile-info p { color: var(--gray-color); margin-bottom: 25px; }
        .profile-details { text-align: left; }
        .profile-details .detail-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--light-gray); }
        .profile-details .detail-item strong { color: var(--dark-text); }
        .profile-details .detail-item span { color: var(--primary-color); font-weight: 600; }

        #search-user-input { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; }
        #add-student-form { display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; background-color: var(--light-bg); border-radius: 8px; }
        #add-student-email { flex-grow: 1; margin-bottom: 0 !important; }
        #add-student-btn { width: auto; flex-shrink: 0; }

        .user-profile-card { border: 1px solid var(--light-gray); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .user-profile-card h4 { margin: 0 0 10px 0; text-align: left; }
        .user-profile-card .form-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .user-profile-card .form-group input[type="number"] { width: 80px; }
        .user-profile-card .form-group button { width: auto; }
        .user-profile-card .form-group label { flex-basis: 100px; font-weight: 600; margin-bottom: 0; }

        .log-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .log-table th, .log-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .log-table th { background-color: var(--secondary-color); color: white; }
        .log-table tr:nth-child(even) { background-color: #f9f9f9; }
        .log-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8em; }
        .log-view { background-color: #e3f2fd; color: #0d47a1; }
        .log-download { background-color: #e8f5e9; color: #1b5e20; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .progress-spinner { width: 60px; height: 60px; border-radius: 50%; border: 4px solid var(--light-gray); border-top-color: var(--primary-color); animation: spin 1s linear infinite; }
        #loading-overlay p { margin-top: 20px; font-size: 1.2em; font-weight: 600; color: var(--secondary-color); }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal { position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: var(--border-radius); box-shadow: var(--shadow); animation: fadeIn 0.3s; }
        .modal-header { padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; text-align: left; font-size: 1.5em; }
        .modal-body { margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
        .modal-footer { text-align: right; }
        .modal-footer button { width: auto; margin-left: 10px; }
        
        /* [BARU] Style untuk tabel di dalam konten feedback/instruksi */
        .rich-content table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .rich-content th, .rich-content td { border: 1px solid #ccc; padding: 5px; }
        .rich-content th { background: #eee; }

        @media (max-width: 768px) {
            body { padding: 0; }
            .container { box-shadow: none; border-radius: 0; padding: 20px 15px; min-height: 100vh; }
            .header h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
            .dashboard-card { padding: 25px; }
            .item-card, .grading-card { padding: 15px; }
            .btn { padding: 14px 20px; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-actions { margin-top: 10px; }
            #add-student-form { flex-direction: column; }
            #add-student-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="main-header"><i class="fa-solid fa-book-open-reader"></i> Cendekia Aksara</h1>
            <p id="sub-header">Portal Akademik Terpadu</p>
        </div>

        <!-- Tampilan Autentikasi -->
        <div id="auth-view" class="view">
            <div id="login-form-container">
                <h2>Masuk ke Portal</h2>
                <form id="login-form">
                    <div class="form-group"><label for="username">Email</label><input type="email" id="username" required></div>
                    <div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <p class="toggle-auth" id="show-register-link">Belum punya akun? Daftar di sini.</p>
            </div>
            <div id="register-form-container" class="hidden">
                <h2>Daftar Akun Baru</h2>
                <form id="register-form">
                    <div class="form-group"><label for="register-name">Nama Lengkap</label><input type="text" id="register-name" required></div>
                    <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                    <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required minlength="6"></div>
                    <button type="submit" class="btn">Daftar</button>
                </form>
                <p class="toggle-auth" id="show-login-link">Sudah punya akun? Masuk di sini.</p>
            </div>
        </div>

        <!-- Tampilan Dasbor Utama (Siswa) -->
        <div id="dashboard-view" class="view hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="welcome-user" style="text-align:left; margin:0;"></h2>
                <button id="logout-btn" class="btn btn-danger btn-icon" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            <div id="main-dashboard-grid" class="dashboard-grid">
                <div class="dashboard-card tugas" id="tugas-menu"> <i class="fa-solid fa-pencil-alt"></i> <h3>Tugas Harian</h3> </div>
                <div class="dashboard-card profil" id="profil-menu"> <i class="fa-solid fa-user"></i> <h3>Profil Saya</h3> </div>
                <div class="dashboard-card kartu-studi" id="kartu-studi-menu"> <i class="fa-solid fa-graduation-cap"></i> <h3>Kartu Studi</h3> </div>
                <a href="https://bhe-24.github.io/PustakaMateri/" target="_blank" class="dashboard-card pustaka"> <i class="fa-solid fa-book-atlas"></i> <h3>Pustaka Materi</h3> </a>
                <a href="https://bhe-24.github.io/PortalKuis/" target="_blank" class="dashboard-card kuis"> <i class="fa-solid fa-list-check"></i> <h3>Portal Kuis</h3> </a>
                <a href="https://bhe-24.github.io/PortalUjian/" target="_blank" class="dashboard-card ujian"> <i class="fa-solid fa-stopwatch"></i> <h3>Portal Ujian</h3> </a>
            </div>
        </div>

        <!-- HALAMAN SISWA -->
        <div id="tugas-view" class="view hidden">
            <button class="btn btn-secondary back-to-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Daftar Tugas Harian</h2>
            <div id="assignment-list-siswa"></div>
        </div>
        <div id="task-detail-view" class="view hidden"></div>
        <div id="profil-view" class="view hidden">
            <button class="btn btn-secondary back-to-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Profil Saya</h2>
            <div id="profil-content" class="profile-info"></div>
        </div>
        <div id="kartu-studi-view" class="view hidden">
            <button class="btn btn-secondary back-to-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <div id="kartu-studi-content"></div>
        </div>

        <!-- HALAMAN ADMIN -->
        <div id="admin-dashboard-view" class="view hidden">
            <h2 id="welcome-admin" style="text-align:left; margin:0 0 20px 0;"></h2>
            <div class="dashboard-grid">
                <div class="dashboard-card tugas" id="admin-tugas-menu"> <i class="fa-solid fa-cogs"></i> <h3>Kelola Tugas Harian</h3> </div>
                <div class="dashboard-card review" id="admin-penilaian-menu"> <i class="fa-solid fa-marker"></i> <h3>Beri Nilai Tugas</h3> </div>
                <div class="dashboard-card kelola-profil" id="admin-profil-menu"> <i class="fa-solid fa-users-cog"></i> <h3>Kelola Profil Siswa</h3> </div>
                <div class="dashboard-card profil" id="admin-data-diri-menu"> <i class="fa-solid fa-address-card"></i> <h3>Data Diri Siswa</h3> </div>
                <div class="dashboard-card arsip" id="admin-arsip-menu"> <i class="fa-solid fa-file-invoice"></i> <h3>Arsip Akses KHS</h3> </div>
                <a href="https://bhe-24.github.io/PustakaMateri/" target="_blank" class="dashboard-card pustaka"> <i class="fa-solid fa-book-atlas"></i> <h3>Pustaka Materi</h3> </a>
                <a href="https://bhe-24.github.io/PortalKuis/" target="_blank" class="dashboard-card kuis"> <i class="fa-solid fa-list-check"></i> <h3>Kelola Kuis</h3> </a>
                <a href="https://bhe-24.github.io/PortalUjian/" target="_blank" class="dashboard-card ujian"> <i class="fa-solid fa-file-signature"></i> <h3>Kelola Ujian</h3> </a>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button id="admin-logout-btn" class="btn btn-danger" style="width:auto;">Logout</button>
            </div>
        </div>
        
        <div id="admin-tugas-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Kelola Tugas Harian</h2>
            <div id="admin-tugas-harian-list-admin"></div> <hr style="margin: 30px 0;">
            <h3><i class="fa-solid fa-plus-circle"></i> Buat/Edit Tugas</h3>
            <form id="create-assignment-form">
                <input type="hidden" id="edit-task-id">
                <div class="form-group"><label for="judul-tugas">Judul Tugas</label><input type="text" id="judul-tugas" required></div>
                <div class="form-group"><label for="matkul-tugas">Mata Pelajaran</label><input type="text" id="matkul-tugas" required></div>
                <div class="form-group"><label for="tipe-tugas">Tipe Tugas</label><select id="tipe-tugas" class="form-control"><option value="Esai">Esai</option><option value="Dokumen">Dokumen</option></select></div>
                
                <!-- [BARU] Toolbar untuk Instruksi -->
                <div class="form-group">
                    <label for="instruksi-tugas">Instruksi</label>
                    <div class="formatting-toolbar">
                        <button type="button" class="format-btn" onclick="insertFormat('instruksi-tugas', '<b>', '</b>')">Bold</button>
                        <button type="button" class="format-btn" onclick="insertFormat('instruksi-tugas', '<i>', '</i>')">Italic</button>
                        <button type="button" class="format-btn" onclick="insertTable('instruksi-tugas')">Tabel</button>
                    </div>
                    <textarea id="instruksi-tugas" rows="4" required placeholder="Gunakan toolbar untuk format teks..."></textarea>
                </div>

                <div class="form-group"><label for="deadline-tugas">Deadline</label><input type="datetime-local" id="deadline-tugas" class="form-control" required></div>
                
                <div class="form-group">
                    <label for="semester-tugas">Semester</label>
                    <select id="semester-tugas" class="form-control" required>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-success">Simpan Tugas</button>
                <button type="button" id="cancel-edit-task-btn" class="btn btn-secondary hidden" style="margin-top:10px;">Batal Edit</button>
            </form>
        </div>
        
        <div id="admin-penilaian-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Beri Nilai Tugas Harian</h2>
            <div class="form-group">
                <label for="grading-assignment-selector">Pilih Tugas untuk Dinilai:</label>
                <select id="grading-assignment-selector" class="form-control"></select>
            </div>
            <div id="student-grading-list"></div>
        </div>
        
        <div id="admin-profil-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Kelola Profil Siswa</h2>
            <form id="add-student-form">
                <input type="email" id="add-student-email" class="form-control" placeholder="Masukkan email siswa..." required>
                <button type="submit" id="add-student-btn" class="btn btn-sm btn-success"><i class="fa-solid fa-plus"></i> Cari & Tambah Siswa</button>
            </form>
            <hr style="margin: 20px 0;">
            <input type="text" id="search-user-input" class="form-control" placeholder="Saring nama atau email siswa...">
            <div id="user-profile-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

        <div id="admin-data-diri-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Data Diri Siswa</h2>
            <div id="data-diri-list"></div>
        </div>

        <div id="admin-arsip-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Arsip Aktivitas KHS</h2>
            <p style="text-align: center; color: var(--gray-color); margin-bottom: 20px;">Memantau akses dan pengunduhan Kartu Hasil Studi siswa.</p>
            <div style="overflow-x: auto;">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Nama Siswa</th>
                            <th>Aktivitas</th>
                            <th>Detail</th>
                        </tr>
                    </thead>
                    <tbody id="arsip-list-body">
                        <!-- Data logs akan di-render di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Elemen UI Tambahan -->
    <div id="loading-overlay" class="hidden"><div class="progress-spinner"></div><p id="loading-text">Memuat...</p></div>
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-title">Judul Modal</h2></div>
            <div class="modal-body" id="modal-body-content"><p id="modal-text">Teks modal di sini.</p></div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="btn btn-secondary">Batal</button>
                <button id="modal-confirm-btn" class="btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Script HTML2Canvas untuk Screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, addDoc, orderBy, limit, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
        authDomain: "mading-cf676.firebaseapp.com", 
        projectId: "mading-cf676", 
        storageBucket: "mading-cf676.firebasestorage.app", 
        messagingSenderId: "72175203671", 
        appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    // [BARU] Setup API Key untuk Gemini
    const apiKey = "AIzaSyCTwRap6VyKlN9bhj7hWuyAxsdPp6DFc_Y"; 
    const GEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    let currentUserData = null;
    let studentSubmissions = {};
    let allStudentsCache = [];
    let displayedStudents = [];

    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');

    const showLoading = (message) => { 
        loadingText.textContent = message; 
        loadingOverlay.classList.remove('hidden'); 
    };
    const hideLoading = () => {
        loadingOverlay.classList.add('hidden');
    };
    
    const nl2br = (str) => {
        if (!str) return '<i>(Tidak ada jawaban)</i>';
        let safeStr = str.replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
        return safeStr.replace(/\n/g, '<br>');
    }

    const updateView = (targetId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        const targetView = document.getElementById(targetId);
        if (targetView) targetView.classList.remove('hidden');
        else console.error(`View with ID ${targetId} not found.`);
    };

    function showModal(title, text, isConfirm = false) {
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBodyContent = document.getElementById('modal-body-content');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        modalTitle.textContent = title;
        // [MODIFIKASI] Gunakan innerHTML agar tag HTML dari feedback/instruksi terlihat
        modalBodyContent.innerHTML = `<div class="rich-content">${text}</div>`;
        
        modalCancelBtn.style.display = isConfirm ? 'inline-block' : 'none';
        modalConfirmBtn.textContent = isConfirm ? 'OK' : 'Tutup';
        
        modal.classList.remove('hidden');
        return new Promise(resolve => {
            modalConfirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
            modalCancelBtn.onclick = () => { modal.classList.add('hidden'); resolve(false); };
        });
    }

    // [BARU] Fungsi Helper Format Teks (Bold, Italic, Table)
    window.insertFormat = (id, startTag, endTag) => {
        const el = document.getElementById(id);
        const start = el.selectionStart;
        const end = el.selectionEnd;
        const text = el.value;
        const before = text.substring(0, start);
        const selected = text.substring(start, end);
        const after = text.substring(end);
        el.value = before + startTag + selected + endTag + after;
        el.focus();
        el.selectionStart = start + startTag.length;
        el.selectionEnd = end + startTag.length;
    };

    window.insertTable = (id) => {
        const tableTemplate = `\n<table border="1" cellpadding="5" cellspacing="0" style="width:100%">
    <tr>
        <th>Header 1</th>
        <th>Header 2</th>
    </tr>
    <tr>
        <td>Data 1</td>
        <td>Data 2</td>
    </tr>
</table>\n`;
        const el = document.getElementById(id);
        el.value += tableTemplate;
        el.focus();
    };

    // [BARU] Fungsi AI Auto-Grading
    async function getAIGrading(instruction, answer) {
        // [PROMPT ENGINEERING]
        const prompt = `
Peran: Anda adalah asisten guru yang cerdas dan objektif.
Tugas: Nilai jawaban siswa berdasarkan instruksi penugasan yang diberikan.
Instruksi Penugasan:
"${instruction}"

Jawaban Siswa:
"${answer}"

Tolong berikan output HANYA dalam format JSON valid berikut tanpa markdown tambahan:
{
  "score": (angka bulat 0-100),
  "feedback": (string HTML).
}

Ketentuan Feedback:
1. Berikan analisis mendalam: apa yang kurang, apa yang sudah benar.
2. Gunakan tag HTML <b> untuk menebalkan poin penting, <i> untuk istilah, dan <br> untuk baris baru.
3. Jika perlu membuat daftar, gunakan simbol (-) manual dengan <br>, jangan gunakan tag <ul>/<li> agar aman di textarea sederhana.
4. Pastikan feedback membangun dan sesuai konteks instruksi.
        `;

        try {
            const response = await fetch(GEN_API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            if (!data.candidates || !data.candidates[0].content) {
                throw new Error("AI tidak memberikan respons valid.");
            }

            const rawText = data.candidates[0].content.parts[0].text;
            // Bersihkan markdown block ```json jika ada
            const jsonText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
            return JSON.parse(jsonText);
        } catch (error) {
            console.error("AI Grading Error:", error);
            throw error;
        }
    }

    onAuthStateChanged(auth, async (user) => {
        showLoading('Mengecek sesi...');
        if (user) {
            try {
                const docRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    let userData = docSnap.data();
                    if (typeof userData.ips === 'string') {
                        userData.ips = parseFloat(userData.ips) || 0;
                    }
                    const isSupposedToBeAdmin = user.email.toLowerCase().endsWith('@ac.id');
                    if (isSupposedToBeAdmin && userData.role !== 'pengajar') {
                        await updateDoc(docRef, { role: 'pengajar' });
                        userData.role = 'pengajar';
                    }
                    if (userData.role === 'siswa' && (userData.semester === undefined || userData.ips === undefined)) {
                        await setDoc(docRef, { semester: userData.semester || 1, ips: userData.ips || 0 }, { merge: true });
                        userData.semester = userData.semester || 1;
                        userData.ips = userData.ips || 0;
                    }
                    currentUserData = { uid: user.uid, ...userData };
                    renderDashboardView();
                } else {
                    await signOut(auth);
                    showModal('Akun Bermasalah', 'Data akun tidak ditemukan.');
                }
            } catch (err) {
                await signOut(auth);
                showModal('Error', 'Gagal mengambil data akun.');
                console.error("Auth state change error:", err);
            }
        } else {
            currentUserData = null;
            updateView('auth-view');
            hideLoading();
        }
    });

    document.getElementById('show-register-link').onclick = () => { 
        document.getElementById('login-form-container').classList.add('hidden'); 
        document.getElementById('register-form-container').classList.remove('hidden'); 
    };
    document.getElementById('show-login-link').onclick = () => { 
        document.getElementById('register-form-container').classList.add('hidden'); 
        document.getElementById('login-form-container').classList.remove('hidden'); 
    };
    
    document.getElementById('login-form').onsubmit = e => { 
        e.preventDefault(); 
        showLoading('Memverifikasi...'); 
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        signInWithEmailAndPassword(auth, email, password)
            .catch(err => { 
                showModal('Login Gagal', 'Kombinasi email dan password tidak cocok.'); 
                hideLoading(); 
            });
    };
    
    document.getElementById('register-form').onsubmit = e => { 
        e.preventDefault(); 
        showLoading('Mendaftarkan akun...');
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const role = email.toLowerCase().endsWith('@ac.id') ? 'pengajar' : 'siswa';
        
        createUserWithEmailAndPassword(auth, email, password)
            .then(cred => {
                const newUser = { name: name, email: email, role: role };
                return setDoc(doc(db, 'users', cred.user.uid), newUser);
            })
            .then(() => { 
                showModal('Pendaftaran Berhasil', 'Akun telah dibuat. Silakan login.'); 
                document.getElementById('show-login-link').click(); 
            })
            .catch(err => {
                let message = 'Terjadi kesalahan.';
                if (err.code === 'auth/email-already-in-use') message = 'Email ini sudah terdaftar.';
                showModal('Pendaftaran Gagal', message);
            })
            .finally(() => hideLoading()); 
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth);
    document.getElementById('admin-logout-btn').onclick = () => signOut(auth);
    
    document.querySelectorAll('.back-to-dashboard').forEach(btn => btn.onclick = renderDashboardView);
    document.querySelectorAll('.back-to-admin-dashboard').forEach(btn => btn.onclick = () => updateView('admin-dashboard-view'));

    function renderDashboardView() {
        if (!currentUserData) { hideLoading(); return; }
        
        if (currentUserData.role === 'pengajar') {
            document.getElementById('welcome-admin').textContent = `Dasbor Admin: ${currentUserData.name}`;
            updateView('admin-dashboard-view');
        } else {
            document.getElementById('welcome-user').textContent = `Selamat Datang, ${currentUserData.name}!`;
            const isDataLengkap = currentUserData.noHp && currentUserData.alamat;
            
            if (!isDataLengkap) {
                renderProfilView();
                setTimeout(() => showModal('Data Diri Belum Lengkap', 'Silakan lengkapi data diri Anda di bawah ini untuk dapat mengakses portal.'), 200);
            } else {
                updateView('dashboard-view');
            }
        }
        hideLoading();
    }

    document.getElementById('tugas-menu').onclick = () => renderTugasView();
    document.getElementById('profil-menu').onclick = () => renderProfilView();
    document.getElementById('kartu-studi-menu').onclick = () => renderKartuStudiView();

    document.getElementById('admin-tugas-menu').onclick = () => renderAdminTugasView();
    document.getElementById('admin-penilaian-menu').onclick = () => renderAdminPenilaianView();
    document.getElementById('admin-profil-menu').onclick = () => renderAdminProfilView();
    document.getElementById('admin-data-diri-menu').onclick = () => renderAdminDataDiriView();
    document.getElementById('admin-arsip-menu').onclick = () => renderAdminArsipView();

    async function renderTugasView() {
        updateView('tugas-view');
        const listDiv = document.getElementById('assignment-list-siswa');
        showLoading('Memuat tugas...');
        try {
            const assignmentsQuery = query(collection(db, 'assignments'), orderBy('createdAt', 'desc'));
            const assignmentsSnap = await getDocs(assignmentsQuery);
            const assignments = assignmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const submissionsQuery = query(collection(db, 'submissions'), where('studentUid', '==', currentUserData.uid));
            const submissionsSnap = await getDocs(submissionsQuery);
            studentSubmissions = {};
            submissionsSnap.docs.forEach(doc => { studentSubmissions[doc.data().assignmentId] = { id: doc.id, ...doc.data() }; });

            const userSemester = parseInt(currentUserData.semester) || 1;
            const filteredAssignments = assignments.filter(a => {
                const taskSemester = a.semester !== undefined ? parseInt(a.semester) : 1;
                return taskSemester === userSemester;
            });

            listDiv.innerHTML = '';
            if (filteredAssignments.length === 0) {
                listDiv.innerHTML = '<h3>Belum ada tugas untuk semester Anda saat ini.</h3>';
            } else {
                filteredAssignments.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'item-card clickable';
                    const deadline = new Date(a.deadline);
                    const isSubmitted = studentSubmissions[a.id];
                    const taskSemester = a.semester !== undefined ? a.semester : 1;
                    
                    card.innerHTML = `${isSubmitted ? '<i class="fa-solid fa-check-circle submitted-icon"></i>' : ''}<h3>${a.judul}</h3><p>${a.mapel}</p><p><strong>Semester:</strong> ${taskSemester}</p><p><strong>Deadline:</strong> ${deadline.toLocaleString('id-ID')}</p>`;
                    card.onclick = () => showTaskDetail(a);
                    listDiv.appendChild(card);
                });
            }
        } catch(err) { 
            listDiv.innerHTML = '<p>Gagal memuat data tugas.</p>'; 
            console.error(err); 
        } finally { 
            hideLoading(); 
        }
    }

    function showTaskDetail(assignment) {
        updateView('task-detail-view');
        const detailView = document.getElementById('task-detail-view');
        const isSubmitted = studentSubmissions[assignment.id];
        let contentHTML = `<button class="btn btn-secondary back-to-tugas-view" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>`;

        if (isSubmitted) {
            let gradeInfoHTML = '';
            if (isSubmitted.nilai !== null && isSubmitted.nilai !== undefined && isSubmitted.nilai !== '') {
                gradeInfoHTML = `<p>Tugas Anda telah dinilai oleh pengajar.</p><button id="check-grade-btn" class="btn" style="width: auto; margin-top: 15px;">Cek Nilai</button>`;
            } else {
                gradeInfoHTML = `<p>Tugas Anda sedang menunggu penilaian dari pengajar.</p>`;
            }
            contentHTML += `<div class="submission-success-view"><i class="fa-solid fa-paper-plane"></i><h3>Tugas Terkirim</h3>${gradeInfoHTML}</div>`;
        } else {
            const deadline = new Date(assignment.deadline);
            const isClosed = new Date() > deadline;
            // [MODIFIKASI] Render instruksi dengan innerHTML agar tag bold/tabel muncul
            contentHTML += `<h2>${assignment.judul}</h2><p><strong>Oleh:</strong> ${assignment.namaPengajar}</p><p><strong>Instruksi:</strong></p><div class="rich-content" style="text-align:left; background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:20px;">${assignment.instruksi}</div><hr>`;
            
            if (isClosed) { 
                contentHTML += '<div class="tag tag-gray" style="text-align:center;padding:12px;">Tugas sudah ditutup.</div>'; 
            } else {
                if (assignment.tipe === 'Esai') {
                    contentHTML += `<form id="submit-form"><div class="form-group"><label>Jawaban Esai Anda</label><textarea id="jawaban-teks" rows="10" required class="form-control"></textarea></div><button type="submit" class="btn">Kirim Jawaban</button></form>`;
                } else if (assignment.tipe === 'Dokumen') {
                    contentHTML += `<form id="submit-form"><div class="form-group"><label>Unggah File (Maks 2MB)</label><input type="file" id="jawaban-file" required class="form-control"></div><button type="submit" class="btn">Kirim File</button></form>`;
                }
            }
        }
        
        detailView.innerHTML = contentHTML;
        detailView.querySelector('.back-to-tugas-view').onclick = renderTugasView;
        
        const checkGradeBtn = detailView.querySelector('#check-grade-btn');
        if (checkGradeBtn) {
            checkGradeBtn.onclick = () => {
                const grade = isSubmitted.nilai;
                const feedback = isSubmitted.feedback || 'Tidak ada feedback.';
                showModal('Hasil Penilaian', `<div style="text-align: left;"><h4>Nilai Anda:</h4><div class="timer-display">${grade}</div><h4 style="margin-top: 15px;">Feedback dari Pengajar:</h4><p class="rich-content"><em>${feedback}</em></p></div>`);
            };
        }

        const submitForm = detailView.querySelector('#submit-form');
        if (submitForm) {
            submitForm.onsubmit = async (e) => {
                e.preventDefault();
                if (await showModal('Konfirmasi', 'Tugas hanya dapat dikirim SATU KALI. Lanjutkan?', true)) {
                    showLoading('Mengirim tugas...');
                    try {
                        const payload = { 
                            assignmentId: assignment.id, 
                            studentUid: currentUserData.uid, 
                            studentName: currentUserData.name, 
                            submittedAt: serverTimestamp(), 
                            nilai: null, 
                            feedback: '' 
                        };
                        
                        if (assignment.tipe === 'Dokumen') {
                            const file = document.getElementById('jawaban-file').files[0];
                            if (!file) throw new Error('File belum dipilih.');
                            if (file.size > 2 * 1024 * 1024) throw new Error('Ukuran file melebihi 2MB.');
                            
                            const storageRef = ref(storage, `submissions/${assignment.id}/${currentUserData.uid}/${file.name}`);
                            const uploadTask = await uploadBytes(storageRef, file);
                            payload.fileUrl = await getDownloadURL(uploadTask.ref);
                            payload.fileName = file.name;
                        } else {
                            payload.jawabanTeks = document.getElementById('jawaban-teks').value;
                        }
                        
                        const newSubmission = await addDoc(collection(db, 'submissions'), payload);
                        studentSubmissions[assignment.id] = { id: newSubmission.id, ...payload };
                        hideLoading(); 
                        showTaskDetail(assignment);
                    } catch (error) { 
                        hideLoading(); 
                        showModal('Error', 'Gagal mengirim tugas. ' + error.message); 
                    }
                }
            };
        }
    }

    async function logKHSAccess(action) {
        try { 
            await addDoc(collection(db, 'khs_access_logs'), { 
                studentUid: currentUserData.uid, 
                studentName: currentUserData.name, 
                action: action, 
                timestamp: serverTimestamp() 
            }); 
        } catch (e) {
            console.error("Gagal mencatat log:", e);
        }
    }

    window.renderKartuStudiView = function() {
        const requiredGrades = [
            'nilai_t1', 'nilai_t2', 'nilai_t3', 'nilai_t4', 
            'nilai_t5', 'nilai_t6', 'nilai_t7', 'nilai_t8', 
            'nilai_uts', 'nilai_uas'
        ];
        
        const isComplete = requiredGrades.every(key => 
            currentUserData[key] !== null && 
            currentUserData[key] !== undefined && 
            currentUserData[key] !== ''
        );

        if (!isComplete) {
            showModal('Akses Ditolak', 'Mohon maaf, Kartu Hasil Studi (KHS) belum dapat diakses karena penilaian belum lengkap. Silakan hubungi admin atau tunggu hingga seluruh nilai diinput.');
            return;
        }

        logKHSAccess('VIEW');
        updateView('kartu-studi-view');
        const container = document.getElementById('kartu-studi-content');
        
        const formatScore = (val) => (val !== null && val !== undefined && val !== '') ? val : '-';
        const t = (k) => parseFloat(currentUserData[k]) || 0;
        
        const subjects = [
            { no: 1, name: "Seni Menemukan Cerita", sks: 2, v1: formatScore(currentUserData.nilai_t1), v2: formatScore(currentUserData.nilai_t2), avg: (t('nilai_t1')+t('nilai_t2'))/2 },
            { no: 2, name: "Seni Menghidupkan Dunia", sks: 2, v1: formatScore(currentUserData.nilai_t3), v2: formatScore(currentUserData.nilai_t4), avg: (t('nilai_t3')+t('nilai_t4'))/2 },
            { no: 3, name: "Seni Menjalin Peristiwa", sks: 2, v1: formatScore(currentUserData.nilai_t5), v2: formatScore(currentUserData.nilai_t6), avg: (t('nilai_t5')+t('nilai_t6'))/2 },
            { no: 4, name: "Seni Memoles Naskah", sks: 2, v1: formatScore(currentUserData.nilai_t7), v2: formatScore(currentUserData.nilai_t8), avg: (t('nilai_t7')+t('nilai_t8'))/2 },
            { no: 5, name: "Ujian Tengah Semester", sks: 2, val: formatScore(currentUserData.nilai_uts), avg: t('nilai_uts'), isExam: true },
            { no: 6, name: "Ujian Akhir Semester", sks: 2, val: formatScore(currentUserData.nilai_uas), avg: t('nilai_uas'), isExam: true },
        ];

        let rowsHTML = '';
        subjects.forEach(s => {
            let grade = '';
            if ((s.isExam && s.val !== '-') || (!s.isExam && (s.v1 !== '-' || s.v2 !== '-'))) {
                if (s.avg >= 85) grade = 'A';
                else if (s.avg >= 75) grade = 'B';
                else if (s.avg >= 60) grade = 'C';
                else if (s.avg >= 50) grade = 'D';
                else grade = 'E';
            }
            
            let nilaiCell = '';
            if (s.isExam) {
                nilaiCell = `<td colspan="2" style="text-align: center;">${s.val}</td>`;
            } else {
                nilaiCell = `<td style="border-right: 1px solid #000; width: 50px;">${s.v1}</td><td style="width: 50px;">${s.v2}</td>`;
            }

            rowsHTML += `
                <tr>
                    <td>${s.no}.</td>
                    <td style="text-align: left; padding-left: 15px;">${s.name}</td>
                    <td>${s.sks}</td>
                    ${nilaiCell}
                    <td>${grade}</td>
                </tr>
            `;
        });

        const displayIPS = (parseFloat(currentUserData.ips) || 0).toFixed(2);
        const docNumber = `KHS-CA-${new Date().getFullYear()}-${currentUserData.uid.substring(0,5).toUpperCase()}`;

        container.innerHTML = `
            <div class="khs-wrapper">
                <div id="khs-download-area" class="khs-container">
                    <img src="[https://i.imgur.com/HDC6SWw.png](https://i.imgur.com/HDC6SWw.png)" class="khs-watermark" alt="Watermark Cendekia Aksara" crossorigin="anonymous">
                    
                    <div class="khs-header">
                        <div style="margin-bottom: 10px;">
                            <img src="[https://i.imgur.com/HDC6SWw.png](https://i.imgur.com/HDC6SWw.png)" alt="Logo Cendekia Aksara" style="height: 60px; display: block; margin: 0 auto;" crossorigin="anonymous">
                        </div>
                        <h2>KARTU HASIL STUDI</h2>
                        <p>Sekolah Menulis Gratis Cendekia Aksara</p>
                    </div>

                    <div class="khs-student-info">
                        <table>
                            <tr>
                                <td style="width: 120px;">Nama</td>
                                <td style="width: 10px;">:</td>
                                <td>${currentUserData.name}</td>
                            </tr>
                            <tr>
                                <td>ID Siswa</td>
                                <td>:</td>
                                <td>${currentUserData.uid.substring(0, 10).toUpperCase()}</td>
                            </tr>
                            <tr>
                                <td>Semester</td>
                                <td>:</td>
                                <td>${currentUserData.semester || 1}</td>
                            </tr>
                        </table>
                    </div>

                    <table class="khs-table">
                        <thead>
                            <tr>
                                <th rowspan="2" style="width: 40px;">No.</th>
                                <th rowspan="2">Mata Pelajaran</th>
                                <th rowspan="2" style="width: 50px;">SKS</th>
                                <th colspan="2">Nilai</th>
                                <th rowspan="2" style="width: 60px;">Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                            <tr style="font-weight: bold;">
                                <td colspan="2" style="text-align: right; padding-right: 15px; border-right: none;">Total</td>
                                <td style="border-left: none;">12</td>
                                <td colspan="3" style="background-color: #f0f0f0;"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="khs-footer">
                        IPS (Indeks Penilaian Semester) : ${displayIPS}
                    </div>

                    <div class="khs-signature-section">
                        <div class="signature-box">
                            <p style="margin-bottom: 60px;">Mengetahui,<br>Kepala Cendekia</p>
                            <img src="[https://i.imgur.com/YvrNYRw.png](https://i.imgur.com/YvrNYRw.png)" class="signature-stamp" alt="Stempel Sah" crossorigin="anonymous">
                            <p style="text-decoration: underline; font-weight: bold;">Mukhamad Bayu Aji</p>
                        </div>
                    </div>

                    <div class="khs-bottom-bar">
                        <strong>No. Dokumen:</strong> ${docNumber} <br>
                        <strong>Catatan:</strong> Kartu Hasil Studi ini diterbitkan secara elektronik oleh sistem Cendekia Aksara. Dokumen ini sah dan tidak memerlukan tanda tangan basah tambahan jika diunduh melalui portal resmi. Segala bentuk perubahan pada data dokumen ini adalah tindakan ilegal.
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <p style="font-size: 0.8em; color: var(--gray-color);">Pastikan data sudah benar sebelum mengunduh.</p>
                <button onclick="downloadKHS()" class="btn btn-primary btn-sm" style="width: auto;">
                    <i class="fa fa-download"></i> Unduh KHS (HD)
                </button>
            </div>
        `;
    };

    window.downloadKHS = function() {
        logKHSAccess('DOWNLOAD');
        showLoading('Menyiapkan dokumen...');
        
        setTimeout(() => {
            const element = document.getElementById('khs-download-area');
            const options = {
                scale: 2, 
                useCORS: true, 
                backgroundColor: "#ffffff",
                logging: true
            };

            html2canvas(element, options).then(canvas => {
                const image = canvas.toDataURL("image/png", 1.0);
                const link = document.createElement('a');
                link.download = `KHS_${currentUserData.name}_Sem${currentUserData.semester || 1}.png`;
                link.href = image;
                link.click();
                hideLoading();
            }).catch(err => {
                console.error(err);
                hideLoading();
                alert("Gagal mengunduh gambar. Pastikan koneksi internet stabil.");
            });
        }, 1000);
    }

    async function renderAdminArsipView() {
        updateView('admin-arsip-view');
        const tbody = document.getElementById('arsip-list-body');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>';
        
        try {
            const q = query(collection(db, 'khs_access_logs'), orderBy('timestamp', 'desc'), limit(50));
            const snapshot = await getDocs(q);
            
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada aktivitas tercatat.</td></tr>';
                return;
            }

            snapshot.forEach(doc => {
                const log = doc.data();
                const date = log.timestamp ? log.timestamp.toDate().toLocaleString('id-ID') : '-';
                const badgeClass = log.action === 'DOWNLOAD' ? 'log-download' : 'log-view';
                const actionLabel = log.action === 'DOWNLOAD' ? 'Mengunduh KHS' : 'Melihat KHS';
                const detailText = log.action === 'DOWNLOAD' ? 'Dokumen berhasil diunduh' : 'Akses halaman KHS';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${date}</td>
                    <td><strong>${log.studentName}</strong></td>
                    <td><span class="log-badge ${badgeClass}">${actionLabel}</span></td>
                    <td>${detailText}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error("Gagal memuat arsip:", err);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Gagal memuat data arsip.</td></tr>';
        }
    }

    function renderProfilView() {
        updateView('profil-view');
        const contentDiv = document.getElementById('profil-content');
        const backBtn = document.querySelector('#profil-view .back-to-dashboard');
        
        const isDataLengkap = currentUserData.noHp && currentUserData.alamat;
        
        if (isDataLengkap) {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden');
        }

        const displayIPS = (parseFloat(currentUserData.ips) || 0).toFixed(2);
        const ipsValue = parseFloat(currentUserData.ips) || 0;
        const profilePicClass = ipsValue < 3.0 ? 'warning' : 'good';
        
        contentDiv.innerHTML = `
            <div class="profile-pic ${profilePicClass}">${displayIPS}</div>
            <h3>${currentUserData.name}</h3>
            <p>${currentUserData.email}</p>
            
            ${ipsValue < 3.0 ? `
            <div class="ips-warning">
                <i class="fa-solid fa-exclamation-triangle"></i>
                <div>
                    <strong>Perhatian!</strong> IPS Anda di bawah 3.00. Segera hubungi wali kelas untuk mendapatkan nilai tambahan.
                </div>
            </div>
            ` : ''}

            <div class="profile-details" style="margin-bottom: 25px;">
                <div class="detail-item">
                    <strong>Semester Saat Ini</strong>
                    <span>${currentUserData.semester || '1'}</span>
                </div>
                <div class="detail-item">
                    <strong>Indeks Penilaian Semester (IPS)</strong>
                    <span>${displayIPS}</span>
                </div>
            </div>

            <form id="profile-form">
                <div class="form-group" style="text-align: left;">
                    <label for="profile-name">Nama Lengkap</label>
                    <input type="text" id="profile-name" class="form-control" value="${currentUserData.name || ''}" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-email">Email (Tidak dapat diubah)</label>
                    <input type="email" id="profile-email" class="form-control" value="${currentUserData.email || ''}" readonly disabled style="background-color: #eee;">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-nohp">Nomor HP/WhatsApp</label>
                    <input type="tel" id="profile-nohp" class="form-control" value="${currentUserData.noHp || ''}" placeholder="cth: 08123456789" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-tgllahir">Tanggal Lahir</label>
                    <input type="date" id="profile-tgllahir" class="form-control" value="${currentUserData.tanggalLahir || ''}">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-alamat">Alamat (Kota, Provinsi)</label>
                    <input type="text" id="profile-alamat" class="form-control" value="${currentUserData.alamat || ''}" placeholder="cth: Jakarta, DKI Jakarta" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-bio">Bio Singkat</label>
                    <textarea id="profile-bio" rows="3" class="form-control" placeholder="Ceritakan sedikit tentang diri Anda...">${currentUserData.bioSingkat || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-success">Simpan Data Diri</button>
            </form>
        `;
    }

    document.getElementById('profil-view').addEventListener('submit', async (e) => {
        if (e.target.id === 'profile-form') {
            e.preventDefault(); 
            showLoading('Menyimpan data...');
            const payload = { 
                name: document.getElementById('profile-name').value, 
                noHp: document.getElementById('profile-nohp').value, 
                tanggalLahir: document.getElementById('profile-tgllahir').value, 
                alamat: document.getElementById('profile-alamat').value, 
                bioSingkat: document.getElementById('profile-bio').value 
            };

            if (!payload.name || !payload.noHp || !payload.alamat) {
                hideLoading();
                showModal('Gagal', 'Nama, Nomor HP, dan Alamat wajib diisi.');
                return;
            }

            try {
                const userDocRef = doc(db, 'users', currentUserData.uid);
                await updateDoc(userDocRef, payload);
                
                Object.assign(currentUserData, payload);
                
                hideLoading(); 
                await showModal('Sukses', 'Data diri berhasil diperbarui.');
                renderDashboardView(); 
            } catch (err) { 
                hideLoading(); 
                showModal('Error', 'Gagal menyimpan data: ' + err.message); 
            }
        }
    });

    async function renderAdminTugasView() {
        updateView('admin-tugas-view');
        document.getElementById('create-assignment-form').reset();
        document.getElementById('edit-task-id').value = '';
        document.getElementById('cancel-edit-task-btn').classList.add('hidden');
        
        const listDiv = document.getElementById('admin-tugas-harian-list-admin');
        showLoading('Memuat daftar tugas...');
        
        try {
            const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(q);
            
            listDiv.innerHTML = '<h3>Daftar Tugas Terbit</h3>';
            
            listDiv.innerHTML += `
                <div style="background-color: #e7f3ff; border-left: 4px solid var(--primary-color); padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                    <p style="margin: 0; font-size: 0.9em; color: var(--dark-text);">
                        <i class="fa-solid fa-info-circle" style="color: var(--primary-color); margin-right: 8px;"></i>
                        <strong>Info:</strong> Tugas yang dibuat sebelum adanya fitur 'Semester' secara otomatis dikategorikan sebagai <strong>'Semester 1 (Default)'</strong>.
                    </p>
                </div>
            `;

            if (snapshot.empty) {
                listDiv.innerHTML += '<p>Belum ada tugas yang dibuat.</p>';
            } else {
                snapshot.docs.forEach(doc => {
                    const task = {id: doc.id, ...doc.data()};
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    
                    let semesterTag;
                    if (task.semester === undefined) {
                        semesterTag = '<span class="tag tag-gray" style="margin-left: 10px;">Semester 1 (Default)</span>';
                    } else {
                        semesterTag = `<span class="tag tag-blue" style="margin-left: 10px;">Semester ${task.semester}</span>`;
                    }
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <h3>${task.judul} ${semesterTag}</h3>
                            <div class="card-actions">
                                <button class="btn btn-secondary btn-icon btn-sm edit-task" data-id="${task.id}"><i class="fa fa-edit"></i></button>
                                <button class="btn btn-danger btn-icon btn-sm delete-task" data-id="${task.id}"><i class="fa fa-trash"></i></button>
                            </div>
                        </div>
                        <p>${task.mapel}</p>
                    `;
                    listDiv.appendChild(card);
                });
            }
        } catch(err) { 
            listDiv.innerHTML = '<p>Gagal memuat tugas.</p>'; 
        } finally { 
            hideLoading(); 
        }
    }

    document.getElementById('create-assignment-form').onsubmit = async (e) => {
        e.preventDefault();
        const editId = document.getElementById('edit-task-id').value;
        const payload = { 
            judul: document.getElementById('judul-tugas').value, 
            mapel: document.getElementById('matkul-tugas').value, 
            tipe: document.getElementById('tipe-tugas').value, 
            instruksi: document.getElementById('instruksi-tugas').value, 
            deadline: document.getElementById('deadline-tugas').value, 
            namaPengajar: currentUserData.name, 
            semester: parseInt(document.getElementById('semester-tugas').value) 
        };
        
        if (!editId) payload.createdAt = serverTimestamp();
        
        showLoading('Menyimpan tugas...');
        try {
            if(editId) {
                await updateDoc(doc(db, 'assignments', editId), payload); 
            } else {
                await addDoc(collection(db, 'assignments'), payload);
            }
            hideLoading(); 
            renderAdminTugasView();
        } catch (err) { 
            hideLoading(); 
            showModal('Error', 'Gagal menyimpan tugas.'); 
        }
    };

    document.getElementById('admin-tugas-harian-list-admin').addEventListener('click', async e => {
        const deleteBtn = e.target.closest('.delete-task');
        if (deleteBtn) {
            const taskId = deleteBtn.dataset.id;
            if (await showModal('Konfirmasi', 'Yakin ingin menghapus tugas ini?', true)) {
                showLoading('Menghapus...');
                try {
                    await deleteDoc(doc(db, 'assignments', taskId));
                    renderAdminTugasView();
                } catch (err) {
                    showModal('Error', 'Gagal menghapus tugas.');
                } finally {
                    hideLoading();
                }
            }
        }
        
        const editBtn = e.target.closest('.edit-task');
        if (editBtn) {
            const taskId = editBtn.dataset.id;
            showLoading('Memuat data tugas...');
            try {
                const docSnap = await getDoc(doc(db, 'assignments', taskId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('edit-task-id').value = taskId;
                    document.getElementById('judul-tugas').value = data.judul;
                    document.getElementById('matkul-tugas').value = data.mapel;
                    document.getElementById('tipe-tugas').value = data.tipe;
                    document.getElementById('instruksi-tugas').value = data.instruksi;
                    document.getElementById('deadline-tugas').value = data.deadline;
                    document.getElementById('semester-tugas').value = data.semester || 1;
                    document.getElementById('cancel-edit-task-btn').classList.remove('hidden');
                    window.scrollTo(0, document.body.scrollHeight);
                }
            } catch(err) {
                showModal('Error', 'Gagal memuat data tugas.');
            } finally {
                hideLoading();
            }
        }
    });

    document.getElementById('cancel-edit-task-btn').onclick = () => { 
        document.getElementById('create-assignment-form').reset(); 
        document.getElementById('edit-task-id').value = ''; 
        document.getElementById('cancel-edit-task-btn').classList.add('hidden'); 
    };

    async function renderAdminPenilaianView() {
        updateView('admin-penilaian-view');
        const sel = document.getElementById('grading-assignment-selector');
        const studentGradingList = document.getElementById('student-grading-list');
        
        showLoading('Mempersiapkan halaman penilaian...');
        try {
            const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(q);
            
            sel.innerHTML = '<option value="">-- Pilih Tugas --</option>';
            snapshot.docs.forEach(doc => {
                const d = doc.data();
                // Simpan instruksi di atribut data agar bisa diakses saat onchange
                const instruksiSafe = encodeURIComponent(d.instruksi);
                sel.innerHTML += `<option value="${doc.id}" data-instruksi="${instruksiSafe}">${d.judul} (Sem ${d.semester||1})</option>`;
            });
            studentGradingList.innerHTML = '<p>Silakan pilih tugas untuk memulai penilaian.</p>';
        } catch(e) {
            studentGradingList.innerHTML = '<p>Gagal memuat daftar tugas.</p>';
        } finally { 
            hideLoading(); 
        }
    }

    document.getElementById('grading-assignment-selector').onchange = async (e) => {
        const assignmentId = e.target.value;
        const list = document.getElementById('student-grading-list');
        
        if (!assignmentId) {
            list.innerHTML = '<p>Silakan pilih tugas untuk memulai penilaian.</p>';
            return;
        }
        
        // Ambil instruksi dari atribut data option yang dipilih untuk AI
        const selectedOption = e.target.options[e.target.selectedIndex];
        const instructionText = decodeURIComponent(selectedOption.getAttribute('data-instruksi') || "");

        showLoading('Memuat data jawaban siswa...');
        try {
            const q = query(collection(db, 'submissions'), where('assignmentId', '==', assignmentId));
            const snap = await getDocs(q);
            
            list.innerHTML = '';
            if (snap.empty) {
                list.innerHTML = '<p>Belum ada siswa yang mengumpulkan tugas ini.</p>';
                return;
            }
            
            const submissions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            submissions.sort((a, b) => (a.studentName || '').localeCompare(b.studentName || '')).forEach(s => {
                const card = document.createElement('div'); 
                card.className = 'grading-card';
                const isGraded = s.nilai !== null && s.nilai !== undefined && s.nilai !== '';
                
                // [MODIFIKASI] Tombol AI dan Toolbar Format Feedback ditambahkan
                // Tombol AI hanya muncul jika Tipe Esai (jawabanTeks ada)
                const aiBtn = (s.jawabanTeks) 
                    ? `<button type="button" class="btn btn-ai ai-grade-btn" data-answer="${encodeURIComponent(s.jawabanTeks)}" data-instruction="${encodeURIComponent(instructionText)}" style="margin-bottom:15px; width:100%;">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Auto-Grade dengan AI
                       </button>` 
                    : '';

                // ID Unik untuk textarea feedback
                const feedbackId = `feedback-${s.id}`;

                // Tampilan jawaban
                let jawabanHTML = '';
                if (s.fileUrl) {
                    jawabanHTML = `<p><strong>File:</strong> <a href="${s.fileUrl}" target="_blank" class="btn btn-secondary download-link"><i class="fa fa-download"></i> Unduh (${s.fileName || 'file'})</a></p>`;
                } else {
                    jawabanHTML = `<p style="text-align: left; margin-bottom: 5px;"><strong>Jawaban Siswa:</strong></p>
                                   <div style="border: 1px solid #ddd; padding: 12px; border-radius: 8px; background: #fdfdfd; max-height: 250px; overflow-y: auto; text-align: left; line-height: 1.5; white-space: normal; margin-bottom: 15px;">
                                        ${nl2br(s.jawabanTeks)}
                                   </div>`;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <h3>${s.studentName}</h3>
                        <span class="tag ${isGraded ? 'tag-blue' : 'tag-green'}">${isGraded ? 'Sudah Dinilai' : 'Sudah Mengumpulkan'}</span>
                    </div>
                    ${jawabanHTML}
                    
                    ${aiBtn}

                    <form class="grading-form" data-submission-id="${s.id}">
                        <div class="form-group">
                            <label>Nilai (0-100):</label>
                            <input type="number" class="nilai-input form-control" min="0" max="100" value="${s.nilai||''}" ${isGraded?'disabled':''}>
                            
                            <label style="margin-top: 10px;">Feedback (Mendukung Bold, Italic, Tabel):</label>
                            <div class="formatting-toolbar">
                                <button type="button" class="format-btn" onclick="insertFormat('${feedbackId}', '<b>', '</b>')">Bold</button>
                                <button type="button" class="format-btn" onclick="insertFormat('${feedbackId}', '<i>', '</i>')">Italic</button>
                                <button type="button" class="format-btn" onclick="insertTable('${feedbackId}')">Tabel</button>
                            </div>
                            
                            <textarea id="${feedbackId}" rows="4" class="feedback-input form-control" ${isGraded?'disabled':''}>${s.feedback||''}</textarea>
                        </div>
                        <div class="grading-card-footer">
                            <button type="submit" class="btn ${isGraded?'btn-secondary':'btn-success'}" style="width: auto;" ${isGraded?'disabled':''}>${isGraded?'Tersimpan':'Simpan Nilai'}</button>
                        </div>
                    </form>`;
                list.appendChild(card);
            });

            // [BARU] Event Listener untuk Tombol AI di dalam list ini
            document.querySelectorAll('.ai-grade-btn').forEach(btn => {
                btn.addEventListener('click', async (evt) => {
                    const button = evt.currentTarget;
                    const card = button.closest('.grading-card');
                    const form = card.querySelector('.grading-form');
                    const nilaiInput = form.querySelector('.nilai-input');
                    const feedbackInput = form.querySelector('.feedback-input');
                    
                    const answer = decodeURIComponent(button.getAttribute('data-answer'));
                    const instruction = decodeURIComponent(button.getAttribute('data-instruction'));

                    if (!answer) { 
                        alert("Tidak ada jawaban teks untuk dianalisis."); 
                        return; 
                    }

                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sedang Menganalisis...';
                    button.disabled = true;

                    try {
                        const aiResult = await getAIGrading(instruction, answer);
                        
                        // Isi form dengan hasil AI
                        nilaiInput.value = aiResult.score;
                        feedbackInput.value = aiResult.feedback;
                        
                        // Aktifkan input jika sebelumnya disabled (misal mau revisi nilai lama)
                        nilaiInput.disabled = false;
                        feedbackInput.disabled = false;
                        
                        // Update tombol simpan
                        const saveBtn = form.querySelector('button[type="submit"]');
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('btn-secondary');
                        saveBtn.classList.add('btn-success');
                        saveBtn.textContent = "Simpan Hasil AI";

                        button.innerHTML = '<i class="fa-solid fa-check"></i> Selesai!';
                        setTimeout(() => { 
                            button.innerHTML = originalText; 
                            button.disabled = false; 
                        }, 2000);
                    } catch (error) {
                        alert("Gagal menggunakan AI: " + error.message);
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                });
            });

        } catch(e) { 
            console.error('Gagal memuat data penilaian:', e); 
            list.innerHTML = '<p>Gagal memuat data penilaian.</p>'; 
        } finally { 
            hideLoading(); 
        }
    };

    document.getElementById('student-grading-list').addEventListener('submit', async (e) => {
        if(e.target.classList.contains('grading-form')) {
            e.preventDefault();
            const form = e.target;
            const submissionId = form.dataset.submissionId;
            const btn = form.querySelector('button[type="submit"]');
            
            const payload = { 
                nilai: form.querySelector('.nilai-input').value, 
                feedback: form.querySelector('.feedback-input').value 
            };
            
            btn.disabled = true; 
            showLoading('Menyimpan nilai...');
            
            try {
                await updateDoc(doc(db, 'submissions', submissionId), payload);
                hideLoading();
                
                btn.textContent = 'Tersimpan';
                btn.classList.replace('btn-success', 'btn-secondary');
                
                form.querySelector('.nilai-input').disabled = true; 
                form.querySelector('.feedback-input').disabled = true;
                
                const tag = form.closest('.grading-card').querySelector('.tag');
                if (tag) { 
                    tag.textContent = 'Sudah Dinilai'; 
                    tag.classList.replace('tag-green', 'tag-blue'); 
                }
            } catch(err) { 
                hideLoading(); 
                showModal('Error', 'Gagal menyimpan nilai.'); 
                btn.disabled = false; 
            }
        }
    });

    async function renderAdminDataDiriView() {
        updateView('admin-data-diri-view');
        const listDiv = document.getElementById('data-diri-list');
        showLoading('Memuat data diri siswa...');
        listDiv.innerHTML = '';
        
        try {
            const q = query(collection(db, 'users'), where('role', '==', 'siswa'));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                listDiv.innerHTML = '<p style="text-align: center;">Belum ada data siswa.</p>';
            } else {
                const users = snapshot.docs.map(doc => doc.data());
                users.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                users.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `
                        <h3 style="text-align: left;">${user.name}</h3>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>No. HP:</strong> ${user.noHp || '<i>(Belum diisi)</i>'}</p>
                        <p><strong>Tgl. Lahir:</strong> ${user.tanggalLahir || '<i>(Belum diisi)</i>'}</p>
                        <p><strong>Alamat:</strong> ${user.alamat || '<i>(Belum diisi)</i>'}</p>
                        <p><strong>Bio:</strong> ${user.bioSingkat || '<i>(Belum diisi)</i>'}</p>
                    `;
                    listDiv.appendChild(card);
                });
            }
        } catch (err) {
            listDiv.innerHTML = `<p>Gagal memuat data: ${err.message}</p>`;
            console.error("Error loading student data diri:", err);
        } finally {
            hideLoading();
        }
    }

    async function renderAdminProfilView() {
        updateView('admin-profil-view');
        showLoading('Memuat daftar siswa...');
        document.getElementById('search-user-input').value = '';
        document.getElementById('add-student-form').reset();
        const listDiv = document.getElementById('user-profile-list');
        listDiv.innerHTML = '';

        try {
            const q = query(collection(db, 'users'), where('role', '==', 'siswa'));
            const snapshot = await getDocs(q);

            allStudentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => a.name.localeCompare(b.name));

            displayedStudents = [...allStudentsCache];
            drawStudentProfileList(displayedStudents);
        } catch (err) {
            listDiv.innerHTML = '<p>Gagal memuat daftar siswa.</p>';
            console.error("Error loading student profiles:", err);
        } finally {
            hideLoading();
        }
    }

    function drawStudentProfileList(usersToDraw) {
        const listDiv = document.getElementById('user-profile-list');
        listDiv.innerHTML = '';

        if (usersToDraw.length === 0) {
            const searchTerm = document.getElementById('search-user-input').value;
            if (searchTerm) {
                listDiv.innerHTML = '<p>Tidak ada siswa yang cocok dengan filter pencarian.</p>';
            } else {
                listDiv.innerHTML = '<p>Belum ada siswa dengan role "siswa" di database.</p>';
            }
            return;
        }

        usersToDraw.forEach(user => {
            const card = document.createElement('div');
            card.className = 'user-profile-card';
            card.id = `profile-card-${user.id}`;

            const nilai = {
                t1: user.nilai_t1 ?? '', t2: user.nilai_t2 ?? '', t3: user.nilai_t3 ?? '', t4: user.nilai_t4 ?? '',
                t5: user.nilai_t5 ?? '', t6: user.nilai_t6 ?? '', t7: user.nilai_t7 ?? '', t8: user.nilai_t8 ?? '',
                uts: user.nilai_uts ?? '', uas: user.nilai_uas ?? ''
            };

            const displayIPS = (parseFloat(user.ips) || 0).toFixed(2);

            card.innerHTML = `
                <h4>${user.name}</h4>
                <p>${user.email}</p>
                <form class="profile-update-form" data-uid="${user.id}">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="flex-basis: 100px;">Semester:</label>
                        <input type="number" class="semester-input form-control" value="${user.semester || 1}" min="1" style="width: 100px;">
                    </div>

                    <label style="font-weight: 600; margin-top: 15px; margin-bottom: 10px; display: block; border-top: 1px solid #eee; padding-top: 15px;">Input Nilai (Skala 0-100):</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px;">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 1" value="${nilai.t1}" min="0" max="100" title="Tugas 1">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 2" value="${nilai.t2}" min="0" max="100" title="Tugas 2">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 3" value="${nilai.t3}" min="0" max="100" title="Tugas 3">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 4" value="${nilai.t4}" min="0" max="100" title="Tugas 4">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 5" value="${nilai.t5}" min="0" max="100" title="Tugas 5">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 6" value="${nilai.t6}" min="0" max="100" title="Tugas 6">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 7" value="${nilai.t7}" min="0" max="100" title="Tugas 7">
                        <input type="number" class="nilai-input form-control" placeholder="Tugas 8" value="${nilai.t8}" min="0" max="100" title="Tugas 8">
                        <input type="number" class="nilai-input form-control" placeholder="UTS" value="${nilai.uts}" min="0" max="100" title="Nilai UTS" style="background-color: #f0f4f8; border: 2px solid var(--primary-color);">
                        <input type="number" class="nilai-input form-control" placeholder="UAS" value="${nilai.uas}" min="0" max="100" title="Nilai UAS" style="background-color: #f0f4f8; border: 2px solid var(--primary-color);">
                    </div>

                    <div class="form-group" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                        <button type="button" class="btn btn-secondary btn-sm hitung-rata-rata" style="width: auto;">Hitung Rata-rata</button>
                        <label style="flex-shrink: 0; margin-left: 10px; font-weight: 600;">Hasil IPS (0-4.00):</label>
                        <input type="text" class="ips-display form-control" value="${displayIPS}" readonly style="font-weight: bold; background-color: #eee; width: 80px;">
                        <button type="submit" class="btn btn-success btn-sm" style="width: auto; margin-left: auto;">Simpan Perubahan</button>
                    </div>
                </form>
            `;
            listDiv.appendChild(card);
        });
    }

    document.getElementById('search-user-input').onkeyup = (e) => {
        const searchTerm = e.target.value.toLowerCase();
        displayedStudents = allStudentsCache.filter(user => 
            user.name.toLowerCase().includes(searchTerm) || 
            user.email.toLowerCase().includes(searchTerm)
        );
        drawStudentProfileList(displayedStudents);
    };

    document.getElementById('add-student-form').onsubmit = async (e) => {
        e.preventDefault();
        const emailToAdd = document.getElementById('add-student-email').value.trim().toLowerCase();
        if (!emailToAdd) return;

        showLoading('Mencari siswa...');
        try {
            const isAlreadyInCache = allStudentsCache.some(student => student.email.toLowerCase() === emailToAdd);
            
            if (isAlreadyInCache) {
                hideLoading();
                alert("Siswa sudah ada dalam daftar.");
                return;
            }

            const q = query(collection(db, 'users'), where('email', '==', emailToAdd), limit(1));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                hideLoading();
                alert("Siswa dengan email tersebut tidak ditemukan di database.");
                return;
            }
            
            const foundStudent = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
            
            if (foundStudent.role === 'pengajar') {
                hideLoading();
                alert("Tidak dapat menambahkan akun pengajar.");
                return;
            }

            if (foundStudent.role !== 'siswa') {
                await updateDoc(doc(db, 'users', foundStudent.id), { 
                    role: 'siswa',
                    semester: foundStudent.semester || 1,
                    ips: foundStudent.ips || 0
                });
                foundStudent.role = 'siswa';
            }

            allStudentsCache.push(foundStudent);
            allStudentsCache.sort((a, b) => a.name.localeCompare(b.name));
            displayedStudents = [...allStudentsCache];

            drawStudentProfileList(displayedStudents);
            hideLoading();
            alert(`Siswa ${foundStudent.name} berhasil ditambahkan.`);
            document.getElementById('add-student-form').reset();

        } catch (err) {
            hideLoading();
            alert('Gagal mencari atau menambahkan siswa: ' + err.message);
        }
    };

    document.getElementById('user-profile-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('hitung-rata-rata')) {
            e.preventDefault();
            const form = e.target.closest('.profile-update-form');
            if (!form) return;

            const nilaiInputs = form.querySelectorAll('.nilai-input');
            let totalNilai = 0;
            let jumlahNilai = 0;

            nilaiInputs.forEach(input => {
                const nilai = parseFloat(input.value);
                if (!isNaN(nilai) && input.value.trim() !== '') {
                    totalNilai += nilai;
                    jumlahNilai++;
                }
            });

            const rataRata = (jumlahNilai > 0) ? (totalNilai / jumlahNilai) : 0;
            const ips = (rataRata / 100) * 4;

            const ipsDisplay = form.querySelector('.ips-display');
            if (ipsDisplay) {
                ipsDisplay.value = ips.toFixed(2);
            }
        }
    });

    document.getElementById('user-profile-list').addEventListener('submit', async (e) => {
        if(e.target.classList.contains('profile-update-form')) {
            e.preventDefault();
            const form = e.target;
            const uid = form.dataset.uid;
            const btn = form.querySelector('button[type="submit"]');

            const nilaiInputs = form.querySelectorAll('.nilai-input');
            const calculatedIPS = parseFloat(form.querySelector('.ips-display').value) || 0;

            const payload = {
                semester: parseInt(form.querySelector('.semester-input').value) || 1,
                ips: calculatedIPS,
                nilai_t1: nilaiInputs[0].value.trim() === '' ? null : parseFloat(nilaiInputs[0].value),
                nilai_t2: nilaiInputs[1].value.trim() === '' ? null : parseFloat(nilaiInputs[1].value),
                nilai_t3: nilaiInputs[2].value.trim() === '' ? null : parseFloat(nilaiInputs[2].value),
                nilai_t4: nilaiInputs[3].value.trim() === '' ? null : parseFloat(nilaiInputs[3].value),
                nilai_t5: nilaiInputs[4].value.trim() === '' ? null : parseFloat(nilaiInputs[4].value),
                nilai_t6: nilaiInputs[5].value.trim() === '' ? null : parseFloat(nilaiInputs[5].value),
                nilai_t7: nilaiInputs[6].value.trim() === '' ? null : parseFloat(nilaiInputs[6].value),
                nilai_t8: nilaiInputs[7].value.trim() === '' ? null : parseFloat(nilaiInputs[7].value),
                nilai_uts: nilaiInputs[8].value.trim() === '' ? null : parseFloat(nilaiInputs[8].value),
                nilai_uas: nilaiInputs[9].value.trim() === '' ? null : parseFloat(nilaiInputs[9].value),
            };

            showLoading('Menyimpan data...');
            btn.disabled = true;
            
            try {
                await updateDoc(doc(db, 'users', uid), payload);
                
                const userInAllCache = allStudentsCache.find(u => u.id === uid);
                if(userInAllCache) Object.assign(userInAllCache, payload);
                
                hideLoading();
                alert('Data profil siswa berhasil diperbarui.');
            } catch (err) {
                hideLoading();
                alert('Gagal memperbarui data.');
            } finally {
                btn.disabled = false;
            }
        }
    });
</script>
</body>
</html>
