<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajukan Cuti - Siswa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; margin: 0; color: #334155; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h2 { margin: 0; color: #0f172a; font-size: 1.2rem; }
        .btn-back { text-decoration: none; color: #64748b; font-weight: 600; font-size: 0.9rem; }

        /* Form Card */
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        .btn-submit { width: 100%; padding: 14px; background: #0f172a; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-submit:hover { background: #1e293b; }

        /* History List */
        .history-list { display: flex; flex-direction: column; gap: 15px; }
        .history-item { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
        
        /* Status Colors */
        .pending { border-color: #f59e0b; }
        .approved { border-color: #10b981; }
        .rejected { border-color: #ef4444; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .badge.pending { background: #fef3c7; color: #b45309; }
        .badge.approved { background: #d1fae5; color: #065f46; }
        .badge.rejected { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2><i class="fa-solid fa-calendar-minus"></i> Pengajuan Izin/Cuti</h2>
            <a href="index.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Formulir Izin</h3>
            <form id="leave-form">
                <div class="form-group">
                    <label>Dari Tanggal</label>
                    <input type="date" id="start-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Sampai Tanggal</label>
                    <input type="date" id="end-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Alasan</label>
                    <textarea id="reason" class="form-input" rows="3" placeholder="Sakit, Acara Keluarga, dll..." required></textarea>
                </div>
                <button type="submit" class="btn-submit">Kirim Pengajuan</button>
            </form>
        </div>

        <h4 style="margin-bottom:15px; color:#64748b;">Riwayat Pengajuan</h4>
        <div id="history-container" class="history-list">
            <div style="text-align:center; padding:20px; color:#94a3b8;">Memuat riwayat...</div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { collection, addDoc, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentUser = null;

        (async () => {
            currentUser = await checkAuth('siswa');
            if(currentUser) loadHistory();
        })();

        // 1. KIRIM PENGAJUAN
        document.getElementById('leave-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Mengirim..."; btn.disabled = true;

            try {
                await addDoc(collection(db, 'leave_requests'), {
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    startDate: document.getElementById('start-date').value,
                    endDate: document.getElementById('end-date').value,
                    reason: document.getElementById('reason').value,
                    status: 'pending', // Status awal
                    timestamp: serverTimestamp()
                });
                
                alert("Pengajuan berhasil dikirim! Menunggu persetujuan admin.");
                e.target.reset();
                loadHistory(); // Refresh list
            } catch(err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        };

        // 2. LOAD RIWAYAT
        async function loadHistory() {
            const container = document.getElementById('history-container');
            const q = query(collection(db, 'leave_requests'), where('studentId', '==', currentUser.uid), orderBy('timestamp', 'desc'));
            const snap = await getDocs(q);

            container.innerHTML = '';
            if(snap.empty) {
                container.innerHTML = '<div style="text-align:center; color:#ccc;">Belum ada pengajuan.</div>';
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                const statusLabel = d.status === 'pending' ? 'Menunggu' : (d.status === 'approved' ? 'Disetujui' : 'Ditolak');
                
                container.innerHTML += `
                    <div class="history-item ${d.status}">
                        <div>
                            <div style="font-weight:bold; margin-bottom:5px;">${d.reason}</div>
                            <div style="font-size:0.85rem; color:#64748b;">
                                <i class="fa-regular fa-calendar"></i> ${d.startDate} s/d ${d.endDate}
                            </div>
                        </div>
                        <div class="badge ${d.status}">${statusLabel}</div>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
