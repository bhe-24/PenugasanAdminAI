<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Izin - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #003366; --accent: #d63384; --bg: #f0f2f5; --border: #cbd5e1; }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: #334155; padding-bottom: 40px; }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; }

        /* --- HEADER SEPERTI KOP SURAT --- */
        .page-header {
            background: white; border-radius: 12px; padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px; border-top: 5px solid var(--primary);
            display: flex; align-items: center; justify-content: space-between;
        }
        .ph-title h2 { margin: 0; font-family: 'Merriweather', serif; color: var(--primary); font-size: 1.4rem; }
        .ph-title p { margin: 5px 0 0; font-size: 0.9rem; color: #64748b; }
        .btn-back { 
            background: #f1f5f9; color: #475569; padding: 8px 16px; 
            border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.9rem; 
            border: 1px solid #e2e8f0; transition: 0.2s;
        }
        .btn-back:hover { background: #e2e8f0; color: #1e293b; }

        /* --- FORMULIR RESMI --- */
        .form-card {
            background: white; border-radius: 12px; padding: 30px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .form-title {
            text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
            color: var(--primary); border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px; margin-bottom: 20px; font-size: 1rem;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: #475569; }
        
        .form-input { 
            width: 100%; padding: 12px; border: 1px solid var(--border); 
            border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; 
            transition: border-color 0.2s; font-family: inherit;
        }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }
        
        textarea.form-input { resize: vertical; min-height: 100px; }

        .btn-submit { 
            width: 100%; padding: 14px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-submit:hover { background: #002244; transform: translateY(-1px); }
        .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; }

        /* --- RIWAYAT --- */
        .history-section h3 { margin: 0 0 15px 0; font-size: 1.1rem; color: #334155; }
        .history-list { display: flex; flex-direction: column; gap: 15px; }
        
        .history-item { 
            background: white; padding: 20px; border-radius: 10px; 
            border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.2s;
        }
        .history-item:hover { transform: translateX(5px); border-color: #cbd5e1; }
        
        .h-info div:first-child { font-weight: 700; color: #1e293b; margin-bottom: 5px; }
        .h-date { font-size: 0.85rem; color: #64748b; display: flex; align-items: center; gap: 6px; }

        /* Status Badges */
        .badge { padding: 6px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; } /* Orange */
        .badge.approved { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; } /* Green */
        .badge.rejected { background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; } /* Red */

        /* Empty State */
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; background: white; border-radius: 12px; border: 1px dashed #cbd5e1; }
        .empty-state i { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <div class="ph-title">
                <h2>Permohonan Izin</h2>
                <p>Formulir Absensi & Cuti Siswa</p>
            </div>
            <a href="index.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
        </div>

        <div class="form-card">
            <div class="form-title"><i class="fa-solid fa-pen-to-square"></i> Isi Data Pengajuan</div>
            <form id="leave-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tanggal Mulai</label>
                        <input type="date" id="start-date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Selesai</label>
                        <input type="date" id="end-date" class="form-input" required>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 25px;">
                    <label>Alasan / Keterangan</label>
                    <textarea id="reason" class="form-input" placeholder="Contoh: Sakit demam, Izin acara keluarga, dll." required></textarea>
                </div>
                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-paper-plane"></i> Kirim Permohonan
                </button>
            </form>
        </div>

        <div class="history-section">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> Riwayat Pengajuan</h3>
            <div id="history-container" class="history-list">
                <div style="text-align:center; padding:30px; color:#64748b;">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Memeriksa data...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { collection, addDoc, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentUser = null;

        // Init
        (async () => {
            currentUser = await checkAuth('siswa');
            if(currentUser) loadHistory();
        })();

        // 1. Submit Logic
        document.getElementById('leave-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengirim...'; 
            btn.disabled = true;

            try {
                // Validasi Tanggal
                const start = document.getElementById('start-date').value;
                const end = document.getElementById('end-date').value;
                if(new Date(start) > new Date(end)) throw new Error("Tanggal selesai tidak boleh sebelum tanggal mulai.");

                await addDoc(collection(db, 'leave_requests'), {
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    startDate: start,
                    endDate: end,
                    reason: document.getElementById('reason').value.trim(),
                    status: 'pending', 
                    timestamp: serverTimestamp()
                });
                
                alert("Permohonan berhasil dikirim.");
                e.target.reset();
                loadHistory(); 
            } catch(err) {
                alert("Gagal: " + err.message);
            } finally {
                btn.innerHTML = originalContent; 
                btn.disabled = false;
            }
        };

        // 2. Load History Logic (FIXED EMPTY STATE)
        async function loadHistory() {
            const container = document.getElementById('history-container');
            
            try {
                const q = query(collection(db, 'leave_requests'), where('studentId', '==', currentUser.uid), orderBy('timestamp', 'desc'));
                const snap = await getDocs(q);

                container.innerHTML = ''; // Bersihkan loading

                // --- PERBAIKAN LOGIKA EMPTY ---
                if(snap.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fa-regular fa-folder-open"></i>
                            <p>Belum ada riwayat pengajuan izin.</p>
                        </div>
                    `;
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    
                    // Format Status
                    let statusLabel = 'Menunggu Verifikasi';
                    let statusClass = 'pending';
                    if (d.status === 'approved') { statusLabel = 'Disetujui'; statusClass = 'approved'; }
                    else if (d.status === 'rejected') { statusLabel = 'Ditolak'; statusClass = 'rejected'; }

                    // Format Tanggal (Opsional biar cantik)
                    const formatDate = (dateStr) => {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                    };

                    container.innerHTML += `
                        <div class="history-item">
                            <div class="h-info">
                                <div>${d.reason}</div>
                                <div class="h-date">
                                    <i class="fa-regular fa-calendar-days"></i> 
                                    ${formatDate(d.startDate)} - ${formatDate(d.endDate)}
                                </div>
                            </div>
                            <div class="badge ${statusClass}">
                                ${d.status === 'approved' ? '<i class="fa-solid fa-check"></i>' : ''} 
                                ${d.status === 'rejected' ? '<i class="fa-solid fa-xmark"></i>' : ''} 
                                ${statusLabel}
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div style="text-align:center; color:red;">Gagal memuat data.</div>`;
            }
        }
    </script>
</body>
</html>
