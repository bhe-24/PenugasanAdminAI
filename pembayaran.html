<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran Semester 3 - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS LAYAR (SCREEN) */
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; color: #333; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #f2994a; padding-bottom: 15px; }
        .page-header h2 { margin: 0; color: #003366; }

        /* KARTU TAGIHAN */
        .bill-card {
            background: linear-gradient(135deg, #003366, #004080);
            color: white; padding: 30px; border-radius: 16px; margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 51, 102, 0.2); position: relative; overflow: hidden;
        }
        .bill-amount { font-size: 2.5rem; font-weight: 700; margin: 10px 0; letter-spacing: 1px; color: #f2c94c; }
        .bill-label { opacity: 0.9; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* PILIHAN METODE BAYAR */
        .payment-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .option-card {
            background: white; border: 2px solid #eee; padding: 20px; border-radius: 12px; cursor: pointer; transition: 0.3s; text-align: center;
        }
        .option-card:hover { border-color: #f2994a; transform: translateY(-3px); }
        .option-card.selected { border-color: #003366; background-color: #f0f7ff; box-shadow: 0 0 0 2px #003366; }
        
        .opt-title { font-weight: bold; color: #003366; display: block; margin-bottom: 5px; }
        .opt-price { color: #f2994a; font-weight: 700; font-size: 1.2rem; }

        /* INFO SISWA */
        .info-card {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 30px; border-left: 5px solid #003366;
        }
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* TOMBOL */
        .btn-pay {
            background: linear-gradient(135deg, #f2994a, #f2c94c); color: white; border: none;
            padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; width: 100%; box-shadow: 0 5px 15px rgba(242, 153, 74, 0.3); transition: 0.3s;
        }
        .btn-print {
            background: #003366; color: white; border: none; padding: 15px 40px; border-radius: 50px; 
            font-size: 1.1rem; font-weight: 700; cursor: pointer; width: 100%;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px;
            text-align: center; position: relative;
        }
        .qris-img { width: 100%; max-width: 250px; margin: 15px 0; border: 2px solid #333; border-radius: 8px; }

        /* ----------------------------------------------------------- */
        /* --- CSS KHUSUS CETAK PDF (A4) --- */
        /* ----------------------------------------------------------- */
        #kwitansi-print-area { display: none; }

        @media print {
            @page { size: A4; margin: 0; }
            body * { visibility: hidden; }
            
            #kwitansi-print-area, #kwitansi-print-area * { visibility: visible; }
            #kwitansi-print-area {
                position: absolute; left: 0; top: 0; width: 210mm; /* A4 Width */
                display: block !important; background: white;
            }

            /* Desain Halaman */
            .print-page {
                width: 210mm; height: 297mm; /* A4 Height */
                padding: 20mm; box-sizing: border-box;
                position: relative; border-bottom: 1px dashed #ccc; /* Penanda potong */
                page-break-after: always;
            }

            /* Halaman 1: Kwitansi Resmi */
            .k-header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #003366; padding-bottom: 15px; }
            .k-logo { width: 80px; height: auto; display: block; margin: 0 auto 10px; }
            .k-title { font-family: 'Playfair Display', serif; font-size: 28pt; color: #003366; margin: 0; font-weight: 900; letter-spacing: 2px; }
            .k-subtitle { font-family: 'Courier Prime', monospace; font-size: 10pt; letter-spacing: 3px; margin-top: 5px; }

            .k-body { font-family: 'Courier Prime', monospace; margin-top: 40px; font-size: 12pt; line-height: 2; }
            .k-row { display: flex; margin-bottom: 10px; }
            .k-label { width: 200px; font-weight: bold; }
            .k-colon { width: 20px; }
            .k-value { flex: 1; border-bottom: 1px dotted #333; }

            .k-total-box {
                margin-top: 40px; background: #eee; padding: 15px; 
                font-family: 'Courier Prime', monospace; font-weight: bold; font-size: 16pt;
                border: 2px solid #003366; display: inline-block;
            }

            .k-footer { position: absolute; bottom: 30mm; right: 20mm; text-align: center; width: 200px; }
            .k-stamp { position: absolute; top: -30px; left: -30px; width: 130px; opacity: 0.85; transform: rotate(-10deg); mix-blend-mode: multiply; }
            
            /* Halaman 2: Rincian */
            .r-title { font-family: 'Poppins', sans-serif; font-size: 20pt; font-weight: bold; color: #003366; text-align: center; margin-bottom: 40px; text-transform: uppercase; }
            .r-table { width: 100%; border-collapse: collapse; font-family: 'Poppins', sans-serif; font-size: 11pt; }
            .r-table th { background: #003366; color: white; padding: 15px; text-align: left; }
            .r-table td { border-bottom: 1px solid #ddd; padding: 12px; }
            .r-table tr:last-child td { border-bottom: 2px solid #003366; font-weight: bold; font-size: 12pt; }
            
            .r-note { margin-top: 40px; font-size: 10pt; color: #555; border: 1px dashed #555; padding: 15px; border-radius: 8px; }
        }

        .hidden { display: none !important; }
        .back-btn { text-decoration: none; color: #333; background: #eee; padding: 8px 20px; border-radius: 50px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <h2><i class="fa-solid fa-file-invoice-dollar"></i> Administrasi</h2>
            <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
        </div>

        <div id="loading" style="text-align:center; padding:50px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size:3rem; color:#f2994a;"></i>
            <p>Memeriksa data tagihan...</p>
        </div>

        <div id="main-content" class="hidden">
            
            <div class="bill-card">
                <div class="bill-label">Total Kewajiban Semester 3</div>
                <div class="bill-amount">Rp 75.450</div>
                <div class="bill-label" id="status-text-main">Status: Menunggu Pembayaran</div>
            </div>

            <div class="info-card">
                <h4 style="margin:0 0 15px 0; color:#003366; border-bottom:2px solid #eee; padding-bottom:10px;">Data Siswa</h4>
                <div class="info-row"><span style="color:#666;">Nama</span><b id="disp-name">-</b></div>
                <div class="info-row"><span style="color:#666;">Semester</span><b id="disp-sem">-</b></div>
                <div class="info-row"><span style="color:#666;">Status Bayar</span><b id="disp-status" style="color:#d63384;">Belum Lunas</b></div>
            </div>

            <div id="payment-selection-area">
                <h4 style="margin-bottom:15px;">Pilih Metode Pembayaran:</h4>
                <div class="payment-options">
                    <div class="option-card selected" onclick="selectOption('lunas')" id="opt-lunas">
                        <span class="opt-title"><i class="fa-solid fa-check-double"></i> LUNAS</span>
                        <span class="opt-price">Rp 75.450</span>
                        <p style="font-size:0.8rem; margin:5px 0 0; color:#666;">Sekali Bayar</p>
                    </div>
                    <div class="option-card" onclick="selectOption('cicil')" id="opt-cicil">
                        <span class="opt-title"><i class="fa-solid fa-hourglass-half"></i> CICILAN</span>
                        <span class="opt-price">Rp 37.725</span>
                        <p style="font-size:0.8rem; margin:5px 0 0; color:#666;">Bayar 50% Sekarang<br>(Sisa bulan depan)</p>
                    </div>
                </div>

                <button onclick="openPaymentModal()" class="btn-pay" id="btn-konfirmasi-bayar">
                    <i class="fa-solid fa-qrcode"></i> Bayar Rp 75.450 Sekarang
                </button>
            </div>

            <div id="print-area" class="hidden" style="text-align:center; margin-top:30px;">
                <p style="color:#0f5132; background:#d1e7dd; padding:10px; border-radius:8px; display:inline-block;">
                    <i class="fa-solid fa-check-circle"></i> Terima kasih. Pembayaran Anda tercatat.
                </p>
                <div style="margin-top:15px;">
                    <button onclick="window.print()" class="btn-print">
                        <i class="fa-solid fa-print"></i> Unduh Kuitansi & Rincian (PDF)
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div id="payment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button onclick="document.getElementById('payment-modal').classList.add('hidden')" style="position:absolute; top:10px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3 style="margin-top:0; color:#003366;">Scan QRIS</h3>
            <p style="font-size:0.9rem;">Total Bayar: <b id="modal-nominal" style="font-size:1.2rem; color:#f2994a;">Rp -</b></p>
            
            <img src="https://imgur.com/link_qris_kamu.png" class="qris-img" alt="QRIS Code">
            
            <p style="font-size:0.8rem; color:#666;">Setelah transfer, <b>WAJIB</b> upload bukti:</p>
            
            <a href="https://forms.gle/link_google_form_kamu" target="_blank" class="btn-pay" style="display:block; text-decoration:none; padding:10px; font-size:0.9rem; margin-top:10px; box-shadow:none;">
                <i class="fa-brands fa-google"></i> Upload Bukti di Sini
            </a>
            
            <p style="font-size:0.7rem; color:#999; margin-top:15px;">Admin akan memverifikasi max 1x24 jam.<br>Refresh halaman ini nanti untuk cek status.</p>
        </div>
    </div>

    <div id="kwitansi-print-area">
        
        <div class="print-page">
            <div class="k-header">
                <img src="https://imgur.com/5Srjyo4.png" class="k-logo">
                <h1 class="k-title">KWITANSI RESMI</h1>
                <div class="k-subtitle">CENDEKIA AKSARA SCHOOL</div>
            </div>

            <div class="k-body">
                <div class="k-row">
                    <span class="k-label">No. Referensi</span><span class="k-colon">:</span><span class="k-value" id="k-ref">INV/2024/XXX</span>
                </div>
                <div class="k-row">
                    <span class="k-label">Telah Terima Dari</span><span class="k-colon">:</span><span class="k-value" id="k-nama">Nama Siswa</span>
                </div>
                <div class="k-row">
                    <span class="k-label">Untuk Pembayaran</span><span class="k-colon">:</span><span class="k-value">Administrasi Semester 3 (Paket Lengkap)</span>
                </div>
                <div class="k-row">
                    <span class="k-label">Status Bayar</span><span class="k-colon">:</span><span class="k-value" id="k-status">LUNAS</span>
                </div>
                <div class="k-row">
                    <span class="k-label">Tanggal</span><span class="k-colon">:</span><span class="k-value" id="k-tgl">-</span>
                </div>
            </div>

            <div class="k-total-box">
                TERBILANG: <span id="k-nominal">Rp 75.450,-</span>
            </div>

            <div class="k-footer">
                <p>Jakarta, <span id="k-tgl-ttd"></span></p>
                <div style="position:relative; height:80px; margin-top:20px;">
                    <img src="https://imgur.com/YvrNYRw.png" class="k-stamp">
                    <p style="position:absolute; bottom:0; width:100%; border-bottom:1px solid black; font-weight:bold;">Admin Keuangan</p>
                </div>
            </div>
        </div>

        <div class="print-page">
            <div class="k-header" style="border:none;">
                <img src="https://imgur.com/5Srjyo4.png" class="k-logo" style="width:60px;">
                <h2 class="r-title" style="font-size:16pt; margin-top:10px;">RINCIAN PEMBAYARAN</h2>
            </div>

            <table class="r-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Keterangan Item</th>
                        <th style="text-align:right;">Nominal</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>1</td><td>Buku Rapor Akademik</td><td align="right">Rp 20.450</td></tr>
                    <tr><td>2</td><td>Special Book (Komunitas Random)</td><td align="right">Rp 25.000</td></tr>
                    <tr><td>3</td><td>Biaya Administrasi</td><td align="right">Rp 5.000</td></tr>
                    <tr><td>4</td><td>Biaya Bimbingan Semester</td><td align="right">Rp 25.000</td></tr>
                    <tr><td colspan="3" style="border:none; height:20px;"></td></tr>
                    <tr style="background:#f4f6f9;">
                        <td colspan="2"><strong>TOTAL TAGIHAN</strong></td>
                        <td align="right"><strong>Rp 75.450</strong></td>
                    </tr>
                </tbody>
            </table>

            <div class="r-note">
                <strong>Catatan Penting:</strong>
                <ul>
                    <li>Special Book diberikan secara acak sesuai ketersediaan komunitas.</li>
                    <li>Simpan bukti ini sebagai syarat pengambilan buku rapor.</li>
                    <li>Jika memilih metode CICILAN, sisa pembayaran akan ditagihkan 30 hari dari tanggal pembayaran pertama.</li>
                </ul>
            </div>
        </div>

    </div>

    <script type="module">
        import { db, checkAuth } from "./js/firebase-config.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentNominal = 75450;
        let selectedMode = 'lunas'; // lunas | cicil

        (async () => {
            const user = await checkAuth('siswa');
            if (user) {
                // Proteksi Semester
                let rawSem = user.semester || 1;
                let sem = parseInt(String(rawSem).replace(/\D/g, '')) || 1;
                
                if (sem < 3) {
                    alert("Maaf, pembayaran ini khusus semester 3 ke atas.");
                    window.location.href = 'index.html';
                    return;
                }
                
                renderPage(user, sem);
            }
        })();

        function renderPage(user, sem) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            document.getElementById('disp-name').innerText = user.name;
            document.getElementById('disp-sem').innerText = sem;

            // SETUP DATA KWITANSI (PDF)
            document.getElementById('k-nama').innerText = user.name;
            document.getElementById('k-ref').innerText = `INV/CA/${new Date().getFullYear()}/${user.uid.substring(0,5).toUpperCase()}`;
            const tgl = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
            document.getElementById('k-tgl').innerText = tgl;
            document.getElementById('k-tgl-ttd').innerText = tgl;

            // CEK STATUS PEMBAYARAN DARI DATABASE
            // Asumsi field di DB: statusPembayaran = 'Lunas' | 'Cicilan' | null
            const status = user.statusPembayaran; 

            if (status === 'Lunas') {
                showPaidState('LUNAS', 'Rp 75.450,-');
            } else if (status === 'Cicilan') {
                // Jika DB mencatat cicilan, berarti dia sudah bayar separuh
                // Tampilkan tombol cetak, tapi statusnya 'CICILAN (50%)'
                // ATAU tampilkan tombol bayar sisa? Sesuai request: "muncul tagihan lagi"
                // Untuk simplifikasi kwitansi saat ini, kita anggap dia cetak bukti pembayaran pertama.
                showPaidState('CICILAN KE-1 (LUNAS 50%)', 'Rp 37.725,-');
                
                // Tambahan info cicilan di layar
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                document.getElementById('disp-status').innerHTML = `<span style="color:#d63384;">Cicilan Aktif</span><br><small>Tagihan berikutnya: ${nextMonth.toLocaleDateString('id-ID')}</small>`;
            } else {
                // Belum Bayar
                document.getElementById('payment-selection-area').classList.remove('hidden');
            }
        }

        function showPaidState(statusLabel, nominalLabel) {
            document.getElementById('payment-selection-area').classList.add('hidden');
            document.getElementById('print-area').classList.remove('hidden');
            
            document.getElementById('disp-status').innerText = statusLabel;
            document.getElementById('disp-status').style.color = '#0f5132';
            
            // Update Teks PDF
            document.getElementById('k-status').innerText = statusLabel;
            document.getElementById('k-nominal').innerText = nominalLabel;
        }

        // LOGIKA PILIH OPSI BAYAR
        window.selectOption = (mode) => {
            selectedMode = mode;
            const btn = document.getElementById('btn-konfirmasi-bayar');
            
            // Reset Style
            document.getElementById('opt-lunas').classList.remove('selected');
            document.getElementById('opt-cicil').classList.remove('selected');
            
            // Set Style Active
            document.getElementById(`opt-${mode}`).classList.add('selected');

            if (mode === 'lunas') {
                currentNominal = 75450;
                btn.innerHTML = '<i class="fa-solid fa-qrcode"></i> Bayar Rp 75.450 Sekarang';
            } else {
                currentNominal = 37725;
                btn.innerHTML = '<i class="fa-solid fa-qrcode"></i> Bayar Rp 37.725 (DP 50%)';
            }
        };

        // BUKA MODAL
        window.openPaymentModal = () => {
            const formatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(currentNominal);
            document.getElementById('modal-nominal').innerText = formatted;
            document.getElementById('payment-modal').classList.remove('hidden');
        };

    </script>
</body>
</html>
