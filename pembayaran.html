<!DOCTYPE html> 
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* STYLE TIDAK DIUBAH */
        * { box-sizing: border-box; }
        :root { --primary: #003366; --accent: #4361ee; --bg: #f4f6f9; }
        body { background-color: var(--bg); font-family: 'Outfit', sans-serif; color: #333; margin: 0; padding-bottom: 40px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        /* ... STYLE LAIN TETAP ... */
    </style>
</head>
<body>

<!-- ================= HTML TIDAK DIUBAH ================= -->

<script type="module">
import { db, checkAuth } from "./js/firebase-config.js";
import { collection, query, where, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

let currentUser = null;
const GOOGLE_FORM_URL = "https://forms.gle/LHpkuvLxLH4DjpK9A";

/* ================= PAYMENT FLOW ================= */

window.triggerUploadFlow = () => {
    localStorage.setItem('payment_status', 'uploading');
    window.open(GOOGLE_FORM_URL, '_blank');
    document.getElementById('modal-qris').classList.remove('active');
};

document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === 'visible') {
        if (localStorage.getItem('payment_status') === 'uploading') {
            document.getElementById('modal-confirm').classList.add('active');
            localStorage.removeItem('payment_status');
        }
    }
});

window.handleConfirm = async (isDone) => {
    document.getElementById('modal-confirm').classList.remove('active');
    if (isDone) {
        document.getElementById('modal-loading').classList.add('active');
        try {
            await updateDoc(doc(db, 'users', currentUser.uid), {
                paymentStatus: 'waiting',
                paymentDate: serverTimestamp()
            });

            const targetTime = new Date().getTime() + (24 * 60 * 60 * 1000);
            localStorage.setItem('payment_timer_target', targetTime);

            document.getElementById('modal-loading').classList.remove('active');
            location.reload();
        } catch(e) {
            document.getElementById('modal-loading').classList.remove('active');
            alert("Gagal kirim data.");
        }
    } else {
        document.getElementById('modal-qris').classList.add('active');
    }
};

/* ================= TIMER ================= */

function showTimerModal() {
    document.getElementById('modal-timer').classList.add('active');
    updateTimer();
    setInterval(updateTimer, 1000);
}

function updateTimer() {
    const target = localStorage.getItem('payment_timer_target');
    if (!target) return;

    const now = new Date().getTime();
    const distance = target - now;

    if (distance < 0) {
        document.getElementById('countdown').innerHTML = "00:00:00";
        return;
    }

    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((distance % (1000 * 60)) / 1000);

    document.getElementById('countdown').innerHTML =
        (h<10?'0':'')+h + ":" + (m<10?'0':'')+m + ":" + (s<10?'0':'')+s;
}

/* ================= RENDER LOGIC ================= */

(async () => {
    currentUser = await checkAuth('siswa');
    if (!currentUser) return;

    // ✅ FIX 1: database JADI SUMBER UTAMA
    if (currentUser.paymentStatus !== 'waiting') {
        localStorage.removeItem('payment_timer_target');
    }

    const rawSem = currentUser.semester || 1;
    const sem = parseInt(String(rawSem).replace(/\D/g, '')) || 1;
    renderData(currentUser, sem);
})();

function setWaitingUI() {
    const badge = document.getElementById('status-badge');
    const actionArea = document.getElementById('action-area');

    badge.className = 'status-badge st-waiting';
    badge.innerHTML = '<i class="fa-solid fa-clock"></i> MENUNGGU VERIFIKASI';

    actionArea.innerHTML = `
        <button onclick="showTimerModal()" class="btn-action btn-waiting">
            <i class="fa-solid fa-hourglass-half"></i> Sedang Diproses Admin
        </button>
    `;
}

async function renderData(user, sem) {
    document.getElementById('header-sem').innerText = "Semester " + sem;
    document.getElementById('st-name').innerText = user.name;
    document.getElementById('st-uid').innerText = user.uid.substring(0,6).toUpperCase();
    document.getElementById('st-ips').innerText = parseFloat(user.ips||0).toFixed(2);

    const status = user.statusPembayaran;
    const paymentStatus = user.paymentStatus;

    const badge = document.getElementById('status-badge');
    const amountEl = document.getElementById('amount-display');
    const detailsEl = document.getElementById('rincian-list');
    const actionArea = document.getElementById('action-area');
    const labelTagihan = document.getElementById('label-tagihan');

    // ✅ FIX 2: HAPUS dominasi localStorage
    const isWaiting = paymentStatus === 'waiting';

    if (isWaiting && status !== 'Lunas') {
        setWaitingUI();
        return;
    }

    /* ================= RENDER NORMAL (TIDAK DIUBAH) ================= */
    if (sem < 3) {
        const q = query(collection(db, 'exams'), where('status', '==', 'active'));
        const snap = await getDocs(q);
        const count = snap.size;
        const totalBayar = count * 1000;

        labelTagihan.innerText = "TAGIHAN UJIAN";
        amountEl.innerText = "Rp " + totalBayar.toLocaleString('id-ID');

        if (status === 'Lunas') {
            badge.className = 'status-badge st-paid';
            badge.innerHTML = '<i class="fa-solid fa-check"></i> LUNAS';
        } else {
            badge.className = 'status-badge st-unpaid';
            badge.innerHTML = 'BELUM BAYAR';
        }
    }
}

/* ================= GLOBAL ================= */

window.showQRIS = (amount, label) => {
    document.getElementById('qris-amount').innerText = "Rp " + amount.toLocaleString('id-ID');
    document.getElementById('qris-title').innerText = label;
    document.getElementById('modal-qris').classList.add('active');
};

window.closeAllModals = () =>
    document.querySelectorAll('.modal-overlay')
    .forEach(el => el.classList.remove('active'));

window.showTimerModal = showTimerModal;
</script>

</body>
</html>
