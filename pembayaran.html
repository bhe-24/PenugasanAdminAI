<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran Semester 3 - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #f2994a; padding-bottom: 15px; }
        .page-header h2 { margin: 0; color: #003366; }

        /* KARTU TAGIHAN (Dinamis) */
        .bill-card {
            background: linear-gradient(135deg, #003366, #004080);
            color: white; padding: 30px; border-radius: 16px; margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 51, 102, 0.2); position: relative; overflow: hidden;
        }
        .bill-card::after {
            content: ''; position: absolute; right: -30px; top: -30px; width: 120px; height: 120px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
        }
        .bill-amount { font-size: 2.5rem; font-weight: 700; margin: 10px 0; letter-spacing: 1px; }
        .bill-label { opacity: 0.8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* KARTU INFO SISWA */
        .info-card {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 30px;
            border-left: 5px solid #003366; display: flex; flex-direction: column; gap: 15px;
        }
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .info-label { color: #666; font-weight: 500; }
        .info-val { font-weight: 700; color: #003366; }

        .status-box { 
            text-align: center; padding: 15px; border-radius: 8px; font-weight: bold; margin-top: 10px; 
        }
        .status-lunas { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .status-belum { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

        /* TOMBOL */
        .action-area { text-align: center; }
        .btn-pay {
            background: linear-gradient(135deg, #f2994a, #f2c94c); color: white; border: none;
            padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 5px 15px rgba(242, 153, 74, 0.3); transition: 0.3s;
        }
        .btn-pay:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(242, 153, 74, 0.4); }

        .btn-print {
            background: #003366; color: white; border: none;
            padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3); transition: 0.3s;
        }
        .btn-print:hover { background: #001f3f; }

        /* MODAL POPUP (Overlay) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px;
            text-align: center; animation: popUp 0.3s ease; position: relative;
        }
        .qris-img { width: 100%; max-width: 250px; margin: 15px 0; border: 2px solid #333; border-radius: 8px; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- DESAIN KWITANSI CETAK --- */
        #kwitansi-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #kwitansi-area, #kwitansi-area * { visibility: visible; }
            #kwitansi-area {
                position: absolute; left: 0; top: 0; width: 100%; display: block !important;
                background: white; color: black; font-family: 'Courier Prime', monospace;
                padding: 40px; box-sizing: border-box;
            }
            .kwitansi-border { border: 2px solid #333; padding: 30px; position: relative; }
            .kwitansi-header { text-align: center; border-bottom: 2px double #333; padding-bottom: 20px; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 20px; }
            .kwitansi-logo { width: 80px; filter: grayscale(100%); }
            .kwitansi-title { font-size: 24pt; font-weight: bold; margin: 0; text-transform: uppercase; }
            .kwitansi-row { display: flex; margin-bottom: 15px; font-size: 14pt; }
            .k-label { width: 220px; font-weight: bold; }
            .k-val { flex: 1; border-bottom: 1px dotted #333; }
            .kwitansi-footer { margin-top: 50px; display: flex; justify-content: space-between; align-items: flex-end; }
            .cap-basah { position: absolute; top: -40px; left: -20px; width: 120px; opacity: 0.8; transform: rotate(-10deg); }
            .ttd-box { text-align: center; position: relative; width: 200px; }
        }

        .hidden { display: none !important; }
        .back-btn { text-decoration: none; color: #333; background: #eee; padding: 8px 20px; border-radius: 50px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <h2><i class="fa-solid fa-file-invoice-dollar"></i> Administrasi</h2>
            <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
        </div>

        <div id="loading" style="text-align:center; padding:50px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size:3rem; color:#f2994a;"></i>
            <p>Memeriksa data tagihan...</p>
        </div>

        <div id="main-content" class="hidden">
            
            <div class="bill-card">
                <div class="bill-label">Total Tagihan Semester 3</div>
                <div class="bill-amount" id="display-nominal">Rp -</div>
                <div class="bill-label" id="text-status-bill">Menunggu Pembayaran</div>
            </div>

            <div class="info-card">
                <h3 style="margin:0 0 15px 0; color:#003366;"><i class="fa-solid fa-user-graduate"></i> Data Siswa</h3>
                <div class="info-row"><span class="info-label">Nama Lengkap</span><span class="info-val" id="disp-name">-</span></div>
                <div class="info-row"><span class="info-label">Semester</span><span class="info-val" id="disp-sem">-</span></div>
                <div class="info-row"><span class="info-label">IPS Terakhir</span><span class="info-val" id="disp-ips">-</span></div>
                
                <div id="status-display" class="status-box status-belum">BELUM LUNAS</div>
            </div>

            <div class="action-area">
                <div id="btn-bayar-wrapper">
                    <p style="margin-bottom:15px; color:#666;">Anda belum menyelesaikan administrasi.</p>
                    <button onclick="openPaymentModal()" class="btn-pay">
                        <i class="fa-solid fa-qrcode"></i> Konfirmasi Bayar Sekarang
                    </button>
                </div>

                <div id="btn-cetak-wrapper" class="hidden">
                    <p style="margin-bottom:15px; color:#0f5132;"><i class="fa-solid fa-check-circle"></i> LUNAS. Terima kasih.</p>
                    <button onclick="window.print()" class="btn-print">
                        <i class="fa-solid fa-print"></i> Cetak Bukti Kwitansi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button onclick="closePaymentModal()" style="position:absolute; top:10px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3 style="margin-top:0; color:#003366;">Scan QRIS</h3>
            <p style="font-size:0.9rem;">Total Bayar: <b id="modal-nominal">Rp -</b></p>
            
            <img src="LINK_IMGUR_QRIS_DISINI" class="qris-img" alt="QRIS Code">
            
            <p style="font-size:0.8rem; color:#666;">Setelah transfer, upload bukti di sini:</p>
            
            <a href="LINK_GOOGLE_FORM_DISINI" target="_blank" class="btn-pay" style="display:block; text-decoration:none; padding:10px; font-size:0.9rem; margin-top:10px; box-shadow:none;">
                <i class="fa-brands fa-google"></i> Upload Bukti via G-Form
            </a>
            
            <p style="font-size:0.7rem; color:#999; margin-top:15px;">Admin akan memverifikasi max 1x24 jam.<br>Refresh halaman ini nanti untuk cek status.</p>
        </div>
    </div>

    <div id="kwitansi-area">
        <div class="kwitansi-border">
            <div class="kwitansi-header">
                <img src="LINK_LOGO_SEKOLAH" class="kwitansi-logo">
                <div>
                    <h1 class="kwitansi-title">KWITANSI PEMBAYARAN</h1>
                    <p style="margin:0;">Cendekia Aksara - Official Receipt</p>
                </div>
            </div>
            <div class="kwitansi-body">
                <div class="kwitansi-row"><span class="k-label">No. Transaksi</span><span class="k-val" id="k-id">INV/CA/XXX</span></div>
                <div class="kwitansi-row"><span class="k-label">Telah Terima Dari</span><span class="k-val" id="k-nama">-</span></div>
                <div class="kwitansi-row"><span class="k-label">Untuk Pembayaran</span><span class="k-val">Administrasi Semester 3</span></div>
                <div class="kwitansi-row"><span class="k-label">Jumlah Uang</span><span class="k-val" id="k-jumlah">Rp -</span></div>
                <div class="kwitansi-row"><span class="k-label">Status</span><span class="k-val">LUNAS</span></div>
                <div class="kwitansi-row"><span class="k-label">Tanggal Cetak</span><span class="k-val" id="k-tgl">-</span></div>
            </div>
            <div class="kwitansi-footer">
                <div style="border: 2px solid black; padding: 10px 20px; font-size: 18pt; font-weight: bold;">LUNAS</div>
                <div class="ttd-box">
                    <p>Bagian Keuangan</p>
                    <img src="LINK_IMGUR_CAP_BASAH" class="cap-basah">
                    <br><br><br>
                    <p style="text-decoration: underline; font-weight: bold;">Admin Keuangan</p>
                </div>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:350px;">
            <div id="alert-icon" style="font-size:3rem; margin-bottom:10px;">⚠️</div>
            <h3 id="alert-title">Perhatian</h3>
            <p id="alert-msg">Pesan alert.</p>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" style="background:#003366; color:white; border:none; padding:10px 25px; border-radius:50px; cursor:pointer; margin-top:15px;">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "./js/firebase-config.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentNominal = 0;

        (async () => {
            const currentUser = await checkAuth('siswa');
            if (currentUser) {
                // 1. Proteksi Semester
                let rawSem = currentUser.semester || 1;
                let sem = parseInt(String(rawSem).replace(/\D/g, '')) || 1;

                if (sem < 3) {
                    showAlert('Akses Ditolak', 'Menu ini khusus untuk siswa Semester 3 ke atas.');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                // 2. Load Nominal Tagihan dari Admin
                try {
                    const settingSnap = await getDoc(doc(db, 'settings', 'payment_config'));
                    if(settingSnap.exists()) {
                        currentNominal = settingSnap.data().amount || 0;
                    } else {
                        currentNominal = 0; // Default jika admin belum set
                    }
                } catch(e) { console.error(e); }

                // 3. Render Data
                renderData(currentUser, sem);
            }
        })();

        function renderData(user, sem) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            // Format Rupiah
            const formattedNominal = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(currentNominal);

            document.getElementById('display-nominal').innerText = formattedNominal;
            document.getElementById('modal-nominal').innerText = formattedNominal;
            document.getElementById('k-jumlah').innerText = formattedNominal;

            document.getElementById('disp-name').innerText = user.name;
            document.getElementById('disp-sem').innerText = sem;
            document.getElementById('disp-ips').innerText = parseFloat(user.ips || 0).toFixed(2);

            // Kwitansi Data
            document.getElementById('k-nama').innerText = user.name;
            document.getElementById('k-tgl').innerText = new Date().toLocaleDateString('id-ID');
            document.getElementById('k-id').innerText = `INV/${new Date().getFullYear()}/${user.uid.substring(0,6).toUpperCase()}`;

            const isLunas = user.statusPembayaran === 'Lunas';

            if (isLunas) {
                const badge = document.getElementById('status-display');
                badge.className = 'status-box status-lunas';
                badge.innerHTML = '<i class="fa-solid fa-check-circle"></i> LUNAS';
                document.getElementById('text-status-bill').innerText = "Sudah Dibayar";

                document.getElementById('btn-bayar-wrapper').classList.add('hidden');
                document.getElementById('btn-cetak-wrapper').classList.remove('hidden');
            }
        }

        // Custom Alert Logic
        function showAlert(title, msg) {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('alert-modal').classList.remove('hidden');
        }

        window.openPaymentModal = () => document.getElementById('payment-modal').classList.remove('hidden');
        window.closePaymentModal = () => document.getElementById('payment-modal').classList.add('hidden');

    </script>
</body>
</html>
