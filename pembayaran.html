<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keuangan - Cendekia Aksara</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Outfit',sans-serif;background:#f4f6f9}
.container{max-width:1100px;margin:auto;padding:20px}
.status-badge{padding:6px 12px;border-radius:20px;font-weight:700;font-size:.75rem}
.st-unpaid{background:#fee2e2;color:#991b1b}
.st-paid{background:#dcfce7;color:#166534}
.st-waiting{background:#e0f2fe;color:#0369a1}
.btn-action{padding:14px;border-radius:12px;font-weight:700;border:none;cursor:pointer}
.btn-waiting{background:#cbd5e1;color:#475569}
</style>
</head>

<body>
<div class="container">
<h2 id="st-name">Memuat...</h2>
<div id="status-badge" class="status-badge">-</div>
<div id="amount-display">Rp -</div>
<div id="action-area"></div>
</div>

<script type="module">
import { db, checkAuth } from "./js/firebase-config.js";
import { doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

let currentUser = null;

/* ================== AUTH & RENDER ================== */
(async () => {
    currentUser = await checkAuth('siswa');
    if (!currentUser) return;

    /* ðŸ”¥ JIKA ADMIN SUDAH VERIFIKASI â†’ MATIKAN TIMER */
    if (currentUser.paymentStatus !== 'waiting') {
        localStorage.removeItem('payment_timer_target');
    }

    renderUI(currentUser);
})();

/* ================== UI LOGIC ================== */
function renderUI(user){
    document.getElementById('st-name').innerText = user.name;

    /* ðŸ”¥ PRIORITAS STATUS ADMIN */
    if (user.statusPembayaran === 'Lunas') {
        setPaidUI();
        return;
    }

    if (user.paymentStatus === 'waiting') {
        setWaitingUI();
        return;
    }

    setUnpaidUI();
}

function setWaitingUI(){
    document.getElementById('status-badge').className = 'status-badge st-waiting';
    document.getElementById('status-badge').innerText = 'MENUNGGU VERIFIKASI';
    document.getElementById('action-area').innerHTML =
        `<button class="btn-action btn-waiting">Diproses Admin</button>`;
}

function setPaidUI(){
    document.getElementById('status-badge').className = 'status-badge st-paid';
    document.getElementById('status-badge').innerText = 'LUNAS';
    document.getElementById('amount-display').innerText = 'Rp 0';
    document.getElementById('action-area').innerHTML =
        `<a href="kwitansi.html" class="btn-action">Lihat Kwitansi</a>`;
}

function setUnpaidUI(){
    document.getElementById('status-badge').className = 'status-badge st-unpaid';
    document.getElementById('status-badge').innerText = 'BELUM BAYAR';
    document.getElementById('amount-display').innerText = 'Rp 75.450';
    document.getElementById('action-area').innerHTML =
        `<button class="btn-action">Bayar Sekarang</button>`;
}

/* ================== KONFIRMASI USER ================== */
window.confirmPayment = async () => {
    await updateDoc(doc(db,'users',currentUser.uid),{
        paymentStatus:'waiting',
        paymentDate:serverTimestamp()
    });
    localStorage.setItem('payment_timer_target',Date.now()+86400000);
    location.reload();
};
</script>
</body>
</html>
