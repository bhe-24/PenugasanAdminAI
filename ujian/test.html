<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Berlangsung - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #003366; --accent: #4361ee; --bg: #f4f7fe; }
        
        body { font-family: 'Outfit', sans-serif; background: var(--bg); margin: 0; padding-top: 80px; padding-bottom: 40px; color: #333; user-select: none; -webkit-user-select: none; }
        
        /* TOP BAR */
        .top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; z-index: 100; box-sizing: border-box;
        }
        .exam-info { font-weight: 700; color: var(--primary); font-size: 1.1rem; display: flex; flex-direction: column; }
        .exam-sub { font-size: 0.8rem; color: #64748b; font-weight: 400; }
        
        .timer-box {
            background: #fee2e2; color: #b91c1c; padding: 8px 16px; border-radius: 50px;
            font-weight: 700; font-family: monospace; font-size: 1.2rem; border: 1px solid #fecaca;
            display: flex; align-items: center; gap: 8px;
        }

        /* CONTAINER SOAL */
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        .q-card {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.03); border: 1px solid #eef2f6;
            margin-bottom: 30px; animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .q-num { font-size: 0.9rem; font-weight: 700; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .q-text { font-size: 1.25rem; font-weight: 600; line-height: 1.6; margin-bottom: 30px; color: #1e293b; }

        /* OPSI JAWABAN */
        .option-item {
            display: flex; align-items: center; gap: 15px;
            padding: 18px 25px; border: 2px solid #f1f5f9; border-radius: 12px;
            margin-bottom: 15px; cursor: pointer; transition: 0.2s;
            background: #fff; position: relative;
        }
        .option-item:hover { border-color: #cbd5e1; background: #f8fafc; }
        
        .option-item.selected { border-color: var(--accent); background: #e0f2fe; color: #0369a1; }
        
        .option-circle {
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid #cbd5e1;
            flex-shrink: 0; display: flex; justify-content: center; align-items: center; font-size: 0.9rem; font-weight: 700;
        }
        .option-item.selected .option-circle { background: var(--accent); border-color: var(--accent); color: white; }

        /* NAVIGASI */
        .nav-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; }
        
        .btn { padding: 14px 28px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 1rem; transition: 0.2s; }
        .btn-prev { background: #e2e8f0; color: #475569; visibility: hidden; }
        .btn-prev:hover { background: #cbd5e1; }
        
        .btn-next { background: var(--primary); color: white; }
        .btn-next:hover { background: #1e3a8a; }
        
        .btn-finish { background: #16a34a; color: white; display: none; }
        .btn-finish:hover { background: #15803d; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; color: #f59e0b; }
        .btn-modal { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin: 0 5px; }
        .btn-yes { background: var(--primary); color: white; }
        .btn-no { background: #eee; color: #333; }
        
        #loading-overlay { z-index: 3000; background: white; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="exam-info">
            <span id="exam-title">Memuat Ujian...</span>
            <span class="exam-sub" id="q-indicator">Soal - / -</span>
        </div>
        <div class="timer-box">
            <i class="fa-regular fa-clock"></i> <span id="timer">--:--</span>
        </div>
    </div>

    <div class="container">
        <div id="q-content"></div>

        <div class="nav-buttons">
            <button class="btn btn-prev" id="btn-prev" onclick="navStep(-1)">
                <i class="fa-solid fa-arrow-left"></i> Sebelumnya
            </button>
            <button class="btn btn-next" id="btn-next" onclick="navStep(1)">
                Selanjutnya <i class="fa-solid fa-arrow-right"></i>
            </button>
            <button class="btn btn-finish" id="btn-finish" onclick="confirmFinish()">
                Selesai Ujian <i class="fa-solid fa-check-circle"></i>
            </button>
        </div>
    </div>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-icon"><i class="fa-solid fa-circle-question"></i></div>
            <h3>Kumpulkan Jawaban?</h3>
            <p style="color:#666; margin-bottom:20px;">Pastikan semua soal terjawab. Anda tidak bisa mengulangi ujian ini setelah dikumpulkan.</p>
            <button class="btn-modal btn-no" onclick="closeModal()">Cek Lagi</button>
            <button class="btn-modal btn-yes" onclick="processSubmit()">Ya, Kumpulkan</button>
        </div>
    </div>

    <div id="loading-overlay" class="modal-overlay active">
        <div style="text-align:center;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary);"></i>
            <p style="margin-top:15px; font-weight:600;">Menyiapkan Ujian...</p>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        // PENTING: Import fungsi yang benar
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ambil ID Ujian dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');
        
        let currentUser = null;
        let questions = [];
        let userAnswers = {}; // Menyimpan jawaban siswa { indexSoal: indexJawaban }
        let currentIndex = 0;
        let timerInterval;

        // --- 1. INISIALISASI ---
        (async () => {
            currentUser = await checkAuth('siswa');
            if(!currentUser) return window.location.href = '../login.html';
            if(!examId) { alert("ID Ujian tidak ditemukan!"); return window.location.href = 'index.html'; }

            try {
                // Ambil Data Ujian
                const docRef = doc(db, 'exams', examId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    alert("Ujian tidak ditemukan atau sudah dihapus.");
                    return window.location.href = 'index.html';
                }

                const data = docSnap.data();
                questions = data.questions || [];
                
                // Setup UI
                document.getElementById('exam-title').innerText = data.judul;
                document.getElementById('loading-overlay').classList.remove('active');

                // Start
                renderQuestion(0);
                startTimer(data.durasi);

            } catch(e) {
                alert("Gagal memuat ujian: " + e.message);
                window.location.href = 'index.html';
            }
        })();

        // --- 2. RENDER SOAL ---
        window.renderQuestion = (idx) => {
            if(idx < 0 || idx >= questions.length) return;
            currentIndex = idx;

            const q = questions[idx];
            const savedAns = userAnswers[idx]; // Jawaban yang sudah dipilih sebelumnya

            // Update Indicator
            document.getElementById('q-indicator').innerText = `Soal ${idx + 1} dari ${questions.length}`;

            // Render HTML
            let optionsHtml = '';
            q.options.forEach((opt, i) => {
                const isSelected = savedAns === i ? 'selected' : '';
                const letter = String.fromCharCode(65 + i); // A, B, C, D
                
                optionsHtml += `
                    <div class="option-item ${isSelected}" onclick="selectAnswer(${idx}, ${i})">
                        <div class="option-circle">${letter}</div>
                        <div>${opt}</div>
                    </div>
                `;
            });

            document.getElementById('q-content').innerHTML = `
                <div class="q-card">
                    <div class="q-num">Pertanyaan No. ${idx + 1}</div>
                    <div class="q-text">${q.text}</div>
                    <div class="options-grid">${optionsHtml}</div>
                </div>
            `;

            updateNavButtons();
        }

        // --- 3. LOGIC JAWABAN & NAVIGASI ---
        window.selectAnswer = (qIdx, optIdx) => {
            userAnswers[qIdx] = optIdx; // Simpan jawaban
            renderQuestion(qIdx); // Re-render untuk update UI (warna biru)
        }

        window.navStep = (step) => {
            renderQuestion(currentIndex + step);
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            const finishBtn = document.getElementById('btn-finish');

            // Tombol Prev
            prevBtn.style.visibility = currentIndex === 0 ? 'hidden' : 'visible';

            // Tombol Next & Finish
            if (currentIndex === questions.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'flex';
            } else {
                nextBtn.style.display = 'flex';
                finishBtn.style.display = 'none';
            }
        }

        // --- 4. TIMER ---
        function startTimer(minutes) {
            let time = minutes * 60;
            const timerEl = document.getElementById('timer');
            
            timerInterval = setInterval(() => {
                const m = Math.floor(time / 60);
                const s = time % 60;
                timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                
                if (time <= 0) {
                    clearInterval(timerInterval);
                    alert("Waktu Habis! Jawaban Anda akan dikirim otomatis.");
                    processSubmit();
                }
                time--;
            }, 1000);
        }

        // --- 5. SUBMIT & NILAI (INI KUNCINYA) ---
        window.confirmFinish = () => {
            // Cek apakah semua soal dijawab (Opsional, tapi bagus buat UX)
            const answeredCount = Object.keys(userAnswers).length;
            if(answeredCount < questions.length) {
                if(!confirm(`Anda baru menjawab ${answeredCount} dari ${questions.length} soal. Yakin mau kumpul?`)) return;
            }
            document.getElementById('modal-confirm').classList.add('active');
        }

        window.closeModal = () => document.getElementById('modal-confirm').classList.remove('active');

        window.processSubmit = async () => {
            clearInterval(timerInterval);
            document.getElementById('modal-confirm').classList.remove('active');
            document.getElementById('loading-overlay').innerHTML = `
                <div style="text-align:center">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size:3rem; color:var(--primary);"></i>
                    <p style="font-weight:bold; margin-top:15px;">Menghitung Nilai...</p>
                </div>
            `;
            document.getElementById('loading-overlay').classList.add('active');

            // HITUNG NILAI
            let correctCount = 0;
            questions.forEach((q, i) => {
                // Bandingkan jawaban user dengan kunci jawaban database
                if (userAnswers[i] === q.correctIndex) {
                    correctCount++;
                }
            });

            // Rumus Nilai (Skala 100)
            const finalScore = Math.round((correctCount / questions.length) * 100);

            try {
                // SIMPAN KE DATABASE 'quiz_results'
                // PENTING: Nama field 'quizId' harus sama persis dengan yang dicari di index.html
                await addDoc(collection(db, 'quiz_results'), {
                    quizId: examId,       // <--- INI KUNCI PENGHUBUNGNYA (ID UJIAN)
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    score: finalScore,
                    answers: userAnswers, // Simpan detail jawaban buat pembahasan nanti
                    correctCount: correctCount,
                    totalQuestions: questions.length,
                    submittedAt: serverTimestamp()
                });

                // Redirect ke Halaman Hasil
                // Kita akan arahkan ke halaman detail hasil (pembahasan)
                // Tapi karena ID Dokumen hasil baru didapat setelah save, kita redirect ke index dulu
                // Nanti di index, tombolnya otomatis berubah jadi "Lihat Pembahasan"
                
                alert(`Ujian Selesai! Nilai Anda: ${finalScore}`);
                window.location.href = 'index.html'; // Kembali ke daftar, nanti otomatis jadi Hijau

            } catch(e) {
                alert("Gagal menyimpan nilai: " + e.message);
                document.getElementById('loading-overlay').classList.remove('active');
            }
        }
    </script>
</body>
</html>
