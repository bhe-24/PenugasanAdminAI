<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ujian - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES --- */
        :root { 
            --primary: #0f172a; 
            --primary-grad: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); 
            --accent: #4361ee; 
            --timer-bg: #dc2626; 
            --text-main: #334155;
            --bg-app: #f1f5f9;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg-app); color: var(--text-main); 
            margin: 0; height: 100vh; width: 100vw;
            display: flex; flex-direction: column; 
            overflow: hidden;
        }

        /* --- HEADER --- */
        .cbt-header {
            height: 65px; background: var(--primary-grad);
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; flex-shrink: 0; z-index: 50; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: white;
        }
        .brand-area { display: flex; align-items: center; gap: 12px; }
        .logo-img { height: 40px; width: 40px; background: white; border-radius: 50%; padding: 2px; object-fit: contain; }
        .brand-text { font-weight: 700; font-size: 1.1rem; letter-spacing: 0.5px; }
        .student-info { font-weight: 500; font-size: 0.95rem; opacity: 0.9; text-align: right; }

        .timer-badge {
            background: var(--timer-bg); color: white; 
            padding: 8px 16px; border-radius: 8px;
            font-weight: 700; font-family: 'Courier New', monospace; 
            font-size: 1.2rem; letter-spacing: 1px;
            box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3);
            display: flex; align-items: center; gap: 8px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* --- BODY LAYOUT --- */
        .cbt-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        .question-area { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; background: #f8fafc; }
        
        .q-card { 
            max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; 
            padding: 30px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 80px; 
        }

        .q-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
        .q-number { font-size: 0.9rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1px; background: #f1f5f9; padding: 5px 10px; border-radius: 6px; }

        .q-text { font-size: 1rem; font-weight: 500; line-height: 1.6; color: #1e293b; margin-bottom: 30px; }
        .q-text img { max-width: 100%; border-radius: 8px; margin: 10px 0; }

        /* PG OPTIONS */
        .option-group { display: flex; flex-direction: column; gap: 12px; }
        .option-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 15px;
            border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s; background: white; font-size: 0.95rem;
        }
        .option-item:hover { background: #f8fafc; border-color: #cbd5e1; }
        .option-item.selected { border-color: var(--accent); background: #eff6ff; box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); }
        .opt-label {
            width: 30px; height: 30px; border-radius: 50%; background: #f1f5f9; color: #64748b; font-weight: 700;
            display: flex; justify-content: center; align-items: center; flex-shrink: 0; transition: 0.2s;
        }
        .option-item.selected .opt-label { background: var(--accent); color: white; }

        /* ESSAY AREA */
        .essay-instruction-box {
            background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px;
            border-radius: 4px 8px 8px 4px; margin-bottom: 20px; font-size: 0.95rem; color: #92400e;
        }
        .essay-textarea {
            width: 100%; height: 300px; padding: 15px; border: 2px solid #e2e8f0;
            border-radius: 12px; font-family: 'Outfit', sans-serif; font-size: 1rem;
            line-height: 1.6; resize: vertical; transition: 0.3s;
        }
        .essay-textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }

        /* --- SIDEBAR NAV --- */
        .nav-sidebar {
            width: 300px; background: white; border-left: 1px solid #e2e8f0;
            display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 40;
        }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-content: start; overflow-y: auto; padding-right: 5px; }
        .nav-item {
            aspect-ratio: 1; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; justify-content: center; align-items: center; 
            font-weight: 600; cursor: pointer; font-size: 0.9rem; color: #64748b; transition: 0.2s;
        }
        .nav-item:hover { background: #f1f5f9; transform: scale(1.05); }
        .nav-item.active { border: 2px solid var(--accent); color: var(--accent); }
        .nav-item.filled { background: var(--primary); color: white; border-color: var(--primary); }
        .nav-item.flagged { background: #f59e0b; color: white; border-color: #f59e0b; }

        /* --- FOOTER --- */
        .cbt-footer {
            height: 70px; background: white; border-top: 1px solid #e2e8f0;
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .btn { padding: 12px 25px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-prev { background: #f1f5f9; color: #475569; }
        .btn-next { background: var(--primary); color: white; }
        .btn-ragu { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .btn-ragu.is-flagged { background: #f59e0b; color: white; border-color: #f59e0b; }
        .btn-submit { background: #10b981; color: white; display: none; }
        .btn-submit.show-always { display: flex; margin-left: auto; }

        /* LOADING & MODAL */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px; width: 90%; animation: popIn 0.3s; }
        @keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .brand-text { display: none; }
            .cbt-header { padding: 0 15px; }
            .timer-badge { font-size: 1rem; padding: 6px 12px; }
            .nav-sidebar { position: fixed; right: 0; top: 65px; bottom: 70px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -5px 0 15px rgba(0,0,0,0.1); width: 80%; }
            .nav-sidebar.open { transform: translateX(0); }
            .question-area { padding: 15px; }
            .q-card { padding: 20px; border-radius: 12px; margin-bottom: 60px; }
            .cbt-footer { padding: 0 15px; height: 60px; gap: 8px; }
            .btn { padding: 10px; font-size: 0.85rem; flex: 1; justify-content: center; }
            .btn span { display: none; }
            .btn-ragu span, .btn-submit span { display: inline; }
            #toggle-sidebar-btn { display: block !important; }
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--accent); margin-bottom:15px;"></i>
        <h3 id="loading-text" style="color:#64748b;">Memuat Soal...</h3>
        <p id="loading-sub" style="color:#94a3b8; font-size:0.9rem; display:none;">Karya Anda sedang kami kirim dan tinjau. Harap tunggu sebentar...</p>
    </div>

    <header class="cbt-header">
        <div class="brand-area">
            <img src="https://i.imgur.com/5Srjyo4.png" alt="Logo" class="logo-img">
            <span class="brand-text">Cendekia Aksara</span>
        </div>
        <div class="timer-badge"><i class="fa-regular fa-clock"></i> <span id="timer">--:--</span></div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="student-info">
                <div id="student-name" style="font-weight:700;">Peserta</div>
                <div style="font-size:0.75rem; opacity:0.8;">Online</div>
            </div>
            <button id="toggle-sidebar-btn" onclick="toggleSidebar()" style="display:none; background:none; border:none; color:white; font-size:1.5rem;">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <div class="cbt-body">
        <main class="question-area" id="q-container"></main>
        
        <aside class="nav-sidebar" id="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0; color:#334155;">Peta Soal</h4>
                <button onclick="toggleSidebar()" style="background:none; border:none; color:#94a3b8; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="nav-grid" id="nav-grid"></div>
            <div style="margin-top:auto; font-size:0.8rem; color:#64748b; border-top:1px solid #e2e8f0; padding-top:15px;">
                <div style="display:flex; gap:10px; margin-bottom:5px;"><span style="width:12px; height:12px; background:var(--primary);"></span> Terjawab</div>
                <div style="display:flex; gap:10px; margin-bottom:5px;"><span style="width:12px; height:12px; background:#f59e0b;"></span> Ragu-ragu</div>
                <div style="display:flex; gap:10px;"><span style="width:12px; height:12px; border:1px solid #ccc;"></span> Belum</div>
            </div>
        </aside>
    </div>

    <footer class="cbt-footer">
        <button class="btn btn-prev" id="btn-prev" onclick="moveQ(-1)"><i class="fa-solid fa-chevron-left"></i> <span>Sebelumnya</span></button>
        <button class="btn btn-ragu" id="btn-ragu" onclick="toggleFlag()"><i class="fa-solid fa-bookmark"></i> <span>Ragu</span></button>
        <button class="btn btn-next" id="btn-next" onclick="moveQ(1)"><span>Lanjut</span> <i class="fa-solid fa-chevron-right"></i></button>
        <button class="btn btn-submit" id="btn-submit" onclick="trySubmit()"><span>Kirim Jawaban</span> <i class="fa-solid fa-paper-plane"></i></button>
    </footer>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-icon" style="font-size:3rem; margin-bottom:15px;"></div>
            <h3 id="modal-title" style="margin:0 0 10px 0;"></h3>
            <p id="modal-msg" style="color:#64748b; margin-bottom:20px;"></p>
            <div id="modal-actions" style="display:flex; gap:10px; justify-content:center;"></div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === TARUH API KEY GEMINI KAMU DI SINI ===
        const GEMINI_API_KEY = "GANTI_DENGAN_API_KEY_GOOGLE_STUDIO_KAMU"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');
        let currentUser = null;
        let examData = null;
        
        let questions = [];
        let answers = JSON.parse(localStorage.getItem(`ans_${examId}`)) || {};
        let flagged = new Set(JSON.parse(localStorage.getItem(`flag_${examId}`)) || []);
        let currentIdx = 0;
        let timerInterval;

        // --- INIT ---
        (async () => {
            try {
                if(!examId) throw new Error("ID Ujian tidak ditemukan.");
                
                currentUser = await checkAuth('siswa');
                if(!currentUser) return;

                document.getElementById('student-name').innerText = currentUser.name || "Siswa";

                const snap = await getDoc(doc(db, 'exams', examId));
                if(!snap.exists()) throw new Error("Soal tidak tersedia.");
                examData = snap.data();

                document.getElementById('loading-screen').style.display = 'none';

                if(examData.type === 'essay') {
                    setupEssayUI();
                } else {
                    questions = examData.questions || [];
                    if(questions.length === 0) throw new Error("Data soal kosong.");
                    renderSidebar();
                    renderQuestion(0);
                }
                
                handleSmartTimer(examData.durasi || 60);

            } catch(e) {
                showModal('error', 'Error', e.message, () => window.location.href='index.html');
            }
        })();

        // --- TIMER LOGIC ---
        function handleSmartTimer(durationMinutes) {
            const STORAGE_KEY = `exam_end_${examId}_${currentUser.uid}`;
            let endTime = localStorage.getItem(STORAGE_KEY);

            if (!endTime) {
                endTime = new Date().getTime() + (durationMinutes * 60 * 1000);
                localStorage.setItem(STORAGE_KEY, endTime);
            }

            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const distance = endTime - new Date().getTime();
                if (distance < 0) {
                    clearInterval(timerInterval);
                    timerEl.innerText = "00:00";
                    alert("Waktu Habis! Jawaban akan dikirim otomatis.");
                    if(examData.type === 'essay') submitEssay();
                    else finalSubmitPG();
                    return;
                }
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);
                timerEl.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if(m < 5) timerEl.parentElement.style.animation = "pulse 1s infinite";
            }, 1000);
        }

        // ==========================================
        // LOGIKA ESAI (PENILAIAN INSTAN DIRECT API)
        // ==========================================
        function setupEssayUI() {
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('btn-prev').style.display = 'none';
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-ragu').style.display = 'none';
            document.getElementById('toggle-sidebar-btn').style.display = 'none';

            const submitBtn = document.getElementById('btn-submit');
            submitBtn.classList.add('show-always');

            const savedEssay = localStorage.getItem(`essay_${examId}`) || "";
            const html = `
                <div class="q-card">
                    <div class="q-header">
                        <div class="q-number"><i class="fa-solid fa-pen-nib"></i> UJIAN ESAI / KARYA SASTRA</div>
                    </div>
                    <div class="essay-instruction-box">
                        <strong>Instruksi Tugas:</strong><br>
                        ${examData.essayInstruction || "Tuliskan karya Anda di bawah ini."}
                    </div>
                    <textarea id="essay-input" class="essay-textarea" placeholder="Mulai mengetik karya Anda di sini... (Jawaban tersimpan otomatis di perangkat)">${savedEssay}</textarea>
                </div>
            `;
            document.getElementById('q-container').innerHTML = html;

            document.getElementById('essay-input').addEventListener('input', (e) => {
                localStorage.setItem(`essay_${examId}`, e.target.value);
            });
        }

        window.trySubmit = () => {
            if(examData.type === 'essay') {
                const text = document.getElementById('essay-input').value.trim();
                if(text.length < 50) return showModal('warning', 'Terlalu Pendek', 'Karya Anda terlalu singkat. Mohon jabarkan lebih panjang lagi.');
                showModal('confirm', 'Kumpulkan Karya?', 'Sistem akan langsung membaca dan menilai karya Anda. Pastikan sudah maksimal.', submitEssay);
            } else {
                if (flagged.size > 0) return showModal('warning', 'Masih Ragu', `Ada ${flagged.size} soal ragu.`);
                if(Object.keys(answers).length < questions.length) showModal('confirm', 'Belum Lengkap', 'Yakin kumpulkan?', finalSubmitPG);
                else showModal('confirm', 'Kumpulkan?', 'Jawaban akan dikirim.', finalSubmitPG);
            }
        }

        async function submitEssay() {
            document.getElementById('modal-overlay').classList.remove('active');
            
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.style.display = 'flex';
            document.getElementById('loading-text').innerText = "Sedang Meninjau...";
            document.getElementById('loading-sub').style.display = 'block'; 
            clearInterval(timerInterval);

            const studentText = document.getElementById('essay-input').value;

            try {
                let aiScore = 0;
                let aiFeedback = "Karya Anda telah tersimpan. Guru akan segera meninjaunya secara manual.";

                // 1. TEMBAK LANGSUNG KE GOOGLE GEMINI API
                if (GEMINI_API_KEY && GEMINI_API_KEY !== "GANTI_DENGAN_API_KEY_GOOGLE_STUDIO_KAMU") {
                    try {
                        const promptText = `
Anda adalah Guru Bahasa dan Sastra Indonesia. Evaluasi karya ini.
INSTRUKSI: "${examData.essayInstruction}"
RUBRIK: "${examData.essayRubric}"
KARYA: "${studentText}"

Berikan HANYA format JSON murni seperti ini tanpa teks markdown lainnya:
{"score": 85, "feedback": "Komentar guru di sini..."}
`;
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: promptText }] }],
                                generationConfig: { temperature: 0.2 } 
                            })
                        });
                        
                        if(response.ok) {
                            const result = await response.json();
                            let aiResponseText = result.candidates[0].content.parts[0].text;
                            
                            // Ambil hanya struktur JSON menggunakan Regex (menghindari error ```json)
                            const jsonMatch = aiResponseText.match(/\{[\s\S]*\}/);
                            
                            if (jsonMatch) {
                                const parsedData = JSON.parse(jsonMatch[0]);
                                aiScore = parsedData.score || 0;
                                aiFeedback = parsedData.feedback || "Karya berhasil dinilai.";
                            }
                        } else {
                            console.warn("Respon dari Gemini gagal.");
                        }
                    } catch(apiErr) {
                        console.error("API Gemini Error:", apiErr);
                    }
                }

                // 2. SIMPAN KE FIRESTORE (DENGAN HASIL JADI)
                const docRef = await addDoc(collection(db, 'quiz_results'), {
                    quizId: examId,
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    type: 'essay',
                    jawabanTeks: studentText,
                    score: aiScore, 
                    feedbackAI: aiFeedback, 
                    submittedAt: serverTimestamp()
                });

                localStorage.removeItem(`exam_end_${examId}_${currentUser.uid}`);
                localStorage.removeItem(`essay_${examId}`);

                // 3. LANGSUNG REDIRECT KE HASIL
                window.location.href = `hasil.html?rid=${docRef.id}`;

            } catch(e) {
                loadingScreen.style.display = 'none';
                showModal('error', 'Gagal', 'Sistem error: ' + e.message);
            }
        }

        // ==========================================
        // LOGIKA PILIHAN GANDA 
        // ==========================================
        function renderQuestion(idx) {
            currentIdx = idx;
            const q = questions[idx];
            let html = `<div class="q-card"><div class="q-header"><div class="q-number">Nomor ${idx + 1}</div></div><div class="q-text">${q.text}</div><div class="option-group">`;
            q.options.forEach((opt, i) => {
                const isSel = answers[idx] === i ? 'selected' : '';
                html += `<div class="option-item ${isSel}" onclick="selectAns(${idx}, ${i})"><div class="opt-label">${String.fromCharCode(65+i)}</div><div>${opt}</div></div>`;
            });
            html += `</div></div>`;
            document.getElementById('q-container').innerHTML = html;
            updateButtonsPG(); updateSidebarHighlight(); updateFlagButton();
        }

        function renderSidebar() {
            const grid = document.getElementById('nav-grid');
            grid.innerHTML = '';
            questions.forEach((_, i) => {
                const div = document.createElement('div');
                div.className = 'nav-item'; div.innerText = i + 1; div.id = `nav-${i}`;
                div.onclick = () => { renderQuestion(i); if(window.innerWidth <= 768) toggleSidebar(); };
                grid.appendChild(div);
            });
            Object.keys(answers).forEach(idx => updateSidebarStatus(idx));
            flagged.forEach(idx => updateSidebarStatus(idx));
        }

        window.selectAns = (qIdx, optIdx) => { answers[qIdx] = optIdx; localStorage.setItem(`ans_${examId}`, JSON.stringify(answers)); renderQuestion(qIdx); updateSidebarStatus(qIdx); }
        window.toggleFlag = () => { if (flagged.has(currentIdx)) flagged.delete(currentIdx); else flagged.add(currentIdx); localStorage.setItem(`flag_${examId}`, JSON.stringify([...flagged])); updateFlagButton(); updateSidebarStatus(currentIdx); }
        window.moveQ = (step) => { const next = currentIdx + step; if(next >= 0 && next < questions.length) renderQuestion(next); }

        function updateButtonsPG() {
            document.getElementById('btn-prev').style.visibility = currentIdx === 0 ? 'hidden' : 'visible';
            if(currentIdx === questions.length - 1) { document.getElementById('btn-next').style.display = 'none'; document.getElementById('btn-submit').style.display = 'flex'; } 
            else { document.getElementById('btn-next').style.display = 'flex'; document.getElementById('btn-submit').style.display = 'none'; }
        }
        function updateFlagButton() { const btn = document.getElementById('btn-ragu'); if(flagged.has(currentIdx)) { btn.classList.add('is-flagged'); btn.querySelector('span').innerText = "Batal Ragu"; } else { btn.classList.remove('is-flagged'); btn.querySelector('span').innerText = "Ragu-ragu"; } }
        function updateSidebarStatus(idx) { const item = document.getElementById(`nav-${idx}`); if(!item) return; item.className = 'nav-item'; if(idx == currentIdx) item.classList.add('active'); if(flagged.has(Number(idx))) item.classList.add('flagged'); else if(answers[idx] !== undefined) item.classList.add('filled'); }
        function updateSidebarHighlight() { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); const curr = document.getElementById(`nav-${currentIdx}`); if(curr) curr.classList.add('active'); }

        async function finalSubmitPG() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Mengirim Jawaban...";
            clearInterval(timerInterval);

            let correct = 0;
            questions.forEach((q, i) => { if(answers[i] === q.correctIndex) correct++; });
            const score = Math.round((correct / questions.length) * 100);

            try {
                const docRef = await addDoc(collection(db, 'quiz_results'), {
                    quizId: examId, studentId: currentUser.uid, studentName: currentUser.name, type: 'pg', score: score, correctCount: correct, totalQuestions: questions.length, answers: answers, submittedAt: serverTimestamp()
                });
                localStorage.removeItem(`exam_end_${examId}_${currentUser.uid}`); localStorage.removeItem(`ans_${examId}`); localStorage.removeItem(`flag_${examId}`);
                window.location.href = `hasil.html?rid=${docRef.id}`;
            } catch(e) { document.getElementById('loading-screen').style.display = 'none'; showModal('error', 'Gagal', e.message); }
        }

        // --- UTILS ---
        function showModal(type, title, msg, onYes) {
            const ov = document.getElementById('modal-overlay'); const icon = document.getElementById('modal-icon'); const btns = document.getElementById('modal-actions');
            document.getElementById('modal-title').innerText = title; document.getElementById('modal-msg').innerText = msg;
            icon.innerHTML = type === 'warning' ? '⚠️' : type === 'error' ? '❌' : '❓';
            btns.innerHTML = '';
            if(onYes) {
                btns.innerHTML = `<button class="btn" style="background:#e2e8f0; color:#333;" onclick="document.getElementById('modal-overlay').classList.remove('active')">Batal</button><button class="btn" style="background:var(--primary); color:white;" id="btn-yes">Ya, Kirim</button>`;
                document.getElementById('btn-yes').onclick = onYes;
            } else { btns.innerHTML = `<button class="btn" style="background:var(--primary); color:white; width:100%; justify-content:center;" onclick="document.getElementById('modal-overlay').classList.remove('active')">OK</button>`; }
            ov.classList.add('active');
        }

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
    </script>
</body>
</html>
