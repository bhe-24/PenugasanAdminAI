<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ujian Berlangsung - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #4361ee; --secondary: #3f37c9; --warning: #f7b731; --bg: #f8f9fa; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg); margin: 0; user-select: none; padding-top: 70px; padding-bottom: 80px; }

        /* HEADER FIXED */
        .top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: #003366; color: white; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .timer-badge { background: #ef4444; padding: 5px 12px; border-radius: 6px; font-family: monospace; font-size: 1.1rem; font-weight: 700; }
        .exam-info h4 { margin: 0; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        /* LAYOUT UTAMA */
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; padding: 20px; }
        
        /* AREA SOAL (KIRI) */
        .question-area { flex: 1; }
        .q-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); min-height: 300px; }
        
        .q-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .q-badge { background: #e0f2fe; color: #0284c7; padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        
        .q-text { font-size: 1.1rem; line-height: 1.6; color: #1e293b; margin-bottom: 25px; }
        
        .options-list { display: flex; flex-direction: column; gap: 12px; }
        .opt-label {
            display: flex; align-items: center; gap: 12px; padding: 15px;
            border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: 0.2s;
        }
        .opt-label:hover { background: #f8fafc; border-color: #cbd5e1; }
        .opt-label.selected { border-color: var(--primary); background: #eff6ff; }
        .opt-circle {
            width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: transparent;
        }
        .opt-label.selected .opt-circle { background: var(--primary); border-color: var(--primary); color: white; }

        /* NAVIGASI NOMOR (KANAN - DESKTOP) */
        .nav-panel { width: 300px; background: white; border-radius: 16px; padding: 20px; height: fit-content; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; }
        .nav-item {
            aspect-ratio: 1; border: 1px solid #e2e8f0; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-weight: 600; cursor: pointer;
            transition: 0.2s; background: white; color: #64748b; font-size: 0.9rem; position: relative;
        }
        .nav-item.active { border-color: var(--primary); color: var(--primary); border-width: 2px; }
        .nav-item.answered { background: var(--primary); color: white; border-color: var(--primary); }
        .nav-item.flagged { background: var(--warning); color: #fff; border-color: var(--warning); }
        /* Badge Ragu kecil di pojok */
        .nav-item.flagged::after { content:''; position:absolute; top:-2px; right:-2px; width:8px; height:8px; background:red; border-radius:50%; }

        /* FOOTER CONTROLS */
        .footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 900;
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }
        .btn-act { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-prev { background: #f1f5f9; color: #475569; }
        .btn-next { background: var(--primary); color: white; }
        .btn-ragu { background: #fff7ed; color: #d97706; border: 1px solid #fdba74; }
        .btn-ragu.active { background: #f7b731; color: white; }
        .btn-finish { background: #10b981; color: white; display: none; }

        /* MODAL LIST SOAL (MOBILE) */
        .mobile-nav-trigger { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        .modal-box { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; }
        
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .nav-panel { display: none; } /* Hide sidebar desktop */
            .mobile-nav-trigger { display: block; } /* Show hamburger menu */
            .container { padding: 15px; }
            .q-card { padding: 20px; }
            
            /* Logic Mobile Nav: Muncul sebagai Modal */
            .nav-panel.mobile-active {
                display: block; position: fixed; top: 60px; right: 0; width: 80%; height: 100%;
                background: white; z-index: 999; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
                animation: slideIn 0.3s;
            }
        }
        @keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="exam-info">
            <h4 id="exam-title">Memuat Ujian...</h4>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="timer-badge" id="timer">--:--</div>
            <button class="mobile-nav-trigger" onclick="toggleMobileNav()"><i class="fa-solid fa-grid-2"></i></button>
        </div>
    </div>

    <div class="container">
        <div class="question-area">
            <div class="q-card" id="q-card">
                <div style="text-align:center; padding:50px;">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary);"></i>
                    <p>Menyiapkan lembar soal...</p>
                </div>
            </div>
        </div>

        <div class="nav-panel" id="nav-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">Daftar Soal</h4>
                <button onclick="toggleMobileNav()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; display:none;" id="close-nav">&times;</button>
            </div>
            
            <div class="nav-grid" id="nav-grid">
                </div>

            <div style="margin-top:20px; font-size:0.8rem; color:#64748b;">
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                    <span style="width:12px; height:12px; background:#4361ee; border-radius:2px;"></span> Dijawab
                </div>
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                    <span style="width:12px; height:12px; background:#f7b731; border-radius:2px;"></span> Ragu-ragu
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:12px; height:12px; border:1px solid #ccc; border-radius:2px;"></span> Belum dijawab
                </div>
            </div>
        </div>
    </div>

    <div class="footer-bar">
        <button class="btn-act btn-prev" id="btn-prev" onclick="moveQ(-1)"><i class="fa-solid fa-chevron-left"></i></button>
        
        <button class="btn-act btn-ragu" id="btn-ragu" onclick="toggleFlag()">
            <i class="fa-solid fa-flag"></i> <span id="ragu-text">Ragu</span>
        </button>
        
        <button class="btn-act btn-next" id="btn-next" onclick="moveQ(1)"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="btn-act btn-finish" id="btn-finish" onclick="confirmFinish()">Selesai <i class="fa-solid fa-check"></i></button>
    </div>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-clipboard-check" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
            <h3>Kumpulkan Ujian?</h3>
            <p style="color:#64748b; font-size:0.9rem;">
                Pastikan seluruh soal telah dijawab. Waktu tersisa: <span id="modal-time" style="font-weight:bold;">--:--</span>
            </p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
                <button onclick="document.getElementById('modal-confirm').classList.remove('show')" class="btn-act btn-prev" style="justify-content:center;">Batal</button>
                <button onclick="submitExam()" class="btn-act btn-next" style="justify-content:center;">Ya, Kumpulkan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');
        
        let currentUser = null;
        let questions = [];
        let answers = {}; // { 0: 1, 1: 3 } (Index soal : Index jawaban)
        let flags = {};   // { 0: true } (Index soal : isRagu)
        let currentIdx = 0;
        let timerInterval;

        (async () => {
            currentUser = await checkAuth('siswa');
            if(!examId || !currentUser) { alert("Akses Error"); window.location.href='index.html'; return; }
            loadExam();
        })();

        async function loadExam() {
            try {
                const snap = await getDoc(doc(db, 'exams', examId));
                if(!snap.exists()) throw new Error("Ujian tidak ditemukan");
                
                const data = snap.data();
                document.getElementById('exam-title').innerText = data.judul;
                questions = data.questions || [];
                
                if(questions.length === 0) throw new Error("Soal kosong");

                initNavGrid();
                startTimer(data.durasi);
                renderQuestion(0);

            } catch(e) {
                alert(e.message);
                window.location.href = 'index.html';
            }
        }

        // --- RENDER SOAL ---
        function renderQuestion(idx) {
            currentIdx = idx;
            const q = questions[idx];
            
            // Update Tampilan Kartu
            const html = `
                <div class="q-header">
                    <span class="q-badge">Soal No. ${idx + 1}</span>
                    <span style="font-size:0.9rem; color:#64748b;">Pilihan Ganda</span>
                </div>
                <div class="q-text">${q.text}</div>
                <div class="options-list">
                    ${q.options.map((opt, i) => `
                        <div class="opt-label ${answers[idx] === i ? 'selected' : ''}" onclick="selectAnswer(${idx}, ${i})">
                            <div class="opt-circle"><i class="fa-solid fa-check"></i></div>
                            <span>${opt}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('q-card').innerHTML = html;

            // Update Navigasi Grid & Tombol Bawah
            updateNavState();
            
            // Atur tombol Next/Finish
            document.getElementById('btn-prev').disabled = (idx === 0);
            if (idx === questions.length - 1) {
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('btn-finish').style.display = 'flex';
            } else {
                document.getElementById('btn-next').style.display = 'flex';
                document.getElementById('btn-finish').style.display = 'none';
            }

            // Update tombol Ragu
            const btnRagu = document.getElementById('btn-ragu');
            if(flags[idx]) {
                btnRagu.classList.add('active');
                document.getElementById('ragu-text').innerText = "Ditandai Ragu";
            } else {
                btnRagu.classList.remove('active');
                document.getElementById('ragu-text').innerText = "Ragu-ragu";
            }
        }

        function initNavGrid() {
            const grid = document.getElementById('nav-grid');
            grid.innerHTML = '';
            questions.forEach((_, i) => {
                const item = document.createElement('div');
                item.className = 'nav-item';
                item.id = `nav-${i}`;
                item.innerText = i + 1;
                item.onclick = () => { renderQuestion(i); toggleMobileNav(false); };
                grid.appendChild(item);
            });
        }

        function updateNavState() {
            // Update Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${currentIdx}`).classList.add('active');

            // Update Colors (Answered/Flagged)
            questions.forEach((_, i) => {
                const el = document.getElementById(`nav-${i}`);
                el.classList.remove('answered', 'flagged');
                
                if(flags[i]) el.classList.add('flagged');
                else if(answers[i] !== undefined) el.classList.add('answered');
            });
        }

        // --- INTERAKSI USER ---
        window.selectAnswer = (qIdx, optIdx) => {
            answers[qIdx] = optIdx;
            // Re-render hanya opsi biar smooth (atau panggil full renderQuestion)
            renderQuestion(qIdx); 
        }

        window.toggleFlag = () => {
            flags[currentIdx] = !flags[currentIdx];
            renderQuestion(currentIdx);
        }

        window.moveQ = (step) => {
            const next = currentIdx + step;
            if(next >= 0 && next < questions.length) renderQuestion(next);
        }

        window.toggleMobileNav = (forceState) => {
            const panel = document.getElementById('nav-panel');
            const closeBtn = document.getElementById('close-nav');
            
            if (forceState === false || panel.classList.contains('mobile-active')) {
                panel.classList.remove('mobile-active');
                closeBtn.style.display = 'none';
            } else {
                panel.classList.add('mobile-active');
                closeBtn.style.display = 'block';
            }
        }

        window.confirmFinish = () => {
            document.getElementById('modal-time').innerText = document.getElementById('timer').innerText;
            document.getElementById('modal-confirm').classList.add('show');
        }

        // --- TIMER & SUBMIT ---
        function startTimer(minutes) {
            let time = minutes * 60;
            const display = document.getElementById('timer');
            
            timerInterval = setInterval(() => {
                const h = Math.floor(time / 3600);
                const m = Math.floor((time % 3600) / 60);
                const s = time % 60;
                display.innerText = `${h}:${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
                
                if (--time < 0) {
                    clearInterval(timerInterval);
                    alert("Waktu Habis!");
                    submitExam(true);
                }
            }, 1000);
        }

        window.submitExam = async (force = false) => {
            clearInterval(timerInterval);
            document.getElementById('modal-confirm').classList.remove('show');
            
            // Full Screen Loading
            const loadingHtml = `<div style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <i class="fa-solid fa-cloud-arrow-up fa-bounce" style="font-size:4rem; color:var(--primary);"></i>
                <h2 style="margin-top:20px;">Mengirim Jawaban...</h2>
            </div>`;
            document.body.innerHTML = loadingHtml;

            // Hitung Skor
            let correctCount = 0;
            questions.forEach((q, i) => {
                if (answers[i] === q.correctIndex) correctCount++;
            });
            const score = (correctCount / questions.length) * 100;

            try {
                // Simpan Hasil
                const resRef = await addDoc(collection(db, 'exam_results'), {
                    examId: examId,
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    answers: answers,
                    score: score,
                    totalQuestions: questions.length,
                    correctCount: correctCount,
                    timestamp: serverTimestamp()
                });

                // Redirect ke Halaman Hasil (Bawa ID Dokumen Hasil)
                setTimeout(() => {
                    window.location.href = `hasil.html?rid=${resRef.id}`;
                }, 1500);

            } catch(e) {
                alert("Gagal menyimpan: " + e.message);
                location.reload();
            }
        }
    </script>
</body>
</html>
