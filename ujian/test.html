<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT Ujian Online</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE STYLE --- */
        :root { --primary: #003366; --accent: #4361ee; --warning: #f59e0b; --success: #10b981; --bg: #f8fafc; --text: #334155; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); 
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- 1. HEADER (FIXED) --- */
        .cbt-header {
            height: 60px; background: white; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            flex-shrink: 0; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .timer-badge {
            background: #eff6ff; color: var(--primary); padding: 6px 15px; border-radius: 50px;
            font-weight: 700; font-family: monospace; font-size: 1.1rem; border: 1px solid #bfdbfe;
            display: flex; align-items: center; gap: 8px;
        }
        .student-info { font-weight: 600; font-size: 0.9rem; color: #64748b; }

        /* --- 2. MAIN LAYOUT (SPLIT) --- */
        .cbt-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* Area Soal */
        .question-area { flex: 1; padding: 20px 20px 80px 20px; overflow-y: auto; scroll-behavior: smooth; }
        .q-card { max-width: 800px; margin: 0 auto; animation: slideIn 0.3s ease; }
        
        .q-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .q-number { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: #94a3b8; letter-spacing: 1px; }
        .q-text { font-size: 1.15rem; font-weight: 500; line-height: 1.6; margin-bottom: 25px; color: #1e293b; }

        /* Opsi Jawaban */
        .option-group { display: flex; flex-direction: column; gap: 12px; }
        .option-item {
            display: flex; align-items: center; gap: 15px; padding: 15px 20px;
            border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: 0.2s; background: white;
        }
        .option-item:hover { background: #f1f5f9; border-color: #cbd5e1; }
        
        .option-item.selected { border-color: var(--primary); background: #f0f9ff; color: var(--primary); }
        .option-item.selected .opt-label { background: var(--primary); color: white; border-color: var(--primary); }

        .opt-label {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid #cbd5e1;
            display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0;
        }

        /* Sidebar Nomor Soal (Desktop) */
        .nav-sidebar {
            width: 280px; background: white; border-left: 1px solid #e2e8f0;
            display: flex; flex-direction: column; padding: 20px; flex-shrink: 0;
            transition: transform 0.3s;
        }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; align-content: start; overflow-y: auto; }
        .nav-item {
            aspect-ratio: 1; border: 1px solid #e2e8f0; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-weight: 600; cursor: pointer; font-size: 0.9rem;
            color: #64748b; transition: 0.2s;
        }
        .nav-item:hover { background: #f1f5f9; }
        .nav-item.active { border: 2px solid var(--primary); } /* Sedang dibuka */
        .nav-item.filled { background: var(--primary); color: white; border-color: var(--primary); } /* Terjawab */
        .nav-item.flagged { background: var(--warning); color: white; border-color: var(--warning); } /* Ragu */

        /* --- 3. FOOTER (NAVIGASI) --- */
        .cbt-footer {
            height: 70px; background: white; border-top: 1px solid #e2e8f0;
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 40;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.95rem; }
        .btn-prev { background: #f1f5f9; color: #475569; }
        .btn-next { background: var(--primary); color: white; }
        .btn-ragu { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .btn-ragu.is-flagged { background: var(--warning); color: white; }
        .btn-submit { background: var(--success); color: white; display: none; }

        /* --- 4. MODERN MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 30px;
            border-radius: 20px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: 0.3s;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 25px; }

        /* LOADING */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* RESPONSIVE MOBILE */
        @media (max-width: 768px) {
            .nav-sidebar { 
                position: fixed; right: 0; top: 60px; bottom: 70px; z-index: 45; 
                transform: translateX(100%); box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            }
            .nav-sidebar.open { transform: translateX(0); }
            .cbt-footer { padding: 0 10px; gap: 5px; }
            .btn { padding: 10px 15px; font-size: 0.85rem; }
            .btn span { display: none; } /* Hide text on small screens, icons only */
            .btn-ragu span { display: inline; }
            .btn-submit span { display: inline; }
            .cbt-header { padding: 0 15px; }
            
            #toggle-nav { display: block; }
        }
        @media (min-width: 769px) { #toggle-nav { display: none; } }

        @keyframes slideIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
        <h3 style="color:#64748b;">Menyiapkan Ujian...</h3>
    </div>

    <header class="cbt-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="timer-badge"><i class="fa-regular fa-clock"></i> <span id="timer">--:--</span></div>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="student-info" id="student-name">Peserta</div>
            <button id="toggle-nav" onclick="toggleSidebar()" style="background:none; border:none; font-size:1.5rem; color:#64748b;">
                <i class="fa-solid fa-grid-2"></i>
            </button>
        </div>
    </header>

    <div class="cbt-body">
        <main class="question-area" id="q-container">
            </main>

        <aside class="nav-sidebar" id="sidebar">
            <h4 style="margin:0 0 15px 0; color:#334155;">Navigasi Soal</h4>
            <div class="nav-grid" id="nav-grid">
                </div>
            <div style="margin-top:auto; font-size:0.8rem; color:#94a3b8; padding-top:15px;">
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;"><div style="width:12px; height:12px; background:var(--primary); border-radius:2px;"></div> Terjawab</div>
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;"><div style="width:12px; height:12px; background:var(--warning); border-radius:2px;"></div> Ragu-ragu</div>
                <div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; border:1px solid #ccc; border-radius:2px;"></div> Kosong</div>
            </div>
        </aside>
    </div>

    <footer class="cbt-footer">
        <button class="btn btn-prev" id="btn-prev" onclick="moveQ(-1)">
            <i class="fa-solid fa-arrow-left"></i> <span>Sebelumnya</span>
        </button>
        
        <button class="btn btn-ragu" id="btn-ragu" onclick="toggleFlag()">
            <i class="fa-solid fa-bookmark"></i> <span>Ragu-ragu</span>
        </button>

        <button class="btn btn-next" id="btn-next" onclick="moveQ(1)">
            <span>Berikutnya</span> <i class="fa-solid fa-arrow-right"></i>
        </button>
        
        <button class="btn btn-submit" id="btn-submit" onclick="trySubmit()">
            <span>Kirim Jawaban</span> <i class="fa-solid fa-paper-plane"></i>
        </button>
    </footer>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-icon" class="modal-icon"></div>
            <h3 id="modal-title" style="margin:0 0 10px 0; color:var(--primary);"></h3>
            <p id="modal-msg" style="color:#64748b; font-size:0.95rem; line-height:1.5;"></p>
            <div id="modal-actions" class="modal-btns"></div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- STATE ---
        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');
        let currentUser = null;
        let questions = [];
        let answers = {}; // { 0: 1, 1: 3 }
        let flagged = new Set(); // Set of indexes { 0, 4 }
        let currentIdx = 0;
        let timerInterval;

        // --- INIT ---
        (async () => {
            try {
                if(!examId) throw new Error("ID Ujian hilang.");
                
                currentUser = await checkAuth('siswa');
                if(!currentUser) { window.location.href = '../login.html'; return; }
                
                document.getElementById('student-name').innerText = currentUser.name || "Peserta";

                // Fetch Data
                const snap = await getDoc(doc(db, 'exams', examId));
                if(!snap.exists()) throw new Error("Soal tidak ditemukan.");
                
                const data = snap.data();
                questions = data.questions || [];
                if(questions.length === 0) throw new Error("Soal kosong.");

                // Start
                document.getElementById('loading-screen').style.display = 'none';
                renderSidebar();
                renderQuestion(0);
                startTimer(data.durasi || 60);

            } catch(e) {
                showModal('error', 'Gagal Memuat', e.message, () => window.location.href='index.html');
            }
        })();

        // --- CORE RENDER ---
        function renderQuestion(idx) {
            currentIdx = idx;
            const q = questions[idx];
            const savedAns = answers[idx];

            let html = `
                <div class="q-card">
                    <div class="q-header">
                        <div class="q-number">SOAL NO. ${idx + 1}</div>
                    </div>
                    <div class="q-text">${q.text}</div>
                    <div class="option-group">
            `;

            q.options.forEach((opt, i) => {
                const isSel = savedAns === i ? 'selected' : '';
                const letter = String.fromCharCode(65 + i);
                html += `
                    <div class="option-item ${isSel}" onclick="selectAns(${idx}, ${i})">
                        <div class="opt-label">${letter}</div>
                        <div>${opt}</div>
                    </div>
                `;
            });

            html += `</div></div>`;
            document.getElementById('q-container').innerHTML = html;

            // Update UI components
            updateButtons();
            updateSidebarHighlight();
            updateFlagButton();
        }

        function renderSidebar() {
            const grid = document.getElementById('nav-grid');
            grid.innerHTML = '';
            questions.forEach((_, i) => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.innerText = i + 1;
                div.id = `nav-${i}`;
                div.onclick = () => renderQuestion(i);
                grid.appendChild(div);
            });
        }

        // --- INTERACTIONS ---
        window.selectAns = (qIdx, optIdx) => {
            answers[qIdx] = optIdx;
            renderQuestion(qIdx); // Re-render for visual feedback
            updateSidebarStatus(qIdx);
        }

        window.toggleFlag = () => {
            if (flagged.has(currentIdx)) flagged.delete(currentIdx);
            else flagged.add(currentIdx);
            updateFlagButton();
            updateSidebarStatus(currentIdx);
        }

        window.moveQ = (step) => {
            const next = currentIdx + step;
            if(next >= 0 && next < questions.length) renderQuestion(next);
        }

        // --- UI UPDATERS ---
        function updateButtons() {
            const prev = document.getElementById('btn-prev');
            const next = document.getElementById('btn-next');
            const submit = document.getElementById('btn-submit');

            prev.style.visibility = currentIdx === 0 ? 'hidden' : 'visible';
            
            if(currentIdx === questions.length - 1) {
                next.style.display = 'none';
                submit.style.display = 'flex';
            } else {
                next.style.display = 'flex';
                submit.style.display = 'none';
            }
        }

        function updateFlagButton() {
            const btn = document.getElementById('btn-ragu');
            if(flagged.has(currentIdx)) {
                btn.classList.add('is-flagged');
                btn.querySelector('span').innerText = "Batalkan Ragu";
            } else {
                btn.classList.remove('is-flagged');
                btn.querySelector('span').innerText = "Ragu-ragu";
            }
        }

        function updateSidebarStatus(idx) {
            const item = document.getElementById(`nav-${idx}`);
            item.className = 'nav-item'; // Reset
            if (idx === currentIdx) item.classList.add('active'); // Current
            
            if (flagged.has(idx)) {
                item.classList.add('flagged'); // Yellow overrides filled
            } else if (answers[idx] !== undefined) {
                item.classList.add('filled'); // Green
            }
        }

        function updateSidebarHighlight() {
            // Refresh highlight current question
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${currentIdx}`).classList.add('active');
        }

        // --- SUBMIT LOGIC (VALIDATION) ---
        window.trySubmit = () => {
            // 1. Cek Ragu-Ragu
            if (flagged.size > 0) {
                showModal('warning', 'Masih Ragu-Ragu', 
                    `Anda menandai ${flagged.size} soal sebagai ragu-ragu. Harap hilangkan tanda kuning di navigasi nomor sebelum mengumpulkan.`, 
                    null // Hanya tombol tutup
                );
                return;
            }

            // 2. Cek Belum Dijawab
            const answeredCount = Object.keys(answers).length;
            const total = questions.length;
            if (answeredCount < total) {
                showModal('confirm', 'Belum Lengkap', 
                    `Anda baru menjawab ${answeredCount} dari ${total} soal. Yakin ingin mengumpulkan? Nilai kosong akan dihitung 0.`, 
                    finalSubmit
                );
            } else {
                showModal('confirm', 'Konfirmasi Selesai', 
                    'Apakah Anda yakin ingin mengakhiri ujian ini? Jawaban tidak bisa diubah setelah dikirim.', 
                    finalSubmit
                );
            }
        }

        async function finalSubmit() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.getElementById('loading-screen').style.display = 'flex';
            document.querySelector('#loading-screen h3').innerText = "Menghitung Nilai...";
            clearInterval(timerInterval);

            // Hitung
            let correct = 0;
            questions.forEach((q, i) => {
                if (answers[i] === q.correctIndex) correct++;
            });
            const score = Math.round((correct / questions.length) * 100);

            try {
                // Simpan (Sesuai ID Ujian)
                await addDoc(collection(db, 'quiz_results'), {
                    quizId: examId,
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    score: score,
                    correctCount: correct,
                    totalQuestions: questions.length,
                    answers: answers,
                    submittedAt: serverTimestamp()
                });

                // Redirect
                window.location.href = `hasil.html?rid=${docRef.id}`;// Akan otomatis jadi hijau

            } catch(e) {
                document.getElementById('loading-screen').style.display = 'none';
                showModal('error', 'Gagal Simpan', 'Koneksi error: ' + e.message);
            }
        }

        // --- UTILS ---
        function startTimer(mins) {
            let sec = mins * 60;
            const el = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const m = Math.floor(sec / 60);
                const s = sec % 60;
                el.innerText = `${m}:${s<10?'0':''}${s}`;
                if(sec <= 0) {
                    clearInterval(timerInterval);
                    alert("Waktu Habis!");
                    finalSubmit();
                }
                sec--;
            }, 1000);
        }

        function showModal(type, title, msg, onYes) {
            const ov = document.getElementById('modal-overlay');
            const icon = document.getElementById('modal-icon');
            const btns = document.getElementById('modal-actions');
            
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            
            icon.innerHTML = type === 'warning' ? '⚠️' : type === 'error' ? '❌' : '❓';
            icon.style.color = type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#4361ee';

            btns.innerHTML = '';
            
            if(onYes) {
                btns.innerHTML = `
                    <button class="btn" style="background:#f1f5f9; color:#333;" onclick="document.getElementById('modal-overlay').classList.remove('active')">Batal</button>
                    <button class="btn" style="background:var(--primary); color:white;" id="btn-modal-yes">Ya</button>
                `;
                document.getElementById('btn-modal-yes').onclick = onYes;
            } else {
                btns.innerHTML = `<button class="btn" style="background:var(--primary); color:white; width:100%; justify-content:center;" onclick="document.getElementById('modal-overlay').classList.remove('active')">OK, Saya Cek</button>`;
            }
            
            ov.classList.add('active');
        }

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
    </script>
</body>
</html>
