<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian - Cendekia Aksara</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background: #f4f7fe; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        #loading-screen { text-align: center; padding: 50px; }
        #error-screen { display: none; text-align: center; padding: 50px; color: red; }
        #exam-screen { display: none; }

        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .timer { font-weight: bold; color: #b91c1c; font-size: 1.2rem; background: #fee2e2; padding: 5px 15px; border-radius: 50px; }
        
        .question-box { margin-bottom: 30px; }
        .q-text { font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; }
        
        .opt { display: block; padding: 15px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .opt:hover { background: #f8fafc; }
        .opt.selected { background: #e0f2fe; border-color: #4361ee; color: #003366; font-weight: 600; }

        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: #4361ee; color: white; margin-top: 20px; width: 100%; }
        .btn:hover { background: #3341c9; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading-screen">
            <h2><i class="fa-solid fa-spinner fa-spin"></i> Sedang Memuat...</h2>
            <p id="status-text">Menghubungkan ke Database...</p>
        </div>

        <div id="error-screen">
            <h2><i class="fa-solid fa-triangle-exclamation"></i> Error</h2>
            <p id="error-msg">-</p>
            <a href="index.html" style="display:inline-block; margin-top:15px; text-decoration:none; color:blue;">&larr; Kembali</a>
        </div>

        <div id="exam-screen">
            <div class="header-bar">
                <div id="exam-title" style="font-weight:bold;">Judul Ujian</div>
                <div class="timer" id="timer">00:00</div>
            </div>

            <div id="question-container"></div>

            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button onclick="prevQ()" id="btn-prev" style="background:#ccc; color:#333; padding:10px 20px; border:none; border-radius:5px; visibility:hidden;">Sebelumnya</button>
                <button onclick="nextQ()" id="btn-next" style="background:#4361ee; color:white; padding:10px 20px; border:none; border-radius:5px;">Selanjutnya</button>
                <button onclick="submitExam()" id="btn-submit" style="background:#16a34a; color:white; padding:10px 20px; border:none; border-radius:5px; display:none;">Kirim Jawaban</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let questions = [];
        let answers = {};
        let currentIdx = 0;
        let currentUser = null;
        let timerInterval;
        let examId = new URLSearchParams(window.location.search).get('id');

        // --- FUNGSI DEBUGGING (Agar Loading Tidak Stuck) ---
        function showError(msg) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('exam-screen').style.display = 'none';
            document.getElementById('error-screen').style.display = 'block';
            document.getElementById('error-msg').innerText = msg;
            console.error(msg); // Cek Console browser (F12)
        }

        // --- 1. START SYSTEM ---
        (async () => {
            try {
                document.getElementById('status-text').innerText = "Cek Login...";
                
                // 1. Cek User
                currentUser = await checkAuth('siswa');
                if(!currentUser) {
                    alert("Anda belum login! Kembali ke halaman login.");
                    window.location.href = '../login.html';
                    return;
                }

                // 2. Cek ID URL
                if(!examId) throw new Error("ID Ujian tidak ditemukan di URL (Address Bar).");

                document.getElementById('status-text').innerText = "Mengunduh Soal...";

                // 3. Ambil Data Ujian
                const docRef = doc(db, 'exams', examId);
                const snap = await getDoc(docRef);

                if (!snap.exists()) throw new Error("Data ujian TIDAK ADA di Database. Mungkin sudah dihapus admin?");

                const data = snap.data();
                if (!data.questions || data.questions.length === 0) throw new Error("Ujian ini kosong (tidak ada soal).");

                // 4. Sukses Load -> Tampilkan
                questions = data.questions;
                document.getElementById('exam-title').innerText = data.judul;
                
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('exam-screen').style.display = 'block';

                renderQuestion(0);
                startTimer(data.durasi || 60);

            } catch (error) {
                showError("GAGAL MEMUAT: " + error.message);
            }
        })();

        // --- 2. RENDER LOGIC ---
        window.renderQuestion = (idx) => {
            currentIdx = idx;
            const q = questions[idx];
            const saved = answers[idx]; // Jawaban tersimpan (0, 1, 2, 3)

            let html = `
                <div class="question-box">
                    <div class="q-text">${idx + 1}. ${q.text}</div>
            `;

            q.options.forEach((opt, i) => {
                const bgClass = saved === i ? 'selected' : ''; // Highlight jika sudah dipilih
                html += `<div class="opt ${bgClass}" onclick="pilihJawaban(${idx}, ${i})">${String.fromCharCode(65+i)}. ${opt}</div>`;
            });

            html += `</div>`;
            document.getElementById('question-container').innerHTML = html;

            // Tombol Navigasi
            document.getElementById('btn-prev').style.visibility = idx === 0 ? 'hidden' : 'visible';
            
            if(idx === questions.length - 1) {
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('btn-submit').style.display = 'block';
            } else {
                document.getElementById('btn-next').style.display = 'block';
                document.getElementById('btn-submit').style.display = 'none';
            }
        }

        window.pilihJawaban = (qIdx, optIdx) => {
            answers[qIdx] = optIdx;
            renderQuestion(qIdx); // Refresh tampilan biar warnanya berubah
        }

        window.prevQ = () => renderQuestion(currentIdx - 1);
        window.nextQ = () => renderQuestion(currentIdx + 1);

        // --- 3. TIMER ---
        function startTimer(minutes) {
            let time = minutes * 60;
            const el = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const m = Math.floor(time / 60);
                const s = time % 60;
                el.innerText = `${m}:${s<10?'0':''}${s}`;
                if(time <= 0) {
                    clearInterval(timerInterval);
                    alert("Waktu Habis!");
                    submitExam();
                }
                time--;
            }, 1000);
        }

        // --- 4. SUBMIT (BAGIAN PALING KRUSIAL) ---
        window.submitExam = async () => {
            if(!confirm("Yakin ingin mengumpulkan?")) return;

            clearInterval(timerInterval);
            document.getElementById('exam-screen').style.opacity = '0.5';
            document.getElementById('status-text').innerText = "Menyimpan Nilai...";
            document.getElementById('loading-screen').style.display = 'block';

            try {
                // Hitung Nilai
                let correct = 0;
                questions.forEach((q, i) => {
                    if(answers[i] === q.correctIndex) correct++;
                });
                const score = Math.round((correct / questions.length) * 100);

                // SIMPAN
                // Pastikan nama collection 'quiz_results' SAMA PERSIS dengan yang di index.html
                await addDoc(collection(db, 'quiz_results'), {
                    quizId: examId, // INI PENTING: ID Ujian
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    score: score,
                    correctCount: correct,
                    totalQuestions: questions.length,
                    answers: answers,
                    submittedAt: serverTimestamp()
                });

                alert("Berhasil! Nilai Anda: " + score);
                window.location.href = 'index.html'; // Kembali ke menu utama

            } catch (e) {
                alert("GAGAL MENYIMPAN NILAI: " + e.message);
                document.getElementById('exam-screen').style.opacity = '1';
                document.getElementById('loading-screen').style.display = 'none';
            }
        }
    </script>
</body>
</html>
