<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Ujian - Cendekia Aksara</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #f4f7fe; color: #333; text-align: center; padding: 40px 20px; }
        .card { background: white; max-width: 500px; margin: 0 auto; padding: 40px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        
        #icon-top { font-size: 3rem; margin-bottom: 20px; }
        .icon-pg { color: #f59e0b; }
        .icon-essay { color: #10b981; }

        .score-circle {
            width: 150px; height: 150px; background: conic-gradient(#4361ee 0%, #e2e8f0 0%);
            border-radius: 50%; margin: 0 auto 25px; display: flex; justify-content: center; align-items: center;
            position: relative; transition: 1s ease-out;
        }
        .score-inner { 
            width: 130px; height: 130px; background: white; border-radius: 50%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .score-val { font-size: 3rem; font-weight: 800; color: #003366; line-height: 1; }
        .score-label { font-size: 0.9rem; color: #64748b; font-weight: 600; }

        .stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .stat-item { background: #f8fafc; padding: 10px 20px; border-radius: 12px; border: 1px solid #e2e8f0; flex: 1; }
        .st-val { font-weight: 700; font-size: 1.2rem; display: block; }
        .st-lbl { font-size: 0.8rem; color: #64748b; }

        .essay-msg {
            background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px; border-radius: 12px;
            color: #166534; font-size: 0.95rem; line-height: 1.6; margin-bottom: 30px; display: none;
        }

        .btn { display: block; width: 100%; padding: 15px; border-radius: 12px; font-weight: 600; text-decoration: none; margin-bottom: 10px; transition: 0.2s; cursor: pointer; }
        .btn-detail { background: #003366; color: white; border: none; }
        .btn-home { background: #e2e8f0; color: #475569; border: none; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    </style>
</head>
<body>

    <div class="card" id="result-card" style="display: none;">
        <i id="icon-top" class="fa-solid fa-trophy icon-pg"></i>
        <h2 id="main-title" style="margin:0 0 5px 0;">Ujian Selesai!</h2>
        <p id="sub-title" style="color:#64748b; margin-bottom:30px;">Berikut adalah hasil pengerjaan Anda.</p>

        <div class="score-circle" id="chart">
            <div class="score-inner">
                <span class="score-val" id="score">0</span>
                <span class="score-label" id="score-text">NILAI</span>
            </div>
        </div>

        <div class="stats" id="stats-box">
            <div class="stat-item">
                <span class="st-val" id="correct" style="color:#10b981;">0</span>
                <span class="st-lbl">Benar</span>
            </div>
            <div class="stat-item">
                <span class="st-val" id="wrong" style="color:#ef4444;">0</span>
                <span class="st-lbl">Salah</span>
            </div>
        </div>

        <div class="essay-msg" id="essay-msg">
            <i class="fa-solid fa-check-circle" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>
            Karya Anda telah berhasil dikirim dan saat ini sedang dalam proses peninjauan oleh sistem. Nilai akan muncul setelah proses evaluasi selesai.
        </div>

        <a href="#" id="link-detail" class="btn btn-detail">Lihat Pembahasan & Kunci</a>
        <a href="index.html" class="btn btn-home">Kembali ke Daftar Ujian</a>
    </div>

    <div id="loading" style="padding: 100px 0; color: #64748b;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <p>Memuat Hasil...</p>
    </div>

    <script type="module">
        import { db } from "../js/firebase-config.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const rid = new URLSearchParams(window.location.search).get('rid');

        (async () => {
            if(!rid) return window.location.href = 'index.html';
            
            try {
                // Ambil Data Hasil
                const snap = await getDoc(doc(db, 'quiz_results', rid));
                if(!snap.exists()) {
                    alert("Data tidak ditemukan.");
                    window.location.href = 'index.html';
                    return;
                }
                
                const r = snap.data();

                // Hapus loading, munculkan kartu
                document.getElementById('loading').style.display = 'none';
                document.getElementById('result-card').style.display = 'block';

                if (r.type === 'essay') {
                    // --- TAMPILAN JIKA ESAI ---
                    document.getElementById('icon-top').className = "fa-solid fa-file-signature icon-essay";
                    document.getElementById('main-title').innerText = "Karya Terkirim!";
                    document.getElementById('sub-title').innerText = "Terima kasih telah mengerjakan.";
                    
                    document.getElementById('score').innerText = r.score > 0 ? r.score : "-";
                    document.getElementById('score-text').innerText = r.score > 0 ? "NILAI" : "PROSES";
                    
                    // Sembunyikan Statistik PG dan Tombol Pembahasan
                    document.getElementById('stats-box').style.display = 'none';
                    document.getElementById('link-detail').style.display = 'none';
                    
                    // Munculkan Pesan Peninjauan
                    document.getElementById('essay-msg').style.display = 'block';

                    // Animasi Chart Esai
                    const scoreNum = Number(r.score) || 0;
                    const deg = (scoreNum / 100) * 360;
                    const chartColor = scoreNum > 0 ? '#10b981' : '#e2e8f0'; // Hijau jika sudah ada nilai, abu jika 0
                    document.getElementById('chart').style.background = `conic-gradient(${chartColor} ${deg}deg, #f1f5f9 0deg)`;

                } else {
                    // --- TAMPILAN JIKA PILIHAN GANDA (DEFAULT) ---
                    const wrong = r.totalQuestions - r.correctCount;
                    
                    document.getElementById('score').innerText = r.score;
                    document.getElementById('correct').innerText = r.correctCount;
                    document.getElementById('wrong').innerText = wrong;
                    
                    // Set Link Pembahasan
                    document.getElementById('link-detail').href = `detail.html?rid=${rid}`;

                    // Animasi Chart PG (Biru)
                    setTimeout(() => {
                        const deg = (r.score / 100) * 360;
                        document.getElementById('chart').style.background = `conic-gradient(#4361ee ${deg}deg, #e2e8f0 0deg)`;
                    }, 100);
                }

            } catch (error) {
                console.error(error);
                alert("Terjadi kesalahan saat memuat data.");
                window.location.href = 'index.html';
            }
        })();
    </script>
</body>
</html>
