<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Konfirmasi Ujian - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Poppins', sans-serif; color: #333; margin: 0; padding-bottom: 100px; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        /* HEADER */
        .page-header { margin-bottom: 20px; }
        .btn-back { text-decoration: none; color: #666; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* LAYOUT GRID */
        .grid-layout { display: grid; grid-template-columns: 300px 1fr; gap: 25px; }
        
        /* CARD STYLE */
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        /* PROFIL SISWA */
        .card-profile { text-align: center; height: fit-content; }
        .avatar-box { 
            width: 90px; height: 90px; background: #e0f2fe; border-radius: 50%; 
            margin: 0 auto 15px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; color: #0284c7; 
        }
        .st-name { font-size: 1.1rem; font-weight: 700; margin: 0; color: #0f172a; }
        .st-id { color: #64748b; font-size: 0.9rem; margin-top: 5px; }
        .divider { height: 1px; background: #f1f5f9; margin: 20px 0; }
        .st-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 10px; }

        /* DETAIL UJIAN */
        .exam-title { font-size: 1.6rem; font-weight: 700; color: #0f172a; margin: 0 0 5px 0; line-height: 1.2; }
        .exam-mapel { font-size: 1rem; color: #64748b; font-weight: 500; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        
        .badges { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; }
        .badge { background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 6px; }

        /* RULES BOX */
        .rules-box { background: #fffbeb; border: 1px solid #fcd34d; border-radius: 16px; padding: 20px; }
        .rules-title { font-weight: 700; color: #b45309; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .rules-list { margin: 0; padding-left: 20px; font-size: 0.9rem; color: #4b5563; line-height: 1.6; }
        .rules-list li { margin-bottom: 8px; }

        /* CHECKBOX & TOMBOL MULAI */
        .footer-action { margin-top: 25px; padding-top: 20px; border-top: 1px dashed #e2e8f0; }
        
        .checkbox-wrapper { 
            display: flex; align-items: flex-start; gap: 12px; cursor: pointer; 
            padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;
            transition: 0.2s;
        }
        .checkbox-wrapper:hover { border-color: #cbd5e1; }
        .checkbox-wrapper input { width: 18px; height: 18px; margin-top: 3px; accent-color: #0284c7; }
        
        /* Floating Button Container */
        .sticky-btn-container {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            z-index: 100; box-sizing: border-box;
            display: flex; justify-content: center;
        }

        .btn-start { 
            width: 100%; max-width: 600px; padding: 16px; border: none; border-radius: 14px; 
            background: #22c55e; color: white; font-weight: 700; font-size: 1.1rem; 
            cursor: pointer; transition: 0.2s; opacity: 0.5; pointer-events: none;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        .btn-start.ready { opacity: 1; pointer-events: all; }
        .btn-start:active { transform: scale(0.98); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-box { background: white; padding: 30px; border-radius: 24px; width: 85%; max-width: 380px; text-align: center; transform: scale(0.8); transition: 0.3s; }
        .modal-overlay.active .modal-box { transform: scale(1); }

        .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px; }
        .btn-modal { padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem; }
        .btn-cancel { background: #f1f5f9; color: #475569; }
        .btn-go { background: #0284c7; color: white; }

        /* RESPONSIF HP */
        @media (max-width: 768px) {
            .grid-layout { grid-template-columns: 1fr; gap: 20px; }
            .card-profile { display: flex; align-items: center; text-align: left; padding: 20px; gap: 15px; }
            .avatar-box { margin: 0; width: 60px; height: 60px; font-size: 1.8rem; }
            .divider, .st-row { display: none; }
            .exam-title { font-size: 1.4rem; }
            .sticky-btn-container { padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <a href="index.html" class="btn-back">
                <i class="fa-solid fa-chevron-left"></i> Kembali
            </a>
        </div>

        <div id="loading" style="text-align:center; padding:80px 20px;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:#0284c7;"></i>
            <p style="margin-top:15px; color:#64748b;">Memverifikasi Data...</p>
        </div>

        <div id="content" class="grid-layout" style="display:none;">
            
            <div class="card card-profile">
                <div class="avatar-box"><i class="fa-solid fa-user-graduate"></i></div>
                <div>
                    <h3 class="st-name" id="st-name">Nama Siswa</h3>
                    <p class="st-id" id="st-uid">ID: -</p>
                    <div style="margin-top:5px;">
                        <span style="background:#dcfce7; color:#166534; font-size:0.75rem; font-weight:700; padding:3px 8px; border-radius:6px;">TERVERIFIKASI</span>
                    </div>
                </div>
                
                <div class="divider"></div>
                
                <div class="st-row"><span>Semester</span><strong id="st-sem">-</strong></div>
                <div class="st-row"><span>Status Bayar</span><strong style="color:#22c55e;">Lunas</strong></div>
            </div>

            <div class="card">
                <h1 class="exam-title" id="ex-title">Judul Ujian</h1>
                <p class="exam-mapel"><i class="fa-solid fa-book-open"></i> <span id="ex-mapel">-</span></p>

                <div class="badges">
                    <div class="badge"><i class="fa-regular fa-clock"></i> <span id="ex-durasi">-</span> Menit</div>
                    <div class="badge"><i class="fa-solid fa-list-check"></i> <span id="ex-soal">-</span> Soal</div>
                    <div class="badge"><i class="fa-solid fa-check-double"></i> Pilihan Ganda</div>
                </div>

                <div class="rules-box">
                    <div class="rules-title"><i class="fa-solid fa-circle-exclamation"></i> PERATURAN UJIAN</div>
                    <ul class="rules-list">
                        <li>Waktu berjalan mundur otomatis saat tombol <b>MULAI</b> ditekan.</li>
                        <li>Jangan keluar dari browser atau membuka tab lain (dideteksi sistem).</li>
                        <li>Jika koneksi terputus, jangan panik. Jawaban tersimpan lokal.</li>
                        <li>Soal akan terkunci otomatis jika waktu habis.</li>
                    </ul>
                </div>

                <div class="footer-action">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="agree-check" onchange="toggleButton()">
                        <span style="font-size:0.9rem; color:#334155; line-height:1.4;">
                            Saya menyatakan data di atas benar dan siap mengerjakan ujian dengan jujur tanpa bantuan pihak lain.
                        </span>
                    </label>
                </div>
            </div>

        </div>
    </div>

    <div class="sticky-btn-container" id="sticky-footer" style="display:none;">
        <button id="btn-start" class="btn-start" onclick="confirmStart()">
            <i class="fa-solid fa-play"></i> MULAI UJIAN
        </button>
    </div>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-rocket" style="font-size:3.5rem; color:#0284c7; margin-bottom:15px;"></i>
            <h2 style="margin:0 0 10px 0; color:#1e293b;">Siap Memulai?</h2>
            <p style="color:#64748b; margin:0; font-size:0.95rem;">
                Waktu akan langsung berjalan. Pastikan Anda sudah siap sepenuhnya.
            </p>
            <div class="modal-btns">
                <button onclick="closeModal('modal-confirm')" class="btn-modal btn-cancel">Batal</button>
                <button onclick="goTest()" class="btn-modal btn-go">Ya, Mulai!</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');

        (async () => {
            const user = await checkAuth('siswa');
            
            if(user) {
                // 1. CEK PEMBAYARAN SAJA (Tanpa blokir semester)
                // Siswa harus Lunas (75rb) atau Cicilan (37rb) atau Lunas Ujian (1rb)
                // Di database semuanya tercatat sebagai 'Lunas' atau 'Cicilan'
                if(user.statusPembayaran !== 'Lunas' && user.statusPembayaran !== 'Cicilan') {
                    alert("Akses ditolak. Mohon selesaikan administrasi pembayaran.");
                    window.location.href = '../pembayaran.html';
                    return;
                }

                // Jika lolos pembayaran, load data
                loadPageData(user);
            }
        })();

        async function loadPageData(user) {
            try {
                // Render Profil
                document.getElementById('st-name').innerText = user.name;
                document.getElementById('st-uid').innerText = "ID: " + user.uid.substring(0,6).toUpperCase();
                document.getElementById('st-sem').innerText = user.semester || 1;

                // Ambil Data Ujian
                if(!examId) throw new Error("ID hilang");
                const docRef = doc(db, 'exams', examId);
                const snap = await getDoc(docRef);

                if(!snap.exists()) {
                    alert("Ujian tidak ditemukan.");
                    window.location.href = 'index.html';
                    return;
                }

                const data = snap.data();
                document.getElementById('ex-title').innerText = data.judul;
                document.getElementById('ex-mapel').innerText = data.mapel;
                document.getElementById('ex-durasi').innerText = data.durasi;
                document.getElementById('ex-soal').innerText = data.questions ? data.questions.length : 0;

                // Tampilkan UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'grid';
                document.getElementById('sticky-footer').style.display = 'flex';

            } catch(e) {
                console.error(e);
                alert("Terjadi kesalahan memuat data.");
                window.location.href = 'index.html';
            }
        }

        window.toggleButton = () => {
            const chk = document.getElementById('agree-check');
            const btn = document.getElementById('btn-start');
            if(chk.checked) btn.classList.add('ready');
            else btn.classList.remove('ready');
        }

        window.confirmStart = () => document.getElementById('modal-confirm').classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        
        window.goTest = () => {
            window.location.href = `test.html?id=${examId}`;
        }
    </script>
</body>
</html>
