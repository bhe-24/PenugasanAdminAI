<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembahasan Soal</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #f8fafc; color: #333; margin: 0; padding-bottom: 60px; }
        
        .header { background: white; padding: 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .back-btn { text-decoration: none; color: #003366; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; }
        
        .review-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        
        .q-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .q-badge { font-size: 0.8rem; font-weight: 700; padding: 4px 10px; border-radius: 6px; }
        .badge-correct { background: #dcfce7; color: #166534; }
        .badge-wrong { background: #fee2e2; color: #991b1b; }
        
        .q-text { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }
        
        .opt-row { display: flex; gap: 15px; padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #f1f5f9; align-items: center; }
        .opt-letter { width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; background: #f1f5f9; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; }
        
        /* WARNA PEMBAHASAN */
        .opt-correct { background: #dcfce7; border-color: #86efac; } /* Kunci Jawaban */
        .opt-correct .opt-letter { background: #16a34a; color: white; }
        
        .opt-wrong { background: #fee2e2; border-color: #fca5a5; } /* Jawaban Siswa Salah */
        .opt-wrong .opt-letter { background: #ef4444; color: white; }
    </style>
</head>
<body>

    <header class="header">
        <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Kembali ke Daftar</a>
        <div style="font-weight:700; font-size:1.1rem;">Pembahasan</div>
    </header>

    <div class="container" id="review-list">
        <div style="text-align:center; padding:50px;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:2rem; color:#ccc;"></i>
        </div>
    </div>

    <script type="module">
        import { db } from "../js/firebase-config.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const rid = new URLSearchParams(window.location.search).get('rid');

        (async () => {
            if(!rid) return alert("ID Hasil tidak ditemukan.");

            // 1. Ambil Hasil Siswa
            const resSnap = await getDoc(doc(db, 'quiz_results', rid));
            const resData = resSnap.data();

            // 2. Ambil Soal Asli (Pakai ID Ujian dari hasil siswa)
            const examSnap = await getDoc(doc(db, 'exams', resData.quizId));
            const questions = examSnap.data().questions;
            const userAns = resData.answers; // { 0: 1, 1: 0 }

            const container = document.getElementById('review-list');
            container.innerHTML = '';

            // 3. Render Loop
            questions.forEach((q, idx) => {
                const myAns = userAns[idx]; // Jawaban siswa (index)
                const correctAns = q.correctIndex; // Kunci (index)
                const isCorrect = myAns === correctAns;

                let badge = isCorrect 
                    ? `<span class="q-badge badge-correct"><i class="fa-solid fa-check"></i> Benar</span>`
                    : `<span class="q-badge badge-wrong"><i class="fa-solid fa-xmark"></i> Salah</span>`;

                let optionsHtml = '';
                q.options.forEach((opt, i) => {
                    let rowClass = '';
                    
                    if (i === correctAns) {
                        rowClass = 'opt-correct'; // Selalu hijaukan kunci
                    } else if (i === myAns && !isCorrect) {
                        rowClass = 'opt-wrong'; // Merahkan jawaban siswa jika salah
                    }

                    // Tanda centang/silang di ujung
                    let icon = '';
                    if (i === correctAns) icon = '<i class="fa-solid fa-check" style="margin-left:auto; color:#166534;"></i>';
                    else if (i === myAns && !isCorrect) icon = '<i class="fa-solid fa-xmark" style="margin-left:auto; color:#991b1b;"></i>';

                    optionsHtml += `
                        <div class="opt-row ${rowClass}">
                            <div class="opt-letter">${String.fromCharCode(65+i)}</div>
                            <div>${opt}</div>
                            ${icon}
                        </div>
                    `;
                });

                container.innerHTML += `
                    <div class="review-card">
                        <div class="q-header">
                            <span style="font-weight:700; color:#64748b;">NO. ${idx+1}</span>
                            ${badge}
                        </div>
                        <div class="q-text">${q.text}</div>
                        <div>${optionsHtml}</div>
                    </div>
                `;
            });
        })();
    </script>
</body>
</html>
