<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal Ujian - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* PERBAIKAN UTAMA: Box Sizing agar tidak overset */
        * { box-sizing: border-box; }

        :root { --primary: #003366; --accent: #4361ee; --bg: #f8f9fa; }
        body { background-color: var(--bg); font-family: 'Outfit', sans-serif; color: #333; margin: 0; padding-bottom: 50px; }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

        /* HEADER MODERN */
        .modern-header {
            background: linear-gradient(135deg, #003366, #0f4c81);
            color: white; padding: 30px 40px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 51, 102, 0.2);
            position: relative; overflow: hidden; margin-bottom: 30px;
            display: flex; align-items: center; justify-content: space-between; gap: 20px;
        }
        
        /* Dekorasi */
        .modern-header::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 200px; height: 200px; background: rgba(255,255,255,0.05);
            border-radius: 50%; pointer-events: none;
        }

        .header-content { flex: 1; z-index: 1; min-width: 0; /* Mencegah flex item jebol */ }
        .brand-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .school-logo { width: 40px; height: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        .page-title { font-size: 1.6rem; font-weight: 700; margin: 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* QUOTE */
        .quote-box {
            margin-top: 8px; font-size: 0.9rem; opacity: 0.9; font-weight: 300;
            display: flex; align-items: center; gap: 8px; min-height: 24px;
        }
        .quote-text { transition: opacity 0.5s ease-in-out; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fade-out { opacity: 0; }
        
        .btn-back {
            background: rgba(255,255,255,0.15); color: white; text-decoration: none;
            padding: 10px 20px; border-radius: 50px; font-weight: 600; backdrop-filter: blur(5px);
            transition: 0.3s; white-space: nowrap; border: 1px solid rgba(255,255,255,0.2);
            display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; flex-shrink: 0;
        }
        .btn-back:hover { background: white; color: var(--primary); transform: translateY(-2px); }

        /* GRID SYSTEM */
        .exam-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
        }

        /* KARTU UJIAN */
        .exam-card {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f0f0f0;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; display: flex; flex-direction: column; justify-content: space-between;
            height: 100%; /* Agar tinggi seragam */
        }
        .exam-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(67, 97, 238, 0.1); border-color: #e0e7ff; }

        .card-top { margin-bottom: 15px; }
        .exam-title { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-bottom: 6px; line-height: 1.3; padding-right: 70px; /* Space for status pill */ }
        .exam-mapel { 
            display: inline-flex; align-items: center; gap: 5px; 
            font-size: 0.85rem; color: #64748b; font-weight: 500;
            background: #f1f5f9; padding: 4px 8px; border-radius: 6px;
        }

        .meta-row { display: flex; gap: 12px; margin-top: 12px; color: #64748b; font-size: 0.8rem; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 5px; }

        /* CONTENT MIDDLE */
        .card-mid { margin: 15px 0; }

        .score-display {
            background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px; padding: 12px;
            text-align: center; color: #15803d;
        }
        .score-num { font-size: 1.8rem; font-weight: 800; line-height: 1; }
        .score-lbl { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; opacity: 0.8; }

        .lock-display {
            background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px; padding: 15px;
            text-align: center; color: #b91c1c; font-size: 0.85rem;
        }

        /* BUTTONS - Dibuat width 100% dengan box-sizing aman */
        .btn-exam {
            width: 100%; padding: 12px; border-radius: 10px;
            text-align: center; text-decoration: none; font-weight: 600; font-size: 0.9rem;
            transition: 0.2s; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-sizing: border-box; /* KUNCI ANTI OVERFLOW */
        }
        .btn-start { background: #4361ee; color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        .btn-start:hover { background: #3a56d4; transform: translateY(-2px); }
        
        .btn-detail { background: white; border: 2px solid #e2e8f0; color: #475569; }
        .btn-detail:hover { border-color: #cbd5e1; background: #f8fafc; }

        .btn-pay { background: #ef4444; color: white; }
        .btn-pay:hover { background: #dc2626; }

        /* STATUS BADGE */
        .status-pill {
            position: absolute; top: 20px; right: 20px; font-size: 0.7rem; font-weight: 700;
            padding: 4px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .st-done { background: #dcfce7; color: #166534; }
        .st-ready { background: #e0f2fe; color: #0369a1; }
        .st-lock { background: #fee2e2; color: #991b1b; }

        #loading { text-align: center; padding: 60px; }
        .hidden { display: none !important; }
        
        /* RESPONSIF HP (Mobile Fixes) */
        @media (max-width: 600px) {
            .container { padding: 15px; } /* Kurangi padding container */
            
            .modern-header { 
                flex-direction: column; 
                align-items: flex-start; 
                text-align: left; 
                padding: 20px; 
                border-radius: 15px;
            }
            
            .header-content { width: 100%; }
            .page-title { font-size: 1.4rem; white-space: normal; } /* Judul boleh wrap di HP */
            .quote-box { display: none; } /* Sembunyikan quote di HP biar ringkas */

            .btn-back { 
                width: 100%; 
                justify-content: center; 
                margin-top: 15px; 
                padding: 12px;
            }
            
            .exam-grid { grid-template-columns: 1fr; gap: 15px; } /* 1 Kolom full width */
            
            .exam-card { padding: 20px; }
            .btn-exam { font-size: 0.95rem; padding: 14px; } /* Tombol lebih mudah ditekan */
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="modern-header">
            <div class="header-content">
                <div class="brand-row">
                    <img src="https://i.imgur.com/5Srjyo4.png" alt="Logo" class="school-logo">
                    <span style="font-weight: 600; letter-spacing: 1px; opacity: 0.9; font-size: 0.9rem;">CENDEKIA AKSARA</span>
                </div>
                <h1 class="page-title">Portal Ujian Online</h1>
                
                <div class="quote-box">
                    <i class="fa-solid fa-quote-left" style="font-size: 0.8rem;"></i>
                    <span id="quote-text" class="quote-text">Memuat motivasi...</span>
                </div>
            </div>

            <a href="../index.html" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i> Kembali ke Dashboard
            </a>
        </header>

        <div id="loading">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary);"></i>
            <p style="margin-top:20px; color:#64748b;">Menyiapkan lembar ujian...</p>
        </div>
        
        <div id="exam-list" class="exam-grid hidden"></div>
        
        <div id="empty-msg" class="hidden" style="text-align:center; padding:60px 20px; color:#94a3b8;">
            <i class="fa-regular fa-folder-open" style="font-size:4rem; margin-bottom:20px; opacity:0.5;"></i>
            <h3>Belum Ada Jadwal Ujian</h3>
            <p>Silakan cek kembali nanti atau hubungi pengajar.</p>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SISTEM MOTIVASI ---
        const quotes = [
            "Kejujuran adalah mata uang yang berlaku di mana saja.",
            "Percaya pada dirimu sendiri, kamu lebih hebat dari yang kamu duga.",
            "Hasil tidak akan pernah mengkhianati usaha.",
            "Fokus pada proses, nikmati hasilnya.",
            "Ujian bukan hanya soal nilai, tapi soal integritas."
        ];

        let qIdx = 0;
        const qElement = document.getElementById('quote-text');

        function rotateQuote() {
            if(!qElement) return;
            qElement.classList.add('fade-out');
            setTimeout(() => {
                qElement.innerText = quotes[qIdx];
                qElement.classList.remove('fade-out');
                qIdx = (qIdx + 1) % quotes.length;
            }, 500);
        }

        rotateQuote();
        setInterval(rotateQuote, 10000);

        // --- LOGIKA UJIAN ---
        (async () => {
            const user = await checkAuth('siswa');
            if(user) loadExams(user);
        })();

        async function loadExams(user) {
            const container = document.getElementById('exam-list');
            
            try {
                // 1. Ambil Ujian Aktif
                const examsQ = query(collection(db, 'exams'), where('status', '==', 'active'));
                const examsSnap = await getDocs(examsQ);

                // 2. Ambil Hasil Siswa
                const resultsQ = query(collection(db, 'exam_results'), where('studentId', '==', user.uid));
                const resultsSnap = await getDocs(resultsQ);
                
                const userResults = {};
                resultsSnap.forEach(doc => {
                    const data = doc.data();
                    userResults[data.examId] = { id: doc.id, ...data };
                });

                document.getElementById('loading').classList.add('hidden');

                if (examsSnap.empty) {
                    document.getElementById('empty-msg').classList.remove('hidden');
                    return;
                }

                container.classList.remove('hidden');
                
                // Cek Pembayaran (Semua Semester Wajib Bayar/Lunas/Cicil)
                const canExam = (user.statusPembayaran === 'Lunas' || user.statusPembayaran === 'Cicilan');

                examsSnap.forEach(docSnap => {
                    const exam = docSnap.data();
                    const examId = docSnap.id;
                    const result = userResults[examId];

                    const card = document.createElement('div');
                    card.className = 'exam-card';

                    let badgeHtml = '';
                    let midHtml = '';
                    let btnHtml = '';

                    if (result) {
                        // KASUS 1: SELESAI
                        const score = parseFloat(result.score).toFixed(0);
                        badgeHtml = `<span class="status-pill st-done">Selesai</span>`;
                        midHtml = `
                            <div class="card-mid score-display">
                                <div class="score-num">${score}</div>
                                <div class="score-lbl">Nilai Akhir</div>
                            </div>
                        `;
                        btnHtml = `
                            <a href="detail.html?rid=${result.id}" class="btn-exam btn-detail">
                                <i class="fa-solid fa-file-circle-check"></i> Lihat Pembahasan
                            </a>
                        `;
                    } else if (!canExam) {
                        // KASUS 2: TERKUNCI (BELUM BAYAR)
                        badgeHtml = `<span class="status-pill st-lock"><i class="fa-solid fa-lock"></i> Terkunci</span>`;
                        midHtml = `
                            <div class="card-mid lock-display">
                                <i class="fa-solid fa-ban" style="font-size:1.5rem; margin-bottom:5px;"></i><br>
                                Selesaikan administrasi untuk membuka akses.
                            </div>
                        `;
                        btnHtml = `
                            <a href="../pembayaran.html" class="btn-exam btn-pay">
                                <i class="fa-solid fa-wallet"></i> Bayar Sekarang
                            </a>
                        `;
                    } else {
                        // KASUS 3: TERSEDIA
                        badgeHtml = `<span class="status-pill st-ready">Tersedia</span>`;
                        midHtml = `
                            <div class="card-mid" style="background:#f8fafc; padding:15px; border-radius:12px; font-size:0.85rem; color:#64748b;">
                                <i class="fa-solid fa-info-circle"></i> Pastikan koneksi internet lancar.
                            </div>
                        `;
                        btnHtml = `
                            <a href="start.html?id=${examId}" class="btn-exam btn-start">
                                <i class="fa-solid fa-play"></i> Kerjakan Sekarang
                            </a>
                        `;
                    }

                    card.innerHTML = `
                        ${badgeHtml}
                        <div class="card-top">
                            <h3 class="exam-title">${exam.judul}</h3>
                            <div class="exam-mapel"><i class="fa-solid fa-book-open"></i> ${exam.mapel}</div>
                            
                            <div class="meta-row">
                                <div class="meta-item"><i class="fa-regular fa-clock"></i> ${exam.durasi}m</div>
                                <div class="meta-item"><i class="fa-solid fa-list-ul"></i> ${exam.questions ? exam.questions.length : 0} Soal</div>
                            </div>
                        </div>

                        ${midHtml}
                        ${btnHtml}
                    `;
                    container.appendChild(card);
                });

            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>
