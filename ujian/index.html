<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Ujian - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Poppins', sans-serif; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* HEADER */
        .header-ujian { 
            background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .header-title h1 { margin: 0; font-size: 1.5rem; color: #003366; }
        .header-title p { margin: 5px 0 0; color: #666; font-size: 0.9rem; }
        
        .btn-back { 
            text-decoration: none; color: #555; background: #eee; padding: 8px 15px; 
            border-radius: 50px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn-back:hover { background: #ddd; }

        /* GRID UJIAN */
        .exam-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        
        /* KARTU UJIAN */
        .exam-card {
            background: white; border-radius: 16px; padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: transform 0.2s;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; border: 1px solid #f0f0f0; height: 100%; box-sizing: border-box;
        }
        .exam-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); border-color: #e0e0e0; }

        /* STATUS BADGE DI POJOK KARTU */
        .status-badge {
            position: absolute; top: 15px; right: 15px;
            font-size: 0.75rem; font-weight: 700; padding: 4px 10px; border-radius: 6px; text-transform: uppercase;
        }
        .st-done { background: #d1e7dd; color: #0f5132; }
        .st-ready { background: #fff3cd; color: #856404; }
        .st-lock { background: #f8d7da; color: #842029; }

        .exam-main { margin-bottom: 20px; }
        .exam-title { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; margin-bottom: 8px; line-height: 1.4; padding-right: 60px; /* Space for badge */ }
        .exam-mapel { font-size: 0.9rem; color: #64748b; display: flex; align-items: center; gap: 6px; margin-bottom: 15px; }
        
        .exam-meta { 
            display: flex; gap: 12px; font-size: 0.85rem; color: #555; 
            background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #f1f5f9;
        }

        /* NILAI DISPLAY */
        .score-box {
            text-align: center; margin: 15px 0; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px;
        }
        .score-val { font-size: 1.8rem; font-weight: 800; color: #166534; }
        .score-label { font-size: 0.8rem; color: #166534; text-transform: uppercase; letter-spacing: 1px; }

        /* TOMBOL BAWAH */
        .card-footer { margin-top: auto; padding-top: 15px; border-top: 1px dashed #eee; }
        .btn-exam {
            display: block; width: 100%; padding: 12px; border: none; border-radius: 10px;
            font-weight: 700; text-align: center; text-decoration: none; font-size: 0.95rem;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn-start { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        .btn-start:hover { box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3); }
        
        .btn-result { background: white; border: 2px solid #e2e8f0; color: #475569; }
        .btn-result:hover { background: #f8fafc; border-color: #cbd5e1; }

        .btn-locked { background: #fee2e2; color: #ef4444; cursor: not-allowed; opacity: 0.8; }

        /* LOCK OVERLAY (JIKA BELUM BAYAR) */
        .lock-msg { font-size: 0.8rem; color: #ef4444; margin-top: 5px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; }

        #loading { text-align: center; padding: 50px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-ujian">
            <div class="header-title">
                <h1>Portal Ujian Online</h1>
                <p>Kerjakan ujian sesuai jadwal dan instruksi.</p>
            </div>
            <a href="../index.html" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i> Dashboard
            </a>
        </div>

        <div id="loading">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:#003366;"></i>
            <p style="margin-top:15px; color:#666;">Memuat Data Ujian...</p>
        </div>
        
        <div id="exam-list" class="exam-grid hidden"></div>
        
        <div id="empty-msg" class="hidden" style="text-align:center; padding:60px; color:#94a3b8;">
            <i class="fa-regular fa-folder-open" style="font-size:4rem; margin-bottom:15px;"></i>
            <p style="font-size:1.1rem;">Belum ada ujian yang tersedia saat ini.</p>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        (async () => {
            const user = await checkAuth('siswa');
            if(user) loadExams(user);
        })();

        async function loadExams(user) {
            const container = document.getElementById('exam-list');
            
            try {
                // 1. Ambil Semua Ujian Aktif
                const examsQ = query(collection(db, 'exams'), where('status', '==', 'active'));
                const examsSnap = await getDocs(examsQ);

                // 2. Ambil Hasil Ujian Siswa Ini (Untuk Cek Nilai)
                const resultsQ = query(collection(db, 'exam_results'), where('studentId', '==', user.uid));
                const resultsSnap = await getDocs(resultsQ);
                
                // Mapping Hasil: { examId: resultData }
                const userResults = {};
                resultsSnap.forEach(doc => {
                    const data = doc.data();
                    userResults[data.examId] = { id: doc.id, ...data };
                });

                document.getElementById('loading').classList.add('hidden');

                if (examsSnap.empty) {
                    document.getElementById('empty-msg').classList.remove('hidden');
                    return;
                }

                container.classList.remove('hidden');
                
                // Cek Status Bayar (Lunas/Cicilan/Lunas 1rb)
                const canExam = (user.statusPembayaran === 'Lunas' || user.statusPembayaran === 'Cicilan');

                examsSnap.forEach(docSnap => {
                    const exam = docSnap.data();
                    const examId = docSnap.id;
                    const result = userResults[examId]; // Ambil hasil jika ada

                    // Filter Semester (Opsional: Hanya tampilkan sesuai semester siswa)
                    // if (exam.semester && exam.semester != user.semester) return;

                    const card = document.createElement('div');
                    card.className = 'exam-card';

                    let contentHtml = '';
                    let badgeHtml = '';
                    let buttonHtml = '';

                    // LOGIKA TAMPILAN KARTU
                    if (result) {
                        // KASUS 1: SUDAH MENGERJAKAN -> TAMPILKAN NILAI
                        const score = parseFloat(result.score).toFixed(0);
                        badgeHtml = `<span class="status-badge st-done">Selesai</span>`;
                        
                        contentHtml = `
                            <div class="score-box">
                                <div class="score-val">${score}</div>
                                <div class="score-label">Nilai Akhir</div>
                            </div>
                        `;
                        
                        buttonHtml = `
                            <a href="hasil.html?rid=${result.id}" class="btn-exam btn-result">
                                <i class="fa-solid fa-square-poll-vertical"></i> Lihat Detail & Pembahasan
                            </a>
                        `;

                    } else if (!canExam) {
                        // KASUS 2: BELUM BAYAR -> TERKUNCI
                        badgeHtml = `<span class="status-badge st-lock"><i class="fa-solid fa-lock"></i> Terkunci</span>`;
                        contentHtml = `
                            <div style="padding:20px; text-align:center; color:#ef4444; background:#fef2f2; border-radius:10px; border:1px dashed #fecaca; margin:10px 0;">
                                <i class="fa-solid fa-ban" style="font-size:1.5rem; margin-bottom:5px;"></i>
                                <div style="font-size:0.85rem; font-weight:600;">Akses Dibatasi</div>
                            </div>
                        `;
                        buttonHtml = `
                            <a href="../pembayaran.html" class="btn-exam btn-locked">
                                Selesaikan Pembayaran
                            </a>
                        `;

                    } else {
                        // KASUS 3: SIAP DIKERJAKAN
                        badgeHtml = `<span class="status-badge st-ready">Tersedia</span>`;
                        contentHtml = `
                            <div style="margin:20px 0; padding:10px; background:#eff6ff; border-radius:8px; color:#1e40af; font-size:0.85rem; display:flex; gap:10px; align-items:center;">
                                <i class="fa-solid fa-circle-info"></i>
                                Pastikan koneksi internet stabil sebelum memulai.
                            </div>
                        `;
                        buttonHtml = `
                            <a href="start.html?id=${examId}" class="btn-exam btn-start">
                                <i class="fa-solid fa-play"></i> Kerjakan Sekarang
                            </a>
                        `;
                    }

                    card.innerHTML = `
                        ${badgeHtml}
                        <div class="exam-main">
                            <div class="exam-title">${exam.judul}</div>
                            <div class="exam-mapel">
                                <i class="fa-solid fa-book-open"></i> ${exam.mapel}
                            </div>
                            <div class="exam-meta">
                                <span><i class="fa-regular fa-clock"></i> ${exam.durasi} Menit</span>
                                <span><i class="fa-solid fa-list-check"></i> ${exam.questions ? exam.questions.length : 0} Soal</span>
                            </div>
                            ${contentHtml}
                        </div>
                        <div class="card-footer">
                            ${buttonHtml}
                        </div>
                    `;
                    container.appendChild(card);
                });

            } catch (e) {
                console.error(e);
                alert("Gagal memuat data ujian.");
            }
        }
    </script>
</body>
</html>
