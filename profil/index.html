<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profil Siswa - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE VARIABLES (CORPORATE THEME) --- */
        :root {
            --primary: #0f172a;   /* Navy Gelap (Formal) */
            --accent: #4361ee;    /* Biru Cendekia (Brand) */
            --bg: #f1f5f9;        /* Abu-abu terang (Clean) */
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-grey: #64748b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            font-family: 'Outfit', sans-serif;
            color: var(--text-dark);
            margin: 0;
            padding-bottom: 40px;
            overflow-x: hidden;
        }

        /* Background Hiasan (Subtle Geometric) */
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 300px;
            background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%);
            z-index: -1;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }

        /* --- 2. LAYOUT CONTAINER --- */
        .container {
            max-width: 1000px; /* Ukuran Laptop Pas */
            margin: 0 auto;
            padding: 20px;
        }

        /* --- 3. PROFILE CARD (MAIN) --- */
        .profile-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); /* Soft Shadow */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        /* --- 4. HEADER SECTION (FOTO & NAMA) --- */
        .profile-header {
            background: linear-gradient(to bottom, #f8fafc, #fff);
            padding: 40px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .pic-wrapper {
            position: relative;
            width: 140px; height: 140px;
            margin: 0 auto 20px;
        }

        .profile-pic {
            width: 100%; height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 5px solid var(--white);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-cam {
            position: absolute; bottom: 5px; right: 5px;
            width: 40px; height: 40px;
            border-radius: 50%; border: none;
            background: var(--accent); color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
            transition: 0.2s; display: flex; justify-content: center; align-items: center;
            font-size: 1.1rem;
        }
        .btn-cam:hover { transform: scale(1.1); }
        .btn-cam.loading { background: #94a3b8; cursor: not-allowed; animation: pulse 1s infinite; }

        .user-title h2 { margin: 0; font-size: 1.8rem; color: var(--primary); font-weight: 700; }
        .user-title p { margin: 5px 0 15px; color: var(--text-grey); font-size: 0.95rem; }
        
        .badges { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .badge { padding: 6px 14px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.5px; }
        .badge-sem { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .badge-ips { background: #dcfce7; color: #15803d; border: 1px solid #86efac; display: flex; align-items: center; gap: 5px; }
        .badge-ips.warning { background: #fef9c3; color: #854d0e; border-color: #fde047; }

        /* --- 5. FORM SECTION --- */
        .profile-body { padding: 40px; }
        .section-title { 
            font-size: 1.1rem; font-weight: 700; color: var(--primary); 
            margin-bottom: 25px; border-left: 4px solid var(--accent); padding-left: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Default Laptop: 2 Kolom */
            gap: 25px;
        }

        .form-group { margin-bottom: 5px; }
        .form-group label {
            display: block; font-size: 0.85rem; font-weight: 600; 
            color: var(--text-grey); margin-bottom: 8px; text-transform: uppercase;
        }
        .form-input {
            width: 100%; padding: 12px 15px;
            border: 1px solid var(--border); border-radius: 8px;
            font-family: inherit; font-size: 0.95rem; color: var(--text-dark);
            transition: 0.2s; background: #f8fafc;
        }
        .form-input:focus {
            border-color: var(--accent); background: #fff; outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        textarea.form-input { resize: vertical; min-height: 100px; }

        .full-width { grid-column: 1 / -1; }

        .btn-save {
            background: var(--primary); color: white;
            border: none; padding: 14px 40px; border-radius: 8px;
            font-weight: 600; font-size: 1rem; cursor: pointer;
            transition: 0.2s; display: inline-flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(15, 23, 42, 0.2);
        }
        .btn-save:hover { background: #1e293b; transform: translateY(-2px); }
        .btn-save:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- 6. NAVIGASI ATAS --- */
        .top-nav { display: flex; justify-content: space-between; align-items: center; color: white; padding: 10px 0; }
        .btn-back { 
            color: white; text-decoration: none; font-weight: 600; 
            display: flex; align-items: center; gap: 8px; opacity: 0.9; transition: 0.2s; 
        }
        .btn-back:hover { opacity: 1; transform: translateX(-3px); }

        /* --- 7. POPUP SYSTEM (MODERN) --- */
        .overlay-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .overlay-backdrop.active { opacity: 1; pointer-events: auto; }

        .popup-card {
            background: white; width: 90%; max-width: 350px;
            padding: 30px; border-radius: 16px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: 0.3s;
        }
        .overlay-backdrop.active .popup-card { transform: scale(1); }

        .btn-pop {
            background: var(--bg); border: none; padding: 10px 25px; 
            border-radius: 50px; font-weight: 600; margin-top: 15px; cursor: pointer; width: 100%;
        }
        .btn-pop.primary { background: var(--accent); color: white; }

        /* --- 8. RESPONSIVE (MOBILE KHUSUS) --- */
        @media (max-width: 768px) {
            .bg-pattern { height: 200px; border-radius: 0; border-bottom-right-radius: 50px; }
            .container { padding: 15px; }
            
            .profile-card { margin-top: 10px; border-radius: 12px; }
            .profile-header { padding: 30px 20px; }
            .pic-wrapper { width: 110px; height: 110px; }
            
            .user-title h2 { font-size: 1.5rem; }
            
            /* Form jadi 1 kolom di HP agar nyaman */
            .profile-body { padding: 25px 20px; }
            .form-grid { grid-template-columns: 1fr; gap: 20px; }
            
            .btn-save { width: 100%; justify-content: center; padding: 12px; }
        }

        #loading { color: white; text-align: center; padding-top: 50px; }
        .hidden { display: none !important; }
        #fileInput { display: none; }
        @keyframes pulse { 0% { opacity:1; } 50% { opacity:0.6; } 100% { opacity:1; } }
    </style>
</head>
<body>

    <div class="bg-pattern"></div>

    <div id="alert-overlay" class="overlay-backdrop">
        <div class="popup-card">
            <div id="alert-icon" style="font-size: 3rem; margin-bottom: 15px;"></div>
            <h3 id="alert-title" style="margin:0 0 10px 0; color:var(--primary);"></h3>
            <p id="alert-msg" style="color:var(--text-grey); font-size:0.9rem; line-height:1.5; margin:0;"></p>
            <button onclick="closeOverlay()" class="btn-pop primary">OK</button>
        </div>
    </div>

    <div class="container">
        <div class="top-nav">
            <a href="../index.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Kembali ke Dashboard</a>
            <span style="font-size:0.9rem; opacity:0.8;">Cendekia Aksara</span>
        </div>

        <div id="loading">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:2rem;"></i>
            <p style="margin-top:10px;">Mengambil data...</p>
        </div>

        <div id="profile-content" class="profile-card hidden">
            
            <div class="profile-header">
                <div class="pic-wrapper">
                    <img src="https://ui-avatars.com/api/?name=User" id="display-pic" class="profile-pic">
                    <button class="btn-cam" id="btn-cam" onclick="document.getElementById('fileInput').click()">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                    <input type="file" id="fileInput" accept="image/*" onchange="uploadFoto()">
                </div>

                <div class="user-title">
                    <h2 id="display-name">...</h2>
                    <p id="display-email">...</p>
                </div>

                <div class="badges">
                    <div class="badge badge-sem" id="display-sem">Semester -</div>
                    <div class="badge badge-ips" id="ips-badge">
                        <i class="fa-solid fa-chart-line"></i> IPS: <span id="display-ips">0.00</span>
                    </div>
                </div>
            </div>

            <div class="profile-body">
                <div class="section-title">Informasi Pribadi</div>
                
                <form id="profile-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nama Lengkap</label>
                            <input type="text" id="inp-name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>WhatsApp / HP</label>
                            <input type="tel" id="inp-hp" class="form-input" placeholder="08..." required>
                        </div>
                        <div class="form-group">
                            <label>Tanggal Lahir</label>
                            <input type="date" id="inp-dob" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Alamat Domisili</label>
                            <input type="text" id="inp-addr" class="form-input" placeholder="Kota, Provinsi">
                        </div>
                        <div class="form-group full-width">
                            <label>Bio Singkat</label>
                            <textarea id="inp-bio" class="form-input" placeholder="Ceritakan sedikit tentang dirimu..."></textarea>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 30px; border-top: 1px dashed var(--border); padding-top: 20px;">
                        <button type="submit" class="btn-save">
                            <i class="fa-solid fa-check"></i> Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- API KEY SAYA PASANG DI SINI (JANGAN DIHAPUS) ---
        const IMGBB_API_KEY = "2f45fcafb6dfb2dbae295499022ce476"; 

        let currentUser = null;

        // --- GLOBAL UTILS ---
        window.closeOverlay = () => document.getElementById('alert-overlay').classList.remove('active');

        function showAlert(type, title, msg) {
            const ov = document.getElementById('alert-overlay');
            const icon = document.getElementById('alert-icon');
            
            if(type === 'success') icon.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#10b981;"></i>';
            else icon.innerHTML = '<i class="fa-solid fa-circle-xmark" style="color:#ef4444;"></i>';

            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            ov.classList.add('active');
        }

        // --- INIT ---
        (async () => {
            currentUser = await checkAuth('siswa');
            if(currentUser) renderProfile(currentUser);
        })();

        // --- RENDER ---
        function renderProfile(user) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('profile-content').classList.remove('hidden');

            // Header Data
            document.getElementById('display-name').innerText = user.name;
            document.getElementById('display-email').innerText = user.email;
            document.getElementById('display-sem').innerText = `Semester ${user.semester || 1}`;
            
            // IPS Logic
            const ips = parseFloat(user.ips || 0).toFixed(2);
            document.getElementById('display-ips').innerText = ips;
            if(ips < 3.00) document.getElementById('ips-badge').classList.add('warning');

            // Foto Profil
            if(user.photoURL) document.getElementById('display-pic').src = user.photoURL;

            // Form Data
            document.getElementById('inp-name').value = user.name;
            document.getElementById('inp-hp').value = user.noHp || '';
            document.getElementById('inp-dob').value = user.tanggalLahir || '';
            document.getElementById('inp-addr').value = user.alamat || '';
            document.getElementById('inp-bio').value = user.bioSingkat || '';
        }

        // --- UPLOAD FOTO (IMGBB) ---
        window.uploadFoto = async () => {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const btn = document.getElementById('btn-cam');

            if(!file) return;

            // Efek Loading di Tombol Kamera
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const formData = new FormData();
                formData.append("image", file);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();

                if(result.success) {
                    const url = result.data.url;
                    await updateDoc(doc(db, "users", currentUser.uid), { photoURL: url });
                    
                    document.getElementById('display-pic').src = url;
                    showAlert('success', 'Foto Diperbarui', 'Tampilan profil Anda makin keren!');
                } else {
                    throw new Error("Gagal upload ke server.");
                }
            } catch (err) {
                showAlert('error', 'Gagal Upload', 'Periksa koneksi internet Anda.');
                console.error(err);
            } finally {
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fa-solid fa-camera"></i>';
                fileInput.value = "";
            }
        };

        // --- SAVE PROFILE ---
        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';
            btn.disabled = true;

            const payload = {
                name: document.getElementById('inp-name').value,
                noHp: document.getElementById('inp-hp').value,
                tanggalLahir: document.getElementById('inp-dob').value,
                alamat: document.getElementById('inp-addr').value,
                bioSingkat: document.getElementById('inp-bio').value
            };

            try {
                await updateDoc(doc(db, 'users', currentUser.uid), payload);
                document.getElementById('display-name').innerText = payload.name;
                showAlert('success', 'Data Tersimpan', 'Informasi profil berhasil diperbarui.');
            } catch (err) {
                showAlert('error', 'Error Database', err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
