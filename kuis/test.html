<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Berlangsung</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #f0f2f5; margin: 0; padding-top: 70px; }
        .top-bar { position: fixed; top: 0; width: 100%; height: 60px; background: #003366; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; box-sizing: border-box; }
        .timer { font-weight: 700; background: #ef4444; padding: 5px 15px; border-radius: 20px; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        
        .q-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 300px; }
        .option { padding: 15px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; display: flex; gap: 10px; align-items: center; }
        .option:hover { background: #f9f9f9; border-color: #ccc; }
        .option.selected { border-color: #003366; background: #e0f2fe; font-weight: 600; }
        .circle { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ccc; }
        .option.selected .circle { background: #003366; border-color: #003366; }

        .nav-btns { display: flex; justify-content: space-between; margin-top: 30px; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; color: white; }
        .btn-next { background: #003366; }
        .btn-prev { background: #6c757d; }
        .btn-finish { background: #28a745; display: none; }
    </style>
</head>
<body>
    <div class="top-bar">
        <span id="q-num">Soal 1</span>
        <div class="timer" id="timer">--:--</div>
    </div>

    <div class="container">
        <div class="q-card" id="q-box">
            <p style="text-align:center;">Memuat soal...</p>
        </div>
        
        <div class="nav-btns">
            <button class="btn btn-prev" id="btn-prev" onclick="nav(-1)">Sebelumnya</button>
            <button class="btn btn-next" id="btn-next" onclick="nav(1)">Selanjutnya</button>
            <button class="btn btn-finish" id="btn-finish" onclick="submitQuiz()">Selesai & Kumpulkan</button>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const quizId = new URLSearchParams(window.location.search).get('id');
        let questions = [], answers = {}, currentIdx = 0, user = null;

        (async () => {
            user = await checkAuth('siswa');
            if(user) {
                const snap = await getDoc(doc(db, 'quizzes', quizId));
                if(snap.exists()) {
                    const data = snap.data();
                    questions = data.questions;
                    startTimer(data.durasi);
                    renderQ(0);
                }
            }
        })();

        function renderQ(idx) {
            currentIdx = idx;
            const q = questions[idx];
            document.getElementById('q-num').innerText = `Soal ${idx + 1} / ${questions.length}`;
            
            let optsHtml = '';
            q.options.forEach((opt, i) => {
                optsHtml += `
                    <div class="option ${answers[idx] === i ? 'selected' : ''}" onclick="selectAns(${i})">
                        <div class="circle"></div>
                        <span>${opt}</span>
                    </div>
                `;
            });

            document.getElementById('q-box').innerHTML = `<h3 style="margin-top:0;">${q.text}</h3>${optsHtml}`;
            
            // Tombol Navigasi
            document.getElementById('btn-prev').style.visibility = idx === 0 ? 'hidden' : 'visible';
            if (idx === questions.length - 1) {
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('btn-finish').style.display = 'block';
            } else {
                document.getElementById('btn-next').style.display = 'block';
                document.getElementById('btn-finish').style.display = 'none';
            }
        }

        window.selectAns = (optIdx) => {
            answers[currentIdx] = optIdx;
            renderQ(currentIdx);
        }

        window.nav = (step) => renderQ(currentIdx + step);

        function startTimer(minutes) {
            let time = minutes * 60;
            const timerEl = document.getElementById('timer');
            const interval = setInterval(() => {
                const m = Math.floor(time / 60);
                const s = time % 60;
                timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (time <= 0) {
                    clearInterval(interval);
                    submitQuiz(true);
                }
                time--;
            }, 1000);
        }

        window.submitQuiz = async (force=false) => {
            if(!force && !confirm("Yakin ingin mengumpulkan?")) return;
            
            let score = 0;
            questions.forEach((q, i) => {
                if(answers[i] === q.correctIndex) score++;
            });
            const finalScore = Math.round((score / questions.length) * 100);

            try {
                const resRef = await addDoc(collection(db, 'quiz_results'), {
                    quizId, studentId: user.uid,
                    studentName: user.name,
                    score: finalScore,
                    answers: answers,
                    timestamp: serverTimestamp()
                });
                window.location.href = `hasil.html?rid=${resRef.id}`;
            } catch(e) { alert("Gagal kirim jawaban"); }
        }
    </script>
</body>
</html>
