<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Berlangsung - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #003366; --accent: #4361ee; --bg: #f4f7fe; }
        
        body { font-family: 'Outfit', sans-serif; background: var(--bg); margin: 0; padding-top: 80px; padding-bottom: 40px; color: #333; user-select: none; }
        
        /* TOP BAR */
        .top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; z-index: 100; box-sizing: border-box;
        }
        .q-indicator { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .timer-box {
            background: #fee2e2; color: #b91c1c; padding: 8px 16px; border-radius: 50px;
            font-weight: 700; font-family: monospace; font-size: 1.1rem; border: 1px solid #fecaca;
            display: flex; align-items: center; gap: 8px;
        }

        /* CONTAINER */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        .q-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.03); border: 1px solid #eef2f6;
            margin-bottom: 30px; animation: fadeIn 0.4s ease; min-height: 200px;
        }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .q-text { font-size: 1.15rem; font-weight: 600; line-height: 1.6; margin-bottom: 25px; color: #1e293b; }

        /* ERROR STATE */
        .error-msg { text-align: center; color: #b91c1c; padding: 40px; }
        .error-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }

        /* OPSI JAWABAN */
        .option-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px; border: 2px solid #f1f5f9; border-radius: 12px;
            margin-bottom: 12px; cursor: pointer; transition: 0.2s;
            background: #fff;
        }
        .option-item:hover { border-color: #cbd5e1; background: #f8fafc; }
        .option-item.selected { border-color: var(--accent); background: #e0f2fe; color: #0369a1; }
        
        .option-circle {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #cbd5e1;
            flex-shrink: 0; display: flex; justify-content: center; align-items: center; font-size: 0.8rem;
        }
        .option-item.selected .option-circle { background: var(--accent); border-color: var(--accent); color: white; }
        .option-item.selected .option-circle::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; }

        /* NAVIGASI */
        .nav-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; transition: 0.2s; }
        .btn-prev { background: #e2e8f0; color: #475569; }
        .btn-next { background: var(--primary); color: white; }
        .btn-finish { background: #16a34a; color: white; display: none; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-box { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 380px; text-align: center; transform: scale(0.8); transition: 0.3s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .btn-modal { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; margin: 0 5px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="q-indicator" id="q-indicator">Memuat...</div>
        <div class="timer-box"><i class="fa-regular fa-clock"></i> <span id="timer">--:--</span></div>
    </div>

    <div class="container">
        <div id="q-content">
            <div class="q-card">
                <div class="error-msg">
                    <i class="fa-solid fa-circle-notch fa-spin error-icon"></i>
                    <p>Sedang mengambil soal dari server...</p>
                </div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-prev" id="btn-prev" onclick="navStep(-1)" style="visibility: hidden;">Sebelumnya</button>
            <button class="btn btn-next" id="btn-next" onclick="navStep(1)" style="visibility: hidden;">Selanjutnya</button>
            <button class="btn btn-finish" id="btn-finish" onclick="confirmFinish()">Selesai</button>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">Selesai Mengerjakan?</h3>
            <p style="color:#666;">Jawaban tidak bisa diubah setelah dikirim.</p>
            <div style="display:flex; justify-content:center;">
                <button class="btn-modal" onclick="closeModal()" style="background:#eee;">Batal</button>
                <button class="btn-modal" onclick="submitQuiz(false)" style="background:var(--primary); color:white;">Ya, Kirim</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const quizId = new URLSearchParams(window.location.search).get('id');
        
        let questions = [];
        let answers = {};
        let currentIdx = 0;
        let currentUser = null;
        let timerInterval = null;
        let quizTitle = "";

        // FUNGSI ERROR HANDLER UI
        function showFatalError(msg) {
            document.getElementById('q-content').innerHTML = `
                <div class="q-card">
                    <div class="error-msg">
                        <i class="fa-solid fa-triangle-exclamation error-icon" style="color:#dc3545; opacity:1;"></i>
                        <h3 style="margin:10px 0;">Terjadi Kesalahan</h3>
                        <p>${msg}</p>
                        <a href="index.html" style="display:inline-block; margin-top:20px; text-decoration:none; background:#003366; color:white; padding:10px 20px; border-radius:10px;">Kembali ke Daftar</a>
                    </div>
                </div>
            `;
            document.getElementById('q-indicator').innerText = "Error";
        }

        (async () => {
            try {
                // 1. Cek User
                currentUser = await checkAuth('siswa');
                if(!currentUser) return; // checkAuth akan redirect

                // 2. Cek ID Kuis
                if(!quizId) throw new Error("ID Kuis tidak ditemukan di URL.");

                // 3. Ambil Data
                console.log("Fetching Quiz ID:", quizId); // Debugging
                const snap = await getDoc(doc(db, 'quizzes', quizId));
                
                if(!snap.exists()) {
                    throw new Error("Soal kuis tidak ditemukan di Database. (Mungkin sudah dihapus admin)");
                }

                const data = snap.data();
                
                // 4. Validasi Isi Soal
                if (!data.questions || !Array.isArray(data.questions) || data.questions.length === 0) {
                    throw new Error("Soal kuis ini Kosong! Silakan lapor ke pengajar.");
                }

                questions = data.questions;
                quizTitle = data.judul;
                
                // 5. Mulai
                startTimer(data.durasi || 10); // Default 10 menit jika null
                renderQuestion(0);

            } catch(e) {
                console.error("DEBUG ERROR:", e);
                showFatalError(e.message);
            }
        })();

        function renderQuestion(idx) {
            currentIdx = idx;
            const q = questions[idx];
            
            // Safety check jika soal undefined
            if(!q) return showFatalError("Data soal corrupt pada index: " + idx);

            document.getElementById('q-indicator').innerText = `Soal ${idx + 1} / ${questions.length}`;

            let optionsHtml = '';
            // Pastikan options ada
            if(q.options && Array.isArray(q.options)) {
                q.options.forEach((opt, i) => {
                    const isSelected = answers[idx] === i ? 'selected' : '';
                    optionsHtml += `
                        <div class="option-item ${isSelected}" onclick="selectAnswer(${i})">
                            <div class="option-circle"></div>
                            <span style="flex:1;">${opt}</span>
                        </div>
                    `;
                });
            } else {
                optionsHtml = '<p style="color:red;">Opsi jawaban error.</p>';
            }

            const html = `
                <div class="q-card">
                    <div class="q-text">${q.text || "Teks soal hilang"}</div>
                    <div class="options-list">${optionsHtml}</div>
                </div>
            `;
            document.getElementById('q-content').innerHTML = html;

            // Navigasi
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnFinish = document.getElementById('btn-finish');

            btnPrev.style.visibility = idx === 0 ? 'hidden' : 'visible';
            
            if (idx === questions.length - 1) {
                btnNext.style.display = 'none';
                btnFinish.style.display = 'flex';
            } else {
                btnNext.style.visibility = 'visible'; // Pastikan visible
                btnNext.style.display = 'flex';
                btnFinish.style.display = 'none';
            }
        }

        window.selectAnswer = (optIdx) => {
            answers[currentIdx] = optIdx;
            renderQuestion(currentIdx); 
        };

        window.navStep = (step) => {
            renderQuestion(currentIdx + step);
        };

        window.confirmFinish = () => document.getElementById('custom-modal').classList.add('active');
        window.closeModal = () => document.getElementById('custom-modal').classList.remove('active');

        function startTimer(minutes) {
            let time = minutes * 60;
            const timerEl = document.getElementById('timer');
            
            timerInterval = setInterval(() => {
                const m = Math.floor(time / 60);
                const s = time % 60;
                timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                
                if (time <= 0) {
                    clearInterval(timerInterval);
                    alert("Waktu Habis! Jawaban akan dikirim otomatis.");
                    submitQuiz(true);
                }
                time--;
            }, 1000);
        }

        window.submitQuiz = async (force = false) => {
            closeModal();
            document.getElementById('q-content').innerHTML = `
                <div class="q-card" style="text-align:center;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size:3rem; color:var(--primary);"></i>
                    <p>Mengirim jawaban...</p>
                </div>
            `;
            
            let correctCount = 0;
            questions.forEach((q, i) => {
                if(answers[i] === q.correctIndex) correctCount++;
            });
            const finalScore = Math.round((correctCount / questions.length) * 100);

            try {
                const resRef = await addDoc(collection(db, 'quiz_results'), {
                    quizId: quizId,
                    quizTitle: quizTitle || "Kuis Tanpa Judul",
                    studentId: currentUser.uid,
                    studentName: currentUser.name,
                    score: finalScore,
                    correctCount: correctCount,
                    totalQuestions: questions.length,
                    answers: answers,
                    submittedAt: serverTimestamp()
                });
                window.location.href = `hasil.html?rid=${resRef.id}`;
            } catch(e) {
                alert("Gagal kirim: " + e.message);
                location.reload(); // Coba reload agar tidak stuck
            }
        };
    </script>
</body>
</html>
