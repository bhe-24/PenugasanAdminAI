<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Harian - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #003366; --accent: #4361ee; --bg: #f4f7fe; }
        body { background-color: var(--bg); font-family: 'Outfit', sans-serif; color: #333; margin: 0; padding-bottom: 60px; }
        .container { max-width: 1000px; margin: 0 auto; padding: 25px; }

        /* HEADER MODERN */
        .modern-header {
            background: linear-gradient(135deg, #003366, #1e3a8a);
            color: white; padding: 30px 40px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 51, 102, 0.25);
            position: relative; overflow: hidden; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modern-header::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 200px; height: 200px; background: rgba(255,255,255,0.05);
            border-radius: 50%; pointer-events: none;
        }
        
        .header-content h1 { margin: 0; font-size: 1.8rem; font-weight: 700; }
        .school-brand { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; opacity: 0.9; font-size: 0.9rem; letter-spacing: 1px; }
        .school-logo { width: 30px; filter: brightness(0) invert(1); }

        /* MOTIVASI TICKER */
        .quote-box { margin-top: 10px; font-size: 0.9rem; font-weight: 300; opacity: 0.9; display: flex; align-items: center; gap: 8px; }
        .quote-text { transition: opacity 0.5s ease; }
        .fade-out { opacity: 0; }

        .btn-back {
            background: rgba(255,255,255,0.2); color: white; text-decoration: none;
            padding: 10px 20px; border-radius: 50px; font-weight: 600; backdrop-filter: blur(5px);
            transition: 0.3s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn-back:hover { background: white; color: var(--primary); transform: translateY(-2px); }

        /* STATS BAR */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        .icon-blue { background: #e0f2fe; color: #0284c7; }
        .icon-purple { background: #f3e8ff; color: #9333ea; }
        .stat-info h3 { margin: 0; font-size: 1.5rem; color: #1e293b; }
        .stat-info p { margin: 0; color: #64748b; font-size: 0.85rem; }

        /* LIST KUIS GRID */
        .section-title { font-size: 1.2rem; font-weight: 700; color: #334155; margin-bottom: 20px; border-left: 5px solid var(--accent); padding-left: 15px; }
        
        .quiz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        
        /* CARD DESAIN */
        .quiz-card {
            background: white; border-radius: 18px; padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; border: 1px solid #f1f5f9; display: flex; flex-direction: column; justify-content: space-between;
        }
        .quiz-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(67, 97, 238, 0.15); border-color: #e0e7ff; }

        .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .mapel-badge { background: #f1f5f9; color: #475569; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        
        .quiz-title { font-size: 1.15rem; font-weight: 700; color: #1e293b; margin: 0 0 10px 0; line-height: 1.4; }
        .quiz-meta { display: flex; gap: 15px; font-size: 0.85rem; color: #64748b; margin-bottom: 20px; }
        .meta-item { display: flex; align-items: center; gap: 5px; }

        /* STATUS & TOMBOL */
        .card-footer { margin-top: auto; }
        
        .btn-quiz { display: block; width: 100%; padding: 12px; border-radius: 12px; text-align: center; text-decoration: none; font-weight: 600; font-size: 0.95rem; transition: 0.2s; border: none; cursor: pointer; }
        
        .btn-start { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0, 51, 102, 0.2); }
        .btn-start:hover { background: #1e3a8a; transform: translateY(-2px); }
        
        .btn-done { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-done:hover { background: #bbf7d0; }

        /* LOADING */
        #loading { text-align: center; padding: 60px; }
        .hidden { display: none !important; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .modern-header { flex-direction: column; align-items: flex-start; gap: 20px; padding: 25px; }
            .btn-back { width: 100%; justify-content: center; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <header class="modern-header">
            <div>
                <div class="school-brand">
                    <img src="https://i.imgur.com/5Srjyo4.png" class="school-logo" alt="Logo">
                    <span>CENDEKIA AKSARA</span>
                </div>
                <h1>Kuis Harian</h1>
                <div class="quote-box">
                    <i class="fa-solid fa-quote-left"></i>
                    <span id="quote-text" class="quote-text">Memuat motivasi...</span>
                </div>
            </div>
            <a href="../index.html" class="btn-back">
                <i class="fa-solid fa-house"></i> Dashboard
            </a>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon icon-blue"><i class="fa-solid fa-list-check"></i></div>
                <div class="stat-info">
                    <h3 id="stat-total">0</h3>
                    <p>Kuis Tersedia</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-purple"><i class="fa-solid fa-star"></i></div>
                <div class="stat-info">
                    <h3 id="stat-score">-</h3>
                    <p>Rata-rata Nilaimu</p>
                </div>
            </div>
        </div>

        <div class="section-title">Daftar Kuis Terbaru</div>
        
        <div id="loading">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary);"></i>
            <p style="margin-top:15px; color:#64748b;">Menyiapkan kuis...</p>
        </div>

        <div id="quiz-list" class="quiz-grid hidden"></div>
        <div id="empty-msg" class="hidden" style="text-align:center; padding:50px; color:#94a3b8;">
            <i class="fa-solid fa-box-open" style="font-size:3rem;"></i>
            <p>Belum ada kuis harian.</p>
        </div>

    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MOTIVASI OTOMATIS ---
        const quotes = [
            "Belajar sedikit demi sedikit, lama-lama menjadi bukit.",
            "Kuis hari ini adalah tabungan nilai untuk masa depan.",
            "Kejujuran adalah kunci utama keberhasilan.",
            "Jangan takut salah, takutlah jika tidak mau mencoba.",
            "Prestasi tak dapat diraih tanpa semangat!"
        ];
        let qIdx = 0;
        function rotateQuote() {
            const el = document.getElementById('quote-text');
            el.classList.add('fade-out');
            setTimeout(() => {
                el.innerText = quotes[qIdx];
                el.classList.remove('fade-out');
                qIdx = (qIdx + 1) % quotes.length;
            }, 500);
        }
        setInterval(rotateQuote, 8000);
        rotateQuote();

        // --- MAIN LOGIC ---
        (async () => {
            const user = await checkAuth('siswa');
            if(user) loadQuizzes(user.uid);
        })();

        async function loadQuizzes(uid) {
            const container = document.getElementById('quiz-list');
            
            try {
                // 1. Ambil Data Kuis Aktif
                const qSnap = await getDocs(query(collection(db, 'quizzes'), where('status', '==', 'active')));
                
                // 2. Ambil Riwayat User (Untuk cek nilai)
                const rSnap = await getDocs(query(collection(db, 'quiz_results'), where('studentId', '==', uid)));
                
                const results = {};
                let totalScore = 0;
                let scoreCount = 0;

                rSnap.forEach(d => {
                    const data = d.data();
                    results[data.quizId] = { id: d.id, score: data.score };
                    totalScore += parseInt(data.score);
                    scoreCount++;
                });

                // Update Stats
                document.getElementById('stat-total').innerText = qSnap.size;
                document.getElementById('stat-score').innerText = scoreCount > 0 ? Math.round(totalScore/scoreCount) : '-';
                document.getElementById('loading').classList.add('hidden');

                if(qSnap.empty) {
                    document.getElementById('empty-msg').classList.remove('hidden');
                    return;
                }

                container.classList.remove('hidden');
                container.innerHTML = '';

                qSnap.forEach(doc => {
                    const data = doc.data();
                    const result = results[doc.id];
                    
                    // Logic Tombol & Status
                    let btnHtml = '';
                    let scoreBadge = '';

                    if (result) {
                        // SUDAH DIKERJAKAN
                        btnHtml = `
                            <a href="hasil.html?rid=${result.id}" class="btn-quiz btn-done">
                                <i class="fa-solid fa-file-pdf"></i> Lihat Hasil
                            </a>
                        `;
                        scoreBadge = `<span style="color:#166534; font-weight:700; font-size:0.9rem;">Nilai: ${result.score}</span>`;
                    } else {
                        // BELUM DIKERJAKAN
                        btnHtml = `
                            <a href="start.html?id=${doc.id}" class="btn-quiz btn-start">
                                <i class="fa-solid fa-play"></i> Kerjakan Sekarang
                            </a>
                        `;
                    }

                    const card = `
                        <div class="quiz-card">
                            <div>
                                <div class="card-header">
                                    <div class="mapel-badge"><i class="fa-solid fa-book-open"></i> ${data.mapel}</div>
                                    ${scoreBadge}
                                </div>
                                <h3 class="quiz-title">${data.judul}</h3>
                                <div class="quiz-meta">
                                    <div class="meta-item"><i class="fa-regular fa-clock"></i> ${data.durasi} Menit</div>
                                    <div class="meta-item"><i class="fa-solid fa-list-ol"></i> ${data.questions ? data.questions.length : 0} Soal</div>
                                </div>
                            </div>
                            <div class="card-footer">
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', card);
                });

            } catch(e) {
                console.error(e);
                alert("Gagal memuat kuis.");
            }
        }
    </script>
</body>
</html>
