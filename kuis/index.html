<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Harian - Cendekia Aksara</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* RESET & GLOBAL */
        * { box-sizing: border-box; }
        :root { --primary: #003366; --accent: #4361ee; --bg: #f4f7fe; }
        
        body { 
            background-color: var(--bg); 
            font-family: 'Outfit', sans-serif; 
            color: #333; 
            margin: 0; 
            padding-bottom: 60px; 
            overflow-x: hidden; /* Mencegah scroll samping */
        }
        
        /* CONTAINER LEBAR (FULL SCREEN FEEL) */
        .container { 
            max-width: 1400px; /* Lebih lebar untuk laptop */
            width: 95%; 
            margin: 0 auto; 
            padding: 20px; 
        }

        /* HEADER MODERN */
        .modern-header {
            background: linear-gradient(135deg, #003366, #1e3a8a);
            color: white; padding: 25px 35px; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 51, 102, 0.2);
            position: relative; overflow: hidden; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center; 
            gap: 20px; flex-wrap: wrap; /* Agar responsif turun ke bawah */
        }
        
        /* Dekorasi Header */
        .modern-header::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 250px; height: 250px; background: rgba(255,255,255,0.05);
            border-radius: 50%; pointer-events: none;
        }
        
        .header-content { flex: 1; min-width: 200px; z-index: 1; }
        .header-content h1 { margin: 5px 0; font-size: 1.8rem; font-weight: 700; line-height: 1.2; }
        
        /* LOGO FIX (Warna Asli) */
        .school-brand { display: flex; align-items: center; gap: 10px; opacity: 1; }
        .school-logo { 
            width: 45px; height: auto; 
            background: white; padding: 5px; border-radius: 50%; /* Lingkaran putih di belakang logo */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .brand-text { font-size: 0.9rem; font-weight: 600; letter-spacing: 1px; opacity: 0.9; }

        /* MOTIVASI */
        .quote-box { margin-top: 5px; font-size: 0.9rem; font-weight: 300; opacity: 0.9; display: flex; align-items: center; gap: 8px; }
        .quote-text { transition: opacity 0.5s ease; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: inline-block; }
        .fade-out { opacity: 0; }

        /* TOMBOL KEMBALI */
        .btn-back {
            background: rgba(255,255,255,0.15); color: white; text-decoration: none;
            padding: 12px 20px; border-radius: 50px; font-weight: 600; backdrop-filter: blur(5px);
            transition: 0.3s; display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.2); flex-shrink: 0;
        }
        .btn-back:hover { background: white; color: var(--primary); transform: translateY(-2px); }

        /* STATS BAR */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eef2f6; }
        .stat-icon { width: 55px; height: 55px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; flex-shrink: 0; }
        .icon-blue { background: #e0f2fe; color: #0284c7; }
        .icon-purple { background: #f3e8ff; color: #9333ea; }
        .stat-info h3 { margin: 0; font-size: 1.6rem; color: #1e293b; line-height: 1; }
        .stat-info p { margin: 4px 0 0; color: #64748b; font-size: 0.9rem; }

        /* LIST KUIS GRID */
        .section-title { font-size: 1.25rem; font-weight: 700; color: #334155; margin-bottom: 20px; border-left: 5px solid var(--accent); padding-left: 15px; }
        
        .quiz-grid { 
            display: grid; 
            /* Grid Responsive: Laptop 3-4 kolom, Tablet 2, HP 1 */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 25px; 
        }
        
        /* CARD DESAIN */
        .quiz-card {
            background: white; border-radius: 18px; padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; border: 1px solid #f1f5f9; display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .quiz-card:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(67, 97, 238, 0.1); border-color: #e0e7ff; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 10px; }
        .mapel-badge { background: #f1f5f9; color: #475569; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; flex-shrink: 0; }
        
        .quiz-title { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin: 0 0 10px 0; line-height: 1.4; }
        .quiz-meta { display: flex; gap: 15px; font-size: 0.85rem; color: #64748b; margin-bottom: 20px; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 6px; }

        /* STATUS & TOMBOL */
        .card-footer { margin-top: auto; }
        
        .btn-quiz { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 14px; border-radius: 12px; text-align: center; text-decoration: none; font-weight: 600; font-size: 0.95rem; transition: 0.2s; border: none; cursor: pointer; box-sizing: border-box; }
        
        .btn-start { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0, 51, 102, 0.2); }
        .btn-start:hover { background: #1e3a8a; transform: translateY(-2px); }
        
        .btn-done { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .btn-done:hover { background: #bbf7d0; }

        .score-display { font-size: 0.9rem; font-weight: 700; color: #166534; background: #dcfce7; padding: 5px 10px; border-radius: 8px; white-space: nowrap; }

        #loading { text-align: center; padding: 80px; grid-column: 1 / -1; }
        .hidden { display: none !important; }

        /* --- RESPONSIVE MOBILE FIX (LAYAR KECIL) --- */
        @media (max-width: 768px) {
            .container { padding: 15px; width: 100%; }
            
            /* Header Vertikal di HP */
            .modern-header { 
                flex-direction: column; 
                align-items: stretch; /* Lebar Penuh */
                gap: 20px; 
                padding: 25px; 
                text-align: left;
            }
            
            .header-content { width: 100%; }
            .quote-text { white-space: normal; font-size: 0.85rem; } /* Text wrap */
            
            /* Tombol Dashboard Full Width */
            .btn-back { width: 100%; justify-content: center; }
            
            /* Stats Rapat */
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-card { padding: 15px; flex-direction: column; text-align: center; gap: 5px; }
            .stat-icon { margin-bottom: 5px; }
            
            /* Grid Kuis 1 Kolom */
            .quiz-grid { grid-template-columns: 1fr; gap: 20px; }
            .quiz-card { padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <header class="modern-header">
            <div class="header-content">
                <div class="school-brand">
                    <img src="https://i.imgur.com/5Srjyo4.png" class="school-logo" alt="Logo">
                    <span class="brand-text">CENDEKIA AKSARA</span>
                </div>
                <h1>Kuis Harian</h1>
                <div class="quote-box">
                    <i class="fa-solid fa-quote-left"></i>
                    <span id="quote-text" class="quote-text">Memuat motivasi...</span>
                </div>
            </div>
            
            <a href="../index.html" class="btn-back">
                <i class="fa-solid fa-house"></i> Dashboard
            </a>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon icon-blue"><i class="fa-solid fa-list-check"></i></div>
                <div class="stat-info">
                    <h3 id="stat-total">0</h3>
                    <p>Kuis Tersedia</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-purple"><i class="fa-solid fa-star"></i></div>
                <div class="stat-info">
                    <h3 id="stat-score">-</h3>
                    <p>Rata-rata Nilaimu</p>
                </div>
            </div>
        </div>

        <div class="section-title">Daftar Kuis Terbaru</div>
        
        <div id="loading">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary);"></i>
            <p style="margin-top:15px; color:#64748b; font-size:1rem;">Menyiapkan kuis...</p>
        </div>

        <div id="quiz-list" class="quiz-grid hidden"></div>
        
        <div id="empty-msg" class="hidden" style="text-align:center; padding:60px; color:#94a3b8; grid-column: 1 / -1;">
            <i class="fa-solid fa-box-open" style="font-size:4rem; margin-bottom:15px; opacity:0.5;"></i>
            <h3>Belum Ada Kuis</h3>
            <p>Silakan cek kembali nanti atau hubungi pengajar.</p>
        </div>

    </div>

    <script type="module">
        import { db, checkAuth } from "../js/firebase-config.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MOTIVASI OTOMATIS ---
        const quotes = [
            "Belajar sedikit demi sedikit, lama-lama menjadi bukit.",
            "Kuis hari ini adalah tabungan nilai untuk masa depan.",
            "Kejujuran adalah kunci utama keberhasilan.",
            "Jangan takut salah, takutlah jika tidak mau mencoba.",
            "Prestasi tak dapat diraih tanpa semangat!"
        ];
        let qIdx = 0;
        function rotateQuote() {
            const el = document.getElementById('quote-text');
            if(!el) return;
            el.classList.add('fade-out');
            setTimeout(() => {
                el.innerText = quotes[qIdx];
                el.classList.remove('fade-out');
                qIdx = (qIdx + 1) % quotes.length;
            }, 500);
        }
        setInterval(rotateQuote, 8000);
        rotateQuote();

        // --- MAIN LOGIC ---
        (async () => {
            const user = await checkAuth('siswa');
            if(user) loadQuizzes(user.uid);
        })();

        async function loadQuizzes(uid) {
            const container = document.getElementById('quiz-list');
            
            try {
                // 1. Ambil Data Kuis Aktif
                const qSnap = await getDocs(query(collection(db, 'quizzes'), where('status', '==', 'active')));
                
                // 2. Ambil Riwayat User
                const rSnap = await getDocs(query(collection(db, 'quiz_results'), where('studentId', '==', uid)));
                
                const results = {};
                let totalScore = 0;
                let scoreCount = 0;

                rSnap.forEach(d => {
                    const data = d.data();
                    results[data.quizId] = { id: d.id, score: data.score };
                    totalScore += parseInt(data.score);
                    scoreCount++;
                });

                // Update Stats
                document.getElementById('stat-total').innerText = qSnap.size;
                document.getElementById('stat-score').innerText = scoreCount > 0 ? Math.round(totalScore/scoreCount) : '-';
                document.getElementById('loading').classList.add('hidden');

                if(qSnap.empty) {
                    document.getElementById('empty-msg').classList.remove('hidden');
                    return;
                }

                container.classList.remove('hidden');
                container.innerHTML = '';

                qSnap.forEach(doc => {
                    const data = doc.data();
                    const result = results[doc.id];
                    
                    let btnHtml = '';
                    let scoreHtml = '';

                    if (result) {
                        // SUDAH DIKERJAKAN
                        btnHtml = `
                            <a href="hasil.html?rid=${result.id}" class="btn-quiz btn-done">
                                <i class="fa-solid fa-file-invoice"></i> Lihat Hasil
                            </a>
                        `;
                        scoreHtml = `<div class="score-display"><i class="fa-solid fa-star"></i> Nilai: ${result.score}</div>`;
                    } else {
                        // BELUM DIKERJAKAN
                        btnHtml = `
                            <a href="start.html?id=${doc.id}" class="btn-quiz btn-start">
                                <i class="fa-solid fa-play"></i> Kerjakan Sekarang
                            </a>
                        `;
                    }

                    const card = `
                        <div class="quiz-card">
                            <div>
                                <div class="card-header">
                                    <div class="mapel-badge"><i class="fa-solid fa-book-open"></i> ${data.mapel}</div>
                                    ${scoreHtml}
                                </div>
                                <h3 class="quiz-title">${data.judul}</h3>
                                <div class="quiz-meta">
                                    <div class="meta-item"><i class="fa-regular fa-clock"></i> ${data.durasi}m</div>
                                    <div class="meta-item"><i class="fa-solid fa-list-ul"></i> ${data.questions ? data.questions.length : 0} Soal</div>
                                </div>
                            </div>
                            <div class="card-footer">
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', card);
                });

            } catch(e) {
                console.error(e);
                alert("Gagal memuat kuis.");
            }
        }
    </script>
</body>
</html>
